<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333; /* Default text color for better contrast on white backgrounds */
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-radius: 15px;
        }

        /* Headings */
        h1 {
            color: #2c3e50;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
            overflow-x: auto;
            gap: 2px;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            background-color: transparent;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #7f8c8d;
            min-width: 120px;
            text-align: center;
            border: 2px solid transparent;
            border-bottom: none;
        }

        .tab:hover {
            background-color: #f8f9fa;
            color: #2c3e50;
            border-color: #e1e8ed;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            border-color: #667eea; /* Match gradient start */
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Stats Cards for Dashboard */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .stat-card.urgent {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
         .stat-card.urgent:hover {
            box-shadow: 0 15px 35px rgba(231, 76, 60, 0.4);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        .stat-card.warning:hover {
            box-shadow: 0 15px 35px rgba(243, 156, 18, 0.4);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
         .stat-card.info:hover {
            box-shadow: 0 15px 35px rgba(52, 152, 219, 0.4);
        }


        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            line-height: 1;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Controls (Buttons, Search) */
        .controls {
            margin: 20px 0; /* Keep vertical margin */
            display: flex;
            justify-content: space-between;
            align-items: flex-start; 
            flex-wrap: wrap;
            gap: 15px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e1e8ed;
        }
         .controls > * { 
            flex-shrink: 0;
        }


        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px; /* Increased margin for spacing */
            background: white;
            border-radius: 10px;
            overflow: hidden; /* Important for border-radius on table */
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        th, td {
            padding: 14px; /* Increased padding for more space */
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: middle; /* Better vertical alignment */
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.6px; /* Slightly increased letter spacing */
            font-size: 12px;
            cursor: pointer; 
        }
        th .sort-arrow { 
            font-size: 0.8em;
            margin-left: 5px;
        }
        
        /* Zebra striping for table body rows */
        tbody tr:nth-child(even) {
            background-color: #f9f9fc; /* Very light purple/grey */
        }

        tbody tr:hover {
            background-color: #f1f3f5; /* Slightly darker hover for better feedback */
        }

        /* Right-align specific numeric columns */
        #inventory-table td:nth-child(4), /* Quantity */
        #new-products-table td:nth-child(6), /* Quantity */
        #to-clear-table td:nth-child(7), /* Initial Bal */
        #to-clear-table td:nth-child(8), /* WH Qty */
        #to-clear-table td:nth-child(9), /* Store Qty */
        #to-clear-table td:nth-child(10), /* Total Qty */
        #to-clear-table td:nth-child(11), /* Weekly Demand */
        #to-clear-table td:nth-child(12), /* Weeks Supply */
        #master-table td:nth-child(6) /* Price */
        {
            text-align: right;
            font-variant-numeric: tabular-nums; /* Helps align numbers if using proportional fonts */
        }


        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px; /* Slightly smaller for compactness */
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .oos { /* For OOS/Low Stock Tab */
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .low { /* For OOS/Low Stock Tab */
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        /* Statuses for "To Clear" Tab based on new logic */
        .normal { /* Normal: Can sell >= 9 months before expiry */
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .alert-status { /* Alert: Can sell 6-9 months before expiry */
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .danger-status { /* Danger: Cannot sell < 6 months before expiry OR Expired OR No demand & will expire */
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .info { /* N/A: No expiry date for new logic */
             background: linear-gradient(135deg, #546e7a 0%, #78909c 100%); /* Grey for N/A */
        }


        /* General Buttons */
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }
         .btn-success:hover {
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }


        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
         .btn-info:hover {
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        /* Refined styles for buttons within table cells */
        td button.btn-info,
        td button.btn-danger,
        td button.btn-success {
            padding: 7px 10px;   /* Reduced padding for compactness */
            font-size: 10px;    /* Smaller font for text like "Edit", "Delete" */
            letter-spacing: 0.3px; /* Adjust letter spacing for smaller font */
            border-radius: 18px; /* Keep pill shape, but ensure it's compact */
            margin: 3px;         /* Spacing between buttons in a cell */
        }


        /* Search Box */
        .search-box {
            padding: 12px 16px;
            width: 280px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%237f8c8d' class='bi bi-search' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E") no-repeat 12px center; /* Added search icon */
            padding-left: 35px; /* Space for the icon */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); /* Slightly more visible focus */
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: none;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        /* Form Group */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .form-group input:disabled, .form-group select:disabled, .form-group textarea:disabled {
            background-color: #f0f0f0;
            opacity: 0.7;
            cursor: not-allowed;
        }
        .form-group label.disabled-label {
            opacity: 0.5;
        }


        /* Alert Notifications */
        .alert {
            padding: 15px 20px; /* More padding */
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 600;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 320px; /* Slightly wider */
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* Stronger shadow */
            border-left-width: 5px; /* Accent border */
            border-left-style: solid;
        }

        .alert-success {
            background-color: #e6f7ed; /* Lighter green */
            color: #0f5132; /* Darker text for contrast */
            border-color: #27ae60; /* Accent color */
        }

        .alert-error {
            background-color: #fbe9e7; /* Lighter red */
            color: #842029; /* Darker text */
            border-color: #e74c3c; /* Accent color */
        }

        /* Confirmation Modal Specific Styles */
        #confirmModal .modal-content {
            text-align: center;
            padding: 40px;
            max-width: 450px;
        }

        #confirmModal .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        #confirmModal .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        #confirmModal .modal-buttons button {
            flex: 1;
            max-width: 150px;
            padding: 12px 25px;
            font-size: 14px;
        }

        /* --- Mobile Responsiveness --- */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            .subtitle {
                font-size: 1rem;
                margin-bottom: 20px;
            }

            .tabs {
                flex-wrap: wrap; 
                justify-content: center; 
                border-bottom: none; 
            }

            .tab {
                min-width: unset; 
                flex: 1 1 auto; 
                padding: 10px 15px;
                font-size: 10px;
                border-bottom: 2px solid #ecf0f1; 
            }

            .tab.active {
                transform: none; 
                box-shadow: none; 
                border-bottom: 2px solid #667eea;
            }

            .stats-cards {
                grid-template-columns: 1fr; 
            }

            .stat-card {
                padding: 20px;
            }

            .stat-number {
                font-size: 2.5rem;
            }

            .controls {
                flex-direction: column; 
                align-items: stretch; 
                padding: 15px;
            }
            .controls .search-box { 
                 width: 100%;
            }


            button { /* General button stacking */
                width: 100%;
                margin-bottom: 10px; 
                font-size: 12px;
                padding: 10px 15px;
            }
             /* Ensure table action buttons don't go full width on mobile */
            td button.btn-info,
            td button.btn-danger,
            td button.btn-success {
                width: auto; /* Override full width for table buttons */
                margin-bottom: 2px; /* Reduce margin if stacked vertically in a small cell */
            }


            .search-box { 
                width: 100%; 
                padding-left: 35px; /* Ensure icon space maintained */
            }


            /* Responsive Tables: force table to scroll horizontally */
            table {
                display: block; 
                width: 100%;
                overflow-x: auto; 
                -webkit-overflow-scrolling: touch; 
                white-space: nowrap; 
            }

            th, td {
                min-width: 120px; /* Ensure columns have a minimum width for readability */
                padding: 10px;    /* Adjust padding for mobile if needed */
            }
            /* Adjust right-alignment for mobile if it causes issues, or keep it */
            #inventory-table td:nth-child(4),
            #new-products-table td:nth-child(6),
            #to-clear-table td:nth-child(7),
            #to-clear-table td:nth-child(8),
            #to-clear-table td:nth-child(9),
            #to-clear-table td:nth-child(10),
            #to-clear-table td:nth-child(11),
            #to-clear-table td:nth-child(12),
            #master-table td:nth-child(6) {
                text-align: right; /* Keep right alignment for consistency */
            }


            .modal-content {
                margin: 20px auto; 
                padding: 20px;
                width: 95%; 
            }

            .alert {
                width: calc(100% - 40px); 
                left: 20px;
                right: 20px;
                top: 10px; 
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Inventory Management System</h1>
        <p class="subtitle">Professional Inventory Tracking & Management Solution</p>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab(this, 'dashboard')">📊 Dashboard</div>
            <div class="tab" onclick="switchTab(this, 'oos-lowstock')">📦 OOS/LOW STOCK</div>
            <div class="tab" onclick="switchTab(this, 'new-products')">✨ New Products</div>
            <div class="tab" onclick="switchTab(this, 'to-clear')">🏷️ To Clear</div>
            <div class="tab" onclick="switchTab(this, 'master-list')">📋 Master List</div>
            <div class="tab" onclick="switchTab(this, 'recycle-bin')">🗑️ Recycle Bin</div>
            <div class="tab" onclick="switchTab(this, 'management')">⚙️ Management</div>
        </div>
        
        <div id="dashboard" class="tab-content active">
            <div class="stats-cards">
                <div class="stat-card urgent" onclick="showFilteredInventory('OOS')">
                    <div class="stat-number" id="oos-count">0</div>
                    <div class="stat-label">Out of Stock</div>
                </div>
                <div class="stat-card warning" onclick="showFilteredInventory('Low stock')">
                    <div class="stat-number" id="low-count">0</div>
                    <div class="stat-label">Low Stock</div>
                </div>
                <div class="stat-card info" onclick="switchTab(document.querySelector('.tab[onclick*=\'new-products\']'), 'new-products')">
                    <div class="stat-number" id="new-count">0</div>
                    <div class="stat-label">New Products</div>
                </div>
            </div>
            
            <h3>Recent Alerts</h3>
            <div id="alerts" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; border: 1px solid #e1e8ed;">
                <p>Loading alerts...</p>
            </div>
        </div>
        
        <div id="oos-lowstock" class="tab-content">
            <div class="controls">
                <button onclick="showAddProductModal()">➕ Add Product</button>
                <input type="text" id="oosSearchInput" class="search-box" placeholder="Search products..." onkeyup="searchInventory(this.value)">
            </div>
            
            <table id="inventory-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('inventory', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'quantity')" data-column-key="quantity">Quantity <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'status')" data-column-key="status">Status <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'shipment')" data-column-key="shipment">Shipment <span class="sort-arrow"></span></th>
                        <th>Remarks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventory-table">
                    </tbody>
            </table>
        </div>
        
        <div id="new-products" class="tab-content">
            <div class="controls">
                <button onclick="showAddNewProductModal()">➕ Add New Product</button>
                <button onclick="mergeNewProductsToMaster()">Merge All to Inventory</button>
                 <input type="text" id="newProductsSearchInput" class="search-box" placeholder="Search new products..." onkeyup="searchNewProducts(this.value)">
            </div>
            
            <table id="new-products-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('newProducts', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'addedDate')" data-column-key="addedDate">Added Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'arrivalDate')" data-column-key="arrivalDate">Arrival Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'quantity')" data-column-key="quantity">Quantity <span class="sort-arrow"></span></th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="new-products-table">
                    </tbody>
            </table>
        </div>
        
        <div id="to-clear" class="tab-content">
            <div class="controls">
                <button onclick="showAddToClearModal()">➕ Add Product to Clear</button>
                <input type="text" id="toClearSearchInput" class="search-box" placeholder="Search products to clear..." onkeyup="searchToClear(this.value)">
            </div>
            
            <table id="to-clear-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('toClear', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'category')" data-column-key="category">Category <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'expiryDate')" data-column-key="expiryDate">Expiry Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'firstHighlightedDate')" data-column-key="firstHighlightedDate">First Highlighted <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'firstReportedBalance')" data-column-key="firstReportedBalance">Initial Bal <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'warehouseQty')" data-column-key="warehouseQty">WH Qty <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'storeQty')" data-column-key="storeQty">Store Qty <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'totalQty')" data-column-key="totalQty">Total Qty <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'weeklyDemand')" data-column-key="weeklyDemand">Wk Demand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'weeksSupply')" data-column-key="weeksSupply">Wks Supply <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'supplyStatus')" data-column-key="supplyStatus">Supply Status <span class="sort-arrow"></span></th>
                        <th>Action Plan</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="to-clear-table">
                    </tbody>
            </table>
        </div>
        
        <div id="master-list" class="tab-content">
            <div class="controls">
                <button onclick="showAddMasterProductModal()">➕ Add Product</button>
                <input type="text" class="search-box" id="masterListSearchInput" placeholder="Search master products..." onkeyup="searchMasterList(this.value)">
                <button onclick="exportMasterList()">📥 Export List</button>
                <button onclick="document.getElementById('csvFileInput').click()">📤 Import CSV</button>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importCSV(event)">
            </div>
            
            <table id="master-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('master', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'product')" data-column-key="product">Product Name <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'category')" data-column-key="category">Category <span class="sort-arrow"></span></th>
                        <th>Description</th>
                        <th onclick="sortTable('master', 'price')" data-column-key="price">Price <span class="sort-arrow"></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="master-table">
                    </tbody>
            </table>
        </div>

        <div id="recycle-bin" class="tab-content">
            <div class="controls">
                <h3>Recycle Bin</h3>
                <input type="text" id="recycleBinSearchInput" class="search-box" placeholder="Search recycle bin..." onkeyup="searchRecycleBin(this.value)">
                <button class="btn-danger" onclick="emptyRecycleBin()">🗑️ Empty Recycle Bin</button>
            </div>
            <table id="recycle-bin-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('recycleBin', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('recycleBin', 'originalCollection')" data-column-key="originalCollection">Original Tab <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('recycleBin', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('recycleBin', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recycle-bin-table">
                    </tbody>
            </table>
        </div>
        
        <div id="management" class="tab-content">
            <div class="controls">
                <button onclick="exportAllData()">📥 Export All Data</button>
                <button onclick="confirmLoadSampleData()">📊 Load Sample Data</button>
            </div>
            
            <h3>System Information</h3>
            <p>Total Products (active): <span id="total-products">0</span></p>
            <p>Total Products (all unique SKUs): <span id="total-products-all">0</span></p>
            <p>Last Synced: <span id="last-updated">Never</span></p>
        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('productModal')">&times;</span>
            <h2 id="productModalTitle">Add New Product</h2>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="editProductId" value="">
                <div class="form-group">
                    <label for="brand">Brand:</label>
                    <select id="brand" required onchange="filterProductsForBrand(this.value, 'productName', 'productsDatalist')">
                        </select>
                </div>
                <div class="form-group">
                    <label for="productName">Product Name:</label>
                    <input type="text" id="productName" list="productsDatalist" required>
                    <datalist id="productsDatalist"></datalist>
                </div>
                <div class="form-group">
                    <label for="inventoryQuantity">Quantity:</label>
                    <input type="number" id="inventoryQuantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="status">Status:</label>
                    <select id="status" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="shipment">Shipment No.:</label>
                    <input type="text" id="shipment">
                </div>
                <div class="form-group">
                    <label for="remarks">Remarks:</label>
                    <textarea id="remarks"></textarea>
                </div>
                <button type="submit">Save Product</button>
            </form>
        </div>
    </div>

    <div id="newProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('newProductModal')">&times;</span>
            <h2 id="newProductModalTitle">Add New Product Entry</h2>
            <form onsubmit="saveNewProduct(event)">
                <input type="hidden" id="editNewProductId" value="">
                <div class="form-group">
                    <label for="newBrand">Brand:</label>
                    <select id="newBrand" required onchange="filterProductsForBrand(this.value, 'newProductName', 'newProductsDatalist')">
                        </select>
                </div>
                <div class="form-group">
                    <label for="newProductSku">Product Code (SKU):</label>
                    <input type="text" id="newProductSku" required>
                </div>
                <div class="form-group">
                    <label for="newProductName">Product Name:</label>
                    <input type="text" id="newProductName" list="newProductsDatalist" required>
                    <datalist id="newProductsDatalist"></datalist>
                </div>
                <div class="form-group">
                    <label for="arrivalDate">Arrival Date:</label>
                    <input type="date" id="arrivalDate" required>
                </div>
                <div class="form-group">
                    <label for="newProductQuantity">Quantity:</label> <input type="number" id="newProductQuantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="notes">Notes:</label>
                    <textarea id="notes"></textarea>
                </div>
                <button type="submit">Save New Product</button>
            </form>
        </div>
    </div>

    <div id="masterProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('masterProductModal')">&times;</span>
            <h2 id="masterProductModalTitle">Add Master Product</h2>
            <form onsubmit="saveMasterProduct(event)">
                <input type="hidden" id="editMasterProductId" value="">
                <div class="form-group">
                    <label for="masterBrand">Brand:</label>
                    <select id="masterBrand" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="masterProductName">Product Name:</label>
                    <input type="text" id="masterProductName" required>
                </div>
                <div class="form-group">
                    <label for="category">Category:</label>
                    <select id="category" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="description">Description:</label>
                    <textarea id="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="sku">Product Code (SKU):</label>
                    <input type="text" id="sku">
                </div>
                <div class="form-group">
                    <label for="price">Price:</label>
                    <input type="number" id="price" step="0.01" min="0">
                </div>
                <button type="submit">Save Master Product</button>
            </form>
        </div>
    </div>

    <div id="toClearModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('toClearModal')">&times;</span>
            <h2 id="toClearModalTitle">Add Product to Clear</h2>
            <form onsubmit="saveToClear(event)">
                <input type="hidden" id="editToClearId" value="">
                <div class="form-group">
                    <label for="toClearBrand">Brand:</label>
                    <select id="toClearBrand" required onchange="filterProductsForBrand(this.value, 'toClearProductName', 'toClearProductsDatalist')">
                        </select>
                </div>
                <div class="form-group">
                    <label for="toClearProductName">Product Name:</label>
                    <input type="text" id="toClearProductName" list="toClearProductsDatalist" required>
                    <datalist id="toClearProductsDatalist"></datalist>
                </div>
                <div class="form-group">
                    <label for="toClearCategory">Category:</label>
                    <select id="toClearCategory" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="toClearExpiryDate">Expiry Date:</label>
                    <input type="date" id="toClearExpiryDate" required>
                </div>
                <div class="form-group">
                    <label for="toClearFirstHighlightedDate">First Highlighted Date:</label>
                    <input type="date" id="toClearFirstHighlightedDate" required readonly>
                </div>
                <div class="form-group">
                    <label for="toClearFirstReportedBalance">First Reported Balance (Total Qty):</label>
                    <input type="number" id="toClearFirstReportedBalance" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearWarehouseQty">Warehouse Qty:</label>
                    <input type="number" id="toClearWarehouseQty" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearStoreQty">Store Qty:</label>
                    <input type="number" id="toClearStoreQty" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearWeeklyDemand">Weekly Demand:</label>
                    <input type="number" id="toClearWeeklyDemand" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearActionPlan">Action Plan:</label>
                    <textarea id="toClearActionPlan"></textarea>
                </div>
                <button type="submit">Save Product to Clear</button>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2>Confirmation</h2>
            <p id="confirmMessage"></p>
            <div class="modal-buttons">
                <button class="btn-danger" id="confirmNo">No</button>
                <button class="btn-success" id="confirmYes">Yes</button>
            </div>
        </div>
    </div>

    <div id="addBrandModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addBrandModal')">&times;</span>
            <h2>Add New Brand</h2>
            <form onsubmit="saveNewBrand(event)">
                <div class="form-group">
                    <label for="newBrandName">Brand Name:</label>
                    <input type="text" id="newBrandName" required>
                </div>
                <button type="submit">Add Brand</button>
            </form>
        </div>
    </div>

    <div id="addStatusModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addStatusModal')">&times;</span>
            <h2>Add New Status</h2>
            <form onsubmit="saveNewStatus(event)">
                <div class="form-group">
                    <label for="newStatusName">Status Name:</label>
                    <input type="text" id="newStatusName" required>
                </div>
                <button type="submit">Add Status</button>
            </form>
        </div>
    </div>

    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addCategoryModal')">&times;</span>
            <h2>Add New Category</h2>
            <form onsubmit="saveNewCategory(event)">
                <div class="form-group">
                    <label for="newCategoryName">Category Name:</label>
                    <input type="text" id="newCategoryName" required>
                </div>
                <button type="submit">Add Category</button>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDo1-y0Vj4XTQeeEUQK_6Y2wqDs94TOAX0", // Replace with your actual API key
            authDomain: "inventory-c3bac.firebaseapp.com",
            projectId: "inventory-c3bac",
            storageBucket: "inventory-c3bac.appspot.com", 
            messagingSenderId: "261015083855",
            appId: "1:261015083855:web:e167f359928eb8ed8cc33a",
            measurementId: "G-V744486L78"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global data arrays
        let inventoryData = [], newProductsData = [], toClearData = [], masterProductsData = [];
        let deletedItemsData = [], brandsData = [], statusesData = [], categoriesData = [];
        let currentInventoryViewData = [], currentNewProductsViewData = [], currentToClearViewData = [];
        let currentMasterListViewData = [], currentRecycleBinViewData = [];

        const inventoryColRef = db.collection('inventory'), newProductsColRef = db.collection('new_products');
        const toClearColRef = db.collection('to_clear'), masterProductsColRef = db.collection('master_products');
        const brandsColRef = db.collection('brands'), statusesColRef = db.collection('statuses');
        const categoriesColRef = db.collection('categories');

        let sortState = {
            inventory: { column: null, direction: 'asc' }, newProducts: { column: null, direction: 'asc' },
            master: { column: null, direction: 'asc' }, toClear: { column: null, direction: 'asc' },
            recycleBin: { column: null, direction: 'asc' }
        };

        function showNotification(message, type) {
            const el = document.createElement('div');
            el.classList.add('alert', `alert-${type}`);
            el.textContent = message;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        let confirmCallback = null;
        function showConfirmModal(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').style.display = 'block';
            confirmCallback = callback;
        }
        document.getElementById('confirmYes').onclick = () => {
            if (confirmCallback) confirmCallback(true);
            document.getElementById('confirmModal').style.display = 'none';
        };
        document.getElementById('confirmNo').onclick = () => {
            if (confirmCallback) confirmCallback(false);
            document.getElementById('confirmModal').style.display = 'none';
        };

        async function fetchDataFromFirestore(collectionRef, includeDeleted = false) {
            let data = [], query = collectionRef;
            if (!includeDeleted && ['inventory', 'new_products', 'to_clear', 'master_products'].includes(collectionRef.id)) {
                query = collectionRef.where("isDeleted", "==", false);
            }
            try {
                const snapshot = await query.get();
                snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
            } catch (e) { console.error(`Error fetching ${collectionRef.id}:`, e); }
            return data;
        }

        async function fetchAllDataForRecycleBin() {
            let items = [];
            for (const ref of [inventoryColRef, newProductsColRef, toClearColRef, masterProductsColRef]) {
                try {
                    const snapshot = await ref.where("isDeleted", "==", true).get();
                    snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data(), originalCollection: ref.id }));
                } catch (e) { console.error(`Error fetching deleted from ${ref.id}:`, e); }
            }
            return items;
        }

        async function saveDataToFirestore(collectionRef, docId, data) {
            try {
                if (docId) await collectionRef.doc(docId).update(data);
                else { const docRef = await collectionRef.add(data); return docRef.id; }
                return docId;
            } catch (e) { console.error(`Error saving to ${collectionRef.id}:`, e); throw e; }
        }

        async function updateLocalData() {
            [inventoryData, newProductsData, toClearData, masterProductsData, deletedItemsData] = await Promise.all([
                fetchDataFromFirestore(inventoryColRef), fetchDataFromFirestore(newProductsColRef),
                fetchDataFromFirestore(toClearColRef), fetchDataFromFirestore(masterProductsColRef),
                fetchAllDataForRecycleBin()
            ]);
            const [rawBrands, rawStatuses, rawCategories] = await Promise.all([
                fetchDataFromFirestore(brandsColRef, true), fetchDataFromFirestore(statusesColRef, true),
                fetchDataFromFirestore(categoriesColRef, true)
            ]);
            brandsData = rawBrands.filter(b => !b.isDeleted);
            statusesData = rawStatuses.filter(s => !s.isDeleted);
            categoriesData = rawCategories.filter(c => !c.isDeleted);

            currentInventoryViewData = inventoryData.filter(item => !item.isDeleted && (item.status === 'OOS' || (item.status && item.status.toLowerCase().includes('low stock'))));
            currentNewProductsViewData = newProductsData.filter(item => !item.isDeleted);
            currentToClearViewData = toClearData.filter(item => !item.isDeleted);
            currentMasterListViewData = masterProductsData.filter(item => !item.isDeleted);
            currentRecycleBinViewData = [...deletedItemsData];

            updateAllTablesAndViews(); updateDashboardStats(); updateAlerts();
            updateManagementStats(); populateProductDatalists(); setupDynamicDropdowns();
        }

        function updateAllTablesAndViews() {
            renderInventoryItems(); renderNewProductsItems(); renderMasterListItems();
            renderToClearItems(); renderRecycleBinItems();
        }

        function setupDynamicDropdowns() {
            ['brand', 'newBrand', 'masterBrand', 'toClearBrand'].forEach(id => populateBrandDropdowns(id));
            populateStatusDropdowns('status');
            ['category', 'toClearCategory'].forEach(id => populateCategoryDropdowns(id));
        }

        function populateBrandDropdowns(selectId) {
            const select = document.getElementById(selectId); if (!select) return;
            const val = select.value; select.innerHTML = '<option value="">Select Brand</option>';
            const unique = [...new Set(masterProductsData.filter(i => !i.isDeleted && i.brand).map(i => i.brand))];
            brandsData.forEach(b => { if (b.name && !unique.includes(b.name)) unique.push(b.name); });
            unique.sort().forEach(b => select.add(new Option(b, b)));
            select.add(new Option('+ Add New Brand...', 'add_new_brand'));
            if (val && unique.includes(val)) select.value = val; else if (val === 'add_new_brand') select.value = '';
            select.onchange = handleDynamicDropdownChange;
        }
        function populateStatusDropdowns(selectId) {
            const select = document.getElementById(selectId); if (!select) return;
            const val = select.value; select.innerHTML = '<option value="">Select Status</option>';
            const unique = [...new Set(inventoryData.filter(i => !i.isDeleted && i.status).map(i => i.status))];
            statusesData.forEach(s => { if (s.name && !unique.includes(s.name)) unique.push(s.name); });
            unique.sort().forEach(s => select.add(new Option(s, s)));
            select.add(new Option('+ Add New Status...', 'add_new_status'));
            if (val && unique.includes(val)) select.value = val; else if (val === 'add_new_status') select.value = '';
            select.onchange = handleDynamicDropdownChange;
        }
        function populateCategoryDropdowns(selectId) {
            const select = document.getElementById(selectId); if (!select) return;
            const val = select.value; select.innerHTML = '<option value="">Select Category</option>';
            const unique = [...new Set(masterProductsData.filter(i => !i.isDeleted && i.category).map(i => i.category))];
            categoriesData.forEach(c => { if (c.name && !unique.includes(c.name)) unique.push(c.name); });
            unique.sort().forEach(c => select.add(new Option(c, c)));
            select.add(new Option('+ Add New Category...', 'add_new_category'));
            if (val && unique.includes(val)) select.value = val; else if (val === 'add_new_category') select.value = '';
            select.onchange = handleDynamicDropdownChange;
        }
        
        function handleDynamicDropdownChange(event) {
            const selectElement = event.target;
            const selectedOptionValue = selectElement.value;
            
            // Store the previously selected valid value if any, to potentially restore after modal cancellation
            // This is a simple approach; updateLocalData() will ultimately refresh dropdowns correctly after an add.
            let previousValue = "";
            for(let i=0; i < selectElement.options.length; i++){
                if(selectElement.options[i].selected && 
                   selectElement.options[i].value !== selectedOptionValue && // ensure it's not the "add_new" itself
                   !selectElement.options[i].value.startsWith('add_new_')) { 
                    previousValue = selectElement.options[i].value;
                    break;
                }
            }
            if (!previousValue && selectElement.options.length > 0 && !selectElement.options[0].value.startsWith('add_new_')) {
                // Fallback if nothing was truly selected other than placeholder, keep placeholder if "add new" is cancelled
                previousValue = selectElement.options[0].value;
            }


            if (selectedOptionValue === 'add_new_brand') {
                showAddBrandModal();
                // After modal is closed (either by save or cancel), the dropdown might need to be reset
                // updateLocalData() called from saveNewBrand will repopulate. If cancelled, try to restore.
                selectElement.value = previousValue; // Attempt to restore previous value
            } else if (selectedOptionValue === 'add_new_status') {
                showAddStatusModal();
                selectElement.value = previousValue;
            } else if (selectedOptionValue === 'add_new_category') {
                showAddCategoryModal();
                selectElement.value = previousValue;
            }
        }

        function populateProductDatalists() {
            const productsDatalist = document.getElementById('productsDatalist');
            const newProductsDatalist = document.getElementById('newProductsDatalist');
            const toClearProductsDatalist = document.getElementById('toClearProductsDatalist');

            if (productsDatalist) productsDatalist.innerHTML = '';
            if (newProductsDatalist) newProductsDatalist.innerHTML = '';
            if (toClearProductsDatalist) toClearProductsDatalist.innerHTML = '';

            const allProductNames = [...new Set(masterProductsData.filter(item => !item.isDeleted && item.product).map(item => item.product))].sort();

            allProductNames.forEach(productName => {
                if (productsDatalist) productsDatalist.add(new Option(productName));
                if (newProductsDatalist) newProductsDatalist.add(new Option(productName));
                if (toClearProductsDatalist) toClearProductsDatalist.add(new Option(productName));
            });
        }

        function filterProductsForBrand(brand, productNameInputId, datalistId) {
            const productNameInput = document.getElementById(productNameInputId);
            const datalist = document.getElementById(datalistId);
            if (!productNameInput || !datalist) return;

            datalist.innerHTML = ''; // Clear existing options
            const filteredProducts = masterProductsData.filter(item => !item.isDeleted && item.brand === brand && item.product);
            const uniqueProductNames = [...new Set(filteredProducts.map(item => item.product))].sort();

            uniqueProductNames.forEach(productName => {
                datalist.add(new Option(productName));
            });
            // If current input value is no longer in the filtered list, clear it
            if (productNameInput.value && !uniqueProductNames.includes(productNameInput.value)) {
                productNameInput.value = '';
            }
        }

        function switchTab(clickedTab, tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            clickedTab.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            if (tabId === 'oos-lowstock') {
                currentInventoryViewData = inventoryData.filter(i => !i.isDeleted && (i.status === 'OOS' || (i.status && i.status.toLowerCase().includes('low stock'))));
                if(document.getElementById('oosSearchInput')) document.getElementById('oosSearchInput').value = '';
                renderInventoryItems();
            } else if (tabId === 'new-products') {
                currentNewProductsViewData = newProductsData.filter(i => !i.isDeleted);
                if(document.getElementById('newProductsSearchInput')) document.getElementById('newProductsSearchInput').value = '';
                renderNewProductsItems();
            } else if (tabId === 'to-clear') {
                currentToClearViewData = toClearData.filter(i => !i.isDeleted);
                 if(document.getElementById('toClearSearchInput')) document.getElementById('toClearSearchInput').value = '';
                renderToClearItems();
            } else if (tabId === 'master-list') {
                currentMasterListViewData = masterProductsData.filter(i => !i.isDeleted);
                if(document.getElementById('masterListSearchInput')) document.getElementById('masterListSearchInput').value = '';
                renderMasterListItems();
            } else if (tabId === 'recycle-bin') {
                currentRecycleBinViewData = [...deletedItemsData];
                if(document.getElementById('recycleBinSearchInput')) document.getElementById('recycleBinSearchInput').value = '';
                renderRecycleBinItems();
            }
        }

        function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                const form = modal.querySelector('form');
                if (form) form.reset();
                if (modalId === 'productModal') {
                    document.getElementById('editProductId').value = '';
                    filterProductsForBrand('', 'productName', 'productsDatalist');
                } else if (modalId === 'newProductModal') {
                    document.getElementById('editNewProductId').value = '';
                    filterProductsForBrand('', 'newProductName', 'newProductsDatalist');
                } else if (modalId === 'masterProductModal') document.getElementById('editMasterProductId').value = '';
                else if (modalId === 'toClearModal') {
                    document.getElementById('editToClearId').value = '';
                    filterProductsForBrand('', 'toClearProductName', 'toClearProductsDatalist');
                }
            }
        }
        window.onclick = function(event) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target == modal) closeModal(modal.id);
            });
        }

        function renderInventoryItems() {
            const tbody = document.getElementById('inventory-table'); if(!tbody) return; tbody.innerHTML = '';
            sortArray(currentInventoryViewData, sortState.inventory.column, sortState.inventory.direction).forEach(item => {
                const r = tbody.insertRow();
                r.insertCell().textContent = item.sku || ''; r.insertCell().textContent = item.brand || '';
                r.insertCell().textContent = item.product || ''; r.insertCell().textContent = item.quantity !== undefined ? item.quantity : '';
                const sCell = r.insertCell(); sCell.innerHTML = `<span class="status-badge ${item.status === 'OOS' ? 'oos' : 'low'}">${item.status || ''}</span>`;
                r.insertCell().textContent = item.shipment || ''; r.insertCell().textContent = item.remarks || '';
                r.insertCell().innerHTML = `<button class="btn-info" onclick="editProduct('${item.id}')">✏️ Edit</button><button class="btn-danger" onclick="moveToRecycleBin('${item.id}', 'inventory')">🗑️ Delete</button>`;
            });
        }
        function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('editProductId').value = '';
            document.getElementById('productModal').querySelector('form').reset();
            populateBrandDropdowns('brand'); populateStatusDropdowns('status');
            filterProductsForBrand('', 'productName', 'productsDatalist');
            openModal('productModal');
        }
        async function saveProduct(event) {
            event.preventDefault();
            const id = document.getElementById('editProductId').value;
            const brand = document.getElementById('brand').value, name = document.getElementById('productName').value;
            let sku = getSkuForProduct(brand, name) || (id ? inventoryData.find(i=>i.id===id)?.sku : '');
            if (!sku && !id) sku = `TEMP_SKU_${Date.now()}`; // Avoid if truly new and not in master
            const data = {
                brand, product: name, sku, quantity: parseInt(document.getElementById('inventoryQuantity').value),
                status: document.getElementById('status').value, shipment: document.getElementById('shipment').value,
                remarks: document.getElementById('remarks').value, isDeleted: false
            };
            try { await saveDataToFirestore(inventoryColRef, id, data); showNotification('Product saved!', 'success'); closeModal('productModal'); await updateLocalData(); } catch (e) {}
        }
        async function editProduct(id) {
            const item = inventoryData.find(p => p.id === id); if (!item) return;
            document.getElementById('productModalTitle').textContent = 'Edit Product';
            document.getElementById('editProductId').value = item.id;
            populateBrandDropdowns('brand'); document.getElementById('brand').value = item.brand;
            filterProductsForBrand(item.brand, 'productName', 'productsDatalist');
            document.getElementById('productName').value = item.product;
            document.getElementById('inventoryQuantity').value = item.quantity;
            populateStatusDropdowns('status'); document.getElementById('status').value = item.status;
            document.getElementById('shipment').value = item.shipment; document.getElementById('remarks').value = item.remarks;
            openModal('productModal');
        }
        function showFilteredInventory(statusFilter) {
            currentInventoryViewData = inventoryData.filter(i => !i.isDeleted && i.status && i.status.toLowerCase().includes(statusFilter.toLowerCase()));
            renderInventoryItems();
            const tab = document.querySelector('.tab[onclick*="oos-lowstock"]'); if (tab) switchTab(tab, 'oos-lowstock');
        }
        function searchInventory(term) {
            const l टर्म = term.toLowerCase().trim();
            let base = inventoryData.filter(i => !i.isDeleted && (i.status === 'OOS' || (i.status && i.status.toLowerCase().includes('low stock'))));
            currentInventoryViewData = lTerm ? base.filter(i => Object.values(i).some(v => String(v).toLowerCase().includes(lTerm))) : base;
            renderInventoryItems();
        }

        function renderNewProductsItems() {
            const tbody = document.getElementById('new-products-table'); if(!tbody) return; tbody.innerHTML = '';
            sortArray(currentNewProductsViewData, sortState.newProducts.column, sortState.newProducts.direction).forEach(item => {
                const r = tbody.insertRow();
                r.insertCell().textContent = item.sku || ''; r.insertCell().textContent = item.brand || '';
                r.insertCell().textContent = item.product || ''; r.insertCell().textContent = item.addedDate || '';
                r.insertCell().textContent = item.arrivalDate || ''; r.insertCell().textContent = item.quantity !== undefined ? item.quantity : '';
                r.insertCell().textContent = item.notes || '';
                r.insertCell().innerHTML = `<button class="btn-info" onclick="editNewProduct('${item.id}')">✏️ Edit</button><button class="btn-success" onclick="moveNewProductToMaster('${item.id}')">✅ Approve</button><button class="btn-danger" onclick="moveToRecycleBin('${item.id}', 'new_products')">🗑️ Delete</button>`;
            });
        }
        function showAddNewProductModal() {
            document.getElementById('newProductModalTitle').textContent = 'Add New Product Entry';
            document.getElementById('editNewProductId').value = '';
            document.getElementById('newProductModal').querySelector('form').reset();
            document.getElementById('arrivalDate').valueAsDate = new Date();
            populateBrandDropdowns('newBrand'); filterProductsForBrand('', 'newProductName', 'newProductsDatalist');
            openModal('newProductModal');
        }
        async function saveNewProduct(event) {
            event.preventDefault();
            const id = document.getElementById('editNewProductId').value;
            const sku = document.getElementById('newProductSku').value.trim();
            if (!sku) { showNotification('SKU is required.', 'error'); return; }
            if (!id && (newProductsData.some(p => p.sku === sku && !p.isDeleted) || masterProductsData.some(p => p.sku === sku && !p.isDeleted))) {
                showNotification('SKU already exists.', 'error'); return;
            }
            const data = {
                brand: document.getElementById('newBrand').value, sku, product: document.getElementById('newProductName').value,
                arrivalDate: document.getElementById('arrivalDate').value, quantity: parseInt(document.getElementById('newProductQuantity').value),
                notes: document.getElementById('notes').value, addedDate: id ? (newProductsData.find(i => i.id === id)?.addedDate || new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0],
                isDeleted: false
            };
            try { await saveDataToFirestore(newProductsColRef, id, data); showNotification('New product saved!', 'success'); closeModal('newProductModal'); await updateLocalData(); } catch (e) {}
        }
        async function editNewProduct(id) {
            const item = newProductsData.find(p => p.id === id); if (!item) return;
            document.getElementById('newProductModalTitle').textContent = 'Edit New Product Entry';
            document.getElementById('editNewProductId').value = item.id;
            populateBrandDropdowns('newBrand'); document.getElementById('newBrand').value = item.brand;
            filterProductsForBrand(item.brand, 'newProductName', 'newProductsDatalist');
            document.getElementById('newProductSku').value = item.sku || ''; document.getElementById('newProductName').value = item.product;
            document.getElementById('arrivalDate').value = item.arrivalDate; document.getElementById('newProductQuantity').value = item.quantity;
            document.getElementById('notes').value = item.notes; openModal('newProductModal');
        }
        async function moveNewProductToMaster(id) {
            showConfirmModal('Approve and move to Master List & Inventory?', async (confirmed) => {
                if (!confirmed) return;
                const item = newProductsData.find(p => p.id === id); if (!item) return;
                if (masterProductsData.some(mp => mp.sku === item.sku && !mp.isDeleted)) {
                    showNotification(`SKU ${item.sku} already in Master List.`, 'error'); return;
                }
                try {
                    await saveDataToFirestore(masterProductsColRef, null, { ...item, category: 'Uncategorized', price: 0, description: item.notes || '', isDeleted: false });
                    await saveDataToFirestore(inventoryColRef, null, { ...item, status: 'In stock', remarks: `From New Products ${new Date().toISOString().split('T')[0]}`, isDeleted: false });
                    await saveDataToFirestore(newProductsColRef, item.id, { isDeleted: true });
                    showNotification('Product approved and moved!', 'success'); await updateLocalData();
                } catch (e) { showNotification('Error moving product.', 'error'); }
            });
        }
        async function mergeNewProductsToMaster() {
            showConfirmModal('Merge ALL new products? SKUs in Master List will be skipped.', async (confirmed) => {
                if (!confirmed) return;
                const activeNew = newProductsData.filter(i => !i.isDeleted); if (activeNew.length === 0) { showNotification('No new products.', 'info'); return; }
                let success = 0, skipped = 0; const batch = db.batch();
                for (const item of activeNew) {
                    if (masterProductsData.some(mp => mp.sku === item.sku && !mp.isDeleted)) { skipped++; continue; }
                    batch.set(masterProductsColRef.doc(), { ...item, category: 'Uncategorized', price: 0, description: item.notes || '', isDeleted: false });
                    batch.set(inventoryColRef.doc(), { ...item, status: 'In stock', remarks: `Batch Merge ${new Date().toISOString().split('T')[0]}`, isDeleted: false });
                    batch.update(newProductsColRef.doc(item.id), { isDeleted: true }); success++;
                }
                if (success > 0 || skipped > 0) {
                    try { await batch.commit(); showNotification(`Merged: ${success}, Skipped: ${skipped}.`, 'success'); await updateLocalData(); }
                    catch (e) { showNotification('Error batch merging.', 'error'); }
                } else { showNotification('No products merged.', 'info'); }
            });
        }
        function searchNewProducts(term) {
            const lTerm = term.toLowerCase().trim();
            const base = newProductsData.filter(i => !i.isDeleted);
            currentNewProductsViewData = lTerm ? base.filter(i => Object.values(i).some(v => String(v).toLowerCase().includes(lTerm))) : base;
            renderNewProductsItems();
        }

        // ----- NEW Supply Status Logic for "To Clear" Tab -----
        function getNewSupplyStatus(item) {
            const totalQty = (Number(item.warehouseQty) || 0) + (Number(item.storeQty) || 0);
            const weeklyDemand = Number(item.weeklyDemand) || 0;

            if (!item.expiryDate) {
                return { text: "N/A", class: "info" }; // No expiry date
            }

            let expiryDateObj;
            try {
                // Attempt to parse YYYY-MM-DD. Adding T00:00:00 ensures it's treated as start of day in local timezone.
                expiryDateObj = new Date(item.expiryDate + "T00:00:00Z"); // Use UTC for consistency if dates are stored as such
                if (isNaN(expiryDateObj.getTime())) { // Check if date is valid
                     // Try parsing without 'Z' if first attempt fails for local dates.
                    expiryDateObj = new Date(item.expiryDate + "T00:00:00");
                     if (isNaN(expiryDateObj.getTime()))  throw new Error("Invalid date");
                }
            } catch (e) {
                console.warn("Invalid expiry date format for item:", item.sku , item.expiryDate, e);
                return { text: "N/A", class: "info" }; // Invalid expiry date format
            }

            const currentDate = new Date();
            currentDate.setUTCHours(0, 0, 0, 0); // Compare with UTC date midnight

            if (expiryDateObj <= currentDate) {
                return { text: "Expired", class: "danger-status" };
            }

            if (weeklyDemand <= 0) {
                return { text: "Danger", class: "danger-status" }; // Will expire without selling if demand is zero
            }

            const daysToSellOut = (totalQty / weeklyDemand) * 7;
            let projectedSellOutDate = new Date(currentDate);
            projectedSellOutDate.setUTCDate(currentDate.getUTCDate() + Math.ceil(daysToSellOut)); // Use UTCDate
            projectedSellOutDate.setUTCHours(0,0,0,0);


            let nineMonthsBeforeExpiry = new Date(expiryDateObj);
            nineMonthsBeforeExpiry.setUTCMonth(expiryDateObj.getUTCMonth() - 9);
            nineMonthsBeforeExpiry.setUTCHours(0,0,0,0);

            let sixMonthsBeforeExpiry = new Date(expiryDateObj);
            sixMonthsBeforeExpiry.setUTCMonth(expiryDateObj.getUTCMonth() - 6);
            sixMonthsBeforeExpiry.setUTCHours(0,0,0,0);

            if (projectedSellOutDate <= nineMonthsBeforeExpiry) {
                return { text: "Normal", class: "normal" };
            } else if (projectedSellOutDate <= sixMonthsBeforeExpiry) {
                return { text: "Alert", class: "alert-status" };
            } else {
                return { text: "Danger", class: "danger-status" };
            }
        }


        function renderToClearItems() {
            const tableBody = document.getElementById('to-clear-table');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            const sortedData = sortArray(currentToClearViewData, sortState.toClear.column, sortState.toClear.direction);

            sortedData.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.sku || '';
                row.insertCell().textContent = item.brand || '';
                row.insertCell().textContent = item.product || '';
                row.insertCell().textContent = item.category || '';
                row.insertCell().textContent = item.expiryDate || '';
                row.insertCell().textContent = item.firstHighlightedDate || '';
                row.insertCell().textContent = item.firstReportedBalance !== undefined ? item.firstReportedBalance : '';
                row.insertCell().textContent = item.warehouseQty !== undefined ? item.warehouseQty : '';
                row.insertCell().textContent = item.storeQty !== undefined ? item.storeQty : '';
                
                const totalQty = (Number(item.warehouseQty) || 0) + (Number(item.storeQty) || 0);
                row.insertCell().textContent = totalQty;
                
                const weeklyDemandNum = Number(item.weeklyDemand) || 0;
                row.insertCell().textContent = item.weeklyDemand !== undefined ? item.weeklyDemand : '';
                
                const weeksSupplyText = weeklyDemandNum > 0 ? (totalQty / weeklyDemandNum).toFixed(2) : 'N/A';
                row.insertCell().textContent = weeksSupplyText;
                
                // Use new supply status logic
                const newStatus = getNewSupplyStatus(item);
                row.insertCell().innerHTML = `<span class="status-badge ${newStatus.class}">${newStatus.text}</span>`;
                
                row.insertCell().textContent = item.actionPlan || '';

                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn-info" onclick="editToClear('${item.id}')">✏️ Edit</button>
                    <button class="btn-danger" onclick="moveToRecycleBin('${item.id}', 'to_clear')">🗑️ Delete</button>
                `;
            });
        }
        function showAddToClearModal() {
            document.getElementById('toClearModalTitle').textContent = 'Add Product to Clear';
            document.getElementById('editToClearId').value = '';
            const form = document.getElementById('toClearModal').querySelector('form'); if (form) form.reset();
            document.getElementById('toClearFirstHighlightedDate').valueAsDate = new Date();
            populateBrandDropdowns('toClearBrand'); populateCategoryDropdowns('toClearCategory');
            filterProductsForBrand('', 'toClearProductName', 'toClearProductsDatalist');
            openModal('toClearModal');
        }
        async function saveToClear(event) {
            event.preventDefault();
            const id = document.getElementById('editToClearId').value;
            const brand = document.getElementById('toClearBrand').value, name = document.getElementById('toClearProductName').value;
            const sku = getSkuForProduct(brand, name);
            if (!sku) { showNotification('Product not found in Master List.', 'error'); return; }
            const data = {
                brand, product: name, sku, category: document.getElementById('toClearCategory').value,
                expiryDate: document.getElementById('toClearExpiryDate').value,
                firstHighlightedDate: document.getElementById('toClearFirstHighlightedDate').value,
                firstReportedBalance: parseInt(document.getElementById('toClearFirstReportedBalance').value || '0'),
                warehouseQty: parseInt(document.getElementById('toClearWarehouseQty').value || '0'),
                storeQty: parseInt(document.getElementById('toClearStoreQty').value || '0'),
                weeklyDemand: parseInt(document.getElementById('toClearWeeklyDemand').value || '0'),
                actionPlan: document.getElementById('toClearActionPlan').value, isDeleted: false
            };
            try { await saveDataToFirestore(toClearColRef, id, data); showNotification('Product to clear saved!', 'success'); closeModal('toClearModal'); await updateLocalData(); } catch (e) {}
        }
        async function editToClear(id) {
            const item = toClearData.find(p => p.id === id); if (!item) return;
            document.getElementById('toClearModalTitle').textContent = 'Edit Product to Clear';
            document.getElementById('editToClearId').value = item.id;
            populateBrandDropdowns('toClearBrand'); document.getElementById('toClearBrand').value = item.brand;
            filterProductsForBrand(item.brand, 'toClearProductName', 'toClearProductsDatalist');
            document.getElementById('toClearProductName').value = item.product;
            populateCategoryDropdowns('toClearCategory'); document.getElementById('toClearCategory').value = item.category;
            document.getElementById('toClearExpiryDate').value = item.expiryDate;
            document.getElementById('toClearFirstHighlightedDate').value = item.firstHighlightedDate;
            document.getElementById('toClearFirstReportedBalance').value = item.firstReportedBalance;
            document.getElementById('toClearWarehouseQty').value = item.warehouseQty;
            document.getElementById('toClearStoreQty').value = item.storeQty;
            document.getElementById('toClearWeeklyDemand').value = item.weeklyDemand;
            document.getElementById('toClearActionPlan').value = item.actionPlan;
            openModal('toClearModal');
        }
        function searchToClear(term) {
            const lTerm = term.toLowerCase().trim();
            const base = toClearData.filter(i => !i.isDeleted);
            currentToClearViewData = lTerm ? base.filter(i => Object.values(i).some(v => String(v).toLowerCase().includes(lTerm))) : base;
            renderToClearItems();
        }
        function getSkuForProduct(brand, product) {
            const item = masterProductsData.find(i => !i.isDeleted && i.brand === brand && i.product === product);
            return item ? item.sku : '';
        }
        // Old getSupplyStatusClass and getSupplyStatusText are no longer used for 'To Clear' tab.
        // They can be removed or kept if used elsewhere (not apparent from current code for this tab).
        // function getSupplyStatusClass(weeksSupply) { ... }
        // function getSupplyStatusText(weeksSupply) { ... }


        function renderMasterListItems() {
            const tbody = document.getElementById('master-table'); if(!tbody) return; tbody.innerHTML = '';
            sortArray(currentMasterListViewData, sortState.master.column, sortState.master.direction).forEach(item => {
                const r = tbody.insertRow();
                r.insertCell().textContent = item.sku || ''; r.insertCell().textContent = item.brand || '';
                r.insertCell().textContent = item.product || ''; r.insertCell().textContent = item.category || '';
                r.insertCell().textContent = item.description || '';
                r.insertCell().textContent = item.price !== undefined ? parseFloat(item.price).toFixed(2) : '';
                r.insertCell().innerHTML = `<button class="btn-info" onclick="editMasterProduct('${item.id}')">✏️ Edit</button><button class="btn-danger" onclick="moveToRecycleBin('${item.id}', 'master_products')">🗑️ Delete</button>`;
            });
        }
        function showAddMasterProductModal() {
            document.getElementById('masterProductModalTitle').textContent = 'Add Master Product';
            document.getElementById('editMasterProductId').value = '';
            document.getElementById('masterProductModal').querySelector('form').reset();
            populateBrandDropdowns('masterBrand'); populateCategoryDropdowns('category');
            openModal('masterProductModal');
        }
        async function saveMasterProduct(event) {
            event.preventDefault();
            const id = document.getElementById('editMasterProductId').value;
            const sku = document.getElementById('sku').value.trim(), name = document.getElementById('masterProductName').value.trim(), brand = document.getElementById('masterBrand').value;
            if (!sku || !name || !brand) { showNotification('SKU, Name, and Brand are required.', 'error'); return; }
            if (masterProductsData.some(p => p.sku === sku && p.id !== id && !p.isDeleted)) { showNotification('SKU already exists.', 'error'); return; }
            if (masterProductsData.some(p => p.brand === brand && p.product === name && p.id !== id && !p.isDeleted)) { showNotification('Brand + Product Name combo exists.', 'error'); return; }
            const data = {
                brand, product: name, sku, category: document.getElementById('category').value,
                description: document.getElementById('description').value, price: parseFloat(document.getElementById('price').value || '0'),
                isDeleted: false
            };
            try { await saveDataToFirestore(masterProductsColRef, id, data); showNotification('Master product saved!', 'success'); closeModal('masterProductModal'); await updateLocalData(); } catch (e) {}
        }
        async function editMasterProduct(id) {
            const item = masterProductsData.find(p => p.id === id); if (!item) return;
            document.getElementById('masterProductModalTitle').textContent = 'Edit Master Product';
            document.getElementById('editMasterProductId').value = item.id;
            populateBrandDropdowns('masterBrand'); document.getElementById('masterBrand').value = item.brand;
            document.getElementById('masterProductName').value = item.product;
            populateCategoryDropdowns('category'); document.getElementById('category').value = item.category;
            document.getElementById('description').value = item.description; document.getElementById('sku').value = item.sku;
            document.getElementById('price').value = item.price; openModal('masterProductModal');
        }
        function searchMasterList(term) {
            const lTerm = term.toLowerCase().trim();
            const base = masterProductsData.filter(i => !i.isDeleted);
            currentMasterListViewData = lTerm ? base.filter(i => Object.values(i).some(v => String(v).toLowerCase().includes(lTerm))) : base;
            renderMasterListItems();
        }
        function exportMasterList() {
            const headers = ["Product Code", "Brand", "Product Name", "Category", "Description", "Price"];
            const rows = masterProductsData.filter(i => !i.isDeleted).map(i => [i.sku||'',i.brand||'',i.product||'',i.category||'',i.description||'',i.price !== undefined ? parseFloat(i.price).toFixed(2) : '']);
            let csv = headers.join(',') + '\n' + rows.map(r => r.map(f => `"${String(f).replace(/"/g, '""')}"`).join(',')).join('\n');
            downloadCSV(csv, 'master_list.csv'); showNotification('Master list exported!', 'success');
        }

        function renderRecycleBinItems() {
            const tbody = document.getElementById('recycle-bin-table'); if(!tbody) return; tbody.innerHTML = '';
            sortArray(currentRecycleBinViewData, sortState.recycleBin.column, sortState.recycleBin.direction).forEach(item => {
                const r = tbody.insertRow();
                r.insertCell().textContent = item.sku || ''; r.insertCell().textContent = item.originalCollection || '';
                r.insertCell().textContent = item.brand || ''; r.insertCell().textContent = item.product || '';
                r.insertCell().innerHTML = `<button class="btn-success" onclick="restoreItem('${item.id}', '${item.originalCollection}')">↩️ Restore</button><button class="btn-danger" onclick="deleteItemPermanently('${item.id}', '${item.originalCollection}')">❌ Permanent Delete</button>`;
            });
        }
        async function moveToRecycleBin(id, collName) {
            showConfirmModal('Move to Recycle Bin?', async (confirmed) => {
                if (!confirmed) return;
                try { await saveDataToFirestore(db.collection(collName), id, { isDeleted: true }); showNotification('Moved to Recycle Bin!', 'success'); await updateLocalData(); }
                catch (e) { showNotification('Error moving item.', 'error'); }
            });
        }
        async function restoreItem(id, collName) {
            showConfirmModal('Restore this item?', async (confirmed) => {
                if (!confirmed) return;
                const itemToRestore = deletedItemsData.find(i => i.id === id && i.originalCollection === collName); if (!itemToRestore) { showNotification('Item not found.', 'error'); return; }
                // SKU conflict check for master_products & new_products before restoring
                if ((collName === 'master_products' && masterProductsData.some(p => p.sku === itemToRestore.sku && !p.isDeleted && p.id !== id)) ||
                    (collName === 'new_products' && newProductsData.some(p => p.sku === itemToRestore.sku && !p.isDeleted && p.id !== id))) {
                     showNotification(`Cannot restore: SKU ${itemToRestore.sku} already active in ${collName}.`, 'error'); return;
                }
                try { await saveDataToFirestore(db.collection(collName), id, { isDeleted: false }); showNotification('Item restored!', 'success'); await updateLocalData(); }
                catch (e) { showNotification('Error restoring item.', 'error'); }
            });
        }
        async function deleteItemPermanently(id, collName) {
            showConfirmModal('PERMANENTLY DELETE this item?', async (confirmed) => {
                if (!confirmed) return;
                try { await db.collection(collName).doc(id).delete(); showNotification('Item permanently deleted!', 'success'); await updateLocalData(); }
                catch (e) { showNotification('Error deleting item.', 'error'); }
            });
        }
        async function emptyRecycleBin() {
            showConfirmModal('PERMANENTLY DELETE ALL items in Recycle Bin?', async (confirmed) => {
                if (!confirmed) return; if (deletedItemsData.length === 0) { showNotification('Recycle Bin empty.', 'info'); return; }
                const batch = db.batch(); let count = 0;
                deletedItemsData.forEach(item => { batch.delete(db.collection(item.originalCollection).doc(item.id)); count++; });
                if (count > 0) {
                    try { await batch.commit(); showNotification(`Deleted ${count} items.`, 'success'); await updateLocalData(); }
                    catch (e) { showNotification('Error emptying recycle bin.', 'error'); }
                }
            });
        }
        function searchRecycleBin(term) {
            const lTerm = term.toLowerCase().trim();
            currentRecycleBinViewData = lTerm ? deletedItemsData.filter(i => Object.values(i).some(v => String(v).toLowerCase().includes(lTerm))) : [...deletedItemsData];
            renderRecycleBinItems();
        }

        function showAddBrandModal() { document.getElementById('addBrandModal').querySelector('form').reset(); openModal('addBrandModal'); }
        function showAddStatusModal() { document.getElementById('addStatusModal').querySelector('form').reset(); openModal('addStatusModal'); }
        function showAddCategoryModal() { document.getElementById('addCategoryModal').querySelector('form').reset(); openModal('addCategoryModal'); }

        async function saveNewBrand(event) {
            event.preventDefault(); const name = document.getElementById('newBrandName').value.trim();
            if (!name) { showNotification('Brand name empty.', 'error'); return; }
            if (brandsData.some(b => b.name.toLowerCase() === name.toLowerCase())) { showNotification('Brand exists.', 'error'); return; }
            try { await saveDataToFirestore(brandsColRef, null, { name, isDeleted: false }); showNotification('Brand added!', 'success'); closeModal('addBrandModal'); await updateLocalData(); } catch (e) {}
        }
        async function saveNewStatus(event) {
            event.preventDefault(); const name = document.getElementById('newStatusName').value.trim();
            if (!name) { showNotification('Status name empty.', 'error'); return; }
            if (statusesData.some(s => s.name.toLowerCase() === name.toLowerCase())) { showNotification('Status exists.', 'error'); return; }
            try { await saveDataToFirestore(statusesColRef, null, { name, isDeleted: false }); showNotification('Status added!', 'success'); closeModal('addStatusModal'); await updateLocalData(); } catch (e) {}
        }
        async function saveNewCategory(event) {
            event.preventDefault(); const name = document.getElementById('newCategoryName').value.trim();
            if (!name) { showNotification('Category name empty.', 'error'); return; }
            if (categoriesData.some(c => c.name.toLowerCase() === name.toLowerCase())) { showNotification('Category exists.', 'error'); return; }
            try { await saveDataToFirestore(categoriesColRef, null, { name, isDeleted: false }); showNotification('Category added!', 'success'); closeModal('addCategoryModal'); await updateLocalData(); } catch (e) {}
        }

        async function exportAllData() {
            if (typeof JSZip === 'undefined') { showNotification('JSZip not loaded.', 'error'); return; }
            const collections = {
                inventory: inventoryData.filter(i => !i.isDeleted), new_products: newProductsData.filter(i => !i.isDeleted),
                to_clear: toClearData.filter(i => !i.isDeleted), master_products: masterProductsData.filter(i => !i.isDeleted),
                brands: brandsData, statuses: statusesData, categories: categoriesData, deleted_items: deletedItemsData
            };
            let zip = new JSZip();
            for (const name in collections) {
                const data = collections[name].map(item => { const { id, isDeleted, ...rest } = item; return rest; });
                if (data.length === 0) continue;
                const headers = Object.keys(data[0]);
                let csv = headers.map(h => `"${String(h).replace(/"/g, '""')}"`).join(',') + '\n';
                csv += data.map(row => headers.map(h => `"${String(row[h] !== undefined ? row[h] : '').replace(/"/g, '""')}"`).join(',')).join('\n');
                zip.file(`${name}.csv`, csv);
            }
            try { const content = await zip.generateAsync({ type: "blob" }); downloadCSV(content, 'all_inventory_data.zip', true); showNotification('All data exported!', 'success'); }
            catch (e) { showNotification('Error exporting data.', 'error'); }
        }
        async function loadSampleData() {
            showNotification('Loading sample data...', 'info');
            const sBrands = [{ name: 'BrandX',isD:0 },{ name: 'BrandY',isD:0 },{ name: 'BrandZ',isD:0 },{ name: 'BrandA',isD:0 },{ name: 'BrandB',isD:0 },{ name: 'BrandC',isD:0 }].map(b=>({...b,isDeleted:!!b.isD}));
            const sStatuses = [{ name: 'OOS',isD:0 },{ name: 'Low stock',isD:0 },{ name: 'In stock',isD:0 }].map(s=>({...s,isDeleted:!!s.isD}));
            const sCats = [{ name: 'Electronics',isD:0 },{ name: 'Accessories',isD:0 },{ name: 'Smart Home',isD:0 },{ name: 'Office Furniture',isD:0 }].map(c=>({...c,isDeleted:!!c.isD}));
            const sMaster = [
                { brand: 'BrandX', product: 'Laptop Pro', sku: 'LX1001', cat: 'Electronics', desc: 'High performance', price: 1200,isD:0 },
                { brand: 'BrandY', product: 'Wireless Mouse', sku: 'WM2002', cat: 'Accessories', desc: 'Ergonomic', price: 25,isD:0 },
                { brand: 'BrandZ', product: 'Smart Speaker', sku: 'SS4004', cat: 'Smart Home', desc: 'Voice activated', price: 99,isD:0 }
            ].map(p=>({category:p.cat,description:p.desc,isDeleted:!!p.isD,...p}));
            const sInv = [
                { brand: 'BrandX', product: 'Laptop Pro', sku: 'LX1001', qty: 5, status: 'Low stock',isD:0 },
                { brand: 'BrandY', product: 'Wireless Mouse', sku: 'WM2002', qty: 0, status: 'OOS',isD:0 }
            ].map(i=>({quantity:i.qty,isDeleted:!!i.isD,...i}));
            const sNewP = [{ brand: 'BrandZ', product: 'Smart Speaker', sku: 'SS4004', arrival: '2025-07-15', qty: 50, notes: 'New model', added: '2025-06-01',isD:0 }].map(p=>({arrivalDate:p.arrival,quantity:p.qty,addedDate:p.added,isDeleted:!!p.isD,...p}));
            const sClear = [{ brand: 'BrandB', product: 'Old Monitor', sku: 'OSM6006', cat:'Electronics', expiry: '2025-08-31', firstH: '2025-06-01', firstRB: 20, whQty:10, sQty:5, wkDmd:3, plan:'Promo',isD:0 }].map(p=>({category:p.cat,expiryDate:p.expiry,firstHighlightedDate:p.firstH,firstReportedBalance:p.firstRB,warehouseQty:p.whQty,storeQty:p.sQty,weeklyDemand:p.wkDmd,actionPlan:p.plan,isDeleted:!!p.isD,...p}));
            const colls = [
                {r:brandsColRef,d:sBrands},{r:statusesColRef,d:sStatuses},{r:categoriesColRef,d:sCats},
                {r:masterProductsColRef,d:sMaster},{r:inventoryColRef,d:sInv},
                {r:newProductsColRef,d:sNewP},{r:toClearColRef,d:sClear}
            ];
            try {
                for (const {r} of colls) { const snap = await r.get(); const b = db.batch(); snap.docs.forEach(d=>b.delete(d.ref)); if(snap.docs.length>0) await b.commit(); }
                const b = db.batch(); colls.forEach(({r,d}) => d.forEach(i => b.set(r.doc(), i))); await b.commit();
                showNotification('Sample data loaded!', 'success'); await updateLocalData();
            } catch (e) { console.error("Error loading sample data:", e); showNotification('Error loading samples.', 'error');}
        }
        function confirmLoadSampleData() { showConfirmModal('DELETE ALL data and load samples?', async c => { if(c) await loadSampleData(); }); }

        function sortTable(key, col) {
            const s = sortState[key];
            s.direction = (s.column === col && s.direction === 'asc') ? 'desc' : 'asc';
            s.column = col; updateSortIndicators(key);
            const renderMap = { inventory: renderInventoryItems, newProducts: renderNewProductsItems, master: renderMasterListItems, toClear: renderToClearItems, recycleBin: renderRecycleBinItems };
            if (renderMap[key]) renderMap[key]();
        }
        function sortArray(arr, col, dir) {
            if (!col || !arr) return arr || [];
            return [...arr].sort((a,b) => {
                let vA = a[col], vB = b[col];
                if (sortState.toClear.column === 'totalQty' && col === 'totalQty') { vA = (Number(a.warehouseQty)||0)+(Number(a.storeQty)||0); vB = (Number(b.warehouseQty)||0)+(Number(b.storeQty)||0); }
                else if (sortState.toClear.column === 'weeksSupply' && col === 'weeksSupply') { const tA=(Number(a.warehouseQty)||0)+(Number(a.storeQty)||0), tB=(Number(b.warehouseQty)||0)+(Number(b.storeQty)||0); vA=(Number(a.weeklyDemand)||0)>0?tA/Number(a.weeklyDemand):(dir==='asc'?Infinity:-Infinity); vB=(Number(b.weeklyDemand)||0)>0?tB/Number(b.weeklyDemand):(dir==='asc'?Infinity:-Infinity); }
                const aU=(vA===undefined||vA===null||vA==='N/A'||(typeof vA==='number'&&isNaN(vA))), bU=(vB===undefined||vB===null||vB==='N/A'||(typeof vB==='number'&&isNaN(vB)));
                if(aU&&bU)return 0; if(aU)return dir==='asc'?1:-1; if(bU)return dir==='asc'?-1:1;
                if(typeof vA==='string'&&typeof vB==='string'){ if(/^\d{4}-\d{2}-\d{2}$/.test(vA)&&/^\d{4}-\d{2}-\d{2}$/.test(vB)) return dir==='asc'?vA.localeCompare(vB):vB.localeCompare(vA); const nA=parseFloat(vA),nB=parseFloat(vB); if(!isNaN(nA)&&!isNaN(nB)&&String(nA)===vA&&String(nB)===vB) return dir==='asc'?nA-nB:nB-nA; return dir==='asc'?vA.localeCompare(vB):vB.localeCompare(vA); }
                if(typeof vA==='number'&&typeof vB==='number') return dir==='asc'?vA-vB:vB-vA;
                return dir==='asc'?String(vA).localeCompare(String(vB)):String(vB).localeCompare(String(vA));
            });
        }
        function updateSortIndicators(key) {
            const cont = document.getElementById(`${key}-table-container`);
            let headers;
            if (cont) headers = cont.querySelectorAll('thead th[data-column-key]');
            else { const t = document.getElementById(`${key}-table`) || document.querySelector(`#${key} table`); if(t) headers = t.querySelectorAll('thead th[data-column-key]'); else return; }
            headers.forEach(h => { const s=h.querySelector('.sort-arrow'); if(s)s.textContent=''; if(h.dataset.columnKey===sortState[key].column&&s)s.textContent=sortState[key].direction==='asc'?' ▲':' ▼'; });
        }

        function updateDashboardStats() {
            document.getElementById('oos-count').textContent = inventoryData.filter(i=>!i.isDeleted&&i.status==='OOS').length;
            document.getElementById('low-count').textContent = inventoryData.filter(i=>!i.isDeleted&&i.status&&i.status.toLowerCase().includes('low stock')).length;
            document.getElementById('new-count').textContent = newProductsData.filter(i=>!i.isDeleted).length;
        }
        function updateAlerts() {
            const div = document.getElementById('alerts'); div.innerHTML=''; let content='';
            const oos = inventoryData.filter(i=>!i.isDeleted&&i.status==='OOS').slice(0,5);
            const low = inventoryData.filter(i=>!i.isDeleted&&i.status&&i.status.toLowerCase().includes('low stock')).slice(0,5);
            const today=new Date(); today.setUTCHours(0,0,0,0); const ninety=new Date(today); ninety.setUTCDate(today.getUTCDate()+90);
            const expiring = toClearData.filter(i=>{ if(!i.isDeleted&&i.expiryDate){ try{const ed=new Date(i.expiryDate+"T00:00:00Z"); if(isNaN(ed.getTime())) return false; return ed>=today&&ed<=ninety;}catch(e){return false;}} return false; }).sort((a,b)=>new Date(a.expiryDate+"T00:00:00Z")-new Date(b.expiryDate+"T00:00:00Z")).slice(0,5);
            if(oos.length>0) content+=`<h4>Out of Stock:</h4><ul>${oos.map(i=>`<li><span class="status-badge oos">OOS</span> ${i.product||'N/A'} (${i.brand||'N/A'})</li>`).join('')}</ul>`;
            if(low.length>0) content+=`<h4>Low Stock:</h4><ul>${low.map(i=>`<li><span class="status-badge low">Low</span> ${i.product||'N/A'} (${i.brand||'N/A'}) - Qty: ${i.quantity}</li>`).join('')}</ul>`;
            if(expiring.length>0) content+=`<h4>Expiring Soon (90d):</h4><ul>${expiring.map(i=>`<li><span class="status-badge alert-status">Expiring</span> ${i.product||'N/A'} (${i.brand||'N/A'}) - Exp: ${i.expiryDate}</li>`).join('')}</ul>`;
            div.innerHTML = content || '<p>No immediate alerts.</p>';
        }
        function updateManagementStats() {
            document.getElementById('total-products').textContent = masterProductsData.filter(i=>!i.isDeleted).length;
            document.getElementById('total-products-all').textContent = new Set(masterProductsData.filter(i=>!i.isDeleted&&i.sku).map(i=>i.sku)).size;
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        }

        function downloadCSV(content, fileName, isBlob = false) {
            const blob = isBlob ? content : new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url); link.setAttribute('download', fileName);
                link.style.visibility = 'hidden'; document.body.appendChild(link);
                link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
            } else showNotification('Download not supported.', 'error');
        }
        async function importCSV(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result, lines = text.split(/\r\n|\n/).filter(l=>l.trim()!=='');
                if (lines.length < 2) { showNotification('CSV empty/invalid.', 'error'); event.target.value=''; return; }
                const headers = lines[0].split(',').map(h=>h.trim().replace(/"/g,'').toLowerCase());
                const reqH = ['product code','brand','product name']; if (reqH.some(rh=>!headers.includes(rh))) { showNotification(`CSV missing: ${reqH.filter(rh=>!headers.includes(rh)).join(',')}.`, 'error'); event.target.value=''; return; }
                const hMap = {'product code':'sku','brand':'brand','product name':'product','category':'category','description':'description','price':'price'};
                let data = [], skusInCSV = new Set();
                for (let i=1; i<lines.length; i++) {
                    const vals = lines[i].split(',').map(v=>v.trim().replace(/"/g,''));
                    if(vals.length !== headers.length) { console.warn(`Row ${i+1} mismatch.`); continue; }
                    let item = {isDeleted:false}, valid=true, sku='';
                    headers.forEach((h,idx)=>{ const fN=hMap[h.toLowerCase()]; if(fN){ let v=vals[idx]; if(fN==='price')item[fN]=parseFloat(v)||0; else if(fN==='sku'){sku=v.trim(); if(!sku)valid=false; else item[fN]=sku;} else item[fN]=v;}});
                    if(!item.brand||!item.product)valid=false;
                    if(valid&&sku){ if(skusInCSV.has(sku)){console.warn(`CSV duplicate SKU ${sku}`);valid=false;} else {skusInCSV.add(sku);data.push(item);}}
                }
                if(data.length===0){showNotification('No valid data in CSV.', 'error');event.target.value='';return;}
                showConfirmModal(`Import ${data.length} items (add/update Master List)?`, async c => {
                    if(c){let nC=0,uC=0;const b=db.batch();data.forEach(i=>{const ex=masterProductsData.find(mp=>mp.sku===i.sku&&!mp.isDeleted);if(ex){b.set(masterProductsColRef.doc(ex.id),i,{merge:true});uC++;}else{b.set(masterProductsColRef.doc(),i);nC++;}});
                        if(nC>0||uC>0){try{await b.commit();showNotification(`Imported: ${nC} new, ${uC} updated.`, 'success');await updateLocalData();}catch(er){showNotification('CSV import commit error.', 'error');}}else showNotification('No items imported.', 'info');}
                    event.target.value='';
                });
            };
            reader.onerror = () => { showNotification('Error reading CSV.', 'error'); event.target.value=''; };
            reader.readAsText(file);
        }

        window.onload = async function() {
            if (typeof JSZip === 'undefined') {
                console.log("JSZip not found, attempting to load...");
                const script = document.createElement('script');
                script.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js";
                script.onload = async () => { console.log("JSZip loaded."); await initializeApp(); };
                script.onerror = () => { console.error("Failed to load JSZip."); initializeApp(); };
                document.head.appendChild(script);
            } else { await initializeApp(); }
        };
        async function initializeApp() {
            await updateLocalData();
            const dashTab = document.querySelector('.tab[onclick*="dashboard"]'), dashCont = document.getElementById('dashboard');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (dashTab && dashCont) { dashTab.classList.add('active'); dashCont.classList.add('active'); }
            else { const fT=document.querySelector('.tab'),fC=document.querySelector('.tab-content'); if(fT)fT.classList.add('active'); if(fC)fC.classList.add('active');}
            Object.keys(sortState).forEach(key => updateSortIndicators(key));
        }
    </script>
</body>
</html>
