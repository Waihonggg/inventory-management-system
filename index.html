<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-radius: 15px;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab-button {
            background-color: #f4f4f4;
            border: none;
            padding: 12px 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s, color 0.3s;
            border-radius: 8px 8px 0 0;
            margin: 0 5px;
            color: #555;
        }

        .tab-button.active {
            background-color: #667eea;
            color: white;
            border-bottom: 3px solid #764ba2;
        }

        .tab-content {
            display: none;
            padding: 20px 0;
        }

        .tab-content.active {
            display: block;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        form {
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }

        form label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        form input[type="text"],
        form input[type="date"],
        form select {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        form button {
            background-color: #667eea;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s ease;
        }

        form button:hover {
            background-color: #5a6ae3;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-radius: 10px;
            background-color: #fff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        table th,
        table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 0.95rem;
            color: #333;
        }

        table th {
            background-color: #f2f2f2;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .action-buttons button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
            transition: background-color 0.2s;
        }

        .action-buttons button.delete {
            background-color: #dc3545;
        }

        .action-buttons button:hover {
            opacity: 0.9;
        }

        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 15% from the top and centered */
            padding: 30px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #4a4a4a;
            font-size: 1.4rem;
            margin-bottom: 10px;
        }

        .card p {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .recent-alerts {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-top: 30px;
        }

        .recent-alerts h3 {
            color: #dc3545;
            font-size: 1.5rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .recent-alerts p {
            font-size: 1rem;
            color: #555;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .recent-alerts .no-alerts {
            color: #28a745;
            text-align: center;
            font-weight: bold;
        }

        .table-actions {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .table-actions button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background-color 0.2s;
        }

        .table-actions button:hover {
            background-color: #0056b3;
        }

        .table-actions input[type="file"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-error {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        .alert.show {
            opacity: 1;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1>Inventory Management Dashboard</h1>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab-button" onclick="switchTab('inventory')">Inventory</button>
            <button class="tab-button" onclick="switchTab('newProducts')">New Products</button>
            <button class="tab-button" onclick="switchTab('toClear')">To Clear</button>
            <button class="tab-button" onclick="switchTab('masterProductList')">Master Product List</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <h2>Dashboard Overview</h2>
            <div class="dashboard-grid">
                <div class="card">
                    <h3>Total Products</h3>
                    <p id="totalProductsCount">0</p>
                </div>
                <div class="card">
                    <h3>Low Stock</h3>
                    <p id="lowStockCount">0</p>
                </div>
                <div class="card">
                    <h3>Out of Stock</h3>
                    <p id="oosCount">0</p>
                </div>
                <div class="card">
                    <h3>Expiring Soon</h3>
                    <p id="expiringSoonCount">0</p>
                </div>
            </div>
            <div class="recent-alerts">
                <h3>Recent Alerts</h3>
                <div id="alertsContainer">
                    </div>
            </div>
        </div>

        <div id="inventory" class="tab-content">
            <h2>Manage Inventory</h2>
            <form id="productForm">
                <input type="hidden" id="editProductId">
                <label for="brand">Brand:</label>
                <input type="text" id="brand" required>

                <label for="productName">Product Name:</label>
                <input type="text" id="productName" required>

                <label for="status">Status:</label>
                <select id="status" required>
                    <option value="">Select Status</option>
                    <option value="In Stock">In Stock</option>
                    <option value="Low stock">Low stock</option>
                    <option value="OOS">OOS</option>
                </select>

                <label for="expiry">Expiry Date:</label>
                <input type="date" id="expiry">

                <label for="shipment">Shipment:</label>
                <input type="text" id="shipment">

                <label for="remarks">Remarks:</label>
                <input type="text" id="remarks">

                <button type="submit">Save Product</button>
            </form>

            <div class="table-actions">
                <button onclick="exportTableToCSV('inventoryTable')">Export CSV</button>
                <input type="file" id="importInventoryCSV" accept=".csv" onchange="importCSVToTable(event, 'inventory')">
            </div>

            <div class="table-container">
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Brand</th>
                            <th>Product Name</th>
                            <th>Status</th>
                            <th>Expiry Date</th>
                            <th>Shipment</th>
                            <th>Remarks</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="newProducts" class="tab-content">
            <h2>New Products</h2>
            <form id="newProductForm">
                <label for="newBrand">Brand:</label>
                <input type="text" id="newBrand" required>

                <label for="newProductName">Product Name:</label>
                <input type="text" id="newProductName" required>

                <label for="newStatus">Status:</label>
                <select id="newStatus" required>
                    <option value="">Select Status</option>
                    <option value="In Stock">In Stock</option>
                    <option value="Low stock">Low stock</option>
                    <option value="OOS">OOS</option>
                </select>

                <label for="newExpiry">Expiry Date:</label>
                <input type="date" id="newExpiry">

                <label for="newShipment">Shipment:</label>
                <input type="text" id="newShipment">

                <label for="newRemarks">Remarks:</label>
                <input type="text" id="newRemarks">

                <button type="submit">Add New Product</button>
            </form>
            <div class="table-actions">
                <button onclick="mergeNewProductsToMaster()">Merge All to Master Inventory</button> <button onclick="exportTableToCSV('newProductsTable')">Export CSV</button>
                <input type="file" id="importNewProductsCSV" accept=".csv" onchange="importCSVToTable(event, 'newProducts')">
            </div>
            <div class="table-container">
                <table id="newProductsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Brand</th>
                            <th>Product Name</th>
                            <th>Status</th>
                            <th>Expiry Date</th>
                            <th>Shipment</th>
                            <th>Remarks</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="newProductsTableBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="toClear" class="tab-content">
            <h2>To Clear Products</h2>
            <form id="toClearForm">
                <input type="hidden" id="toClearEditId">
                <label for="toClearBrand">Brand:</label>
                <input type="text" id="toClearBrand" required>

                <label for="toClearProduct">Product Name:</label>
                <input type="text" id="toClearProduct" required>

                <label for="toClearCategory">Category:</label>
                <select id="toClearCategory" required>
                    <option value="">Select Category</option>
                    <option value="Promotional">Promotional</option>
                    <option value="Damaged">Damaged</option>
                    <option value="Short Expiry">Short Expiry</option>
                    <option value="Discontinued">Discontinued</option>
                </select>

                <label for="toClearExpiryDate">Expiry Date:</label>
                <input type="date" id="toClearExpiryDate">

                <label for="toClearQuantity">Quantity:</label>
                <input type="text" id="toClearQuantity">

                <label for="toClearReason">Reason:</label>
                <input type="text" id="toClearReason">

                <button type="submit">Save To Clear Item</button>
            </form>

            <div class="table-actions">
                <button onclick="exportTableToCSV('toClearTable')">Export CSV</button>
                <input type="file" id="importToClearCSV" accept=".csv" onchange="importCSVToTable(event, 'toClear')">
            </div>

            <div class="table-container">
                <table id="toClearTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Brand</th>
                            <th>Product Name</th>
                            <th>Category</th>
                            <th>Expiry Date</th>
                            <th>Quantity</th>
                            <th>Reason</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="toClearTableBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="masterProductList" class="tab-content">
            <h2>Master Product List</h2>
            <form id="masterProductForm">
                <input type="hidden" id="masterEditId">
                <label for="masterBrand">Brand:</label>
                <input type="text" id="masterBrand" required>

                <label for="masterProduct">Product Name:</label>
                <input type="text" id="masterProduct" required>

                <label for="masterRemarks">Remarks:</label>
                <input type="text" id="masterRemarks">

                <button type="submit">Save Master Product</button>
            </form>

            <div class="table-actions">
                <button onclick="exportTableToCSV('masterProductListTable')">Export CSV</button>
                <input type="file" id="importMasterProductCSV" accept=".csv" onchange="importCSVToTable(event, 'masterProductList')">
            </div>

            <div class="table-container">
                <table id="masterProductListTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Brand</th>
                            <th>Product Name</th>
                            <th>Remarks</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="masterProductListTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="editMasterProductModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="document.getElementById('editMasterProductModal').style.display='none'">&times;</span>
            <h2>Edit Master Product</h2>
            <form id="editMasterProductForm">
                <input type="hidden" id="modalMasterProductId">
                <label for="modalMasterBrand">Brand:</label>
                <input type="text" id="modalMasterBrand" required>

                <label for="modalMasterProduct">Product Name:</label>
                <input type="text" id="modalMasterProduct" required>

                <label for="modalMasterRemarks">Remarks:</label>
                <input type="text" id="modalMasterRemarks">

                <button type="submit">Update Master Product</button>
            </form>
        </div>
    </div>

    <script>
        // Firebase configuration (REPLACE WITH YOUR ACTUAL CONFIG)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global data arrays
        let inventoryData = [];
        let newProductsData = [];
        let toClearData = [];
        let masterProductListData = [];

        // Function to switch tabs
        function switchTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => button.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick="switchTab('${tabId}')"]`).classList.add('active');

            // Update tables when switching tabs
            if (tabId === 'inventory') {
                updateInventoryTable();
            } else if (tabId === 'newProducts') {
                updateNewProductsTable();
            } else if (tabId === 'toClear') {
                updateToClearTable();
            } else if (tabId === 'masterProductList') {
                updateMasterProductListTable();
            } else if (tabId === 'dashboard') {
                updateDashboardCounts();
                updateAlerts();
            }
        }

        // --- Firebase Data Operations ---

        // Fetch data from Firestore collections
        async function fetchDataFromFirestore(collectionName) {
            try {
                const snapshot = await db.collection(collectionName).get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error(`Error fetching data from ${collectionName}:`, error);
                showNotification(`Error loading ${collectionName} data.`, 'error');
                return [];
            }
        }

        // Save data to a Firestore collection
        async function saveDataToFirestore(collectionName, dataArray) {
            try {
                const batch = db.batch();
                const collectionRef = db.collection(collectionName);

                // Clear existing documents in the collection first
                const existingDocs = await collectionRef.get();
                existingDocs.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                // Add new documents
                dataArray.forEach(item => {
                    // Firestore auto-generates ID if you use .add()
                    // If you want to use your own 'id' field, use .doc(item.id.toString()).set(item)
                    // For simplicity, let's use generated IDs and save our 'id' as a field
                    const docRef = collectionRef.doc(); // Let Firestore generate ID
                    batch.set(docRef, { ...item, id: item.id }); // Save the item's 'id' field too
                });

                await batch.commit();
                // showNotification(`Data saved to ${collectionName} successfully!`, 'success');
            } catch (error) {
                console.error(`Error saving data to ${collectionName}:`, error);
                showNotification(`Error saving ${collectionName} data.`, 'error');
            }
        }
        
        // Update local data arrays from Firestore
        async function updateLocalData() {
            inventoryData = await fetchDataFromFirestore('inventory');
            newProductsData = await fetchDataFromFirestore('newProducts');
            toClearData = await fetchDataFromFirestore('toClear');
            masterProductListData = await fetchDataFromFirestore('masterProductList');
        }

        // --- Save Functions ---

        // Save Inventory Product (Edit or Add)
        document.getElementById('productForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const editId = document.getElementById('editProductId').value;
            const newProduct = {
                brand: document.getElementById('brand').value,
                product: document.getElementById('productName').value,
                status: document.getElementById('status').value,
                expiry: document.getElementById('expiry').value,
                shipment: document.getElementById('shipment').value,
                remarks: document.getElementById('remarks').value
            };

            if (editId) {
                // Edit existing product
                const index = inventoryData.findIndex(item => item.id == editId);
                if (index !== -1) {
                    inventoryData[index] = { ...inventoryData[index], ...newProduct };
                    showNotification('Product updated successfully!', 'success');
                }
            } else {
                // Add new product
                newProduct.id = inventoryData.length > 0 ? Math.max(...inventoryData.map(item => item.id)) + 1 : 1;
                inventoryData.push(newProduct);
                showNotification('Product added to inventory!', 'success');
            }
            
            await saveDataToFirestore('inventory', inventoryData);
            updateInventoryTable();
            updateDashboardCounts();
            updateAlerts();
            document.getElementById('productForm').reset();
            document.getElementById('editProductId').value = ''; // Clear edit ID
        });

        // Save New Product
        document.getElementById('newProductForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const newProduct = {
                id: newProductsData.length > 0 ? Math.max(...newProductsData.map(item => item.id)) + 1 : 1,
                brand: document.getElementById('newBrand').value,
                product: document.getElementById('newProductName').value,
                status: document.getElementById('newStatus').value,
                expiry: document.getElementById('newExpiry').value,
                shipment: document.getElementById('newShipment').value,
                remarks: document.getElementById('newRemarks').value
            };
            newProductsData.push(newProduct);
            await saveDataToFirestore('newProducts', newProductsData);
            updateNewProductsTable();
            showNotification('New product added to staging list!', 'success');
            document.getElementById('newProductForm').reset();
        });

        // Save To Clear Item
        document.getElementById('toClearForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const editId = document.getElementById('toClearEditId').value;
            const newToClearItem = {
                brand: document.getElementById('toClearBrand').value,
                product: document.getElementById('toClearProduct').value,
                category: document.getElementById('toClearCategory').value,
                expiryDate: document.getElementById('toClearExpiryDate').value,
                quantity: document.getElementById('toClearQuantity').value,
                reason: document.getElementById('toClearReason').value
            };

            if (editId) {
                const index = toClearData.findIndex(item => item.id == editId);
                if (index !== -1) {
                    toClearData[index] = { ...toClearData[index], ...newToClearItem };
                    showNotification('To Clear item updated!', 'success');
                }
            } else {
                newToClearItem.id = toClearData.length > 0 ? Math.max(...toClearData.map(item => item.id)) + 1 : 1;
                toClearData.push(newToClearItem);
                showNotification('Item added to To Clear list!', 'success');
            }

            await saveDataToFirestore('toClear', toClearData);
            updateToClearTable();
            updateAlerts();
            document.getElementById('toClearForm').reset();
            document.getElementById('toClearEditId').value = '';
        });

        // Save Master Product List Item
        document.getElementById('masterProductForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const editId = document.getElementById('masterEditId').value;
            const newMasterProduct = {
                brand: document.getElementById('masterBrand').value,
                product: document.getElementById('masterProduct').value,
                remarks: document.getElementById('masterRemarks').value
            };

            if (editId) {
                const index = masterProductListData.findIndex(item => item.id == editId);
                if (index !== -1) {
                    masterProductListData[index] = { ...masterProductListData[index], ...newMasterProduct };
                    showNotification('Master product updated!', 'success');
                }
            } else {
                newMasterProduct.id = masterProductListData.length > 0 ? Math.max(...masterProductListData.map(item => item.id)) + 1 : 1;
                masterProductListData.push(newMasterProduct);
                showNotification('Master product added!', 'success');
            }

            await saveDataToFirestore('masterProductList', masterProductListData);
            updateMasterProductListTable();
            document.getElementById('masterProductForm').reset();
            document.getElementById('masterEditId').value = '';
        });

        // Save Master Product from Modal
        document.getElementById('editMasterProductForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const id = document.getElementById('modalMasterProductId').value;
            const index = masterProductListData.findIndex(item => item.id == id);
            if (index !== -1) {
                masterProductListData[index].brand = document.getElementById('modalMasterBrand').value;
                masterProductListData[index].product = document.getElementById('modalMasterProduct').value;
                masterProductListData[index].remarks = document.getElementById('modalMasterRemarks').value;
                await saveDataToFirestore('masterProductList', masterProductListData);
                updateMasterProductListTable();
                document.getElementById('editMasterProductModal').style.display = 'none';
                showNotification('Master Product updated successfully!', 'success');
            }
        });


        // --- Update Table Functions ---

        function updateInventoryTable() {
            const tableBody = document.getElementById('inventoryTableBody');
            tableBody.innerHTML = '';
            inventoryData.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.id;
                row.insertCell().textContent = item.brand;
                row.insertCell().textContent = item.product;
                row.insertCell().textContent = item.status;
                row.insertCell().textContent = item.expiry;
                row.insertCell().textContent = item.shipment;
                row.insertCell().textContent = item.remarks;

                const actionsCell = row.insertCell();
                actionsCell.className = 'action-buttons';
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.onclick = () => editProduct(item.id);
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'delete';
                deleteButton.onclick = () => deleteProduct(item.id);
                actionsCell.appendChild(deleteButton);
            });
        }

        function updateNewProductsTable() {
            const tableBody = document.getElementById('newProductsTableBody');
            tableBody.innerHTML = '';
            newProductsData.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.id;
                row.insertCell().textContent = item.brand;
                row.insertCell().textContent = item.product;
                row.insertCell().textContent = item.status;
                row.insertCell().textContent = item.expiry;
                row.insertCell().textContent = item.shipment;
                row.insertCell().textContent = item.remarks;

                const actionsCell = row.insertCell();
                actionsCell.className = 'action-buttons';
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.onclick = () => editNewProduct(item.id);
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'delete';
                deleteButton.onclick = () => deleteNewProduct(item.id);
                actionsCell.appendChild(deleteButton);
            });
        }

        function updateToClearTable() {
            const tableBody = document.getElementById('toClearTableBody');
            tableBody.innerHTML = '';
            toClearData.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.id;
                row.insertCell().textContent = item.brand;
                row.insertCell().textContent = item.product;
                row.insertCell().textContent = item.category;
                row.insertCell().textContent = item.expiryDate;
                row.insertCell().textContent = item.quantity;
                row.insertCell().textContent = item.reason;

                const actionsCell = row.insertCell();
                actionsCell.className = 'action-buttons';
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.onclick = () => editToClear(item.id);
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'delete';
                deleteButton.onclick = () => deleteToClear(item.id);
                actionsCell.appendChild(deleteButton);
            });
        }

        function updateMasterProductListTable() {
            const tableBody = document.getElementById('masterProductListTableBody');
            tableBody.innerHTML = '';
            masterProductListData.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.id;
                row.insertCell().textContent = item.brand;
                row.insertCell().textContent = item.product;
                row.insertCell().textContent = item.remarks;

                const actionsCell = row.insertCell();
                actionsCell.className = 'action-buttons';
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.onclick = () => openEditMasterProductModal(item.id);
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'delete';
                deleteButton.onclick = () => deleteMasterProduct(item.id);
                actionsCell.appendChild(deleteButton);
            });
        }

        // --- Edit Functions ---

        function editProduct(id) {
            const product = inventoryData.find(item => item.id === id);
            if (product) {
                document.getElementById('editProductId').value = product.id;
                document.getElementById('brand').value = product.brand;
                document.getElementById('productName').value = product.product;
                document.getElementById('status').value = product.status;
                document.getElementById('expiry').value = product.expiry;
                document.getElementById('shipment').value = product.shipment;
                document.getElementById('remarks').value = product.remarks;
                showNotification('Editing existing product.', 'info');
            }
        }

        function editNewProduct(id) {
            const product = newProductsData.find(item => item.id === id);
            if (product) {
                document.getElementById('newBrand').value = product.brand;
                document.getElementById('newProductName').value = product.product;
                document.getElementById('newStatus').value = product.status;
                document.getElementById('newExpiry').value = product.expiry;
                document.getElementById('newShipment').value = product.shipment;
                document.getElementById('newRemarks').value = product.remarks;
                // For editing new products, you might add a hidden input for ID if you need to update it
                // For now, let's just pre-fill the form. To actually save changes, you'd need similar logic as saveProduct
                showNotification('Currently only pre-filling. Re-add to update.', 'info');
            }
        }

        function editToClear(id) {
            const item = toClearData.find(item => item.id === id);
            if (item) {
                document.getElementById('toClearEditId').value = item.id;
                document.getElementById('toClearBrand').value = item.brand;
                document.getElementById('toClearProduct').value = item.product;
                document.getElementById('toClearCategory').value = item.category;
                document.getElementById('toClearExpiryDate').value = item.expiryDate;
                document.getElementById('toClearQuantity').value = item.quantity;
                document.getElementById('toClearReason').value = item.reason;
                showNotification('Editing To Clear item.', 'info');
            }
        }

        function openEditMasterProductModal(id) {
            const product = masterProductListData.find(item => item.id === id);
            if (product) {
                document.getElementById('modalMasterProductId').value = product.id;
                document.getElementById('modalMasterBrand').value = product.brand;
                document.getElementById('modalMasterProduct').value = product.product;
                document.getElementById('modalMasterRemarks').value = product.remarks;
                document.getElementById('editMasterProductModal').style.display = 'block';
            }
        }

        // --- Delete Functions ---

        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product from Inventory?')) {
                inventoryData = inventoryData.filter(item => item.id !== id);
                await saveDataToFirestore('inventory', inventoryData);
                updateInventoryTable();
                updateDashboardCounts();
                updateAlerts();
                showNotification('Product deleted from inventory.', 'success');
            }
        }

        async function deleteNewProduct(id) {
            if (confirm('Are you sure you want to delete this new product?')) {
                newProductsData = newProductsData.filter(item => item.id !== id);
                await saveDataToFirestore('newProducts', newProductsData);
                updateNewProductsTable();
                showNotification('New product deleted.', 'success');
            }
        }

        async function deleteToClear(id) {
            if (confirm('Are you sure you want to delete this To Clear item?')) {
                toClearData = toClearData.filter(item => item.id !== id);
                await saveDataToFirestore('toClear', toClearData);
                updateToClearTable();
                updateAlerts();
                showNotification('To Clear item deleted.', 'success');
            }
        }

        async function deleteMasterProduct(id) {
            if (confirm('Are you sure you want to delete this Master Product?')) {
                masterProductListData = masterProductListData.filter(item => item.id !== id);
                await saveDataToFirestore('masterProductList', masterProductListData);
                updateMasterProductListTable();
                showNotification('Master Product deleted.', 'success');
            }
        }

        // --- Dashboard Functions ---

        function updateDashboardCounts() {
            document.getElementById('totalProductsCount').textContent = inventoryData.length;
            const lowStock = inventoryData.filter(item => item.status === 'Low stock').length;
            const oos = inventoryData.filter(item => item.status === 'OOS').length;
            document.getElementById('lowStockCount').textContent = lowStock;
            document.getElementById('oosCount').textContent = oos;

            const today = new Date();
            const expiringSoon = inventoryData.filter(item => {
                if (item.expiry) {
                    const expiryDate = new Date(item.expiry);
                    const diffTime = expiryDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays > 0 && diffDays <= 30; // Expiring within 30 days
                }
                return false;
            }).length;
            document.getElementById('expiringSoonCount').textContent = expiringSoon;
        }

        function updateAlerts() {
            const alertsContainer = document.getElementById('alertsContainer');
            alertsContainer.innerHTML = '';
            let hasAlerts = false;

            // Check for expiry dates
            const today = new Date();
            inventoryData.forEach(item => {
                if (item.expiry) {
                    const expiryDate = new Date(item.expiry);
                    const diffTime = expiryDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays <= 0) {
                        const p = document.createElement('p');
                        p.textContent = `ðŸš¨ ${item.brand} - ${item.product} has EXPIRED!`;
                        alertsContainer.appendChild(p);
                        hasAlerts = true;
                    } else if (diffDays <= 30) {
                        const p = document.createElement('p');
                        p.textContent = `âš ï¸ ${item.brand} - ${item.product} will expire in ${diffDays} days.`;
                        alertsContainer.appendChild(p);
                        hasAlerts = true;
                    }
                }
            });

            // Check for low stock/OOS
            inventoryData.forEach(item => {
                if (item.status === 'Low stock') {
                    const p = document.createElement('p');
                    p.textContent = `ðŸ“‰ ${item.brand} - ${item.product} is Low stock.`;
                    alertsContainer.appendChild(p);
                    hasAlerts = true;
                } else if (item.status === 'OOS') {
                    const p = document.createElement('p');
                    p.textContent = `ðŸš« ${item.brand} - ${item.product} is Out of Stock!`;
                    alertsContainer.appendChild(p);
                    hasAlerts = true;
                }
            });

            // Check for To Clear - Short Expiry
            toClearData.forEach(item => {
                if (item.category === 'Short Expiry' && item.expiryDate) {
                    const expiryDate = new Date(item.expiryDate);
                    const diffTime = expiryDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays <= 60) { // Alert if short expiry within 60 days
                        const p = document.createElement('p');
                        p.textContent = `ðŸ—‘ï¸ To Clear: ${item.brand} - ${item.product} (Short Expiry) in ${diffDays} days.`;
                        alertsContainer.appendChild(p);
                        hasAlerts = true;
                    }
                }
            });


            if (!hasAlerts) {
                const p = document.createElement('p');
                p.className = 'no-alerts';
                p.textContent = 'Everything looks good! No urgent alerts.';
                alertsContainer.appendChild(p);
            }
        }
        
        // Function to merge new products into the master inventory
        async function mergeNewProductsToMaster() {
            if (newProductsData.length === 0) {
                showNotification('No new products to merge.', 'info');
                return;
            }

            // Assign unique IDs to new products before merging
            let currentMaxId = inventoryData.length > 0 ? Math.max(...inventoryData.map(item => item.id)) : 0;

            const productsToMerge = newProductsData.map(item => {
                currentMaxId++;
                return {
                    id: currentMaxId, // Assign a new unique ID
                    brand: item.brand,
                    product: item.product,
                    status: item.status,
                    expiry: item.expiry,
                    shipment: item.shipment, // Corrected typo here
                    remarks: item.remarks
                };
            });

            // Add products to inventoryData
            inventoryData.push(...productsToMerge);

            // Clear newProductsData
            newProductsData = [];

            // Save updated data to Firestore
            await saveDataToFirestore('inventory', inventoryData);
            await saveDataToFirestore('newProducts', newProductsData); // Clear new products collection

            // Update UI tables
            updateInventoryTable();
            updateNewProductsTable();
            updateAlerts(); // Re-evaluate alerts with updated inventory
            updateDashboardCounts(); // Update dashboard counts as well

            showNotification(`${productsToMerge.length} new products merged into Master Inventory!`, 'success');
        }


        // --- CSV Export/Import ---

        function exportTableToCSV(tableId) {
            const table = document.getElementById(tableId);
            let csv = [];
            for (let i = 0; i < table.rows.length; i++) {
                let row = [], cols = table.rows[i].querySelectorAll('td, th');
                for (let j = 0; j < cols.length - (tableId === 'inventoryTable' || tableId === 'newProductsTable' || tableId === 'toClearTable' || tableId === 'masterProductListTable' ? 1 : 0); j++) {
                    let data = cols[j].innerText.replace(/"/g, '""'); // Escape double quotes
                    row.push(`"${data}"`); // Enclose in double quotes
                }
                csv.push(row.join(','));
            }

            const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${tableId}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification(`Exported ${tableId}.csv`, 'success');
        }

        async function importCSVToTable(event, targetCollection) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) {
                    showNotification('CSV file is empty or malformed.', 'error');
                    return;
                }

                const headers = parseCSVLine(lines[0]);
                const importedData = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length !== headers.length) {
                        console.warn(`Skipping malformed row ${i + 1}: ${lines[i]}`);
                        continue;
                    }
                    let item = {};
                    headers.forEach((header, index) => {
                        item[header.trim().toLowerCase().replace(/ /g, '')] = values[index].trim();
                    });
                    
                    // Assign a new ID for imported items
                    let newId;
                    if (targetCollection === 'inventory') {
                        newId = inventoryData.length > 0 ? Math.max(...inventoryData.map(d => d.id)) + 1 : 1;
                    } else if (targetCollection === 'newProducts') {
                        newId = newProductsData.length > 0 ? Math.max(...newProductsData.map(d => d.id)) + 1 : 1;
                    } else if (targetCollection === 'toClear') {
                        newId = toClearData.length > 0 ? Math.max(...toClearData.map(d => d.id)) + 1 : 1;
                    } else if (targetCollection === 'masterProductList') {
                        newId = masterProductListData.length > 0 ? Math.max(...masterProductListData.map(d => d.id)) + 1 : 1;
                    }
                    item.id = newId;

                    importedData.push(item);
                }

                let currentData;
                if (targetCollection === 'inventory') {
                    currentData = inventoryData;
                } else if (targetCollection === 'newProducts') {
                    currentData = newProductsData;
                } else if (targetCollection === 'toClear') {
                    currentData = toClearData;
                } else if (targetCollection === 'masterProductList') {
                    currentData = masterProductListData;
                }

                // Check for duplicates based on a combination of brand and product (basic check)
                const uniqueImportedData = [];
                const existingProductKeys = new Set(currentData.map(item => `${item.brand}-${item.product}`));

                importedData.forEach(item => {
                    const key = `${item.brand}-${item.product}`;
                    if (!existingProductKeys.has(key)) {
                        uniqueImportedData.push(item);
                        existingProductKeys.add(key);
                    } else {
                        console.warn(`Duplicate found and skipped: ${item.brand} - ${item.product}`);
                    }
                });

                if (uniqueImportedData.length > 0) {
                    // Append unique imported data to current data
                    if (targetCollection === 'inventory') {
                        inventoryData.push(...uniqueImportedData);
                        await saveDataToFirestore('inventory', inventoryData);
                        updateInventoryTable();
                    } else if (targetCollection === 'newProducts') {
                        newProductsData.push(...uniqueImportedData);
                        await saveDataToFirestore('newProducts', newProductsData);
                        updateNewProductsTable();
                    } else if (targetCollection === 'toClear') {
                        toClearData.push(...uniqueImportedData);
                        await saveDataToFirestore('toClear', toClearData);
                        updateToClearTable();
                    } else if (targetCollection === 'masterProductList') {
                        masterProductListData.push(...uniqueImportedData);
                        await saveDataToFirestore('masterProductList', masterProductListData);
                        updateMasterProductListTable();
                    }
                    showNotification(`Successfully imported ${uniqueImportedData.length} unique items to ${targetCollection}!`, 'success');
                } else {
                    showNotification('No unique items to import or all were duplicates!', 'error');
                }
                
                // Update dashboard counts and alerts after importing to inventory
                if (targetCollection === 'inventory') {
                    updateDashboardCounts();
                    updateAlerts();
                }

            };
            reader.readAsText(file);
        }

        // Helper function to parse CSV line (handles commas in quotes)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '\"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // Notification function
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Trigger reflow to ensure transition works
            void notification.offsetWidth; 
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 3000);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }

        // Initialize on load: Fetch data from Firestore
        window.onload = async function() {
            // Wait for data to load from Firestore before updating tables
            await updateLocalData();
            switchTab('dashboard'); // Default to dashboard after load
        };
    </script>
</body>
</html>
