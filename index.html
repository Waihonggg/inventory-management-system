<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333; /* Default text color for better contrast on white backgrounds */
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-radius: 15px;
        }

        /* Headings */
        h1 {
            color: #2c3e50;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
            overflow-x: auto;
            gap: 2px;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            background-color: transparent;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #7f8c8d;
            min-width: 120px;
            text-align: center;
            border: 2px solid transparent;
            border-bottom: none;
        }

        .tab:hover {
            background-color: #f8f9fa;
            color: #2c3e50;
            border-color: #e1e8ed;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            border-color: #667eea; /* Match gradient start */
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Stats Cards for Dashboard */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .stat-card.urgent {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
         .stat-card.urgent:hover {
            box-shadow: 0 15px 35px rgba(231, 76, 60, 0.4);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        .stat-card.warning:hover {
            box-shadow: 0 15px 35px rgba(243, 156, 18, 0.4);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
         .stat-card.info:hover {
            box-shadow: 0 15px 35px rgba(52, 152, 219, 0.4);
        }


        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            line-height: 1;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Controls (Buttons, Search) */
        .controls {
            margin: 20px 0; /* Keep vertical margin */
            display: flex;
            justify-content: space-between;
            align-items: flex-start; 
            flex-wrap: wrap;
            gap: 15px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e1e8ed;
        }
         .controls > * { 
            flex-shrink: 0;
        }


        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px; /* Increased margin for spacing */
            background: white;
            border-radius: 10px;
            overflow: hidden; /* Important for border-radius on table */
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        th, td {
            padding: 14px; /* Increased padding for more space */
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: middle; /* Better vertical alignment */
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.6px; /* Slightly increased letter spacing */
            font-size: 12px;
            cursor: pointer; 
        }
        th .sort-arrow { 
            font-size: 0.8em;
            margin-left: 5px;
        }
        
        /* Zebra striping for table body rows */
        tbody tr:nth-child(even) {
            background-color: #f9f9fc; /* Very light purple/grey */
        }

        tbody tr:hover {
            background-color: #f1f3f5; /* Slightly darker hover for better feedback */
        }

        /* Right-align specific numeric columns */
        #inventory-table td:nth-child(4), /* Quantity */
        #new-products-table td:nth-child(6), /* Quantity */
        #to-clear-table td:nth-child(7), /* Initial Bal */
        #to-clear-table td:nth-child(8), /* WH Qty */
        #to-clear-table td:nth-child(9), /* Store Qty */
        #to-clear-table td:nth-child(10), /* Total Qty */
        #to-clear-table td:nth-child(11), /* Weekly Demand */
        #to-clear-table td:nth-child(12), /* Weeks Supply */
        #master-table td:nth-child(6) /* Price */
        {
            text-align: right;
            font-variant-numeric: tabular-nums; /* Helps align numbers if using proportional fonts */
        }


        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px; /* Slightly smaller for compactness */
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .oos {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .low {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .normal {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .danger-status {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .alert-status {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        /* General Buttons */
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }
         .btn-success:hover {
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }


        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
         .btn-info:hover {
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        /* Refined styles for buttons within table cells */
        td button.btn-info,
        td button.btn-danger,
        td button.btn-success {
            padding: 7px 10px;   /* Reduced padding for compactness */
            font-size: 10px;    /* Smaller font for text like "Edit", "Delete" */
            letter-spacing: 0.3px; /* Adjust letter spacing for smaller font */
            border-radius: 18px; /* Keep pill shape, but ensure it's compact */
            margin: 3px;         /* Spacing between buttons in a cell */
            /* Inherits general hover effects, no need to redefine transform here unless different behavior is wanted */
        }


        /* Search Box */
        .search-box {
            padding: 12px 16px;
            width: 280px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%237f8c8d' class='bi bi-search' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E") no-repeat 12px center; /* Added search icon */
            padding-left: 35px; /* Space for the icon */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); /* Slightly more visible focus */
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: none;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        /* Form Group */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .form-group input:disabled, .form-group select:disabled, .form-group textarea:disabled {
            background-color: #f0f0f0;
            opacity: 0.7;
            cursor: not-allowed;
        }
        .form-group label.disabled-label {
            opacity: 0.5;
        }


        /* Alert Notifications */
        .alert {
            padding: 15px 20px; /* More padding */
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 600;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 320px; /* Slightly wider */
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* Stronger shadow */
            border-left-width: 5px; /* Accent border */
            border-left-style: solid;
        }

        .alert-success {
            background-color: #e6f7ed; /* Lighter green */
            color: #0f5132; /* Darker text for contrast */
            border-color: #27ae60; /* Accent color */
        }

        .alert-error {
            background-color: #fbe9e7; /* Lighter red */
            color: #842029; /* Darker text */
            border-color: #e74c3c; /* Accent color */
        }

        /* Confirmation Modal Specific Styles */
        #confirmModal .modal-content {
            text-align: center;
            padding: 40px;
            max-width: 450px;
        }

        #confirmModal .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        #confirmModal .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        #confirmModal .modal-buttons button {
            flex: 1;
            max-width: 150px;
            padding: 12px 25px;
            font-size: 14px;
        }

        /* --- Mobile Responsiveness --- */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            .subtitle {
                font-size: 1rem;
                margin-bottom: 20px;
            }

            .tabs {
                flex-wrap: wrap; 
                justify-content: center; 
                border-bottom: none; 
            }

            .tab {
                min-width: unset; 
                flex: 1 1 auto; 
                padding: 10px 15px;
                font-size: 10px;
                border-bottom: 2px solid #ecf0f1; 
            }

            .tab.active {
                transform: none; 
                box-shadow: none; 
                border-bottom: 2px solid #667eea;
            }

            .stats-cards {
                grid-template-columns: 1fr; 
            }

            .stat-card {
                padding: 20px;
            }

            .stat-number {
                font-size: 2.5rem;
            }

            .controls {
                flex-direction: column; 
                align-items: stretch; 
                padding: 15px;
            }
            .controls .search-box { 
                 width: 100%;
            }


            button { /* General button stacking */
                width: 100%;
                margin-bottom: 10px; 
                font-size: 12px;
                padding: 10px 15px;
            }
             /* Ensure table action buttons don't go full width on mobile */
            td button.btn-info,
            td button.btn-danger,
            td button.btn-success {
                width: auto; /* Override full width for table buttons */
                margin-bottom: 2px; /* Reduce margin if stacked vertically in a small cell */
            }


            .search-box { 
                width: 100%; 
                padding-left: 35px; /* Ensure icon space maintained */
            }


            /* Responsive Tables: force table to scroll horizontally */
            table {
                display: block; 
                width: 100%;
                overflow-x: auto; 
                -webkit-overflow-scrolling: touch; 
                white-space: nowrap; 
            }

            th, td {
                min-width: 120px; /* Ensure columns have a minimum width for readability */
                padding: 10px;    /* Adjust padding for mobile if needed */
            }
            /* Adjust right-alignment for mobile if it causes issues, or keep it */
            #inventory-table td:nth-child(4),
            #new-products-table td:nth-child(6),
            #to-clear-table td:nth-child(7),
            #to-clear-table td:nth-child(8),
            #to-clear-table td:nth-child(9),
            #to-clear-table td:nth-child(10),
            #to-clear-table td:nth-child(11),
            #to-clear-table td:nth-child(12),
            #master-table td:nth-child(6) {
                text-align: right; /* Keep right alignment for consistency */
            }


            .modal-content {
                margin: 20px auto; 
                padding: 20px;
                width: 95%; 
            }

            .alert {
                width: calc(100% - 40px); 
                left: 20px;
                right: 20px;
                top: 10px; 
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Inventory Management System</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab(this, 'dashboard')">📊 Dashboard</div>
            <div class="tab" onclick="switchTab(this, 'oos-lowstock')"> OOS/LOW STOCK</div>
            <div class="tab" onclick="switchTab(this, 'new-products')">✨ New Products</div>
            <div class="tab" onclick="switchTab(this, 'to-clear')">🏷️ To Clear</div>
            <div class="tab" onclick="switchTab(this, 'master-list')">📋 Master List</div>
            <div class="tab" onclick="switchTab(this, 'recycle-bin')">🗑️ Recycle Bin</div>
            <div class="tab" onclick="switchTab(this, 'management')">⚙️ Management</div>
        </div>
        
        <div id="dashboard" class="tab-content active">
            <div class="stats-cards">
                <div class="stat-card urgent" onclick="showFilteredInventory('OUT OF STOCK')">
                    <div class="stat-number" id="oos-count">0</div>
                    <div class="stat-label">OUT OF STOCK</div>
                </div>
                <div class="stat-card warning" onclick="showFilteredInventory('LOW STOCK')">
                    <div class="stat-number" id="low-count">0</div>
                    <div class="stat-label">LOW STOCK</div>
                </div>
                <div class="stat-card info" onclick="switchTabAndFilter('new-products', 'NEW PRODUCTS')">
                    <div class="stat-number" id="new-count">0</div>
                    <div class="stat-label">NEW PRODUCTS</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);" onclick="switchTabAndFilter('to-clear', 'TO CLEAR')">
                    <div class="stat-number" id="to-clear-count">0</div>
                    <div class="stat-label">TO CLEAR</div>
                </div>
            </div>
            
            <h3>Recent Alerts</h3>
            <div id="alerts" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; border: 1px solid #e1e8ed;">
                <p>Loading alerts...</p>
            </div>
        </div>
        
        <div id="oos-lowstock" class="tab-content">
            <div class="controls">
                <button onclick="showAddProductModal()">➕ Add Product</button>
                <input type="text" id="oosSearchInput" class="search-box" placeholder="Search products..." onkeyup="searchInventory(this.value)">
                <select id="oosLowStockFilter" onchange="filterInventoryByStatus(this.value)">
                    <option value="">All Statuses</option>
                    <option value="OUT OF STOCK">OUT OF STOCK</option>
                    <option value="LOW STOCK">LOW STOCK</option>
                </select>
            </div>
            
            <table id="inventory-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('inventory', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'quantity')" data-column-key="quantity">Quantity <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'status')" data-column-key="status">Status <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'shipmentDate')" data-column-key="shipmentDate">Shipment Date <span class="sort-arrow"></span></th>
                        <th>Remarks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventory-table">
                    </tbody>
            </table>
        </div>
        
        <div id="new-products" class="tab-content">
            <div class="controls">
                <button onclick="showAddNewProductModal()">➕ Add New Product</button>
                <button onclick="mergeNewProductsToMaster()">Merge All to Inventory</button>
                 <input type="text" id="newProductsSearchInput" class="search-box" placeholder="Search new products..." onkeyup="searchNewProducts(this.value)">
            </div>
            
            <table id="new-products-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('newProducts', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'addedDate')" data-column-key="addedDate">Added Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'arrivalDate')" data-column-key="arrivalDate">Arrival Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'quantity')" data-column-key="quantity">Quantity <span class="sort-arrow"></span></th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="new-products-table">
                    </tbody>
            </table>
        </div>
        
        <div id="to-clear" class="tab-content">
            <div class="controls">
                <button onclick="showAddToClearModal()">➕ Add Product to Clear</button>
                <input type="text" id="toClearSearchInput" class="search-box" placeholder="Search products to clear..." onkeyup="searchToClear(this.value)">
            </div>
            
            <table id="to-clear-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('toClear', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'expiryDate')" data-column-key="expiryDate">Expiry Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'firstHighlightedDate')" data-column-key="firstHighlightedDate">First Highlighted <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'firstReportedBalance')" data-column-key="firstReportedBalance">Initial Bal <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'warehouseQty')" data-column-key="warehouseQty">WH Qty <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'storeQty')" data-column-key="storeQty">Store Qty <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'totalQty')" data-column-key="totalQty">Total Qty <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'weeklyDemand')" data-column-key="weeklyDemand">Wk Demand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'weeksSupply')" data-column-key="weeksSupply">Wks Supply <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'supplyStatus')" data-column-key="supplyStatus">Supply Status <span class="sort-arrow"></span></th>
                        <th>Remarks</th>
                        <th>Action Plan</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="to-clear-table">
                    </tbody>
            </table>
        </div>
        
        <div id="master-list" class="tab-content">
            <div class="controls">
                <button onclick="showAddMasterProductModal()">➕ Add Product</button>
                <input type="text" class="search-box" id="masterListSearchInput" placeholder="Search master products..." onkeyup="searchMasterList(this.value)">
                <button onclick="exportMasterList()">📥 Export List</button>
                <button onclick="document.getElementById('csvFileInput').click()">📤 Import CSV</button>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importCSV(event)">
            </div>
            
            <table id="master-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('master', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'product')" data-column-key="product">Product Name <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'weeklyDemand')" data-column-key="weeklyDemand">WK DEMAND <span class="sort-arrow"></span></th>
                        <th>Description</th>
                        <th onclick="sortTable('master', 'price')" data-column-key="price">Price <span class="sort-arrow"></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="master-table">
                    </tbody>
            </table>
        </div>

        <div id="recycle-bin" class="tab-content">
            <div class="controls">
                <h3>Recycle Bin</h3>
                <input type="text" id="recycleBinSearchInput" class="search-box" placeholder="Search recycle bin..." onkeyup="searchRecycleBin(this.value)">
                <button class="btn-danger" onclick="emptyRecycleBin()">🗑️ Empty Recycle Bin</button>
            </div>
            <table id="recycle-bin-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('recycleBin', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('recycleBin', 'originalCollection')" data-column-key="originalCollection">Original Tab <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('recycleBin', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('recycleBin', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recycle-bin-table">
                    </tbody>
            </table>
        </div>
        
        <div id="management" class="tab-content">
            <div class="controls">
                <button onclick="exportAllData()">📥 Export All Data</button>
                <button onclick="confirmLoadSampleData()">📊 Load Sample Data</button>
            </div>
            
            <h3>System Information</h3>
            <p>Total Products (active): <span id="total-products">0</span></p>
            <p>Total Products (all unique SKUs): <span id="total-products-all">0</span></p>
            <p>Last Synced: <span id="last-updated">Never</span></p>
        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('productModal')">&times;</span>
            <h2 id="productModalTitle">Add New Product</h2>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="editProductId" value="">
                <div class="form-group">
                    <label for="brand">Brand:</label>
                    <select id="brand" required onchange="filterProductsForBrand(this.value, 'productName', 'productsDatalist')">
                        </select>
                </div>
                <div class="form-group">
                    <label for="productName">Product Name:</label>
                    <input type="text" id="productName" list="productsDatalist" required>
                    <datalist id="productsDatalist"></datalist>
                </div>
                <div class="form-group">
                    <label for="inventoryQuantity">Quantity:</label>
                    <input type="number" id="inventoryQuantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="status">Status:</label>
                    <select id="status" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="shipmentDate">Shipment Date:</label>
                    <input type="date" id="shipmentDate">
                </div>
                <div class="form-group">
                    <label for="remarks">Remarks:</label>
                    <textarea id="remarks"></textarea>
                </div>
                <button type="submit">Save Product</button>
            </form>
        </div>
    </div>

    <div id="newProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('newProductModal')">&times;</span>
            <h2 id="newProductModalTitle">Add New Product Entry</h2>
            <form onsubmit="saveNewProduct(event)">
                <input type="hidden" id="editNewProductId" value="">
                <div class="form-group">
                    <label for="newBrand">Brand:</label>
                    <select id="newBrand" required onchange="filterProductsForBrand(this.value, 'newProductName', 'newProductsDatalist')">
                        </select>
                </div>
                <div class="form-group">
                    <label for="newProductSku">Product Code (SKU):</label>
                    <input type="text" id="newProductSku" required>
                </div>
                <div class="form-group">
                    <label for="newProductName">Product Name:</label>
                    <input type="text" id="newProductName" list="newProductsDatalist" required>
                    <datalist id="newProductsDatalist"></datalist>
                </div>
                <div class="form-group">
                    <label for="arrivalDate">Arrival Date:</label>
                    <input type="date" id="arrivalDate" required>
                </div>
                <div class="form-group">
                    <label for="newProductQuantity">Quantity:</label> <input type="number" id="newProductQuantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="notes">Notes:</label>
                    <textarea id="notes"></textarea>
                </div>
                <button type="submit">Save New Product</button>
            </form>
        </div>
    </div>

    <div id="masterProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('masterProductModal')">&times;</span>
            <h2 id="masterProductModalTitle">Add Master Product</h2>
            <form onsubmit="saveMasterProduct(event)">
                <input type="hidden" id="editMasterProductId" value="">
                <div class="form-group">
                    <label for="masterBrand">Brand:</label>
                    <select id="masterBrand" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="masterProductName">Product Name:</label>
                    <input type="text" id="masterProductName" required>
                </div>
                <div class="form-group">
                    <label for="masterWeeklyDemand">WK DEMAND:</label>
                    <input type="number" id="masterWeeklyDemand" min="0" required>
                </div>
                <div class="form-group">
                    <label for="description">Description:</label>
                    <textarea id="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="sku">Product Code (SKU):</label>
                    <input type="text" id="sku">
                </div>
                <div class="form-group">
                    <label for="price">Price:</label>
                    <input type="number" id="price" step="0.01" min="0">
                </div>
                <button type="submit">Save Master Product</button>
            </form>
        </div>
    </div>

    <div id="toClearModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('toClearModal')">&times;</span>
            <h2 id="toClearModalTitle">Add Product to Clear</h2>
            <form onsubmit="saveToClear(event)">
                <input type="hidden" id="editToClearId" value="">
                <div class="form-group">
                    <label for="toClearBrand">Brand:</label>
                    <select id="toClearBrand" required onchange="filterProductsForBrand(this.value, 'toClearProductName', 'toClearProductsDatalist')">
                        </select>
                </div>
                <div class="form-group">
                    <label for="toClearProductName">Product Name:</label>
                    <input type="text" id="toClearProductName" list="toClearProductsDatalist" required onchange="populateWeeklyDemand(this.value)">
                    <datalist id="toClearProductsDatalist"></datalist>
                </div>
                <div class="form-group">
                    <label for="toClearExpiryDate">Expiry Date:</label>
                    <input type="date" id="toClearExpiryDate" required>
                </div>
                <div class="form-group">
                    <label for="toClearFirstHighlightedDate">First Highlighted Date:</label>
                    <input type="date" id="toClearFirstHighlightedDate" required readonly>
                </div>
                <div class="form-group">
                    <label for="toClearFirstReportedBalance">First Reported Balance (Total Qty):</label>
                    <input type="number" id="toClearFirstReportedBalance" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearWarehouseQty">Warehouse Qty:</label>
                    <input type="number" id="toClearWarehouseQty" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearStoreQty">Store Qty:</label>
                    <input type="number" id="toClearStoreQty" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearWeeklyDemand">Weekly Demand:</label>
                    <input type="number" id="toClearWeeklyDemand" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearSupplyStatus">Supply Status:</label>
                    <select id="toClearSupplyStatus" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="toClearRemarks">Remarks:</label>
                    <textarea id="toClearRemarks"></textarea>
                </div>
                <div class="form-group">
                    <label for="toClearActionPlan">Action Plan:</label>
                    <textarea id="toClearActionPlan"></textarea>
                </div>
                <button type="submit">Save Product to Clear</button>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2>Confirmation</h2>
            <p id="confirmMessage"></p>
            <div class="modal-buttons">
                <button class="btn-danger" id="confirmNo">No</button>
                <button class="btn-success" id="confirmYes">Yes</button>
            </div>
        </div>
    </div>

    <div id="addBrandModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addBrandModal')">&times;</span>
            <h2>Add New Brand</h2>
            <form onsubmit="saveNewBrand(event)">
                <div class="form-group">
                    <label for="newBrandName">Brand Name:</label>
                    <input type="text" id="newBrandName" required>
                </div>
                <button type="submit">Add Brand</button>
            </form>
        </div>
    </div>

    <div id="addStatusModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addStatusModal')">&times;</span>
            <h2>Add New Status</h2>
            <form onsubmit="saveNewStatus(event)">
                <div class="form-group">
                    <label for="newStatusName">Status Name:</label>
                    <input type="text" id="newStatusName" required>
                </div>
                <button type="submit">Add Status</button>
            </form>
        </div>
    </div>

    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addCategory')">&times;</span>
            <h2>Add New Category</h2>
            <form onsubmit="saveNewCategory(event)">
                <div class="form-group">
                    <label for="newCategoryName">Category Name:</label>
                    <input type="text" id="newCategoryName" required>
                </div>
                <button type="submit">Add Category</button>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDo1-y0Vj4XTQeeEUQK_6Y2wqDs94TOAX0", // Replace with your actual API key
            authDomain: "inventory-c3bac.firebaseapp.com",
            projectId: "inventory-c3bac",
            storageBucket: "inventory-c3bac.appspot.com", // Corrected storage bucket
            messagingSenderId: "261015083855",
            appId: "1:261015083855:web:e167f359928eb8ed8cc33a",
            measurementId: "G-V744486L78"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global data arrays to hold fetched data
        let inventoryData = [];
        let newProductsData = [];
        let toClearData = [];
        let masterProductsData = [];
        let deletedItemsData = []; // For Recycle Bin
        let brandsData = [];
        let statusesData = [];
        let categoriesData = []; // Data for current views (used for filtering and sorting)
        let currentInventoryViewData = [];
        let currentNewProductsViewData = [];
        let currentToClearViewData = [];
        let currentMasterListViewData = [];
        let currentRecycleBinViewData = [];

        // Firestore collection references
        const inventoryColRef = db.collection('inventory');
        const newProductsColRef = db.collection('new_products');
        const toClearColRef = db.collection('to_clear');
        const masterProductsColRef = db.collection('master_products');
        const brandsColRef = db.collection('brands');
        const statusesColRef = db.collection('statuses');
        const categoriesColRef = db.collection('categories');

        // Sort state for tables
        let sortState = {
            inventory: { column: null, direction: 'asc' },
            newProducts: { column: null, direction: 'asc' },
            master: { column: null, direction: 'asc' },
            toClear: { column: null, direction: 'asc' },
            recycleBin: { column: null, direction: 'asc' }
        };

        // --- Notification System ---
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.classList.add('alert', `alert-${type}`);
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // --- Confirmation Modal ---
        let confirmCallback = null;
        function showConfirmModal(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').style.display = 'block';
            confirmCallback = callback;
        }

        document.getElementById('confirmYes').onclick = () => {
            if (confirmCallback) {
                confirmCallback(true);
            }
            document.getElementById('confirmModal').style.display = 'none';
        };

        document.getElementById('confirmNo').onclick = () => {
            if (confirmCallback) {
                confirmCallback(false);
            }
            document.getElementById('confirmModal').style.display = 'none';
        };

        // --- Firestore Data Operations ---
        async function fetchDataFromFirestore(collectionRef, includeDeleted = false) {
            let data = [];
            let query = collectionRef;

            // For main data collections, filter by isDeleted unless includeDeleted is true
            if (!includeDeleted && (collectionRef.id === 'inventory' || collectionRef.id === 'new_products' || collectionRef.id === 'to_clear' || collectionRef.id === 'master_products')) {
                query = collectionRef.where("isDeleted", "==", false);
            }

            // For auxiliary collections like brands, statuses, categories, assume they might not all have `isDeleted`
            // or we fetch all and filter client-side if necessary,
            try {
                const snapshot = await query.get();
                snapshot.forEach(doc => {
                    data.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error(`Error fetching data from ${collectionRef.id}:`, error);
                showNotification(`Error loading ${collectionRef.id} data.`, 'error');
            }
            return data;
        }

        async function updateLocalData() {
            try {
                inventoryData = await fetchDataFromFirestore(inventoryColRef);
                newProductsData = await fetchDataFromFirestore(newProductsColRef);
                toClearData = await fetchDataFromFirestore(toClearColRef);
                masterProductsData = await fetchDataFromFirestore(masterProductsColRef);
                deletedItemsData = await fetchDataFromFirestore(inventoryColRef, true); // Fetch all for recycle bin
                deletedItemsData = deletedItemsData.filter(item => item.isDeleted === true); // Filter deleted items

                brandsData = await fetchDataFromFirestore(brandsColRef);
                statusesData = await fetchDataFromFirestore(statusesColRef);
                categoriesData = await fetchDataFromFirestore(categoriesColRef);

                currentInventoryViewData = [...inventoryData];
                currentNewProductsViewData = [...newProductsData];
                currentToClearViewData = [...toClearData];
                currentMasterListViewData = [...masterProductsData];
                currentRecycleBinViewData = [...deletedItemsData];

                renderInventoryTable(currentInventoryViewData);
                renderNewProductsTable(currentNewProductsViewData);
                renderToClearTable(currentToClearViewData);
                renderMasterTable(currentMasterListViewData);
                renderRecycleBinTable(currentRecycleBinViewData);
                updateDashboardCounts();
                populateDropdowns();

                document.getElementById('last-updated').textContent = new Date().toLocaleString();

            } catch (error) {
                console.error("Error updating local data:", error);
                showNotification("Failed to load all data. Please refresh.", "error");
            }
        }

        async function updateProductStatusCount(statusType, countElementId) {
            const count = inventoryData.filter(item => item.status && item.status.toUpperCase() === statusType.toUpperCase()).length;
            document.getElementById(countElementId).textContent = count;
        }

        async function updateDashboardCounts() {
            await updateProductStatusCount('OUT OF STOCK', 'oos-count');
            await updateProductStatusCount('LOW STOCK', 'low-count');
            document.getElementById('new-count').textContent = newProductsData.length;
            document.getElementById('to-clear-count').textContent = toClearData.length;
            document.getElementById('total-products').textContent = inventoryData.length;
            document.getElementById('total-products-all').textContent = [...new Set([...inventoryData.map(item => item.sku), ...newProductsData.map(item => item.sku), ...masterProductsData.map(item => item.sku), ...toClearData.map(item => item.sku)])].length;
            renderAlerts();
        }

        // --- Tab Switching ---
        function switchTab(clickedTab, tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            clickedTab.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            // Reset search input and re-render the table for the switched tab
            resetAndRenderTab(tabId);
        }

        function resetAndRenderTab(tabId) {
            const searchInputMap = {
                'oos-lowstock': 'oosSearchInput',
                'new-products': 'newProductsSearchInput',
                'to-clear': 'toClearSearchInput',
                'master-list': 'masterListSearchInput',
                'recycle-bin': 'recycleBinSearchInput'
            };

            // Reset specific filter dropdowns if they exist
            if (tabId === 'oos-lowstock') {
                const filter = document.getElementById('oosLowStockFilter');
                if (filter) filter.value = "";
                filterInventoryByStatus(""); // Re-render with all statuses
            }

            const searchInputId = searchInputMap[tabId];
            if (searchInputId) {
                document.getElementById(searchInputId).value = '';
            }

            // Re-render based on tabId
            switch (tabId) {
                case 'oos-lowstock':
                    currentInventoryViewData = [...inventoryData];
                    renderInventoryTable(currentInventoryViewData);
                    break;
                case 'new-products':
                    currentNewProductsViewData = [...newProductsData];
                    renderNewProductsTable(currentNewProductsViewData);
                    break;
                case 'to-clear':
                    currentToClearViewData = [...toClearData];
                    renderToClearTable(currentToClearViewData);
                    break;
                case 'master-list':
                    currentMasterListViewData = [...masterProductsData];
                    renderMasterTable(currentMasterListViewData);
                    break;
                case 'recycle-bin':
                    currentRecycleBinViewData = [...deletedItemsData];
                    renderRecycleBinTable(currentRecycleBinViewData);
                    break;
            }
        }

        function switchTabAndFilter(tabId, filterValue) {
            const tabButton = document.querySelector(`.tab[onclick*='${tabId}']`);
            if (tabButton) {
                switchTab(tabButton, tabId);
                // Apply the filter after switching tab
                if (tabId === 'oos-lowstock') {
                    const filterDropdown = document.getElementById('oosLowStockFilter');
                    if (filterDropdown) {
                        filterDropdown.value = filterValue;
                        filterInventoryByStatus(filterValue);
                    }
                }
                // Add more filtering logic for other tabs if needed (e.g., 'new-products', 'to-clear')
                if (tabId === 'new-products' && filterValue === 'NEW PRODUCTS') {
                    // No specific filter needed for new products as the tab itself shows new products
                }
                 if (tabId === 'to-clear' && filterValue === 'TO CLEAR') {
                    // No specific filter needed for to-clear as the tab itself shows to-clear products
                }
            }
        }


        // --- Inventory Table (OOS/LOW STOCK) ---
        function renderInventoryTable(data) {
            const tableBody = document.getElementById('inventory-table');
            tableBody.innerHTML = '';
            data.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.sku || 'N/A'}</td>
                    <td>${item.brand || 'N/A'}</td>
                    <td>${item.product || 'N/A'}</td>
                    <td style="text-align: right;">${item.quantity || 0}</td>
                    <td><span class="status-badge ${item.status ? item.status.toLowerCase().replace(/\s/g, '-') : ''}">${item.status || 'N/A'}</span></td>
                    <td>${item.shipmentDate || 'N/A'}</td>
                    <td>${item.remarks || 'N/A'}</td>
                    <td>
                        <button class="btn-info" onclick="editProduct('${item.id}')">Edit</button>
                        <button class="btn-danger" onclick="deleteProduct('${item.id}')">Delete</button>
                    </td>
                `;
            });
        }

        function searchInventory(query) {
            const filteredData = inventoryData.filter(item =>
                (item.sku && item.sku.toLowerCase().includes(query.toLowerCase())) ||
                (item.brand && item.brand.toLowerCase().includes(query.toLowerCase())) ||
                (item.product && item.product.toLowerCase().includes(query.toLowerCase())) ||
                (item.status && item.status.toLowerCase().includes(query.toLowerCase()))
            );
            currentInventoryViewData = filteredData;
            renderInventoryTable(currentInventoryViewData);
        }

        function filterInventoryByStatus(status) {
            currentInventoryViewData = status ? inventoryData.filter(item => item.status && item.status.toUpperCase() === status.toUpperCase()) : [...inventoryData];
            renderInventoryTable(currentInventoryViewData);
        }

        async function saveProduct(event) {
            event.preventDefault();
            const id = document.getElementById('editProductId').value;
            const brand = document.getElementById('brand').value;
            const productName = document.getElementById('productName').value;
            const quantity = parseInt(document.getElementById('inventoryQuantity').value);
            const status = document.getElementById('status').value;
            const shipmentDate = document.getElementById('shipmentDate').value;
            const remarks = document.getElementById('remarks').value;

            // Get SKU from master list based on product name and brand
            const masterProduct = masterProductsData.find(mp => mp.product === productName && mp.brand === brand);
            const sku = masterProduct ? masterProduct.sku : '';

            const productData = {
                brand,
                product: productName,
                sku, // Include SKU
                quantity,
                status,
                shipmentDate,
                remarks,
                isDeleted: false // Ensure it's not marked as deleted
            };

            try {
                if (id) {
                    await inventoryColRef.doc(id).update(productData);
                    showNotification('Product updated successfully!', 'success');
                } else {
                    await inventoryColRef.add({ ...productData, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    showNotification('Product added successfully!', 'success');
                }
                closeModal('productModal');
                await updateLocalData();
            } catch (error) {
                console.error("Error saving product:", error);
                showNotification('Error saving product.', 'error');
            }
        }

        async function editProduct(id) {
            const product = inventoryData.find(item => item.id === id);
            if (product) {
                document.getElementById('productModalTitle').textContent = 'Edit Product';
                document.getElementById('editProductId').value = product.id;
                document.getElementById('brand').value = product.brand;
                // Trigger change to populate product datalist
                filterProductsForBrand(product.brand, 'productName', 'productsDatalist');
                document.getElementById('productName').value = product.product;
                document.getElementById('inventoryQuantity').value = product.quantity;
                document.getElementById('status').value = product.status;
                document.getElementById('shipmentDate').value = product.shipmentDate || '';
                document.getElementById('remarks').value = product.remarks || '';
                document.getElementById('productModal').style.display = 'block';
            }
        }

        async function deleteProduct(id) {
            showConfirmModal('Are you sure you want to move this product to the recycle bin?', async (confirmed) => {
                if (confirmed) {
                    try {
                        const productToDelete = inventoryData.find(item => item.id === id);
                        if (productToDelete) {
                            await inventoryColRef.doc(id).update({ isDeleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp(), originalCollection: 'inventory' });
                            showNotification('Product moved to recycle bin.', 'success');
                            await updateLocalData();
                        }
                    } catch (error) {
                        console.error("Error deleting product:", error);
                        showNotification('Error deleting product.', 'error');
                    }
                }
            });
        }


        // --- New Products Table ---
        function renderNewProductsTable(data) {
            const tableBody = document.getElementById('new-products-table');
            tableBody.innerHTML = '';
            data.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.sku || 'N/A'}</td>
                    <td>${item.brand || 'N/A'}</td>
                    <td>${item.product || 'N/A'}</td>
                    <td>${item.addedDate || 'N/A'}</td>
                    <td>${item.arrivalDate || 'N/A'}</td>
                    <td style="text-align: right;">${item.quantity || 0}</td>
                    <td>${item.notes || 'N/A'}</td>
                    <td>
                        <button class="btn-info" onclick="editNewProduct('${item.id}')">Edit</button>
                        <button class="btn-success" onclick="mergeNewProductToInventory('${item.id}')">Merge</button>
                        <button class="btn-danger" onclick="deleteNewProduct('${item.id}')">Delete</button>
                    </td>
                `;
            });
        }

        function searchNewProducts(query) {
            const filteredData = newProductsData.filter(item =>
                (item.sku && item.sku.toLowerCase().includes(query.toLowerCase())) ||
                (item.brand && item.brand.toLowerCase().includes(query.toLowerCase())) ||
                (item.product && item.product.toLowerCase().includes(query.toLowerCase()))
            );
            currentNewProductsViewData = filteredData;
            renderNewProductsTable(currentNewProductsViewData);
        }

        async function saveNewProduct(event) {
            event.preventDefault();
            const id = document.getElementById('editNewProductId').value;
            const brand = document.getElementById('newBrand').value;
            const sku = document.getElementById('newProductSku').value;
            const productName = document.getElementById('newProductName').value;
            const arrivalDate = document.getElementById('arrivalDate').value;
            const quantity = parseInt(document.getElementById('newProductQuantity').value);
            const notes = document.getElementById('notes').value;

            const productData = {
                brand,
                sku,
                product: productName,
                addedDate: new Date().toISOString().split('T')[0], // Automatically set today's date
                arrivalDate,
                quantity,
                notes,
                isDeleted: false
            };

            try {
                if (id) {
                    await newProductsColRef.doc(id).update(productData);
                    showNotification('New product updated successfully!', 'success');
                } else {
                    await newProductsColRef.add({ ...productData, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    showNotification('New product added successfully!', 'success');
                }
                closeModal('newProductModal');
                await updateLocalData();
            } catch (error) {
                console.error("Error saving new product:", error);
                showNotification('Error saving new product.', 'error');
            }
        }

        async function editNewProduct(id) {
            const product = newProductsData.find(item => item.id === id);
            if (product) {
                document.getElementById('newProductModalTitle').textContent = 'Edit New Product Entry';
                document.getElementById('editNewProductId').value = product.id;
                document.getElementById('newBrand').value = product.brand;
                document.getElementById('newProductSku').value = product.sku;
                // Trigger change to populate product datalist
                filterProductsForBrand(product.brand, 'newProductName', 'newProductsDatalist');
                document.getElementById('newProductName').value = product.product;
                document.getElementById('arrivalDate').value = product.arrivalDate;
                document.getElementById('newProductQuantity').value = product.quantity;
                document.getElementById('notes').value = product.notes || '';
                document.getElementById('newProductModal').style.display = 'block';
            }
        }

        async function mergeNewProductToInventory(id) {
            showConfirmModal('Are you sure you want to merge this product to the main inventory?', async (confirmed) => {
                if (confirmed) {
                    try {
                        const productToMerge = newProductsData.find(item => item.id === id);
                        if (productToMerge) {
                            const { id: _, addedDate, notes, isDeleted, ...inventoryItem } = productToMerge;
                            // Add to inventory, default status to 'In stock' for new items, shipmentDate to arrivalDate
                            await inventoryColRef.add({ ...inventoryItem, status: 'In stock', shipmentDate: productToMerge.arrivalDate, createdAt: firebase.firestore.FieldValue.serverTimestamp(), isDeleted: false });
                            await newProductsColRef.doc(id).update({ isDeleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp(), originalCollection: 'new_products' }); // Soft delete from new products
                            showNotification('Product merged to inventory successfully!', 'success');
                            await updateLocalData();
                        }
                    } catch (error) {
                        console.error("Error merging new product:", error);
                        showNotification('Error merging new product.', 'error');
                    }
                }
            });
        }

        async function mergeNewProductsToMaster() {
            showConfirmModal('Are you sure you want to merge ALL new products to the main inventory?', async (confirmed) => {
                if (confirmed) {
                    try {
                        const batch = db.batch();
                        newProductsData.forEach(productToMerge => {
                            const { id, addedDate, notes, isDeleted, ...inventoryItem } = productToMerge;
                            // Add to inventory, default status to 'In stock' for new items, shipmentDate to arrivalDate
                            batch.set(inventoryColRef.doc(), { ...inventoryItem, status: 'In stock', shipmentDate: productToMerge.arrivalDate, createdAt: firebase.firestore.FieldValue.serverTimestamp(), isDeleted: false });
                            batch.update(newProductsColRef.doc(id), { isDeleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp(), originalCollection: 'new_products' }); // Soft delete from new products
                        });
                        await batch.commit();
                        showNotification('All new products merged to inventory successfully!', 'success');
                        await updateLocalData();
                    } catch (error) {
                        console.error("Error merging all new products:", error);
                        showNotification('Error merging all new products.', 'error');
                    }
                }
            });
        }

        async function deleteNewProduct(id) {
            showConfirmModal('Are you sure you want to move this new product entry to the recycle bin?', async (confirmed) => {
                if (confirmed) {
                    try {
                        const productToDelete = newProductsData.find(item => item.id === id);
                        if (productToDelete) {
                            await newProductsColRef.doc(id).update({ isDeleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp(), originalCollection: 'new_products' });
                            showNotification('New product entry moved to recycle bin.', 'success');
                            await updateLocalData();
                        }
                    } catch (error) {
                        console.error("Error deleting new product:", error);
                        showNotification('Error deleting new product.', 'error');
                    }
                }
            });
        }


        // --- To Clear Table ---
        function renderToClearTable(data) {
            const tableBody = document.getElementById('to-clear-table');
            tableBody.innerHTML = '';
            data.forEach(item => {
                const row = tableBody.insertRow();
                const totalQty = (item.warehouseQty || 0) + (item.storeQty || 0);
                const weeksSupply = (item.weeklyDemand && item.weeklyDemand > 0) ? (totalQty / item.weeklyDemand).toFixed(1) : 'N/A';
                row.innerHTML = `
                    <td>${item.sku || 'N/A'}</td>
                    <td>${item.brand || 'N/A'}</td>
                    <td>${item.product || 'N/A'}</td>
                    <td>${item.expiryDate || 'N/A'}</td>
                    <td>${item.firstHighlightedDate || 'N/A'}</td>
                    <td style="text-align: right;">${item.firstReportedBalance || 0}</td>
                    <td style="text-align: right;">${item.warehouseQty || 0}</td>
                    <td style="text-align: right;">${item.storeQty || 0}</td>
                    <td style="text-align: right;">${totalQty}</td>
                    <td style="text-align: right;">${item.weeklyDemand || 0}</td>
                    <td style="text-align: right;">${weeksSupply}</td>
                    <td><span class="status-badge ${item.supplyStatus ? item.supplyStatus.toLowerCase().replace(/\s/g, '-') : ''}">${item.supplyStatus || 'N/A'}</span></td>
                    <td>${item.remarks || 'N/A'}</td>
                    <td>${item.actionPlan || 'N/A'}</td>
                    <td>
                        <button class="btn-info" onclick="editToClear('${item.id}')">Edit</button>
                        <button class="btn-danger" onclick="deleteToClear('${item.id}')">Delete</button>
                    </td>
                `;
            });
        }

        function searchToClear(query) {
            const filteredData = toClearData.filter(item =>
                (item.sku && item.sku.toLowerCase().includes(query.toLowerCase())) ||
                (item.brand && item.brand.toLowerCase().includes(query.toLowerCase())) ||
                (item.product && item.product.toLowerCase().includes(query.toLowerCase())) ||
                (item.supplyStatus && item.supplyStatus.toLowerCase().includes(query.toLowerCase()))
            );
            currentToClearViewData = filteredData;
            renderToClearTable(currentToClearViewData);
        }

        async function saveToClear(event) {
            event.preventDefault();
            const id = document.getElementById('editToClearId').value;
            const brand = document.getElementById('toClearBrand').value;
            const productName = document.getElementById('toClearProductName').value;
            const expiryDate = document.getElementById('toClearExpiryDate').value;
            const firstHighlightedDate = document.getElementById('toClearFirstHighlightedDate').value;
            const firstReportedBalance = parseInt(document.getElementById('toClearFirstReportedBalance').value) || 0;
            const warehouseQty = parseInt(document.getElementById('toClearWarehouseQty').value) || 0;
            const storeQty = parseInt(document.getElementById('toClearStoreQty').value) || 0;
            const weeklyDemand = parseInt(document.getElementById('toClearWeeklyDemand').value) || 0;
            const supplyStatus = document.getElementById('toClearSupplyStatus').value;
            const actionPlan = document.getElementById('toClearActionPlan').value;
            const remarks = document.getElementById('toClearRemarks').value; // Get remarks

            const masterProduct = masterProductsData.find(mp => mp.product === productName && mp.brand === brand);
            const sku = masterProduct ? masterProduct.sku : '';

            const productData = {
                brand,
                product: productName,
                sku,
                expiryDate,
                firstHighlightedDate,
                firstReportedBalance,
                warehouseQty,
                storeQty,
                weeklyDemand,
                supplyStatus,
                actionPlan,
                remarks, // Save remarks
                isDeleted: false
            };

            try {
                if (id) {
                    await toClearColRef.doc(id).update(productData);
                    showNotification('Product to clear updated successfully!', 'success');
                } else {
                    await toClearColRef.add({ ...productData, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    showNotification('Product to clear added successfully!', 'success');
                }
                closeModal('toClearModal');
                await updateLocalData();
            } catch (error) {
                console.error("Error saving product to clear:", error);
                showNotification('Error saving product to clear.', 'error');
            }
        }

        async function editToClear(id) {
            const product = toClearData.find(item => item.id === id);
            if (product) {
                document.getElementById('toClearModalTitle').textContent = 'Edit Product to Clear';
                document.getElementById('editToClearId').value = product.id;
                document.getElementById('toClearBrand').value = product.brand;
                filterProductsForBrand(product.brand, 'toClearProductName', 'toClearProductsDatalist');
                document.getElementById('toClearProductName').value = product.product;
                document.getElementById('toClearExpiryDate').value = product.expiryDate || '';
                document.getElementById('toClearFirstHighlightedDate').value = product.firstHighlightedDate || new Date().toISOString().split('T')[0];
                document.getElementById('toClearFirstReportedBalance').value = product.firstReportedBalance || 0;
                document.getElementById('toClearWarehouseQty').value = product.warehouseQty || 0;
                document.getElementById('toClearStoreQty').value = product.storeQty || 0;
                document.getElementById('toClearWeeklyDemand').value = product.weeklyDemand || 0;
                document.getElementById('toClearSupplyStatus').value = product.supplyStatus || '';
                document.getElementById('toClearActionPlan').value = product.actionPlan || '';
                document.getElementById('toClearRemarks').value = product.remarks || ''; // Populate remarks
                document.getElementById('toClearModal').style.display = 'block';
            }
        }

        async function deleteToClear(id) {
            showConfirmModal('Are you sure you want to move this "To Clear" product to the recycle bin?', async (confirmed) => {
                if (confirmed) {
                    try {
                        const productToDelete = toClearData.find(item => item.id === id);
                        if (productToDelete) {
                            await toClearColRef.doc(id).update({ isDeleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp(), originalCollection: 'to_clear' });
                            showNotification('"To Clear" product moved to recycle bin.', 'success');
                            await updateLocalData();
                        }
                    } catch (error) {
                        console.error("Error deleting to clear product:", error);
                        showNotification('Error deleting "To Clear" product.', 'error');
                    }
                }
            });
        }


        // --- Master List Table ---
        function renderMasterTable(data) {
            const tableBody = document.getElementById('master-table');
            tableBody.innerHTML = '';
            data.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.sku || 'N/A'}</td>
                    <td>${item.brand || 'N/A'}</td>
                    <td>${item.product || 'N/A'}</td>
                    <td>${item.weeklyDemand || 0}</td> <td>${item.description || 'N/A'}</td>
                    <td style="text-align: right;">${item.price ? item.price.toFixed(2) : '0.00'}</td>
                    <td>
                        <button class="btn-info" onclick="editMasterProduct('${item.id}')">Edit</button>
                        <button class="btn-danger" onclick="deleteMasterProduct('${item.id}')">Delete</button>
                    </td>
                `;
            });
        }

        function searchMasterList(query) {
            const filteredData = masterProductsData.filter(item =>
                (item.sku && item.sku.toLowerCase().includes(query.toLowerCase())) ||
                (item.brand && item.brand.toLowerCase().includes(query.toLowerCase())) ||
                (item.product && item.product.toLowerCase().includes(query.toLowerCase())) ||
                (item.description && item.description.toLowerCase().includes(query.toLowerCase()))
            );
            currentMasterListViewData = filteredData;
            renderMasterTable(currentMasterListViewData);
        }

        async function saveMasterProduct(event) {
            event.preventDefault();
            const id = document.getElementById('editMasterProductId').value;
            const brand = document.getElementById('masterBrand').value;
            const productName = document.getElementById('masterProductName').value;
            const weeklyDemand = parseInt(document.getElementById('masterWeeklyDemand').value) || 0; // Changed from category
            const description = document.getElementById('description').value;
            const sku = document.getElementById('sku').value;
            const price = parseFloat(document.getElementById('price').value) || 0;

            const productData = {
                brand,
                product: productName,
                weeklyDemand, // Changed from category
                description,
                sku,
                price,
                isDeleted: false
            };

            try {
                if (id) {
                    await masterProductsColRef.doc(id).update(productData);
                    showNotification('Master product updated successfully!', 'success');
                } else {
                    await masterProductsColRef.add({ ...productData, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    showNotification('Master product added successfully!', 'success');
                }
                closeModal('masterProductModal');
                await updateLocalData();
            } catch (error) {
                console.error("Error saving master product:", error);
                showNotification('Error saving master product.', 'error');
            }
        }

        async function editMasterProduct(id) {
            const product = masterProductsData.find(item => item.id === id);
            if (product) {
                document.getElementById('masterProductModalTitle').textContent = 'Edit Master Product';
                document.getElementById('editMasterProductId').value = product.id;
                document.getElementById('masterBrand').value = product.brand;
                document.getElementById('masterProductName').value = product.product;
                document.getElementById('masterWeeklyDemand').value = product.weeklyDemand || 0; // Changed from category
                document.getElementById('description').value = product.description || '';
                document.getElementById('sku').value = product.sku || '';
                document.getElementById('price').value = product.price || 0;
                document.getElementById('masterProductModal').style.display = 'block';
            }
        }

        async function deleteMasterProduct(id) {
            showConfirmModal('Are you sure you want to move this master product to the recycle bin?', async (confirmed) => {
                if (confirmed) {
                    try {
                        const productToDelete = masterProductsData.find(item => item.id === id);
                        if (productToDelete) {
                            await masterProductsColRef.doc(id).update({ isDeleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp(), originalCollection: 'master_products' });
                            showNotification('Master product moved to recycle bin.', 'success');
                            await updateLocalData();
                        }
                    } catch (error) {
                        console.error("Error deleting master product:", error);
                        showNotification('Error deleting master product.', 'error');
                    }
                }
            });
        }


        // --- Recycle Bin Table ---
        function renderRecycleBinTable(data) {
            const tableBody = document.getElementById('recycle-bin-table');
            tableBody.innerHTML = '';
            data.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.sku || 'N/A'}</td>
                    <td>${item.originalCollection || 'N/A'}</td>
                    <td>${item.brand || 'N/A'}</td>
                    <td>${item.product || 'N/A'}</td>
                    <td>
                        <button class="btn-success" onclick="restoreFromRecycleBin('${item.id}', '${item.originalCollection}')">Restore</button>
                        <button class="btn-danger" onclick="permanentlyDelete('${item.id}', '${item.originalCollection}')">Permanently Delete</button>
                    </td>
                `;
            });
        }

        function searchRecycleBin(query) {
            const filteredData = deletedItemsData.filter(item =>
                (item.sku && item.sku.toLowerCase().includes(query.toLowerCase())) ||
                (item.brand && item.brand.toLowerCase().includes(query.toLowerCase())) ||
                (item.product && item.product.toLowerCase().includes(query.toLowerCase())) ||
                (item.originalCollection && item.originalCollection.toLowerCase().includes(query.toLowerCase()))
            );
            currentRecycleBinViewData = filteredData;
            renderRecycleBinTable(currentRecycleBinViewData);
        }

        async function restoreFromRecycleBin(id, originalCollection) {
            showConfirmModal('Are you sure you want to restore this item?', async (confirmed) => {
                if (confirmed) {
                    try {
                        let collectionRef;
                        if (originalCollection === 'inventory') collectionRef = inventoryColRef;
                        else if (originalCollection === 'new_products') collectionRef = newProductsColRef;
                        else if (originalCollection === 'to_clear') collectionRef = toClearColRef;
                        else if (originalCollection === 'master_products') collectionRef = masterProductsColRef;

                        if (collectionRef) {
                            await collectionRef.doc(id).update({ isDeleted: false, deletedAt: firebase.firestore.FieldValue.delete(), originalCollection: firebase.firestore.FieldValue.delete() });
                            showNotification('Item restored successfully!', 'success');
                            await updateLocalData();
                        } else {
                            showNotification('Could not determine original collection for restore.', 'error');
                        }
                    } catch (error) {
                        console.error("Error restoring item:", error);
                        showNotification('Error restoring item.', 'error');
                    }
                }
            });
        }

        async function permanentlyDelete(id, originalCollection) {
            showConfirmModal('WARNING: This action cannot be undone. Are you sure you want to permanently delete this item?', async (confirmed) => {
                if (confirmed) {
                    try {
                        let collectionRef;
                        if (originalCollection === 'inventory') collectionRef = inventoryColRef;
                        else if (originalCollection === 'new_products') collectionRef = newProductsColRef;
                        else if (originalCollection === 'to_clear') collectionRef = toClearColRef;
                        else if (originalCollection === 'master_products') collectionRef = masterProductsColRef;

                        if (collectionRef) {
                            await collectionRef.doc(id).delete();
                            showNotification('Item permanently deleted.', 'success');
                            await updateLocalData();
                        } else {
                            showNotification('Could not determine original collection for permanent delete.', 'error');
                        }
                    } catch (error) {
                        console.error("Error permanently deleting item:", error);
                        showNotification('Error permanently deleting item.', 'error');
                    }
                }
            });
        }

        async function emptyRecycleBin() {
            if (deletedItemsData.length === 0) {
                showNotification('Recycle Bin is already empty.', 'info');
                return;
            }
            showConfirmModal('Are you sure you want to permanently empty the recycle bin? This action cannot be undone.', async (confirmed) => {
                if (confirmed) {
                    try {
                        const batch = db.batch();
                        for (const item of deletedItemsData) {
                            let collectionRef;
                            if (item.originalCollection === 'inventory') collectionRef = inventoryColRef;
                            else if (item.originalCollection === 'new_products') collectionRef = newProductsColRef;
                            else if (item.originalCollection === 'to_clear') collectionRef = toClearColRef;
                            else if (item.originalCollection === 'master_products') collectionRef = masterProductsColRef;

                            if (collectionRef) {
                                batch.delete(collectionRef.doc(item.id));
                            }
                        }
                        await batch.commit();
                        showNotification('Recycle Bin emptied permanently!', 'success');
                        await updateLocalData();
                    } catch (error) {
                        console.error("Error emptying recycle bin:", error);
                        showNotification('Error emptying recycle bin.', 'error');
                    }
                }
            });
        }

        // --- Modals ---
        function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('editProductId').value = '';
            document.getElementById('brand').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('inventoryQuantity').value = '';
            document.getElementById('status').value = '';
            document.getElementById('shipmentDate').value = ''; // Reset shipment date
            document.getElementById('remarks').value = '';
            populateBrandDropdown('brand');
            populateStatusDropdown('status'); // Re-populate statuses
            document.getElementById('productModal').style.display = 'block';
        }

        function showAddNewProductModal() {
            document.getElementById('newProductModalTitle').textContent = 'Add New Product Entry';
            document.getElementById('editNewProductId').value = '';
            document.getElementById('newBrand').value = '';
            document.getElementById('newProductSku').value = '';
            document.getElementById('newProductName').value = '';
            document.getElementById('arrivalDate').value = '';
            document.getElementById('newProductQuantity').value = '';
            document.getElementById('notes').value = '';
            populateBrandDropdown('newBrand');
            document.getElementById('newProductModal').style.display = 'block';
        }

        function showAddMasterProductModal() {
            document.getElementById('masterProductModalTitle').textContent = 'Add Master Product';
            document.getElementById('editMasterProductId').value = '';
            document.getElementById('masterBrand').value = '';
            document.getElementById('masterProductName').value = '';
            document.getElementById('masterWeeklyDemand').value = ''; // Changed from category
            document.getElementById('description').value = '';
            document.getElementById('sku').value = '';
            document.getElementById('price').value = '';
            populateBrandDropdown('masterBrand');
            // No category dropdown to populate anymore
            document.getElementById('masterProductModal').style.display = 'block';
        }

        function showAddToClearModal() {
            document.getElementById('toClearModalTitle').textContent = 'Add Product to Clear';
            document.getElementById('editToClearId').value = '';
            document.getElementById('toClearBrand').value = '';
            document.getElementById('toClearProductName').value = '';
            // No category dropdown to populate anymore
            document.getElementById('toClearExpiryDate').value = '';
            document.getElementById('toClearFirstHighlightedDate').value = new Date().toISOString().split('T')[0]; // Set default to today
            document.getElementById('toClearFirstReportedBalance').value = '';
            document.getElementById('toClearWarehouseQty').value = '';
            document.getElementById('toClearStoreQty').value = '';
            document.getElementById('toClearWeeklyDemand').value = '';
            document.getElementById('toClearSupplyStatus').value = '';
            document.getElementById('toClearActionPlan').value = '';
            document.getElementById('toClearRemarks').value = ''; // Reset remarks
            populateBrandDropdown('toClearBrand');
            populateSupplyStatusDropdown('toClearSupplyStatus');
            document.getElementById('toClearModal').style.display = 'block';
        }


        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        // --- Dropdown Populators ---
        function populateDropdown(dropdownId, dataArray, valueKey, textKey, defaultOptionText, clearExisting = true, excludeValue = null) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;

            if (clearExisting) {
                dropdown.innerHTML = `<option value="">${defaultOptionText}</option>`;
            }

            dataArray.forEach(item => {
                if (item[valueKey] !== excludeValue) {
                    const option = document.createElement('option');
                    option.value = item[valueKey];
                    option.textContent = item[textKey];
                    dropdown.appendChild(option);
                }
            });
        }

        function populateBrandDropdown(id) {
            populateDropdown(id, brandsData, 'name', 'name', 'Select Brand');
        }

        function populateStatusDropdown(id) {
            // Exclude "In stock" from the status dropdown for OOS/LOW STOCK tab
            populateDropdown(id, statusesData, 'name', 'name', 'Select Status', true, 'In stock');
        }
        function populateSupplyStatusDropdown(id) {
            populateDropdown(id, statusesData, 'name', 'name', 'Select Supply Status');
        }

        function populateCategoryDropdown(id) {
            populateDropdown(id, categoriesData, 'name', 'name', 'Select Category');
        }

        function populateDropdowns() {
            populateBrandDropdown('brand'); // For inventory product modal
            populateBrandDropdown('newBrand'); // For new product modal
            populateBrandDropdown('masterBrand'); // For master product modal
            populateBrandDropdown('toClearBrand'); // For to clear product modal

            populateStatusDropdown('status'); // For inventory status
            populateSupplyStatusDropdown('toClearSupplyStatus'); // For to clear supply status
            // No longer populate category dropdown as it's removed
        }

        // --- Datalist Filtering for Product Names based on Brand ---
        function filterProductsForBrand(brand, productInputId, datalistId) {
            const productDatalist = document.getElementById(datalistId);
            productDatalist.innerHTML = '';
            const uniqueProducts = new Set(); // Use a Set to store unique product names

            masterProductsData.filter(mp => mp.brand === brand).forEach(mp => {
                if (!uniqueProducts.has(mp.product)) {
                    const option = document.createElement('option');
                    option.value = mp.product;
                    productDatalist.appendChild(option);
                    uniqueProducts.add(mp.product);
                }
            });
        }

        // Auto-populate Weekly Demand for 'To Clear' product based on Master List
        function populateWeeklyDemand(productName) {
            const selectedBrand = document.getElementById('toClearBrand').value;
            const masterProduct = masterProductsData.find(mp => mp.product === productName && mp.brand === selectedBrand);
            if (masterProduct && masterProduct.weeklyDemand !== undefined) {
                document.getElementById('toClearWeeklyDemand').value = masterProduct.weeklyDemand;
            } else {
                document.getElementById('toClearWeeklyDemand').value = 0; // Or empty, depending on desired behavior
            }
        }


        // --- Sorting ---
        function sortTable(tableKey, columnKey) {
            let column = sortState[tableKey].column;
            let direction = sortState[tableKey].direction;

            if (column === columnKey) {
                direction = (direction === 'asc') ? 'desc' : 'asc';
            } else {
                column = columnKey;
                direction = 'asc';
            }

            sortState[tableKey] = { column, direction };
            updateSortIndicators(tableKey);

            let dataToSort;
            let renderFunction;

            switch (tableKey) {
                case 'inventory':
                    dataToSort = currentInventoryViewData;
                    renderFunction = renderInventoryTable;
                    break;
                case 'newProducts':
                    dataToSort = currentNewProductsViewData;
                    renderFunction = renderNewProductsTable;
                    break;
                case 'toClear':
                    dataToSort = currentToClearViewData;
                    renderFunction = renderToClearTable;
                    break;
                case 'master':
                    dataToSort = currentMasterListViewData;
                    renderFunction = renderMasterTable;
                    break;
                case 'recycleBin':
                    dataToSort = currentRecycleBinViewData;
                    renderFunction = renderRecycleBinTable;
                    break;
                default:
                    return;
            }

            dataToSort.sort((a, b) => {
                const valA = a[column] === undefined || a[column] === null ? '' : String(a[column]).toLowerCase();
                const valB = b[column] === undefined || b[column] === null ? '' : String(b[column]).toLowerCase();

                // Special handling for numeric columns
                if (['quantity', 'price', 'firstReportedBalance', 'warehouseQty', 'storeQty', 'totalQty', 'weeklyDemand', 'weeksSupply'].includes(column)) {
                    const numA = parseFloat(a[column]) || 0;
                    const numB = parseFloat(b[column]) || 0;
                    return direction === 'asc' ? numA - numB : numB - numA;
                }
                // Special handling for date columns
                else if (['addedDate', 'arrivalDate', 'expiryDate', 'firstHighlightedDate', 'shipmentDate'].includes(column)) {
                    const dateA = a[column] ? new Date(a[column]).getTime() : 0;
                    const dateB = b[column] ? new Date(b[column]).getTime() : 0;
                    return direction === 'asc' ? dateA - dateB : dateB - dateA;
                }

                // Default string comparison
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });

            renderFunction(dataToSort);
        }

        function updateSortIndicators(tableKey) {
            const tableContainer = document.getElementById(`${tableKey}-table-container`);
            if (!tableContainer) return;

            tableContainer.querySelectorAll('.sort-arrow').forEach(span => span.textContent = '');

            const currentColumn = sortState[tableKey].column;
            const currentDirection = sortState[tableKey].direction;

            if (currentColumn) {
                const th = tableContainer.querySelector(`th[data-column-key="${currentColumn}"]`);
                if (th) {
                    const arrowSpan = th.querySelector('.sort-arrow');
                    if (arrowSpan) {
                        arrowSpan.textContent = currentDirection === 'asc' ? ' ▲' : ' ▼';
                    }
                }
            }
        }

        // --- Alerts ---
        function renderAlerts() {
            const alertsContainer = document.getElementById('alerts');
            alertsContainer.innerHTML = '';
            let hasAlerts = false;

            // Out of Stock alerts
            const oosProducts = inventoryData.filter(item => item.status && item.status.toUpperCase() === 'OUT OF STOCK');
            if (oosProducts.length > 0) {
                hasAlerts = true;
                const ul = document.createElement('ul');
                ul.innerHTML = '<strong>Out of Stock Products:</strong>';
                oosProducts.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.product} (${p.sku})`;
                    ul.appendChild(li);
                });
                alertsContainer.appendChild(ul);
            }

            // Low Stock alerts (e.g., quantity < 5)
            const lowStockProducts = inventoryData.filter(item => item.status && item.status.toUpperCase() === 'LOW STOCK' && item.quantity < 5); // Example threshold
            if (lowStockProducts.length > 0) {
                hasAlerts = true;
                const ul = document.createElement('ul');
                ul.innerHTML = '<strong>Low Stock Products:</strong>';
                lowStockProducts.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.product} (${p.sku}) - Qty: ${p.quantity}`;
                    ul.appendChild(li);
                });
                alertsContainer.appendChild(ul);
            }

            // To Clear alerts (e.g., expiring soon, low weeks supply)
            const today = new Date();
            const threeMonthsLater = new Date();
            threeMonthsLater.setMonth(today.getMonth() + 3);

            const expiringSoon = toClearData.filter(item => item.expiryDate && new Date(item.expiryDate) < threeMonthsLater && new Date(item.expiryDate) >= today);
            if (expiringSoon.length > 0) {
                hasAlerts = true;
                const ul = document.createElement('ul');
                ul.innerHTML = '<strong>Products Expiring Soon (within 3 months):</strong>';
                expiringSoon.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.product} (${p.sku}) - Expires: ${p.expiryDate}`;
                    ul.appendChild(li);
                });
                alertsContainer.appendChild(ul);
            }

            const lowWeeksSupply = toClearData.filter(item => {
                const totalQty = (item.warehouseQty || 0) + (item.storeQty || 0);
                if (item.weeklyDemand && item.weeklyDemand > 0) {
                    const weeksSupply = totalQty / item.weeklyDemand;
                    return weeksSupply < 2; // Example threshold: less than 2 weeks supply
                }
                return false;
            });

            if (lowWeeksSupply.length > 0) {
                hasAlerts = true;
                const ul = document.createElement('ul');
                ul.innerHTML = '<strong>Products with Low Weeks Supply (< 2 weeks):</strong>';
                lowWeeksSupply.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.product} (${p.sku}) - Wks Supply: ${(p.warehouseQty + p.storeQty) / p.weeklyDemand.toFixed(1)}`;
                    ul.appendChild(li);
                });
                alertsContainer.appendChild(ul);
            }


            if (!hasAlerts) {
                alertsContainer.innerHTML = '<p>No new alerts at the moment. All good!</p>';
            }
        }

        // --- Data Import/Export ---
        async function exportAllData() {
            const dataToExport = {
                inventory: inventoryData,
                newProducts: newProductsData,
                toClear: toClearData,
                masterProducts: masterProductsData,
                deletedItems: deletedItemsData,
                brands: brandsData,
                statuses: statusesData,
                categories: categoriesData // Include categories
            };

            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_system_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('All data exported successfully!', 'success');
        }

        function confirmLoadSampleData() {
            showConfirmModal('Loading sample data will overwrite your current data. Are you sure?', async (confirmed) => {
                if (confirmed) {
                    await loadSampleData();
                }
            });
        }

        async function loadSampleData() {
            const sampleBrands = [
                { name: "BrandX" },
                { name: "BrandY" },
                { name: "BrandZ" }
            ];
            const sampleStatuses = [
                { name: "In stock" },
                { name: "Low stock" },
                { name: "Out of Stock" }
            ];
            const sampleCategories = [
                { name: "Electronics" },
                { name: "Apparel" },
                { name: "Home Goods" }
            ];
            const sampleMasterProducts = [
                { brand: "BrandX", product: "Laptop Pro", weeklyDemand: 50, description: "High performance laptop", sku: "LP-001", price: 1200.00, isDeleted: false },
                { brand: "BrandX", product: "Mechanical Keyboard", weeklyDemand: 20, description: "Gaming keyboard with RGB", sku: "MK-005", price: 90.00, isDeleted: false },
                { brand: "BrandY", product: "Wireless Mouse", weeklyDemand: 30, description: "Ergonomic wireless mouse", sku: "WM-010", price: 25.00, isDeleted: false },
                { brand: "BrandZ", product: "Smartwatch Elite", weeklyDemand: 15, description: "Fitness tracker with heart rate monitor", sku: "SW-020", price: 150.00, isDeleted: false }
            ];
            const sampleInventory = [
                { brand: "BrandX", product: "Laptop Pro", sku: "LP-001", quantity: 10, status: "In stock", shipmentDate: "", remarks: "", isDeleted: false },
                { brand: "BrandY", product: "Wireless Mouse", sku: "WM-010", quantity: 2, status: "Low stock", shipmentDate: "", remarks: "Reorder soon", isDeleted: false },
                { brand: "BrandX", product: "Mechanical Keyboard", sku: "MK-005", quantity: 0, status: "Out of Stock", shipmentDate: "2025-06-15", remarks: "Backordered", isDeleted: false }
            ];
            const sampleNewProducts = [
                { brand: "BrandZ", product: "VR Headset", sku: "VR-001", addedDate: "2025-05-20", arrivalDate: "2025-06-25", quantity: 5, notes: "New model launch", isDeleted: false }
            ];
            const sampleToClear = [
                { brand: "BrandY", product: "Old Model Tablet", sku: "OMT-001", expiryDate: "2025-07-30", firstHighlightedDate: "2025-04-01", firstReportedBalance: 50, warehouseQty: 20, storeQty: 10, weeklyDemand: 5, supplyStatus: "Excess", actionPlan: "Promote sales", remarks: "Discontinued model", isDeleted: false }
            ];

            try {
                // Clear existing data (soft delete by marking as deleted)
                const collectionsToClear = [inventoryColRef, newProductsColRef, toClearColRef, masterProductsColRef, brandsColRef, statusesColRef, categoriesColRef];
                for (const colRef of collectionsToClear) {
                    const snapshot = await colRef.get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        if (colRef.id === 'inventory' || colRef.id === 'new_products' || colRef.id === 'to_clear' || colRef.id === 'master_products') {
                            batch.update(doc.ref, { isDeleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp(), originalCollection: colRef.id });
                        } else {
                            batch.delete(doc.ref); // Permanently delete brands, statuses, categories
                        }
                    });
                    await batch.commit();
                }

                // Add sample data
                const batch = db.batch();
                sampleBrands.forEach(item => batch.set(brandsColRef.doc(), item));
                sampleStatuses.forEach(item => batch.set(statusesColRef.doc(), item));
                sampleCategories.forEach(item => batch.set(categoriesColRef.doc(), item));
                sampleMasterProducts.forEach(item => batch.set(masterProductsColRef.doc(), { ...item, createdAt: firebase.firestore.FieldValue.serverTimestamp() }));
                sampleInventory.forEach(item => batch.set(inventoryColRef.doc(), { ...item, createdAt: firebase.firestore.FieldValue.serverTimestamp() }));
                sampleNewProducts.forEach(item => batch.set(newProductsColRef.doc(), { ...item, createdAt: firebase.firestore.FieldValue.serverTimestamp() }));
                sampleToClear.forEach(item => batch.set(toClearColRef.doc(), { ...item, createdAt: firebase.firestore.FieldValue.serverTimestamp() }));

                await batch.commit();
                showNotification('Sample data loaded successfully!', 'success');
                await updateLocalData(); // Refresh UI with new data
            } catch (error) {
                console.error("Error loading sample data:", error);
                showNotification('Error loading sample data.', 'error');
            }
        }

        // CSV Import for Master List
        async function importCSV(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');

                if (lines.length === 0) {
                    showNotification('CSV file is empty.', 'error');
                    return;
                }

                // Assuming the first line is the header
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const requiredHeaders = ['Product Code (SKU)', 'Brand', 'Product Name', 'WK DEMAND', 'Description', 'Price'];
                const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));

                if (missingHeaders.length > 0) {
                    showNotification(`Missing required CSV headers: ${missingHeaders.join(', ')}`, 'error');
                    return;
                }

                const productsToImport = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    if (values.length !== headers.length) {
                        console.warn(`Skipping malformed row: ${lines[i]}`);
                        continue;
                    }
                    const product = {};
                    headers.forEach((header, index) => {
                        let value = values[index];
                        // Map CSV headers to internal data keys
                        if (header === 'Product Code (SKU)') product.sku = value;
                        else if (header === 'Brand') product.brand = value;
                        else if (header === 'Product Name') product.product = value;
                        else if (header === 'WK DEMAND') product.weeklyDemand = parseInt(value) || 0;
                        else if (header === 'Description') product.description = value;
                        else if (header === 'Price') product.price = parseFloat(value) || 0;
                    });
                    product.isDeleted = false;
                    productsToImport.push(product);
                }

                if (productsToImport.length === 0) {
                    showNotification('No valid products found in CSV to import.', 'error');
                    return;
                }

                showConfirmModal(`Importing this CSV will add ${productsToImport.length} products to your Master List. Continue?`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const batch = db.batch();
                            let newBrands = new Set(brandsData.map(b => b.name));

                            for (const product of productsToImport) {
                                // Add product to master_products
                                batch.set(masterProductsColRef.doc(), { ...product, createdAt: firebase.firestore.FieldValue.serverTimestamp() });

                                // Collect new brands to add
                                if (product.brand && !newBrands.has(product.brand)) {
                                    batch.set(brandsColRef.doc(), { name: product.brand });
                                    newBrands.add(product.brand);
                                }
                            }
                            await batch.commit();
                            showNotification('Master list imported successfully!', 'success');
                            await updateLocalData(); // Refresh UI
                        } catch (error) {
                            console.error("Error importing CSV:", error);
                            showNotification('Error importing CSV.', 'error');
                        }
                    }
                });
            };
            reader.readAsText(file);
            // Reset the file input to allow re-importing the same file
            event.target.value = '';
        }

        // Load JSZip dynamically for export functionality
        function loadJSZipAndInitialize() {
            if (typeof JSZip === 'undefined') {
                const script = document.createElement('script');
                script.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
                script.onload = initializeApp;
                script.onerror = () => {
                    console.error("Failed to load JSZip. Export all data may not work.");
                    initializeApp(); 
                };
                document.head.appendChild(script);
            } else {
                initializeApp();
            }
        }

        async function initializeApp() {
            await updateLocalData();
            // Set the Dashboard tab as active on initial load
            const dashboardTabButton = document.querySelector('.tab[onclick*="dashboard"]');
            const dashboardContent = document.getElementById('dashboard');

            // Deactivate all tabs and content first
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (dashboardTabButton && dashboardContent) {
                dashboardTabButton.classList.add('active');
                dashboardContent.classList.add('active');
            } else { // Fallback
                const firstTab = document.querySelector('.tab');
                const firstContent = document.querySelector('.tab-content');
                if(firstTab) firstTab.classList.add('active');
                if(firstContent) firstContent.classList.add('active');
            }
            
            Object.keys(sortState).forEach(tableKey => updateSortIndicators(tableKey));
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', loadJSZipAndInitialize);

    </script>
    </body>
</html>
