<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-radius: 15px;
        }

        /* Headings */
        h1 {
            color: #2c3e50;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
            overflow-x: auto;
            gap: 2px;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            background-color: transparent;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #7f8c8d;
            min-width: 120px;
            text-align: center;
            border: 2px solid transparent;
            border-bottom: none;
        }

        .tab:hover {
            background-color: #f8f9fa;
            color: #2c3e50;
            border-color: #e1e8ed;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Stats Cards for Dashboard */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.urgent {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .stat-card.good {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            line-height: 1;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Controls (Buttons, Search) */
        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 15px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e1e8ed;
        }

        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        th, td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .oos {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .low {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .normal {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        /* Buttons */
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        /* Search Box */
        .search-box {
            padding: 12px 16px;
            width: 280px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: none;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        /* Form Group */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        /* Alert Notifications */
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 600;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Confirmation Modal Specific Styles */
        #confirmModal .modal-content {
            text-align: center;
            padding: 40px;
            max-width: 450px;
        }

        #confirmModal .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        #confirmModal .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        #confirmModal .modal-buttons button {
            flex: 1;
            max-width: 150px;
            padding: 12px 25px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Inventory Management System</h1>
        <p class="subtitle">Professional Inventory Tracking & Management Solution</p>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</div>
            <div class="tab" onclick="switchTab('inventory')">üì¶ Inventory</div>
            <div class="tab" onclick="switchTab('new-products')">‚ú® New Products</div>
            <div class="tab" onclick="switchTab('to-clear')">üè∑Ô∏è To Clear</div>
            <div class="tab" onclick="switchTab('master-list')">üìã Master List</div>
            <div class="tab" onclick="switchTab('recycle-bin')">üóëÔ∏è Recycle Bin</div>
            <div class="tab" onclick="switchTab('management')">‚öôÔ∏è Management</div>
        </div>
        
        <div id="dashboard" class="tab-content active">
            <div class="stats-cards">
                <div class="stat-card urgent" onclick="showFilteredInventory('OOS')">
                    <div class="stat-number" id="oos-count">0</div>
                    <div class="stat-label">Out of Stock</div>
                </div>
                <div class="stat-card warning" onclick="showFilteredInventory('Low stock')">
                    <div class="stat-number" id="low-count">0</div>
                    <div class="stat-label">Low Stock</div>
                </div>
                <div class="stat-card good" onclick="showFilteredInventory('In Stock')">
                    <div class="stat-number" id="in-stock-count">0</div>
                    <div class="stat-label">In Stock</div>
                </div>
                <div class="stat-card info" onclick="switchTab('new-products')">
                    <div class="stat-number" id="new-count">0</div>
                    <div class="stat-label">New Products</div>
                </div>
            </div>
            
            <h3>Recent Alerts</h3>
            <div id="alerts" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                <p>Loading alerts...</p>
            </div>
        </div>
        
        <div id="inventory" class="tab-content">
            <div class="controls">
                <button onclick="showAddProductModal()">‚ûï Add Product</button>
                <input type="text" class="search-box" placeholder="üîç Search products..." onkeyup="searchInventory(this.value)">
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Brand</th>
                        <th>Product</th>
                        <th>Status</th>
                        <th>Expiry</th>
                        <th>Shipment</th>
                        <th>Remarks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventory-table">
                    </tbody>
            </table>
        </div>
        
        <div id="new-products" class="tab-content">
            <div class="controls">
                <button onclick="showAddNewProductModal()">‚ûï Add New Product</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Brand</th>
                        <th>Product</th>
                        <th>Added Date</th>
                        <th>Arrival Date</th>
                        <th>Quantity</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="new-products-table">
                    </tbody>
            </table>
        </div>
        
        <div id="to-clear" class="tab-content">
            <div class="controls">
                <button onclick="showAddToClearModal()">‚ûï Add Product to Clear</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Brand</th>
                        <th>Product</th>
                        <th>Category</th>
                        <th>Expiry Date</th>
                        <th>Total Qty</th>
                        <th>Weekly Demand</th>
                        <th>Action Plan</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="to-clear-table">
                    </tbody>
            </table>
        </div>
        
        <div id="master-list" class="tab-content">
            <div class="controls">
                <button onclick="showAddMasterProductModal()">‚ûï Add Product</button>
                <button onclick="exportMasterList()">üì• Export List</button>
                <button onclick="document.getElementById('csvFileInput').click()">üì§ Import CSV</button>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importCSV(event)">
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Brand</th>
                        <th>Product Name</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>SKU</th>
                        <th>Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="master-table">
                    </tbody>
            </table>
        </div>

        <div id="recycle-bin" class="tab-content">
            <h2>Recycle Bin - Deleted Items</h2>
            <p>Items moved here are soft-deleted and can be restored or permanently removed.</p>
            <table>
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Brand</th>
                        <th>Product</th>
                        <th>Deleted Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recycle-bin-table">
                    </tbody>
            </table>
        </div>
        
        <div id="management" class="tab-content">
            <div class="controls">
                <button onclick="exportAllData()">üì• Export All Data</button>
                <button onclick="confirmLoadSampleData()">üìä Load Sample Data (Firestore)</button>
            </div>
            
            <h3>System Information</h3>
            <p>Total Products: <span id="total-products">0</span></p>
            <p>Last Updated: <span id="last-updated">Never</span></p>
        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('productModal')">&times;</span>
            <h2 id="productModalTitle">Add New Product</h2>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="editProductId" value="">
                <div class="form-group">
                    <label>Brand:</label>
                    <select id="brand" required onchange="populateProductDropdown(this, document.getElementById('productName'))">
                        <option value="">Select Brand</option>
                        <option value="Greenlife">Greenlife</option>
                        <option value="NN">Nordic Naturals</option>
                        <option value="NaturesPlus">NaturesPlus</option>
                        <option value="ENZYMEDICA">ENZYMEDICA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Product Name:</label>
                    <select id="productName" required>
                        <option value="">Select Product</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status:</label>
                    <select id="status" required>
                        <option value="">Select Status</option>
                        <option value="OOS">Out of Stock</option>
                        <option value="Low stock">Low Stock</option>
                        <option value="In Stock">In Stock</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Expiry Date:</label>
                    <input type="date" id="expiry">
                </div>
                <div class="form-group">
                    <label>Estimated Shipment:</label>
                    <input type="date" id="shipment">
                </div>
                <div class="form-group">
                    <label>Remarks:</label>
                    <textarea id="remarks"></textarea>
                </div>
                <button type="submit">Save Product</button>
            </form>
        </div>
    </div>

    <div id="newProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('newProductModal')">&times;</span>
            <h2 id="newProductModalTitle">Add New Product</h2>
            <form onsubmit="saveNewProduct(event)">
                <input type="hidden" id="editNewProductId" value="">
                <div class="form-group">
                    <label>Brand:</label>
                    <select id="newBrand" required onchange="populateProductDropdown(this, document.getElementById('newProductName'))">
                        <option value="">Select Brand</option>
                        <option value="Greenlife">Greenlife</option>
                        <option value="NN">Nordic Naturals</option>
                        <option value="NaturesPlus">NaturesPlus</option>
                        <option value="ENZYMEDICA">ENZYMEDICA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Product Name:</label>
                    <select id="newProductName" required>
                        <option value="">Select Product</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity:</label>
                    <input type="number" id="quantity" required min="1">
                </div>
                <div class="form-group">
                    <label>Arrival Date:</label>
                    <input type="date" id="arrivalDate">
                </div>
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea id="notes"></textarea>
                </div>
                <button type="submit">Save New Product</button>
            </form>
        </div>
    </div>

    <div id="masterProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('masterProductModal')">&times;</span>
            <h2 id="masterProductModalTitle">Add Master Product</h2>
            <form onsubmit="saveMasterProduct(event)">
                <input type="hidden" id="editMasterProductId" value="">
                <div class="form-group">
                    <label>Brand:</label>
                    <select id="masterBrand" required>
                        <option value="">Select Brand</option>
                        <option value="Greenlife">Greenlife</option>
                        <option value="NN">Nordic Naturals</option>
                        <option value="NaturesPlus">NaturesPlus</option>
                        <option value="ENZYMEDICA">ENZYMEDICA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Product Name:</label>
                    <input type="text" id="masterProductName" required>
                </div>
                <div class="form-group">
                    <label>Category:</label>
                    <select id="category" required>
                        <option value="">Select Category</option>
                        <option value="Vitamins">Vitamins</option>
                        <option value="Probiotics">Probiotics</option>
                        <option value="Joint Support">Joint Support</option>
                        <option value="Digestive Health">Digestive Health</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="description"></textarea>
                </div>
                <div class="form-group">
                    <label>SKU:</label>
                    <input type="text" id="sku">
                </div>
                <div class="form-group">
                    <label>Price:</label>
                    <input type="number" id="price" step="0.01" min="0">
                </div>
                <button type="submit">Save Master Product</button>
            </form>
        </div>
    </div>

    <div id="toClearModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('toClearModal')">&times;</span>
            <h2 id="toClearModalTitle">Add Product to Clear</h2>
            <form onsubmit="saveToClear(event)">
                <input type="hidden" id="editToClearId" value="">
                <div class="form-group">
                    <label>Brand:</label>
                    <select id="toClearBrand" required onchange="populateProductDropdown(this, document.getElementById('toClearProductName'))">
                        <option value="">Select Brand</option>
                        <option value="Greenlife">Greenlife</option>
                        <option value="NN">Nordic Naturals</option>
                        <option value="NaturesPlus">NaturesPlus</option>
                        <option value="ENZYMEDICA">ENZYMEDICA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Product Name:</label>
                    <select id="toClearProductName" required>
                        <option value="">Select Product</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Category:</label>
                    <select id="toClearCategory" required>
                        <option value="">Select Category</option>
                        <option value="Short Expiry">Short Expiry</option>
                        <option value="Excess Stock">Excess Stock</option>
                        <option value="Discontinued">Discontinued</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Expiry Date:</label>
                    <input type="date" id="toClearExpiryDate" required>
                </div>
                <div class="form-group">
                    <label>Total Quantity:</label>
                    <input type="number" id="toClearTotalQty" required min="1">
                </div>
                <div class="form-group">
                    <label>Weekly Demand:</label>
                    <input type="number" id="toClearWeeklyDemand" step="0.1" min="0" required>
                </div>
                <div class="form-group">
                    <label>Action Plan:</label>
                    <textarea id="toClearActionPlan" required></textarea>
                </div>
                <button type="submit">Save Product</button>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('confirmModal')">&times;</span>
            <h2 id="confirmMessage">Are you sure?</h2>
            <div class="modal-buttons">
                <button class="btn-danger" id="confirmNo">No</button>
                <button class="btn-success" id="confirmYes">Yes</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getFirestore, collection, getDocs, getDoc, addDoc, updateDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js"; // Optional, if you want analytics

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDo1-y0Vj4XTQeeEUQK_6Y2wqDs94TOAX0",
            authDomain: "inventory-c3bac.firebaseapp.com",
            projectId: "inventory-c3bac",
            storageBucket: "inventory-c3bac.firebasestorage.app",
            messagingSenderId: "261015083855",
            appId: "1:261015083855:web:e167f359928eb8ed8cc33a",
            measurementId: "G-V744486L78"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        // const analytics = getAnalytics(app); // Optional, if you want analytics

        // Data storage (local copies, kept in sync with Firestore)
        let inventoryData = [];
        let newProductsData = [];
        let toClearData = [];
        let masterProductsData = [];
        let recycleBinData = []; // To store items marked as deleted

        // Variable to hold the callback for the confirmation modal
        let confirmCallback = null;

        // Firestore Collection References
        const inventoryCol = collection(db, 'inventory');
        const newProductsCol = collection(db, 'new_products');
        const toClearCol = collection(db, 'to_clear');
        const masterProductsCol = collection(db, 'master_products');

        // Initial sample data (to be added only if collections are empty)
        const initialSampleData = {
            inventory: [
                { brand: "Greenlife", product: "ENZ PEARLS ACIDOPHILUS", status: "OOS", expiry: "", shipment: "", remarks: "", isDeleted: false },
                { brand: "Greenlife", product: "GL VIT C + ZINC", status: "OOS", expiry: "", shipment: "", remarks: "", isDeleted: false },
                { brand: "NN", product: "NORDIC KIDS VIT C GUM 60'S", status: "Low stock", expiry: "", shipment: "", remarks: "", isDeleted: false },
                { brand: "ENZYMEDICA", product: "DIGEST + PROBIOTICS 30'S", status: "In Stock", expiry: "", shipment: "", remarks: "", isDeleted: false }
            ],
            new_products: [
                { brand: "Greenlife", product: "GL SUPER PROBIOTIC", addedDate: "2024-01-15", arrivalDate: "2024-02-01", quantity: 60, notes: "New formula", isDeleted: false },
                { brand: "NN", product: "NORDIC OMEGA FOCUS", addedDate: "2024-01-20", arrivalDate: "2024-02-15", quantity: 48, notes: "Cognitive support", isDeleted: false }
            ],
            to_clear: [
                { brand: "Greenlife", product: "GL VITAMIN B COMPLEX", category: "Short Expiry", expiryDate: "2024-03-15", totalQty: 24, weeklyDemand: 3.5, actionPlan: "20% discount promotion", isDeleted: false },
                { brand: "NN", product: "VITAMIN C GUMMIES", category: "Discontinued", expiryDate: "2024-12-10", totalQty: 18, weeklyDemand: 2.0, actionPlan: "Clear with 30% discount", isDeleted: false }
            ],
            master_products: [
                { brand: "Greenlife", product: "ENZ PEARLS ACIDOPHILUS", category: "Probiotics", description: "Probiotic supplement", sku: "GL001", price: 18.50, isDeleted: false },
                { brand: "Greenlife", product: "GL VIT C + ZINC", category: "Vitamins", description: "Immune support", sku: "GL002", price: 15.99, isDeleted: false },
                { brand: "NN", product: "NORDIC KIDS VIT C GUM 60'S", category: "Vitamins", description: "Kids vitamin C", sku: "NN001", price: 12.50, isDeleted: false },
                { brand: "NN", product: "NORDIC OMEGA FOCUS", category: "Vitamins", description: "Brain health", sku: "NN002", price: 25.00, isDeleted: false },
                { brand: "NaturesPlus", product: "SOURCE OF LIFE GOLD", category: "Vitamins", description: "Multivitamin", sku: "NP001", price: 30.00, isDeleted: false },
                { brand: "ENZYMEDICA", product: "DIGEST GOLD", category: "Digestive Health", description: "Digestive enzymes", sku: "EZ001", price: 40.00, isDeleted: false },
                { brand: "ENZYMEDICA", product: "DIGEST + PROBIOTICS 30'S", category: "Digestive Health", description: "Enzymes and probiotics", sku: "EZ002", price: 35.00, isDeleted: false },
                { brand: "Greenlife", product: "GL SUPER PROBIOTIC", category: "Probiotics", description: "Advanced probiotic formula", sku: "GL003", price: 22.00, isDeleted: false },
                { brand: "Greenlife", product: "GL VITAMIN B COMPLEX", category: "Vitamins", description: "Energy support", sku: "GL004", price: 10.00, isDeleted: false },
                { brand: "NN", product: "VITAMIN C GUMMIES", category: "Vitamins", description: "Vitamin C chewables", sku: "NN003", price: 11.00, isDeleted: false }
            ]
        };

        // --- Utility Functions ---
        async function fetchDataFromFirestore(collectionRef, includeDeleted = false) {
            let data = [];
            let q = collectionRef;
            if (!includeDeleted) {
                q = query(collectionRef, where("isDeleted", "==", false));
            }
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc) => {
                data.push({ id: doc.id, ...doc.data() });
            });
            return data;
        }

        async function updateLocalData() {
            try {
                inventoryData = await fetchDataFromFirestore(inventoryCol);
                newProductsData = await fetchDataFromFirestore(newProductsCol);
                toClearData = await fetchDataFromFirestore(toClearCol);
                masterProductsData = await fetchDataFromFirestore(masterProductsCol);
                recycleBinData = await fetchDataFromFirestore(inventoryCol, true).then(data => data.filter(item => item.isDeleted));
                
                const newProdsDeleted = await fetchDataFromFirestore(newProductsCol, true).then(data => data.filter(item => item.isDeleted));
                const toClearDeleted = await fetchDataFromFirestore(toClearCol, true).then(data => data.filter(item => item.isDeleted));
                const masterDeleted = await fetchDataFromFirestore(masterProductsCol, true).then(data => data.filter(item => item.isDeleted));
                
                recycleBinData = recycleBinData.concat(newProdsDeleted, toClearDeleted, masterDeleted);

                updateAllTables();
                updateDashboardStats();
                updateAlerts();
                updateManagementStats();
            } catch (e) {
                console.error("Error updating local data from Firestore: ", e);
                showNotification("Error loading data from server.", "error");
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Re-render tables when switching tabs to ensure latest data
            if (tabId === 'inventory') {
                updateInventoryTable(inventoryData);
            } else if (tabId === 'new-products') {
                updateNewProductsTable(newProductsData);
            } else if (tabId === 'to-clear') {
                updateToClearTable(toClearData);
            } else if (tabId === 'master-list') {
                updateMasterTable(masterProductsData);
            } else if (tabId === 'recycle-bin') {
                updateRecycleBinTable(recycleBinData);
            }
        }

        // --- Confirmation Modal Logic ---
        function showConfirmModal(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').style.display = 'block';
            confirmCallback = callback;
        }

        document.getElementById('confirmYes').onclick = function() {
            if (confirmCallback) {
                confirmCallback(true);
            }
            closeModal('confirmModal');
        };

        document.getElementById('confirmNo').onclick = function() {
            if (confirmCallback) {
                confirmCallback(false);
            }
            closeModal('confirmModal');
        };

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Notification function
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // --- Data Management Functions (Firestore Integrated) ---

        // Load sample data if collections are empty (Firestore)
        async function loadSampleDataFirestore() {
            try {
                const invSnapshot = await getDocs(inventoryCol);
                if (invSnapshot.empty) {
                    showNotification("Loading sample data...", "info");
                    for (const item of initialSampleData.inventory) {
                        await addDoc(inventoryCol, item);
                    }
                    for (const item of initialSampleData.new_products) {
                        await addDoc(newProductsCol, item);
                    }
                    for (const item of initialSampleData.to_clear) {
                        await addDoc(toClearCol, item);
                    }
                    for (const item of initialSampleData.master_products) {
                        await addDoc(masterProductsCol, item);
                    }
                    showNotification("Sample data loaded successfully!", "success");
                } else {
                    showNotification("Data already exists in Firestore. Not loading sample data.", "info");
                }
                await updateLocalData(); // Refresh all data from Firestore
            } catch (e) {
                console.error("Error loading sample data: ", e);
                showNotification("Error loading sample data.", "error");
            }
        }

        // Confirmation for loading sample data
        function confirmLoadSampleData() {
            showConfirmModal("This will add sample data to your Firestore. Existing data will not be overwritten. Are you sure?", async (confirmed) => {
                if (confirmed) {
                    await loadSampleDataFirestore();
                }
            });
        }

        // Save/Edit functions (Firestore)

        // Save Product (Inventory Tab)
        async function saveProduct(event) {
            event.preventDefault();
            const editId = document.getElementById('editProductId').value;
            const productData = {
                brand: document.getElementById('brand').value,
                product: document.getElementById('productName').value,
                status: document.getElementById('status').value,
                expiry: document.getElementById('expiry').value,
                shipment: document.getElementById('shipment').value,
                remarks: document.getElementById('remarks').value,
                isDeleted: false
            };

            try {
                if (editId) {
                    await updateDoc(doc(db, 'inventory', editId), productData);
                    showNotification('Product updated successfully!', 'success');
                } else {
                    await addDoc(inventoryCol, productData);
                    showNotification('Product added successfully!', 'success');
                }
                closeModal('productModal');
                await updateLocalData(); // Refresh data
            } catch (e) {
                console.error("Error saving product: ", e);
                showNotification('Error saving product.', 'error');
            }
        }

        // Save New Product (New Products Tab)
        async function saveNewProduct(event) {
            event.preventDefault();
            const editId = document.getElementById('editNewProductId').value;
            const newProductData = {
                brand: document.getElementById('newBrand').value,
                product: document.getElementById('newProductName').value,
                addedDate: new Date().toISOString().slice(0, 10), // Set current date
                arrivalDate: document.getElementById('arrivalDate').value,
                quantity: parseInt(document.getElementById('quantity').value),
                notes: document.getElementById('notes').value,
                isDeleted: false
            };

            try {
                if (editId) {
                    await updateDoc(doc(db, 'new_products', editId), newProductData);
                    showNotification('New product updated successfully!', 'success');
                } else {
                    await addDoc(newProductsCol, newProductData);
                    showNotification('New product added successfully!', 'success');
                }
                closeModal('newProductModal');
                await updateLocalData();
            } catch (e) {
                console.error("Error saving new product: ", e);
                showNotification('Error saving new product.', 'error');
            }
        }

        // Save Master Product (Master List Tab)
        async function saveMasterProduct(event) {
            event.preventDefault();
            const editId = document.getElementById('editMasterProductId').value;
            const masterProductData = {
                brand: document.getElementById('masterBrand').value,
                product: document.getElementById('masterProductName').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                sku: document.getElementById('sku').value,
                price: parseFloat(document.getElementById('price').value),
                isDeleted: false
            };

            try {
                if (editId) {
                    await updateDoc(doc(db, 'master_products', editId), masterProductData);
                    showNotification('Master product updated successfully!', 'success');
                } else {
                    await addDoc(masterProductsCol, masterProductData);
                    showNotification('Master product added successfully!', 'success');
                }
                closeModal('masterProductModal');
                await updateLocalData();
            } catch (e) {
                console.error("Error saving master product: ", e);
                showNotification('Error saving master product.', 'error');
            }
        }

        // Save To Clear Product (To Clear Tab)
        async function saveToClear(event) {
            event.preventDefault();
            const editId = document.getElementById('editToClearId').value;
            const toClearProductData = {
                brand: document.getElementById('toClearBrand').value,
                product: document.getElementById('toClearProductName').value,
                category: document.getElementById('toClearCategory').value,
                expiryDate: document.getElementById('toClearExpiryDate').value,
                totalQty: parseInt(document.getElementById('toClearTotalQty').value),
                weeklyDemand: parseFloat(document.getElementById('toClearWeeklyDemand').value),
                actionPlan: document.getElementById('toClearActionPlan').value,
                isDeleted: false
            };

            try {
                if (editId) {
                    await updateDoc(doc(db, 'to_clear', editId), toClearProductData);
                    showNotification('Product to clear updated successfully!', 'success');
                } else {
                    await addDoc(toClearCol, toClearProductData);
                    showNotification('Product to clear added successfully!', 'success');
                }
                closeModal('toClearModal');
                await updateLocalData();
            } catch (e) {
                console.error("Error saving product to clear: ", e);
                showNotification('Error saving product to clear.', 'error');
            }
        }

        // Delete functions (Soft Delete)
        async function deleteItem(collectionRef, id, sourceTab) {
            showConfirmModal("Are you sure you want to delete this item? It will be moved to the Recycle Bin.", async (confirmed) => {
                if (confirmed) {
                    try {
                        const itemDoc = doc(db, collectionRef.id, id);
                        await updateDoc(itemDoc, {
                            isDeleted: true,
                            deletedDate: new Date().toISOString().slice(0, 10),
                            originalCollection: collectionRef.id // Store original collection for restore
                        });
                        showNotification('Item moved to Recycle Bin!', 'success');
                        await updateLocalData();
                    } catch (e) {
                        console.error("Error deleting item: ", e);
                        showNotification('Error moving item to Recycle Bin.', 'error');
                    }
                }
            });
        }

        // Restore item from Recycle Bin
        async function restoreItem(id, originalCollectionName) {
            showConfirmModal("Are you sure you want to restore this item?", async (confirmed) => {
                if (confirmed) {
                    try {
                        const itemDoc = doc(db, originalCollectionName, id);
                        await updateDoc(itemDoc, {
                            isDeleted: false,
                            deletedDate: null,
                            originalCollection: null
                        });
                        showNotification('Item restored successfully!', 'success');
                        await updateLocalData();
                    } catch (e) {
                        console.error("Error restoring item: ", e);
                        showNotification('Error restoring item.', 'error');
                    }
                }
            });
        }

        // Permanently delete item from Recycle Bin
        async function permanentlyDeleteItem(id, originalCollectionName) {
            showConfirmModal("Are you sure you want to permanently delete this item? This action cannot be undone.", async (confirmed) => {
                if (confirmed) {
                    try {
                        const itemDoc = doc(db, originalCollectionName, id);
                        await deleteDoc(itemDoc);
                        showNotification('Item permanently deleted!', 'success');
                        await updateLocalData();
                    } catch (e) {
                        console.error("Error permanently deleting item: ", e);
                        showNotification('Error permanently deleting item.', 'error');
                    }
                }
            });
        }


        // --- Display Functions ---

        function updateAllTables() {
            updateInventoryTable(inventoryData);
            updateNewProductsTable(newProductsData);
            updateToClearTable(toClearData);
            updateMasterTable(masterProductsData);
            updateRecycleBinTable(recycleBinData);
        }

        function updateInventoryTable(data) {
            const tableBody = document.getElementById('inventory-table');
            tableBody.innerHTML = '';
            data.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.brand;
                row.insertCell().textContent = item.product;
                const statusCell = row.insertCell();
                statusCell.innerHTML = `<span class="status-badge ${item.status === 'OOS' ? 'oos' : item.status === 'Low stock' ? 'low' : 'normal'}">${item.status}</span>`;
                row.insertCell().textContent = item.expiry;
                row.insertCell().textContent = item.shipment;
                row.insertCell().textContent = item.remarks;
                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn-info" onclick="showEditProductModal('${item.id}')">Edit</button>
                    <button class="btn-danger" onclick="deleteItem(inventoryCol, '${item.id}')">Delete</button>
                `;
            });
        }

        function updateNewProductsTable(data) {
            const tableBody = document.getElementById('new-products-table');
            tableBody.innerHTML = '';
            data.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.brand;
                row.insertCell().textContent = item.product;
                row.insertCell().textContent = item.addedDate;
                row.insertCell().textContent = item.arrivalDate;
                row.insertCell().textContent = item.quantity;
                row.insertCell().textContent = item.notes;
                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn-info" onclick="showEditNewProductModal('${item.id}')">Edit</button>
                    <button class="btn-danger" onclick="deleteItem(newProductsCol, '${item.id}')">Delete</button>
                `;
            });
        }

        function updateToClearTable(data) {
            const tableBody = document.getElementById('to-clear-table');
            tableBody.innerHTML = '';
            data.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.brand;
                row.insertCell().textContent = item.product;
                row.insertCell().textContent = item.category;
                row.insertCell().textContent = item.expiryDate;
                row.insertCell().textContent = item.totalQty;
                row.insertCell().textContent = item.weeklyDemand;
                row.insertCell().textContent = item.actionPlan;
                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn-info" onclick="showEditToClearModal('${item.id}')">Edit</button>
                    <button class="btn-danger" onclick="deleteItem(toClearCol, '${item.id}')">Delete</button>
                `;
            });
        }

        function updateMasterTable(data) {
            const tableBody = document.getElementById('master-table');
            tableBody.innerHTML = '';
            data.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.brand;
                row.insertCell().textContent = item.product;
                row.insertCell().textContent = item.category;
                row.insertCell().textContent = item.description;
                row.insertCell().textContent = item.sku;
                row.insertCell().textContent = `$${item.price.toFixed(2)}`;
                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn-info" onclick="showEditMasterProductModal('${item.id}')">Edit</button>
                    <button class="btn-danger" onclick="deleteItem(masterProductsCol, '${item.id}')">Delete</button>
                `;
            });
        }

        function updateRecycleBinTable(data) {
            const tableBody = document.getElementById('recycle-bin-table');
            tableBody.innerHTML = '';
            if (data.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5;
                cell.textContent = "Recycle Bin is empty.";
                cell.style.textAlign = "center";
                cell.style.padding = "20px";
                return;
            }

            data.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.originalCollection || 'N/A'; // Source collection
                row.insertCell().textContent = item.brand;
                row.insertCell().textContent = item.product;
                row.insertCell().textContent = item.deletedDate || 'N/A';
                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn-success" onclick="restoreItem('${item.id}', '${item.originalCollection}')">Restore</button>
                    <button class="btn-danger" onclick="permanentlyDeleteItem('${item.id}', '${item.originalCollection}')">Permanently Delete</button>
                `;
            });
        }

        function updateDashboardStats() {
            document.getElementById('oos-count').textContent = inventoryData.filter(item => item.status === 'OOS').length;
            document.getElementById('low-count').textContent = inventoryData.filter(item => item.status === 'Low stock').length;
            document.getElementById('in-stock-count').textContent = inventoryData.filter(item => item.status === 'In Stock').length;
            document.getElementById('new-count').textContent = newProductsData.length;
        }

        function updateAlerts() {
            const alertsDiv = document.getElementById('alerts');
            alertsDiv.innerHTML = '';

            const today = new Date();
            let hasAlerts = false;

            // Expiry alerts for Inventory
            inventoryData.forEach(item => {
                if (item.expiry) {
                    const expiryDate = new Date(item.expiry);
                    const diffTime = expiryDate.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays <= 30 && diffDays > 0) {
                        alertsDiv.innerHTML += `<p>‚ö†Ô∏è Product "${item.product}" (Brand: ${item.brand}) expires in ${diffDays} days!</p>`;
                        hasAlerts = true;
                    } else if (diffDays <= 0) {
                        alertsDiv.innerHTML += `<p>üö® Product "${item.product}" (Brand: ${item.brand}) has expired!</p>`;
                        hasAlerts = true;
                    }
                }
            });

            // Low stock alerts
            inventoryData.forEach(item => {
                if (item.status === 'Low stock') {
                    alertsDiv.innerHTML += `<p>üìâ Product "${item.product}" (Brand: ${item.brand}) is running low on stock.</p>`;
                    hasAlerts = true;
                }
            });

            // Out of stock alerts
            inventoryData.forEach(item => {
                if (item.status === 'OOS') {
                    alertsDiv.innerHTML += `<p>‚ùå Product "${item.product}" (Brand: ${item.brand}) is out of stock!</p>`;
                    hasAlerts = true;
                }
            });

            // To Clear - Critical items
            toClearData.forEach(item => {
                const expiryDate = new Date(item.expiryDate);
                const diffTime = expiryDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays <= 60 && item.category === "Short Expiry") {
                    alertsDiv.innerHTML += `<p>üî• Action Required: Product "${item.product}" (To Clear) has short expiry (${diffDays} days).</p>`;
                    hasAlerts = true;
                }
            });

            if (!hasAlerts) {
                alertsDiv.innerHTML = '<p>üéâ No urgent alerts at the moment. Everything looks good!</p>';
            }
        }

        function updateManagementStats() {
            document.getElementById('total-products').textContent = inventoryData.length + newProductsData.length + toClearData.length + masterProductsData.length;
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        }

        // --- Modal Display Functions ---

        async function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('editProductId').value = '';
            document.getElementById('brand').value = '';
            document.getElementById('productName').innerHTML = '<option value="">Select Product</option>'; // Clear and reset
            document.getElementById('status').value = '';
            document.getElementById('expiry').value = '';
            document.getElementById('shipment').value = '';
            document.getElementById('remarks').value = '';
            await populateProductDropdown(document.getElementById('brand'), document.getElementById('productName')); // Populate for default state
            document.getElementById('productModal').style.display = 'block';
        }

        async function showEditProductModal(id) {
            const productRef = doc(db, 'inventory', id);
            const productSnap = await getDoc(productRef);
            if (!productSnap.exists()) {
                showNotification("Product not found!", "error");
                return;
            }
            const item = productSnap.data();

            document.getElementById('productModalTitle').textContent = 'Edit Product';
            document.getElementById('editProductId').value = id;
            document.getElementById('brand').value = item.brand;
            await populateProductDropdown(document.getElementById('brand'), document.getElementById('productName')); // Populate with products for selected brand
            document.getElementById('productName').value = item.product;
            document.getElementById('status').value = item.status;
            document.getElementById('expiry').value = item.expiry;
            document.getElementById('shipment').value = item.shipment;
            document.getElementById('remarks').value = item.remarks;
            document.getElementById('productModal').style.display = 'block';
        }

        async function showAddNewProductModal() {
            document.getElementById('newProductModalTitle').textContent = 'Add New Product';
            document.getElementById('editNewProductId').value = '';
            document.getElementById('newBrand').value = '';
            document.getElementById('newProductName').innerHTML = '<option value="">Select Product</option>';
            document.getElementById('quantity').value = '';
            document.getElementById('arrivalDate').value = '';
            document.getElementById('notes').value = '';
            await populateProductDropdown(document.getElementById('newBrand'), document.getElementById('newProductName'));
            document.getElementById('newProductModal').style.display = 'block';
        }

        async function showEditNewProductModal(id) {
            const productRef = doc(db, 'new_products', id);
            const productSnap = await getDoc(productRef);
            if (!productSnap.exists()) {
                showNotification("New Product not found!", "error");
                return;
            }
            const item = productSnap.data();

            document.getElementById('newProductModalTitle').textContent = 'Edit New Product';
            document.getElementById('editNewProductId').value = id;
            document.getElementById('newBrand').value = item.brand;
            await populateProductDropdown(document.getElementById('newBrand'), document.getElementById('newProductName'));
            document.getElementById('newProductName').value = item.product;
            document.getElementById('quantity').value = item.quantity;
            document.getElementById('arrivalDate').value = item.arrivalDate;
            document.getElementById('notes').value = item.notes;
            document.getElementById('newProductModal').style.display = 'block';
        }

        async function showAddMasterProductModal() {
            document.getElementById('masterProductModalTitle').textContent = 'Add Master Product';
            document.getElementById('editMasterProductId').value = '';
            document.getElementById('masterBrand').value = '';
            document.getElementById('masterProductName').value = '';
            document.getElementById('category').value = '';
            document.getElementById('description').value = '';
            document.getElementById('sku').value = '';
            document.getElementById('price').value = '';
            document.getElementById('masterProductModal').style.display = 'block';
        }

        async function showEditMasterProductModal(id) {
            const productRef = doc(db, 'master_products', id);
            const productSnap = await getDoc(productRef);
            if (!productSnap.exists()) {
                showNotification("Master Product not found!", "error");
                return;
            }
            const item = productSnap.data();

            document.getElementById('masterProductModalTitle').textContent = 'Edit Master Product';
            document.getElementById('editMasterProductId').value = id;
            document.getElementById('masterBrand').value = item.brand;
            document.getElementById('masterProductName').value = item.product;
            document.getElementById('category').value = item.category;
            document.getElementById('description').value = item.description;
            document.getElementById('sku').value = item.sku;
            document.getElementById('price').value = item.price;
            document.getElementById('masterProductModal').style.display = 'block';
        }

        async function showAddToClearModal() {
            document.getElementById('toClearModalTitle').textContent = 'Add Product to Clear';
            document.getElementById('editToClearId').value = '';
            document.getElementById('toClearBrand').value = '';
            document.getElementById('toClearProductName').innerHTML = '<option value="">Select Product</option>';
            document.getElementById('toClearCategory').value = '';
            document.getElementById('toClearExpiryDate').value = '';
            document.getElementById('toClearTotalQty').value = '';
            document.getElementById('toClearWeeklyDemand').value = '';
            document.getElementById('toClearActionPlan').value = '';
            await populateProductDropdown(document.getElementById('toClearBrand'), document.getElementById('toClearProductName'));
            document.getElementById('toClearModal').style.display = 'block';
        }

        async function showEditToClearModal(id) {
            const productRef = doc(db, 'to_clear', id);
            const productSnap = await getDoc(productRef);
            if (!productSnap.exists()) {
                showNotification("Product to Clear not found!", "error");
                return;
            }
            const item = productSnap.data();

            document.getElementById('toClearModalTitle').textContent = 'Edit Product to Clear';
            document.getElementById('editToClearId').value = id;
            document.getElementById('toClearBrand').value = item.brand;
            await populateProductDropdown(document.getElementById('toClearBrand'), document.getElementById('toClearProductName'));
            document.getElementById('toClearProductName').value = item.product;
            document.getElementById('toClearCategory').value = item.category;
            document.getElementById('toClearExpiryDate').value = item.expiryDate;
            document.getElementById('toClearTotalQty').value = item.totalQty;
            document.getElementById('toClearWeeklyDemand').value = item.weeklyDemand;
            document.getElementById('toClearActionPlan').value = item.actionPlan;
            document.getElementById('toClearModal').style.display = 'block';
        }

        // --- Product Dropdown Population (from Master List) ---
        async function populateProductDropdown(brandSelectElement, productSelectElement) {
            const selectedBrand = brandSelectElement.value;
            productSelectElement.innerHTML = '<option value="">Select Product</option>'; // Reset options

            if (selectedBrand) {
                await updateLocalData(); // Ensure masterProductsData is fresh
                const filteredProducts = masterProductsData.filter(p => p.brand === selectedBrand);
                filteredProducts.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.product;
                    option.textContent = p.product;
                    productSelectElement.appendChild(option);
                });
            }
        }

        // --- Search Functionality ---
        function searchInventory(searchTerm) {
            const filteredData = inventoryData.filter(item =>
                item.brand.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.product.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.status.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.remarks.toLowerCase().includes(searchTerm.toLowerCase())
            );
            updateInventoryTable(filteredData);
        }

        function showFilteredInventory(status) {
            const filteredData = inventoryData.filter(item => item.status === status);
            switchTab('inventory'); // Switch to inventory tab
            updateInventoryTable(filteredData); // Display filtered data
        }

        // --- Export/Import (CSV) ---
        function convertToCSV(data) {
            if (data.length === 0) return '';
            const header = Object.keys(data[0]).join(',');
            const rows = data.map(row => Object.values(row).map(value => {
                // Handle commas and quotes within values
                if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            }).join(','));
            return [header, ...rows].join('\n');
        }

        function exportMasterList() {
            const csv = convertToCSV(masterProductsData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'master_list.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('Master list exported successfully!', 'success');
        }

        async function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) {
                    showNotification('CSV file is empty.', 'error');
                    return;
                }

                const headers = parseCSVLine(lines[0]);
                const importedItems = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length === headers.length) {
                        const item = {};
                        for (let j = 0; j < headers.length; j++) {
                            const key = headers[j].trim();
                            let value = values[j].trim();
                            // Convert price to number
                            if (key === 'price' && !isNaN(parseFloat(value))) {
                                value = parseFloat(value);
                            }
                            item[key] = value;
                        }
                        // Add isDeleted flag for new imports
                        item.isDeleted = false; 
                        importedItems.push(item);
                    } else {
                        console.warn(`Skipping malformed row: ${lines[i]}`);
                    }
                }

                if (importedItems.length > 0) {
                    showConfirmModal(`Import ${importedItems.length} items to Master List? Existing data will not be overwritten by import, but new items will be added.`, async (confirmed) => {
                        if (confirmed) {
                            try {
                                let importedCount = 0;
                                for (const item of importedItems) {
                                    // Check if an item with the same brand and product name already exists
                                    const q = query(masterProductsCol, where("brand", "==", item.brand), where("product", "==", item.product), where("isDeleted", "==", false));
                                    const querySnapshot = await getDocs(q);
                                    if (querySnapshot.empty) {
                                        await addDoc(masterProductsCol, item);
                                        importedCount++;
                                    } else {
                                        console.log(`Skipping existing master product: ${item.brand} - ${item.product}`);
                                    }
                                }
                                showNotification(`${importedCount} items imported successfully to Master List!`, 'success');
                                await updateLocalData();
                            } catch (e) {
                                console.error("Error importing CSV to Firestore: ", e);
                                showNotification('Error importing CSV to Firestore.', 'error');
                            }
                        } else {
                            showNotification('CSV import cancelled.', 'info');
                        }
                    });
                } else {
                    showNotification('No valid data found in CSV to import.', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Helper function to parse CSV line (handles commas in quotes)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '\"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // Export all data to a single JSON file
        async function exportAllData() {
            try {
                const allData = {
                    inventory: await fetchDataFromFirestore(inventoryCol, true),
                    new_products: await fetchDataFromFirestore(newProductsCol, true),
                    to_clear: await fetchDataFromFirestore(toClearCol, true),
                    master_products: await fetchDataFromFirestore(masterProductsCol, true)
                };
                const dataStr = JSON.stringify(allData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `inventory_data_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('All data exported successfully!', 'success');
            } catch (e) {
                console.error("Error exporting all data: ", e);
                showNotification('Error exporting all data.', 'error');
            }
        }


        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }

        // Initialize on load
        window.onload = async function() {
            await loadSampleDataFirestore(); // Attempt to load sample data if collections are empty
            await updateLocalData(); // Always refresh data from Firestore on load
        };
    </script>
</body>
</html>
