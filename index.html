<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333; /* Default text color for better contrast on white backgrounds */
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-radius: 15px;
        }

        /* Headings */
        h1 {
            color: #2c3e50;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
            overflow-x: auto;
            gap: 2px;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            background-color: transparent;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #7f8c8d;
            min-width: 120px;
            text-align: center;
            border: 2px solid transparent;
            border-bottom: none;
        }

        .tab:hover {
            background-color: #f8f9fa;
            color: #2c3e50;
            border-color: #e1e8ed;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            border-color: #667eea; /* Match gradient start */
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Stats Cards for Dashboard */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .stat-card.urgent {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
         .stat-card.urgent:hover {
            box-shadow: 0 15px 35px rgba(231, 76, 60, 0.4);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        .stat-card.warning:hover {
            box-shadow: 0 15px 35px rgba(243, 156, 18, 0.4);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
         .stat-card.info:hover {
            box-shadow: 0 15px 35px rgba(52, 152, 219, 0.4);
        }
        .stat-card.toclear-card { /* Custom style for To Clear card if needed, or use existing */
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); /* Example: Purple */
        }
        .stat-card.toclear-card:hover {
            box-shadow: 0 15px 35px rgba(155, 89, 182, 0.4);
        }
        .stat-card.staff-claim-card {
            background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%);
        }
        .stat-card.staff-claim-card:hover {
            box-shadow: 0 15px 35px rgba(22, 160, 133, 0.4);
        }


        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            line-height: 1;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Controls (Buttons, Search) */
        .controls {
            margin: 20px 0; /* Keep vertical margin */
            display: flex;
            justify-content: space-between;
            align-items: flex-start; 
            flex-wrap: wrap;
            gap: 15px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e1e8ed;
        }
         .controls > * { 
            flex-shrink: 0;
        }


        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px; /* Increased margin for spacing */
            background: white;
            border-radius: 10px;
            overflow: hidden; /* Important for border-radius on table */
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        th, td {
            padding: 8px 14px; /* Reduced padding for shorter rows */
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: middle; /* Better vertical alignment */
            font-size: 13px; /* Slightly smaller font for compactness */
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.6px; /* Slightly increased letter spacing */
            font-size: 12px;
            cursor: pointer; 
        }
        th .sort-arrow { 
            font-size: 0.8em;
            margin-left: 5px;
        }
        
        /* Zebra striping for table body rows */
        tbody tr:nth-child(even) {
            background-color: #f9f9fc; /* Very light purple/grey */
        }

        tbody tr:hover {
            background-color: #f1f3f5; /* Slightly darker hover for better feedback */
        }

        /* Right-align specific numeric columns */
        #inventory-table td:nth-child(5), /* Quantity */
        #new-products-table td:nth-child(7), /* Quantity */
        #to-clear-table td:nth-child(7), /* Initial Bal */
        #to-clear-table td:nth-child(8), /* WH Qty */
        #to-clear-table td:nth-child(9), /* Store Qty */
        #to-clear-table td:nth-child(10), /* Total Qty */
        #to-clear-table td:nth-child(11), /* Weekly Demand */
        #to-clear-table td:nth-child(12), /* Weeks Supply */
        #master-table td:nth-child(5), /* WK Demand */
        #master-table td:nth-child(7),  /* Price */
        #staff-claim-table td:nth-child(4), /* Price */
        #staff-claim-table td:nth-child(7) /* Quantities */
        {
            text-align: right;
            font-variant-numeric: tabular-nums; /* Helps align numbers if using proportional fonts */
        }


        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px; /* Slightly smaller for compactness */
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .oos {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .low {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .normal {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .danger-status {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .alert-status {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        /* General Buttons */
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }
         .btn-success:hover {
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }


        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
         .btn-info:hover {
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-warning {
             background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        .btn-warning:hover {
             box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }


        /* Refined styles for buttons within table cells */
        td button {
            padding: 7px 10px;   /* Reduced padding for compactness */
            font-size: 10px;    /* Smaller font for text like "Edit", "Delete" */
            letter-spacing: 0.3px; /* Adjust letter spacing for smaller font */
            border-radius: 18px; /* Keep pill shape, but ensure it's compact */
            margin: 2px;         /* Spacing between buttons in a cell */
        }


        /* Search Box */
        .search-box {
            padding: 12px 16px;
            width: 280px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%237f8c8d' class='bi bi-search' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E") no-repeat 12px center; /* Added search icon */
            padding-left: 35px; /* Space for the icon */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); /* Slightly more visible focus */
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: none;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        /* Add this after the existing form-group input styles */
/* Clear button styling - NEW */
.clear-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: #f8f9fa;
    border: 1px solid #e1e8ed;
    color: #666;
    cursor: pointer;
    font-size: 14px;
    padding: 4px 8px;
    width: auto;
    height: auto;
    border-radius: 4px;
    z-index: 10;
    font-weight: bold;
    line-height: 1;
    min-width: 24px;
    display: none;
}

.clear-btn:hover {
    background: #e9ecef;
    color: #e74c3c;
    border-color: #e74c3c;
}

.input-with-clear {
    position: relative;
    display: flex;
    align-items: center;
}

.input-with-clear input {
    padding-right: 40px !important;
}
        
        .close:hover {
            color: #e74c3c;
        }

        /* Form Group */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .form-group input:disabled, .form-group select:disabled, .form-group textarea:disabled {
            background-color: #f0f0f0;
            opacity: 0.7;
            cursor: not-allowed;
        }
        .form-group label.disabled-label {
            opacity: 0.5;
        }


        /* Alert Notifications */
        .alert {
            padding: 15px 20px; /* More padding */
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 600;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 320px; /* Slightly wider */
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* Stronger shadow */
            border-left-width: 5px; /* Accent border */
            border-left-style: solid;
        }

        .alert-success {
            background-color: #e6f7ed; /* Lighter green */
            color: #0f5132; /* Darker text for contrast */
            border-color: #27ae60; /* Accent color */
        }

        .alert-error {
            background-color: #fbe9e7; /* Lighter red */
            color: #842029; /* Darker text */
            border-color: #e74c3c; /* Accent color */
        }
        .alert-info {
            background-color: #e7f3fe;
            color: #0c5460;
            border-color: #3498db;
        }
        .alert-warning {
             background-color: #fff8e1;
             color: #856404;
             border-color: #f39c12;
        }

        /* Confirmation Modal Specific Styles */
        #confirmModal .modal-content {
            text-align: center;
            padding: 40px;
            max-width: 450px;
        }

        #confirmModal .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        #confirmModal .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        #confirmModal .modal-buttons button {
            flex: 1;
            max-width: 150px;
            padding: 12px 25px;
            font-size: 14px;
        }

        /* --- Mobile Responsiveness --- */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            .subtitle {
                font-size: 1rem;
                margin-bottom: 20px;
            }

            .tabs {
                flex-wrap: wrap; 
                justify-content: center; 
                border-bottom: none; 
            }

            .tab {
                min-width: unset; 
                flex: 1 1 auto; 
                padding: 10px 15px;
                font-size: 10px;
                border-bottom: 2px solid #ecf0f1; 
            }

            .tab.active {
                transform: none; 
                box-shadow: none; 
                border-bottom: 2px solid #667eea;
            }

            .stats-cards {
                grid-template-columns: 1fr; 
            }

            .stat-card {
                padding: 20px;
            }

            .stat-number {
                font-size: 2.5rem;
            }

            .controls {
                flex-direction: column; 
                align-items: stretch; 
                padding: 15px;
            }
            .controls .search-box { 
                 width: 100%;
            }


            button { /* General button stacking */
                width: 100%;
                margin-bottom: 10px; 
                font-size: 12px;
                padding: 10px 15px;
            }
             /* Ensure table action buttons don't go full width on mobile */
            td button {
                width: auto; /* Override full width for table buttons */
                margin-bottom: 2px; /* Reduce margin if stacked vertically in a small cell */
            }


            .search-box { 
                width: 100%; 
                padding-left: 35px; /* Ensure icon space maintained */
            }


            /* Responsive Tables: force table to scroll horizontally */
            table {
                display: block; 
                width: 100%;
                overflow-x: auto; 
                -webkit-overflow-scrolling: touch; 
                white-space: nowrap; 
            }

            th, td {
                min-width: 120px; /* Ensure columns have a minimum width for readability */
                padding: 10px;    /* Adjust padding for mobile if needed */
            }
            /* Adjust right-alignment for mobile if it causes issues, or keep it */
             #inventory-table td:nth-child(5), /* Quantity */
            #new-products-table td:nth-child(7), /* Quantity */
            #to-clear-table td:nth-child(7), 
            #to-clear-table td:nth-child(8), 
            #to-clear-table td:nth-child(9), 
            #to-clear-table td:nth-child(10), 
            #to-clear-table td:nth-child(11), 
            #to-clear-table td:nth-child(12), 
            #master-table td:nth-child(5),
            #master-table td:nth-child(7),
            #staff-claim-table td:nth-child(4),
            #staff-claim-table td:nth-child(7)
             {
                text-align: right; /* Keep right alignment for consistency */
            }


            .modal-content {
                margin: 20px auto; 
                padding: 20px;
                width: 95%; 
            }

            .alert {
                width: calc(100% - 40px); 
                left: 20px;
                right: 20px;
                top: 10px; 
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Inventory Management System</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab(this, 'dashboard')">üìä Dashboard</div>
            <div class="tab" onclick="switchTab(this, 'oos-lowstock')"> OOS/LOW STOCK</div>
            <div class="tab" onclick="switchTab(this, 'new-products')">‚ú® New Products</div>
            <div class="tab" onclick="switchTab(this, 'to-clear')">üè∑Ô∏è 7-12 Months</div>
            <div class="tab" onclick="switchTab(this, 'staff-claim')">üë• Staff Claim</div>
            <div class="tab" onclick="switchTab(this, 'master-list')">üìã Master List</div>
            <div class="tab" onclick="switchTab(this, 'recycle-bin')">üóëÔ∏è Recycle Bin</div>
            <div class="tab" onclick="switchTab(this, 'management')">‚öôÔ∏è Management</div>
        </div>
        
        <div id="dashboard" class="tab-content active">
            <div class="stats-cards">
                <div class="stat-card urgent" onclick="showFilteredInventory('OOS', true)">
                    <div class="stat-number" id="oos-count">0</div>
                    <div class="stat-label">Out of Stock</div>
                </div>
                <div class="stat-card warning" onclick="showFilteredInventory('Low stock', true)">
                    <div class="stat-number" id="low-count">0</div>
                    <div class="stat-label">Low Stock</div>
                </div>
                <div class="stat-card info" onclick="switchTab(document.querySelector('.tab[onclick*=\'new-products\']'), 'new-products')">
                    <div class="stat-number" id="new-count">0</div>
                    <div class="stat-label">New Products</div>
                </div>
                <div class="stat-card toclear-card" onclick="switchTab(document.querySelector('.tab[onclick*=\'to-clear\']'), 'to-clear')">
                    <div class="stat-number" id="to-clear-count">0</div>
                    <div class="stat-label">7-12 Months</div>
                </div>
                <div class="stat-card staff-claim-card" onclick="switchTab(document.querySelector('.tab[onclick*=\'staff-claim\']'), 'staff-claim')">
                    <div class="stat-number" id="staff-claim-count">0</div>
                    <div class="stat-label">Staff Claim</div>
                </div>
            </div>
            
            <h3>Recent Alerts</h3>
            <div id="alerts" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; border: 1px solid #e1e8ed;">
                <p>Loading alerts...</p>
            </div>
        </div>
        
        <div id="oos-lowstock" class="tab-content">
            <div class="controls">
                <button onclick="showAddProductModal()">‚ûï Add Product</button>
                <input type="text" id="oosSearchInput" class="search-box" placeholder="Search products..." onkeyup="searchInventory(this.value)">
            </div>
            
            <table id="inventory-table-container">
                <thead>
                    <tr>
                        <th style="min-width: 200px;">Actions</th>
                        <th onclick="sortTable('inventory', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'quantity')" data-column-key="quantity">Quantity <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'status')" data-column-key="status">Status <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'shipmentDate')" data-column-key="shipmentDate">Shipment Date <span class="sort-arrow"></span></th>
                        <th>Remarks</th>
                        <th onclick="sortTable('inventory', 'lastUpdated')" data-column-key="lastUpdated">Last Updated <span class="sort-arrow"></span></th>
                    </tr>
                </thead>
                <tbody id="inventory-table">
                    </tbody>
            </table>
        </div>
        
        <div id="new-products" class="tab-content">
            <div class="controls">
                <button onclick="showAddNewProductModal()">‚ûï Add New Product</button>
                <button onclick="mergeNewProductsToMaster()">Merge All to Inventory</button>
                 <input type="text" id="newProductsSearchInput" class="search-box" placeholder="Search new products..." onkeyup="searchNewProducts(this.value)">
            </div>
            
            <table id="new-products-table-container">
                <thead>
                    <tr>
                        <th>Actions</th>
                        <th onclick="sortTable('newProducts', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'addedDate')" data-column-key="addedDate">Added Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'arrivalDate')" data-column-key="arrivalDate">Arrival Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'quantity')" data-column-key="quantity">Quantity <span class="sort-arrow"></span></th>
                        <th>Notes</th>
                        <th onclick="sortTable('newProducts', 'lastUpdated')" data-column-key="lastUpdated">Last Updated <span class="sort-arrow"></span></th>
                    </tr>
                </thead>
                <tbody id="new-products-table">
                    </tbody>
            </table>
        </div>
        
        <div id="to-clear" class="tab-content">
            <div class="controls">
                <button onclick="showAddToClearModal()">‚ûï Add Product to 7-12 Months</button>
                <input type="text" id="toClearSearchInput" class="search-box" placeholder="Search products to clear..." onkeyup="searchToClear(this.value)">
            </div>
            
            <table id="to-clear-table-container">
                <thead>
                    <tr>
                        <th>Actions</th>
                        <th onclick="sortTable('toClear', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'expiryDate')" data-column-key="expiryDate">Expiry Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'firstHighlightedDate')" data-column-key="firstHighlightedDate">First Highlighted <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'firstReportedBalance')" data-column-key="firstReportedBalance">Initial Bal <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'warehouseQty')" data-column-key="warehouseQty">WH Qty <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'storeQty')" data-column-key="storeQty">Store Qty <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'totalQty')" data-column-key="totalQty">Total Qty <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'weeklyDemand')" data-column-key="weeklyDemand">Wk Demand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'weeksSupply')" data-column-key="weeksSupply">Wks Supply <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'supplyStatus')" data-column-key="supplyStatus">Supply Status <span class="sort-arrow"></span></th>
                        <th>Remarks</th>
                        <th>Action Plan</th>
                        <th onclick="sortTable('toClear', 'lastUpdated')" data-column-key="lastUpdated">Last Updated <span class="sort-arrow"></span></th>
                    </tr>
                </thead>
                <tbody id="to-clear-table">
                    </tbody>
            </table>
        </div>
        
        <div id="staff-claim" class="tab-content">
            <div class="controls">
                <button onclick="showAddStaffClaimModal()">‚ûï Add Product to Staff Claim</button>
                <input type="text" id="staffClaimSearchInput" class="search-box" placeholder="Search staff claim products..." onkeyup="searchStaffClaim(this.value)">
                <button onclick="exportStaffClaimList()">üì• Export List</button>
                <button onclick="document.getElementById('staffClaimCsvFileInput').click()">üì§ Import CSV</button>
                <input type="file" id="staffClaimCsvFileInput" accept=".csv" style="display: none;" onchange="importStaffClaimCSV(event)">
            </div>
            
            <table id="staff-claim-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('staffClaim', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('staffClaim', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('staffClaim', 'product')" data-column-key="product">Product Name <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('staffClaim', 'price')" data-column-key="price">Price <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('staffClaim', 'expiryDate')" data-column-key="expiryDate">Exp. Date <span class="sort-arrow"></span></th>
                        <th>Import Remarks</th>
                        <th onclick="sortTable('staffClaim', 'warehouseQty')" data-column-key="warehouseQty">Quantities <span class="sort-arrow"></span></th>
                        <th>Action Remark</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="staff-claim-table">
                </tbody>
            </table>
        </div>

        <div id="master-list" class="tab-content">
            <div class="controls">
                <button onclick="showAddMasterProductModal()">‚ûï Add Product</button>
                <input type="text" class="search-box" id="masterListSearchInput" placeholder="Search master products..." onkeyup="searchMasterList(this.value)">
                <button onclick="exportMasterList()">üì• Export List</button>
                <button onclick="document.getElementById('csvFileInput').click()">üì§ Import CSV</button>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importCSV(event)">
            </div>
            
            <table id="master-table-container">
                <thead>
                    <tr>
                        <th>Actions</th>
                        <th onclick="sortTable('master', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'product')" data-column-key="product">Product Name <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'wkDemand')" data-column-key="wkDemand">WK Demand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'expiryDate')" data-column-key="expiryDate">Expiry Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'price')" data-column-key="price">Price <span class="sort-arrow"></span></th>
                        
                    </tr>
                </thead>
                <tbody id="master-table">
                    </tbody>
            </table>
        </div>

        <div id="recycle-bin" class="tab-content">
            <div class="controls">
                <h3>Recycle Bin</h3>
                <input type="text" id="recycleBinSearchInput" class="search-box" placeholder="Search recycle bin..." onkeyup="searchRecycleBin(this.value)">
                <button class="btn-danger" onclick="emptyRecycleBin()">üóëÔ∏è Empty Recycle Bin</button>
            </div>
            <table id="recycle-bin-table-container">
                <thead>
                    <tr>
                        <th>Actions</th>
                        <th onclick="sortTable('recycleBin', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('recycleBin', 'originalCollection')" data-column-key="originalCollection">Original Tab <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('recycleBin', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('recycleBin', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        
                    </tr>
                </thead>
                <tbody id="recycle-bin-table">
                    </tbody>
            </table>
        </div>
        
        <div id="management" class="tab-content">
            <div class="controls">
                <button onclick="exportAllData()">üì• Export All Data</button>
                <button onclick="confirmLoadSampleData()">üìä Load Sample Data</button>
            </div>
            
            <h3>System Information</h3>
            <p>Total Products (active): <span id="total-products">0</span></p>
            <p>Total Products (all unique SKUs): <span id="total-products-all">0</span></p>
            <p>Last Synced: <span id="last-updated">Never</span></p>
        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('productModal')">&times;</span>
            <h2 id="productModalTitle">Add New Product</h2>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="editProductId" value="">
                <div class="form-group">
                    <label for="brand">Brand:</label>
                    <select id="brand" required onchange="filterProductsForBrand(this.value, 'productName', 'productsDatalist')">
                        </select>
                </div>
                <div class="form-group">
    <label for="productName">Product Name:</label>
    <div class="input-with-clear">
        <input type="text" id="productName" list="productsDatalist" required>
        <datalist id="productsDatalist"></datalist>
        <button type="button" class="clear-btn" onclick="clearProductSelection('productName')" title="Clear selection">√ó</button>
    </div>
</div>
                <div class="form-group">
                    <label for="inventoryQuantity">Quantity:</label>
                    <input type="number" id="inventoryQuantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="status">Status:</label>
                    <select id="status" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="shipmentDate">Shipment Date:</label>
                    <input type="date" id="shipmentDate">
                </div>
                <div class="form-group">
                    <label for="remarks">Remarks:</label>
                    <textarea id="remarks"></textarea>
                </div>
                <button type="submit">Save Product</button>
            </form>
        </div>
    </div>

    <div id="newProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('newProductModal')">&times;</span>
            <h2 id="newProductModalTitle">Add New Product Entry</h2>
            <form onsubmit="saveNewProduct(event)">
                <input type="hidden" id="editNewProductId" value="">
                <div class="form-group">
                    <label for="newBrand">Brand:</label>
                    <select id="newBrand" required onchange="filterProductsForBrand(this.value, 'newProductName', 'newProductsDatalist')">
                        </select>
                </div>
                <div class="form-group">
                    <label for="newProductSku">Product Code (SKU):</label>
                    <input type="text" id="newProductSku" required>
                </div>
                <div class="form-group">
                    <label for="newProductName">Product Name:</label>
                    <input type="text" id="newProductName" required>
                </div>

                <div class="form-group">
                    <label for="arrivalDate">Arrival Date:</label>
                    <input type="date" id="arrivalDate" required>
                </div>
                <div class="form-group">
                    <label for="newProductQuantity">Quantity:</label> <input type="number" id="newProductQuantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="notes">Notes:</label>
                    <textarea id="notes"></textarea>
                </div>
                <button type="submit">Save New Product</button>
            </form>
        </div>
    </div>

    <div id="masterProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('masterProductModal')">&times;</span>
            <h2 id="masterProductModalTitle">Add Master Product</h2>
            <form onsubmit="saveMasterProduct(event)">
                <input type="hidden" id="editMasterProductId" value="">
                <div class="form-group">
                    <label for="masterBrand">Brand:</label>
                    <select id="masterBrand" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="masterProductName">Product Name:</label>
                    <input type="text" id="masterProductName" required>
                </div>
                 <div class="form-group">
                    <label for="wkDemand">Weekly Demand (WK Demand):</label>
                    <input type="number" id="wkDemand" min="0" step="1" value="0">
                </div>
               <div class="form-group">
        <label for="masterExpiryMonth">Expiry Date:</label>
        <div style="display: flex; gap: 10px;">
            <select id="masterExpiryMonth" style="flex: 1;">
                <option value="">Month</option>
            </select>
            <select id="masterExpiryYear" style="flex: 1;">
                <option value="">Year</option>
            </select>
        </div>
    </div>
                <div class="form-group">
                    <label for="sku">Product Code (SKU):</label>
                    <input type="text" id="sku">
                </div>
                <div class="form-group">
                    <label for="price">Price:</label>
                    <input type="number" id="price" step="0.01" min="0">
                </div>
                <button type="submit">Save Master Product</button>
            </form>
        </div>
    </div>

    <div id="toClearModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('toClearModal')">&times;</span>
            <h2 id="toClearModalTitle">Add Product to Clear</h2>
            <form onsubmit="saveToClear(event)">
                <input type="hidden" id="editToClearId" value="">
                <div class="form-group">
                    <label for="toClearBrand">Brand:</label>
                     <select id="toClearBrand" required onchange="handleToClearBrandChange(this.value)">
                        </select>
                </div>
                <div class="form-group">
    <label for="toClearProductName">Product Name:</label>
    <div class="input-with-clear">
        <input type="text" id="toClearProductName" list="toClearProductsDatalist" required onchange="handleToClearProductChange()">
        <datalist id="toClearProductsDatalist"></datalist>
        <button type="button" class="clear-btn" onclick="clearProductSelection('toClearProductName')" title="Clear selection">√ó</button>
    </div>
</div>
                <div class="form-group">
                    <label for="toClearExpiryDate">Expiry Date:</label>
                    <input type="date" id="toClearExpiryDate" required>
                </div>
                <div class="form-group">
                    <label for="toClearFirstHighlightedDate">First Highlighted Date:</label>
                    <input type="date" id="toClearFirstHighlightedDate" required>
                </div>
                <div class="form-group">
                    <label for="toClearFirstReportedBalance">First Reported Balance (Total Qty):</label>
                    <input type="number" id="toClearFirstReportedBalance" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearWarehouseQty">Warehouse Qty:</label>
                    <input type="number" id="toClearWarehouseQty" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="toClearStoreQty">Store Qty:</label>
                    <input type="number" id="toClearStoreQty" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="toClearWeeklyDemand">Weekly Demand:</label>
                    <input type="number" id="toClearWeeklyDemand" min="0" readonly>
                </div>
                <div class="form-group">
                    <label for="toClearRemarks">Remarks:</label>
                    <textarea id="toClearRemarks"></textarea>
                </div>
                <div class="form-group">
                    <label for="toClearActionPlan">Action Plan:</label>
                    <textarea id="toClearActionPlan"></textarea>
                </div>
                <button type="submit">Save Product to Clear</button>
            </form>
        </div>
    </div>

    <div id="staffClaimModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('staffClaimModal')">&times;</span>
            <h2 id="staffClaimModalTitle">Edit Staff Claim Product</h2>
            <form onsubmit="saveStaffClaim(event)">
                <input type="hidden" id="editStaffClaimId" value="">
                <div class="form-group">
                    <label for="staffClaimProductCode" class="disabled-label">Product Code:</label>
                    <input type="text" id="staffClaimProductCode" disabled>
                </div>
                <div class="form-group">
                    <label for="staffClaimBrand" class="disabled-label">Brand:</label>
                    <input type="text" id="staffClaimBrand" disabled>
                </div>
                <div class="form-group">
                    <label for="staffClaimProductName" class="disabled-label">Product Name:</label>
                    <input type="text" id="staffClaimProductName" disabled>
                </div>
                <div class="form-group">
                    <label for="staffClaimExpiryDate">Expiry Date:</label>
                    <input type="date" id="staffClaimExpiryDate" required>
                </div>
                 <div class="form-group">
                    <label for="staffClaimWarehouseQty">Quantities:</label>
                    <input type="number" id="staffClaimWarehouseQty" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="staffClaimActionPlan">Action Remark:</label>
                    <textarea id="staffClaimActionPlan"></textarea>
                </div>
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>
    
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2>Confirmation</h2>
            <p id="confirmMessage"></p>
            <div class="modal-buttons">
                <button class="btn-danger" id="confirmNo">No</button>
                <button class="btn-success" id="confirmYes">Yes</button>
            </div>
        </div>
    </div>

    <div id="addBrandModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addBrandModal')">&times;</span>
            <h2>Add New Brand</h2>
            <form onsubmit="saveNewBrand(event)">
                <div class="form-group">
                    <label for="newBrandName">Brand Name:</label>
                    <input type="text" id="newBrandName" required>
                </div>
                <button type="submit">Add Brand</button>
            </form>
        </div>
    </div>

    <div id="addStatusModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addStatusModal')">&times;</span>
            <h2>Add New Status</h2>
            <form onsubmit="saveNewStatus(event)">
                <div class="form-group">
                    <label for="newStatusName">Status Name:</label>
                    <input type="text" id="newStatusName" required>
                </div>
                <button type="submit">Add Status</button>
            </form>
        </div>
    </div>

    <div id="addRemarkModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addRemarkModal')">&times;</span>
            <h2>Add New Remark</h2>
            <form onsubmit="saveNewRemark(event)">
                <div class="form-group">
                    <label for="newRemarkText">Remark Text:</label>
                    <input type="text" id="newRemarkText" required>
                </div>
                <button type="submit">Add Remark</button>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // IMPORTANT: Replace with your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDo1-y0Vj4XTQeeEUQK_6Y2wqDs94TOAX0",
            authDomain: "inventory-c3bac.firebaseapp.com",
            projectId: "inventory-c3bac",
            storageBucket: "inventory-c3bac.firebasestorage.app",
            messagingSenderId: "261015083855",
            appId: "1:261015083855:web:e167f359928eb8ed8cc33a",
            measurementId: "G-V744486L78"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global data arrays to hold fetched data
        let inventoryData = [];
        let newProductsData = [];
        let toClearData = [];
        let masterProductsData = [];
        let deletedItemsData = []; // For Recycle Bin
        let brandsData = []; 
        let statusesData = []; 
        let staffClaimData = []; 

        // Data for current views (used for filtering and sorting)
        let currentInventoryViewData = [];
        let currentNewProductsViewData = [];
        let currentToClearViewData = [];
        let currentMasterListViewData = [];
        let currentRecycleBinViewData = [];
        let currentStaffClaimViewData = [];

        // Firestore collection references
        const inventoryColRef = db.collection('inventory');
        const newProductsColRef = db.collection('new_products');
        const toClearColRef = db.collection('to_clear');
        const masterProductsColRef = db.collection('master_products');
        const brandsColRef = db.collection('brands');
        const statusesColRef = db.collection('statuses');
        const staffClaimColRef = db.collection('staff_claim'); 

        // Sort state for tables
        let sortState = {
            inventory: { column: 'lastUpdated', direction: 'desc' },
            newProducts: { column: 'addedDate', direction: 'desc' },
            master: { column: 'sku', direction: 'asc' },
            toClear: { column: 'expiryDate', direction: 'asc' },
            staffClaim: { column: 'expiryDate', direction: 'asc' },
            recycleBin: { column: 'sku', direction: 'asc' }
        };

        // --- Notification System ---
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.classList.add('alert', `alert-${type}`);
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // --- Confirmation Modal ---
        let confirmCallback = null;
        function showConfirmModal(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').style.display = 'block';
            confirmCallback = callback;
        }

        document.getElementById('confirmYes').onclick = () => {
            if (confirmCallback) confirmCallback(true);
            document.getElementById('confirmModal').style.display = 'none';
        };

        document.getElementById('confirmNo').onclick = () => {
            if (confirmCallback) confirmCallback(false);
            document.getElementById('confirmModal').style.display = 'none';
        };

        // --- Firestore Data Operations ---
        async function fetchDataFromFirestore(collectionRef, includeDeleted = false) {
            let data = [];
            let query = includeDeleted ? collectionRef : collectionRef.where("isDeleted", "==", false);
            
            try {
                const querySnapshot = await query.get();
                querySnapshot.forEach((doc) => {
                    const docData = doc.data();
                    if ((collectionRef.id === 'to_clear' || collectionRef.id === 'staff_claim' || collectionRef.id === 'inventory') && typeof docData.isPinned === 'undefined') {
                        docData.isPinned = false;
                    }
                    data.push({ id: doc.id, ...docData });
                });
            } catch (error) {
                console.error(`Error fetching data from ${collectionRef.id}:`, error);
                if (error.code === 'failed-precondition') {
                     console.warn(`Firestore query for ${collectionRef.id} might require an index. Check Firestore console.`);
                }
            }
            return data;
        }

        async function fetchAllDataForRecycleBin() {
            const collectionsToFetchFrom = [inventoryColRef, newProductsColRef, toClearColRef, masterProductsColRef, staffClaimColRef];
            let allDeletedItems = [];
            for (const colRef of collectionsToFetchFrom) {
                try {
                    const querySnapshot = await colRef.where("isDeleted", "==", true).get();
                    querySnapshot.forEach((doc) => allDeletedItems.push({ id: doc.id, ...doc.data(), originalCollection: colRef.id }));
                } catch (error) {
                    console.error(`Error fetching deleted items from ${colRef.id}:`, error);
                }
            }
            return allDeletedItems;
        }

        async function saveDataToFirestore(collectionRef, docId, data) {
            try {
                if (docId) {
                    await collectionRef.doc(docId).set(data, { merge: true });
                } else {
                    const docRef = await collectionRef.add(data);
                    return docRef.id;
                }
                return docId;
            } catch (error) {
                console.error(`Error saving data to ${collectionRef.id}:`, error);
                showNotification(`Error saving data to server.`, 'error');
                throw error;
            }
        }

        // --- Update Local Data & UI ---
        async function updateLocalData() {
            try {
                [
                    inventoryData,
                    newProductsData,
                    toClearData,
                    masterProductsData,
                    staffClaimData,
                    deletedItemsData,
                    brandsData,
                    statusesData
                ] = await Promise.all([
                    fetchDataFromFirestore(inventoryColRef),
                    fetchDataFromFirestore(newProductsColRef),
                    fetchDataFromFirestore(toClearColRef),
                    fetchDataFromFirestore(masterProductsColRef),
                    fetchDataFromFirestore(staffClaimColRef),
                    fetchAllDataForRecycleBin(),
                    fetchDataFromFirestore(brandsColRef),
                    fetchDataFromFirestore(statusesColRef)
                ]);
                
                // Initialize current views
                const activeTab = document.querySelector('.tab.active') || document.querySelector('.tab');
                if (activeTab) {
                    const activeTabId = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
                    switchTab(activeTab, activeTabId, false); // Pass false to prevent re-rendering before full setup
                }


                updateAllTablesAndViews();
                updateDashboardStats();
                updateAlerts();
                updateManagementStats();
                populateProductDatalists();
                setupDynamicDropdowns();
            } catch (error) {
                console.error("Error updating local data from Firestore:", error);
                showNotification('Error loading data from server.', 'error');
            }
        }
        
        function updateAllTablesAndViews() {
            renderInventoryItems();
            renderNewProductsItems();
            renderMasterListItems();
            renderToClearItems();
            renderStaffClaimItems();
            renderRecycleBinItems();
        }
        
        // --- UI Helper Functions ---
        function clearProductSelection(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = '';
                toggleClearButton(input, false);
                if (inputId === 'toClearProductName') {
                    document.getElementById('toClearWeeklyDemand').value = '';
                }
                input.focus();
            }
        }

        function toggleClearButton(inputElement, show) {
            const clearButton = inputElement.parentElement.querySelector('.clear-btn');
            if (clearButton) clearButton.style.display = show ? 'block' : 'none';
        }
        
        // --- Dynamic Dropdowns ---
        function setupDynamicDropdowns() {
            ['brand', 'newBrand', 'masterBrand', 'toClearBrand'].forEach(id => populateBrandDropdowns(id));
            populateStatusDropdowns('status');
        }

        function populateBrandDropdowns(selectId) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;

            const currentValue = selectElement.value; 
            const uniqueBrands = [...new Set([
                ...masterProductsData.map(item => item.brand),
                ...brandsData.map(brandDoc => brandDoc.name)
            ])].filter(Boolean).sort((a, b) => a.localeCompare(b));

            selectElement.innerHTML = '<option value="">Select Brand</option>';
            uniqueBrands.forEach(brand => selectElement.innerHTML += `<option value="${brand}">${brand}</option>`);
            selectElement.innerHTML += '<option value="add_new_brand">+ Add New Brand...</option>';
            
            if (currentValue && uniqueBrands.includes(currentValue)) {
                selectElement.value = currentValue;
            }

            selectElement.removeEventListener('change', handleDynamicDropdownChange); 
            selectElement.addEventListener('change', handleDynamicDropdownChange);
        }

        function populateStatusDropdowns(selectId) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;

            const currentValue = selectElement.value;
            const allowedStatuses = [...new Set([
                'OOS', 'Low stock',
                ...statusesData.map(s => s.name),
                ...inventoryData.map(i => i.status)
            ])].filter(s => s && s.toLowerCase() !== 'in stock').sort();

            selectElement.innerHTML = '<option value="">Select Status</option>';
            allowedStatuses.forEach(status => selectElement.innerHTML += `<option value="${status}">${status}</option>`);
            selectElement.innerHTML += '<option value="add_new_status">+ Add New Status...</option>';

            if (currentValue && allowedStatuses.includes(currentValue)) {
                selectElement.value = currentValue;
            }
            selectElement.removeEventListener('change', handleDynamicDropdownChange);
            selectElement.addEventListener('change', handleDynamicDropdownChange);
        }

        function handleDynamicDropdownChange(event) {
            if (event.target.value === 'add_new_brand') showAddBrandModal();
            else if (event.target.value === 'add_new_status') showAddStatusModal();
        }

        // --- Product Datalists ---
        function populateProductDatalists() {
            const datalistIds = ['productsDatalist', 'newProductsDatalist', 'toClearProductsDatalist', 'staffClaimProductsDatalist'];
            const allProductNames = [...new Set(masterProductsData.map(item => item.product).filter(Boolean))].sort();
            
            datalistIds.forEach(id => {
                const datalist = document.getElementById(id);
                if (datalist) {
                    datalist.innerHTML = allProductNames.map(name => `<option value="${name}"></option>`).join('');
                }
            });
        }

        function filterProductsForBrand(brand, productNameInputId, datalistId) {
            const productNameInput = document.getElementById(productNameInputId);
            const datalist = document.getElementById(datalistId);
            if (!productNameInput || !datalist) return;

            const productNames = brand 
                ? [...new Set(masterProductsData.filter(item => item.brand === brand).map(item => item.product).filter(Boolean))].sort()
                : [...new Set(masterProductsData.map(item => item.product).filter(Boolean))].sort();

            datalist.innerHTML = productNames.map(name => `<option value="${name}"></option>`).join('');

            if (productNameInput.value && !productNames.includes(productNameInput.value)) {
                productNameInput.value = '';
            }

            productNameInput.removeEventListener('input', handleProductInput);
            productNameInput.removeEventListener('change', handleProductChange);
            productNameInput.addEventListener('input', handleProductInput);
            productNameInput.addEventListener('change', handleProductChange);

            toggleClearButton(productNameInput, productNameInput.value.trim().length > 0);
        }

        function handleProductInput() { toggleClearButton(this, this.value.trim().length > 0); }

        function handleProductChange() {
            const brand = this.closest('.modal-content').querySelector('select[id*="Brand"]')?.value;
            if (brand && this.value && ![...this.list.options].some(opt => opt.value === this.value)) {
                showNotification(`"${this.value}" is not available for ${brand}.`, 'warning');
                this.value = '';
                toggleClearButton(this, false);
            }
            if (this.id === 'toClearProductName') handleToClearProductChange();
        }
        
        function handleToClearBrandChange(brandValue) {
            filterProductsForBrand(brandValue, 'toClearProductName', 'toClearProductsDatalist');
            document.getElementById('toClearWeeklyDemand').value = '';
            document.getElementById('toClearProductName').value = ''; 
        }

        function handleToClearProductChange() {
            const brand = document.getElementById('toClearBrand').value;
            const productName = document.getElementById('toClearProductName').value;
            const wkDemandInput = document.getElementById('toClearWeeklyDemand');

            const masterProduct = masterProductsData.find(mp => mp.brand === brand && mp.product === productName);
            wkDemandInput.value = masterProduct ? (masterProduct.wkDemand || 0) : '';
        }
        
        function handleStaffClaimBrandChange(brandValue) {
            filterProductsForBrand(brandValue, 'staffClaimProductName', 'staffClaimProductsDatalist');
            document.getElementById('staffClaimProductName').value = '';
        }

        // --- Tab Switching ---
        function switchTab(clickedTab, tabId, doRender = true) {
            document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
            clickedTab.classList.add('active');
            document.getElementById(tabId).classList.add('active');

            const searchInput = document.querySelector(`#${tabId} .search-box`);
            if (searchInput) searchInput.value = '';

            const dataMap = {
                'oos-lowstock': () => inventoryData.filter(item => (item.status === 'OOS' || (item.status && item.status.toLowerCase().includes('low stock')))),
                'new-products': () => [...newProductsData],
                'to-clear': () => [...toClearData],
                'staff-claim': () => [...staffClaimData],
                'master-list': () => [...masterProductsData],
                'recycle-bin': () => [...deletedItemsData]
            };
            const viewMap = {
                'oos-lowstock': 'currentInventoryViewData',
                'new-products': 'currentNewProductsViewData',
                'to-clear': 'currentToClearViewData',
                'staff-claim': 'currentStaffClaimViewData',
                'master-list': 'currentMasterListViewData',
                'recycle-bin': 'currentRecycleBinViewData'
            };
            
            if(dataMap[tabId]) {
                window[viewMap[tabId]] = dataMap[tabId]();
                if(doRender) updateAllTablesAndViews();
            }
        }

        // --- Modals ---
        function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                modal.querySelector('form')?.reset();
                ['editProductId', 'editNewProductId', 'editMasterProductId', 'editToClearId', 'editStaffClaimId'].forEach(id => {
                    const input = document.getElementById(id);
                    if (input) input.value = '';
                });
                if (modalId === 'toClearModal') {
                    document.getElementById('toClearFirstHighlightedDate').readOnly = false;
                    document.getElementById('toClearFirstReportedBalance').readOnly = false;
                }
            }
        }
        window.onclick = (event) => { if (event.target.classList.contains('modal')) closeModal(event.target.id); };

        // --- Generic CRUD & Utility Functions ---
        const getSkuForProduct = (brand, product) => masterProductsData.find(item => item.brand === brand && item.product === product)?.sku || null;
        
        async function moveToRecycleBin(id, collectionName) {
            showConfirmModal('Move this item to Recycle Bin?', async (confirmed) => {
                if(confirmed) {
                    try {
                        await db.collection(collectionName).doc(id).update({ isDeleted: true });
                        showNotification('Item moved to Recycle Bin!', 'success');
                        await updateLocalData();
                    } catch (e) { console.error(e); showNotification('Error moving item.', 'error'); }
                }
            });
        }

        async function togglePinItem(id, collectionKey) {
            const collectionMap = {
                inventory: { data: inventoryData, ref: inventoryColRef },
                to_clear: { data: toClearData, ref: toClearColRef },
                staff_claim: { data: staffClaimData, ref: staffClaimColRef }
            };
            const collection = collectionMap[collectionKey];
            const item = collection.data.find(p => p.id === id);
            if (item) {
                const newPinnedState = !item.isPinned;
                try {
                    await saveDataToFirestore(collection.ref, id, { isPinned: newPinnedState });
                    showNotification(`Item ${newPinnedState ? 'pinned' : 'unpinned'}.`, 'success');
                    await updateLocalData();
                } catch (e) { showNotification('Error updating pin status.', 'error'); }
            }
        }
        
        function sortAndPin(dataArray, tableKey) {
            const pinned = dataArray.filter(item => item.isPinned);
            const unpinned = dataArray.filter(item => !item.isPinned);
            const { column, direction } = sortState[tableKey];
            return [...sortArray(pinned, column, direction), ...sortArray(unpinned, column, direction)];
        }
        
        // --- Inventory (OOS/Low Stock) ---
        function renderInventoryItems() {
            const tableBody = document.getElementById('inventory-table');
            if (!tableBody) return;
            const sortedData = sortAndPin(currentInventoryViewData, 'inventory');
            tableBody.innerHTML = sortedData.map(item => `
                <tr>
                    <td>
                        <button class="btn-info" onclick="editProduct('${item.id}')">‚úèÔ∏è Edit</button>
                        <button class="${item.isPinned ? 'btn-warning' : 'btn-success'}" onclick="togglePinItem('${item.id}', 'inventory')">
                            ${item.isPinned ? '‚ûñ Unpin' : 'üìå Pin'}
                        </button>
                        <button class="btn-danger" onclick="moveToRecycleBin('${item.id}', 'inventory')">üóëÔ∏è Delete</button>
                    </td>
                    <td>${item.sku || ''}</td>
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td>${item.quantity ?? ''}</td>
                    <td><span class="status-badge ${item.status === 'OOS' ? 'oos' : 'low'}">${item.status || ''}</span></td>
                    <td>${item.shipmentDate || ''}</td>
                    <td>${item.remarks || ''}</td>
                    <td>${item.lastUpdated ? new Date(item.lastUpdated).toLocaleString() : ''}</td>
                </tr>
            `).join('');
        }
        
        function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Add Product (OOS/Low Stock)';
            closeModal('productModal');
            populateBrandDropdowns('brand');
            populateStatusDropdowns('status');
            filterProductsForBrand('', 'productName', 'productsDatalist'); 
            openModal('productModal');
        }

        async function saveProduct(event) {
            event.preventDefault();
            const id = document.getElementById('editProductId').value;
            const brand = document.getElementById('brand').value;
            const productName = document.getElementById('productName').value;
            const sku = getSkuForProduct(brand, productName);
            if (!sku) {
                showNotification("Product not found in Master List.", "error");
                return;
            }
            if (!id && inventoryData.some(item => item.sku === sku)) {
                showNotification(`Product already in OOS/Low Stock list.`, "error");
                return;
            }
            const data = {
                brand, product: productName, sku,
                quantity: parseInt(document.getElementById('inventoryQuantity').value),
                status: document.getElementById('status').value,
                shipmentDate: document.getElementById('shipmentDate').value,
                remarks: document.getElementById('remarks').value,
                lastUpdated: new Date().toISOString(),
                isDeleted: false,
                isPinned: id ? (inventoryData.find(p => p.id === id)?.isPinned || false) : false
            };
            try {
                await saveDataToFirestore(inventoryColRef, id, data);
                showNotification('Product saved!', 'success');
                closeModal('productModal');
                await updateLocalData();
            } catch (e) {}
        }

        async function editProduct(id) {
            const item = inventoryData.find(p => p.id === id);
            if (item) {
                document.getElementById('productModalTitle').textContent = 'Edit Product';
                document.getElementById('editProductId').value = item.id;
                populateBrandDropdowns('brand');
                document.getElementById('brand').value = item.brand;
                filterProductsForBrand(item.brand, 'productName', 'productsDatalist');
                document.getElementById('productName').value = item.product;
                document.getElementById('inventoryQuantity').value = item.quantity;
                populateStatusDropdowns('status');
                document.getElementById('status').value = item.status;
                document.getElementById('shipmentDate').value = item.shipmentDate || '';
                document.getElementById('remarks').value = item.remarks;
                openModal('productModal');
            }
        }
        
        function searchInventory(searchTerm) {
            const lower = searchTerm.toLowerCase().trim();
            const baseData = inventoryData.filter(i => (i.status === 'OOS' || i.status?.toLowerCase().includes('low stock')));
            currentInventoryViewData = lower ? baseData.filter(i => Object.values(i).some(v => String(v).toLowerCase().includes(lower))) : baseData;
            renderInventoryItems();
        }

        // --- New Products ---
        function renderNewProductsItems() {
            const tableBody = document.getElementById('new-products-table');
            if (!tableBody) return;
            const sortedData = sortArray(currentNewProductsViewData, 'addedDate', 'desc');
            tableBody.innerHTML = sortedData.map(item => `
                <tr>
                    <td>
                        <button class="btn-info" onclick="editNewProduct('${item.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn-success" onclick="moveNewProductToMaster('${item.id}')">‚úÖ Approve</button>
                        <button class="btn-danger" onclick="moveToRecycleBin('${item.id}', 'new_products')">üóëÔ∏è Delete</button>
                    </td>
                    <td>${item.sku || ''}</td>
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td>${item.addedDate || ''}</td>
                    <td>${item.arrivalDate || ''}</td>
                    <td>${item.quantity ?? ''}</td>
                    <td>${item.notes || ''}</td>
                    <td>${item.lastUpdated ? new Date(item.lastUpdated).toLocaleString() : ''}</td>
                </tr>
            `).join('');
        }

        function showAddNewProductModal() {
            document.getElementById('newProductModalTitle').textContent = 'Add New Product Entry';
            closeModal('newProductModal');
            document.getElementById('arrivalDate').valueAsDate = new Date();
            populateBrandDropdowns('newBrand');
            filterProductsForBrand('', 'newProductName', 'newProductsDatalist');
            openModal('newProductModal');
        }

        async function saveNewProduct(event) {
            event.preventDefault();
            const id = document.getElementById('editNewProductId').value;
            const skuValue = document.getElementById('newProductSku').value.trim();
            if (!skuValue) { showNotification('SKU is required.', 'error'); return; }
            if (!id && (newProductsData.some(p => p.sku === skuValue) || masterProductsData.some(p => p.sku === skuValue))) {
                showNotification('SKU already exists.', 'error');
                return;
            }
            const data = {
                brand: document.getElementById('newBrand').value,
                sku: skuValue,
                product: document.getElementById('newProductName').value,
                arrivalDate: document.getElementById('arrivalDate').value,
                quantity: parseInt(document.getElementById('newProductQuantity').value),
                notes: document.getElementById('notes').value,
                addedDate: id ? (newProductsData.find(i => i.id === id)?.addedDate || new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0],
                lastUpdated: new Date().toISOString(),
                isDeleted: false
            };
            try {
                await saveDataToFirestore(newProductsColRef, id, data);
                showNotification('New product saved!', 'success');
                closeModal('newProductModal');
                await updateLocalData();
            } catch (e) {}
        }
        
        async function editNewProduct(id) {
            const item = newProductsData.find(p => p.id === id);
            if (item) {
                document.getElementById('newProductModalTitle').textContent = 'Edit New Product';
                document.getElementById('editNewProductId').value = item.id;
                populateBrandDropdowns('newBrand');
                document.getElementById('newBrand').value = item.brand;
                filterProductsForBrand(item.brand, 'newProductName', 'newProductsDatalist');
                document.getElementById('newProductSku').value = item.sku || '';
                document.getElementById('newProductName').value = item.product;
                document.getElementById('arrivalDate').value = item.arrivalDate;
                document.getElementById('newProductQuantity').value = item.quantity;
                document.getElementById('notes').value = item.notes;
                openModal('newProductModal');
            }
        }
        
        function searchNewProducts(searchTerm) {
            const lower = searchTerm.toLowerCase().trim();
            currentNewProductsViewData = lower ? newProductsData.filter(i => Object.values(i).some(v => String(v).toLowerCase().includes(lower))) : [...newProductsData];
            renderNewProductsItems();
        }
        
        async function moveNewProductToMaster(id) {
            showConfirmModal('Are you sure you want to approve this new product and move it to Master List & Inventory?', async (confirmed) => {
                if (confirmed) {
                    const item = newProductsData.find(p => p.id === id);
                    if (item) {
                        try {
                            const masterProductExists = masterProductsData.find(mp => mp.sku === item.sku && !mp.isDeleted);
                            if (masterProductExists) {
                                showNotification(`SKU ${item.sku} already exists in Master List. Cannot move. Please edit SKU or manage in Master List.`, 'error');
                                return;
                            }

                            const masterProductData = {
                                brand: item.brand,
                                product: item.product,
                                sku: item.sku,
                                wkDemand: 0, // Default WK Demand
                                price: 0.00, 
                                isDeleted: false
                            };
                            await saveDataToFirestore(masterProductsColRef, null, masterProductData);

                            const inventoryProductData = {
                                brand: item.brand,
                                product: item.product,
                                sku: item.sku,
                                quantity: item.quantity,
                                status: 'In stock', // Default status for newly approved
                                shipmentDate: '', 
                                remarks: `Added from New Products (Approved: ${new Date().toISOString().split('T')[0]})`,
                                isDeleted: false
                            };
                            await saveDataToFirestore(inventoryColRef, null, inventoryProductData);
                            await saveDataToFirestore(newProductsColRef, item.id, { isDeleted: true }); 

                            showNotification('Product approved and moved successfully!', 'success');
                            await updateLocalData();
                        } catch (e) {
                            console.error("Error moving new product to master:", e);
                            showNotification('Error moving product.', 'error');
                        }
                    }
                }
            });
        }

        async function mergeNewProductsToMaster() {
            showConfirmModal('Are you sure you want to merge ALL new products to Master List & Inventory? SKUs already in Master List will be skipped.', async (confirmed) => {
                if (confirmed) {
                    const batch = db.batch();
                    let successCount = 0;
                    let skippedCount = 0;
                    const activeNewProducts = newProductsData.filter(item => !item.isDeleted);

                    if (activeNewProducts.length === 0) {
                        showNotification('No new products to merge.', 'info');
                        return;
                    }

                    for (const item of activeNewProducts) {
                        const masterProductExists = masterProductsData.find(mp => mp.sku === item.sku && !mp.isDeleted);
                        if (masterProductExists) {
                            skippedCount++;
                            console.warn(`Skipping SKU ${item.sku} as it already exists in Master List.`);
                            continue; 
                        }
                        
                        try {
                            const masterProductRef = masterProductsColRef.doc(); 
                            const masterProductData = {
                                brand: item.brand, product: item.product, sku: item.sku,
                                wkDemand: 0, price: 0.00, isDeleted: false
                            };
                            batch.set(masterProductRef, masterProductData);

                            const inventoryProductRef = inventoryColRef.doc(); 
                            const inventoryProductData = {
                                brand: item.brand, product: item.product, sku: item.sku,
                                quantity: item.quantity, status: 'In stock', shipmentDate: '',
                                remarks: `Added from New Products (Batch Merge: ${new Date().toISOString().split('T')[0]})`,
                                isDeleted: false
                            };
                            batch.set(inventoryProductRef, inventoryProductData);

                            const newProductRef = newProductsColRef.doc(item.id);
                            batch.update(newProductRef, { isDeleted: true });
                            successCount++;
                        } catch (e) {
                            console.error(`Error processing new product ${item.id || item.sku} for merge:`, e);
                        }
                    }

                    if (successCount > 0 || skippedCount > 0) {
                        try {
                            await batch.commit();
                            let message = "";
                            if (successCount > 0) message += `Successfully merged ${successCount} new products. `;
                            if (skippedCount > 0) message += `${skippedCount} products were skipped.`;
                            showNotification(message.trim(), successCount > 0 ? 'success' : 'info');
                            await updateLocalData();
                        } catch (e) {
                            console.error("Batch commit failed:", e);
                            showNotification('Error committing batch merge.', 'error');
                        }
                    } else if (activeNewProducts.length > 0) { 
                         showNotification('Failed to merge new products. Check console.', 'error');
                    } else {
                        showNotification('No new products were eligible for merging.', 'info');
                    }
                }
            });
        }
        
        // --- To Clear ---
        function renderToClearItems() {
            const tableBody = document.getElementById('to-clear-table');
            if (!tableBody) return;
            const sortedData = sortAndPin(currentToClearViewData, 'toClear');
            tableBody.innerHTML = sortedData.map(item => {
                const totalQty = (Number(item.warehouseQty) || 0) + (Number(item.storeQty) || 0);
                const weeklyDemand = Number(item.weeklyDemand) || 0;
                const weeksSupply = weeklyDemand > 0 ? (totalQty / weeklyDemand).toFixed(2) : 'N/A';
                return `
                <tr>
                    <td>
                        <button class="btn-info" onclick="editToClear('${item.id}')">‚úèÔ∏è Edit</button>
                        <button class="${item.isPinned ? 'btn-warning' : 'btn-success'}" onclick="togglePinItem('${item.id}', 'to_clear')">${item.isPinned ? '‚ûñ Unpin' : 'üìå Pin'}</button>
                        <button class="btn-danger" onclick="moveToRecycleBin('${item.id}', 'to_clear')">üóëÔ∏è Delete</button>
                    </td>
                    <td>${item.sku || ''}</td>
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td>${item.expiryDate || ''}</td>
                    <td>${item.firstHighlightedDate || ''}</td>
                    <td>${item.firstReportedBalance ?? ''}</td>
                    <td>${item.warehouseQty ?? ''}</td>
                    <td>${item.storeQty ?? ''}</td>
                    <td>${totalQty}</td>
                    <td>${item.weeklyDemand ?? ''}</td>
                    <td>${weeksSupply}</td>
                    <td><span class="status-badge ${getSupplyStatusClass(item)}">${getSupplyStatusText(item)}</span></td>
                    <td>${item.remarks || ''}</td>
                    <td>${item.actionPlan || ''}</td>
                    <td>${item.lastUpdated ? new Date(item.lastUpdated).toLocaleString() : ''}</td>
                </tr>`
            }).join('');
        }
        
        function showAddToClearModal() {
            document.getElementById('toClearModalTitle').textContent = 'Add Product to Clear';
            closeModal('toClearModal');
            document.getElementById('toClearFirstHighlightedDate').valueAsDate = new Date();
            populateBrandDropdowns('toClearBrand');
            filterProductsForBrand('', 'toClearProductName', 'toClearProductsDatalist');
            openModal('toClearModal');
        }

        async function saveToClear(event) {
            event.preventDefault();
            const id = document.getElementById('editToClearId').value;
            const brand = document.getElementById('toClearBrand').value;
            const productName = document.getElementById('toClearProductName').value;
            const skuValue = getSkuForProduct(brand, productName);
            if (!skuValue) { showNotification("Product not found in Master List.", "error"); return; }
            
            const data = {
                brand, product: productName, sku: skuValue,
                expiryDate: document.getElementById('toClearExpiryDate').value,
                firstHighlightedDate: document.getElementById('toClearFirstHighlightedDate').value,
                firstReportedBalance: parseInt(document.getElementById('toClearFirstReportedBalance').value || '0'),
                warehouseQty: parseInt(document.getElementById('toClearWarehouseQty').value || '0'),
                storeQty: parseInt(document.getElementById('toClearStoreQty').value || '0'),
                weeklyDemand: parseInt(document.getElementById('toClearWeeklyDemand').value || '0'),
                remarks: document.getElementById('toClearRemarks').value,
                actionPlan: document.getElementById('toClearActionPlan').value,
                lastUpdated: new Date().toISOString(),
                isDeleted: false,
                isPinned: id ? (toClearData.find(p => p.id === id)?.isPinned || false) : false
            };
            
            if (id) {
                const existing = toClearData.find(p => p.id === id);
                if (existing) {
                    data.firstHighlightedDate = existing.firstHighlightedDate;
                    data.firstReportedBalance = existing.firstReportedBalance;
                }
            }
            try {
                await saveDataToFirestore(toClearColRef, id, data);
                showNotification('Product to clear saved!', 'success');
                closeModal('toClearModal');
                await updateLocalData();
            } catch (e) {}
        }
        
        async function editToClear(id) {
            const item = toClearData.find(p => p.id === id);
            if (item) {
                document.getElementById('toClearModalTitle').textContent = 'Edit Product to Clear';
                document.getElementById('editToClearId').value = item.id;
                populateBrandDropdowns('toClearBrand');
                document.getElementById('toClearBrand').value = item.brand;
                filterProductsForBrand(item.brand, 'toClearProductName', 'toClearProductsDatalist');
                document.getElementById('toClearProductName').value = item.product;
                document.getElementById('toClearWeeklyDemand').value = item.weeklyDemand || '';
                document.getElementById('toClearFirstHighlightedDate').value = item.firstHighlightedDate;
                document.getElementById('toClearFirstReportedBalance').value = item.firstReportedBalance;
                document.getElementById('toClearFirstHighlightedDate').readOnly = true;
                document.getElementById('toClearFirstReportedBalance').readOnly = true;
                document.getElementById('toClearExpiryDate').value = item.expiryDate;
                document.getElementById('toClearWarehouseQty').value = item.warehouseQty;
                document.getElementById('toClearStoreQty').value = item.storeQty;
                document.getElementById('toClearRemarks').value = item.remarks || '';
                document.getElementById('toClearActionPlan').value = item.actionPlan;
                openModal('toClearModal');
            }
        }
        
        function searchToClear(searchTerm) {
            const lower = searchTerm.toLowerCase().trim();
            currentToClearViewData = lower ? toClearData.filter(i => Object.values(i).some(v => String(v).toLowerCase().includes(lower))) : [...toClearData];
            renderToClearItems();
        }

        // --- Staff Claim ---
        function renderStaffClaimItems() {
            const tableBody = document.getElementById('staff-claim-table');
            if (!tableBody) return;
            
            const sortedData = sortAndPin(currentStaffClaimViewData, 'staffClaim');

            tableBody.innerHTML = sortedData.map(item => `
                <tr>
                    <td>${item.sku || ''}</td>
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td>${item.price !== undefined ? parseFloat(item.price).toFixed(2) : ''}</td>
                    <td>${item.expiryDate || ''}</td>
                    <td>${item.claimRemarks || ''}</td>
                    <td>${item.warehouseQty !== undefined ? item.warehouseQty : ''}</td>
                    <td>${item.actionPlan || ''}</td>
                    <td>
                        <button class="btn-info" onclick="editStaffClaim('${item.id}')">‚úèÔ∏è Edit</button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddStaffClaimModal() {
            showNotification('To add items, please use the "Import CSV" function.', 'info');
        }

        async function saveStaffClaim(event) {
            event.preventDefault();
            const id = document.getElementById('editStaffClaimId').value;
            if (!id) return;

            const data = {
                expiryDate: document.getElementById('staffClaimExpiryDate').value,
                warehouseQty: parseInt(document.getElementById('staffClaimWarehouseQty').value || '0'),
                actionPlan: document.getElementById('staffClaimActionPlan').value,
                lastUpdated: new Date().toISOString(),
            };

            try {
                await saveDataToFirestore(staffClaimColRef, id, data);
                showNotification('Staff claim item updated successfully!', 'success');
                closeModal('staffClaimModal');
                await updateLocalData();
            } catch (e) { /* handled */ }
        }

        async function editStaffClaim(id) {
            const item = staffClaimData.find(p => p.id === id);
            if (item) {
                document.getElementById('staffClaimModalTitle').textContent = 'Edit Staff Claim Item';
                document.getElementById('editStaffClaimId').value = item.id;
                
                document.getElementById('staffClaimProductCode').value = item.sku || '';
                document.getElementById('staffClaimBrand').value = item.brand || '';
                document.getElementById('staffClaimProductName').value = item.product || '';
                
                document.getElementById('staffClaimExpiryDate').value = item.expiryDate;
                document.getElementById('staffClaimWarehouseQty').value = item.warehouseQty;
                document.getElementById('staffClaimActionPlan').value = item.actionPlan || '';
                openModal('staffClaimModal');
            }
        }
        
        function searchStaffClaim(searchTerm) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();
            currentStaffClaimViewData = lowerCaseSearchTerm ? staffClaimData.filter(item =>
                 Object.values(item).some(val => String(val).toLowerCase().includes(lowerCaseSearchTerm))
            ) : [...staffClaimData];
            renderStaffClaimItems();
        }

        function exportStaffClaimList() {
            const headers = ["Product Code", "Brand", "Product Name", "Price", "Exp. Date", "Import Remarks", "Quantities", "Action Remark"];
            const rows = staffClaimData.map(item => [
                item.sku || '',
                item.brand || '',
                item.product || '',
                item.price !== undefined ? parseFloat(item.price).toFixed(2) : '',
                item.expiryDate || '',
                item.claimRemarks || '',
                item.warehouseQty !== undefined ? item.warehouseQty : '',
                item.actionPlan || ''
            ]);
            const csvContent = [headers, ...rows].map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
            downloadCSV(csvContent, 'staff_claim_list.csv');
            showNotification('Staff Claim list exported!', 'success');
        }
        
        function normalizeDateAndGetRemark(dateStr) {
            if (!dateStr) return { date: '', remark: '' };
            let remark = (dateStr.match(/\(([^)]+)\)/) || [])[1] || '';
            let cleanDateStr = dateStr.replace(/\s*\([^)]+\)/, '').trim();

            let date;
            if (/^\d{4}-\d{2}-\d{2}$/.test(cleanDateStr)) {
                date = new Date(cleanDateStr + 'T00:00:00');
            } else if (/^(\d{1,2})\/(\d{2,4})$/.test(cleanDateStr)) {
                let [, month, year] = cleanDateStr.match(/^(\d{1,2})\/(\d{2,4})$/);
                year = year.length === 2 ? `20${year}` : year;
                date = new Date(`${year}-${month}-01`);
                date.setDate(new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate()); // last day of month
            } else {
                return { date: cleanDateStr, remark: remark }; // Return original if unparseable
            }
            return { date: date.toISOString().split('T')[0], remark: remark };
        }

        async function importStaffClaimCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== '');
                if (lines.length < 2) {
                    showNotification('CSV file is empty or invalid.', 'error');
                    event.target.value = '';
                    return;
                }

                const importData = [];
                let currentBrand = '';
                const knownBrands = ["SHAKLEE", "NORDIC NATURALS", "VITAGREEN", "NATURE'S PLUS", "MORISHITA JINTAN", "MOVEFREE", "GREENLIFE", "ENZYMEDICA", "JKJ"];

                for (const line of lines) {
                    const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
                    
                    const potentialBrand = (values[1] || '').toUpperCase();
                    const priceStringForBrandCheck = values[0] || '';
                    const priceForBrandCheck = parseFloat(priceStringForBrandCheck.replace(/[^0-9.]/g, ''));

                    if (knownBrands.includes(potentialBrand) && isNaN(priceForBrandCheck)) {
                        currentBrand = values[1];
                        continue;
                    }
                    
                    const priceString = values[0] || '';
                    const priceFromCsv = parseFloat(priceString.replace(/[^0-9.]/g, ''));
                    if (isNaN(priceFromCsv) || values.length < 12) continue;
                    
                    const { date: expiryDate, remark: claimRemarks } = normalizeDateAndGetRemark(values[2] || '');
                    
                    let item = { 
                        isDeleted: false, 
                        actionPlan: '', 
                        storeQty: 0,
                        expiryDate: expiryDate,
                        claimRemarks: claimRemarks,
                        warehouseQty: parseInt(values[3], 10) || 0
                    };
                    
                    const productCode = (values[11] || '').trim();
                    const masterProduct = productCode ? masterProductsData.find(mp => mp.sku === productCode) : null;

                    if (masterProduct) {
                        item.sku = masterProduct.sku;
                        item.brand = masterProduct.brand;
                        item.product = masterProduct.product;
                        item.price = masterProduct.price || 0;
                    } else {
                        item.sku = productCode || '';
                        item.brand = currentBrand;
                        item.product = (values[1] || '').trim();
                        item.price = priceFromCsv;
                        if (productCode) console.warn(`Product code ${productCode} not in master list. Using CSV data.`);
                    }
                    importData.push(item);
                }

                if (importData.length === 0) {
                    showNotification('No valid product data found to import.', 'error');
                    event.target.value = '';
                    return;
                }

                const message = `This will CLEAR all ${staffClaimData.length} existing items and replace them with ${importData.length} new items. Continue?`;
                showConfirmModal(message, async (confirmed) => {
                    if (confirmed) {
                        const batch = db.batch();
                        staffClaimData.forEach(item => batch.delete(staffClaimColRef.doc(item.id)));
                        importData.forEach(item => {
                            item.lastUpdated = new Date().toISOString();
                            batch.set(staffClaimColRef.doc(), item);
                        });
                        try {
                            await batch.commit();
                            showNotification(`Successfully imported ${importData.length} items.`, 'success');
                            await updateLocalData();
                        } catch (err) {
                            showNotification('Error during import.', 'error');
                            console.error("Batch commit failed:", err);
                        }
                    }
                    event.target.value = '';
                });
            };
            reader.readAsText(file);
        }

        // --- Master List ---
        function renderMasterListItems() {
            const tableBody = document.getElementById('master-table');
            if (!tableBody) return;
            const sortedData = sortArray(currentMasterListViewData, sortState.master.column, sortState.master.direction);
            tableBody.innerHTML = sortedData.map(item => {
                let expiry = '';
                if (item.expiryDate) {
                    const [y, m] = item.expiryDate.split('-');
                    expiry = `${new Date(y, m - 1).toLocaleString('default', { month: 'short' })}-${y.slice(-2)}`;
                }
                return `
                <tr>
                    <td>
                        <button class="btn-info" onclick="editMasterProduct('${item.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn-danger" onclick="moveToRecycleBin('${item.id}', 'master_products')">üóëÔ∏è Delete</button>
                    </td>
                    <td>${item.sku || ''}</td>
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td>${item.wkDemand ?? ''}</td>
                    <td>${expiry}</td>
                    <td>${item.price !== undefined ? parseFloat(item.price).toFixed(2) : ''}</td>
                </tr>`
            }).join('');
        }
        
        function showAddMasterProductModal() {
            document.getElementById('masterProductModalTitle').textContent = 'Add Master Product';
            closeModal('masterProductModal');
            populateBrandDropdowns('masterBrand');
            populateExpiryDateSelectors(null);
            openModal('masterProductModal');
        }

        function populateExpiryDateSelectors(selectedDate) {
            const monthSelect = document.getElementById('masterExpiryMonth');
            const yearSelect = document.getElementById('masterExpiryYear');
            monthSelect.innerHTML = '<option value="">Month</option>';
            yearSelect.innerHTML = '<option value="">Year</option>';
            for (let i = 1; i <= 12; i++) {
                monthSelect.innerHTML += `<option value="${String(i).padStart(2, '0')}">${new Date(2000, i - 1, 1).toLocaleString('default', { month: 'long' })}</option>`;
            }
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i <= currentYear + 15; i++) {
                yearSelect.innerHTML += `<option value="${i}">${i}</option>`;
            }
            if (selectedDate?.includes('-')) {
                const [year, month] = selectedDate.split('-');
                if (![...yearSelect.options].some(opt => opt.value === year)) {
                    yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
                }
                monthSelect.value = month;
                yearSelect.value = year;
            }
        }
        
        async function saveMasterProduct(event) {
            event.preventDefault();
            const id = document.getElementById('editMasterProductId').value;
            const sku = document.getElementById('sku').value.trim();
            const productName = document.getElementById('masterProductName').value.trim();
            const brandName = document.getElementById('masterBrand').value;
            if (!sku || !productName || !brandName) {
                showNotification('SKU, Product Name, and Brand are required.', 'error');
                return;
            }
            if (masterProductsData.some(p => p.sku === sku && p.id !== id)) {
                showNotification('This SKU already exists.', 'error');
                return;
            }
            
            const month = document.getElementById('masterExpiryMonth').value;
            const year = document.getElementById('masterExpiryYear').value;
            const expiryDateValue = (year && month) ? `${year}-${month}` : '';

            const data = {
                brand: brandName,
                product: productName,
                wkDemand: parseInt(document.getElementById('wkDemand').value || '0'),
                expiryDate: expiryDateValue,
                sku,
                price: parseFloat(document.getElementById('price').value || '0'),
                isDeleted: false
            };
            try {
                await saveDataToFirestore(masterProductsColRef, id, data);
                showNotification('Master product saved!', 'success');
                closeModal('masterProductModal');
                await updateLocalData();
            } catch (e) {}
        }
        
        async function editMasterProduct(id) {
            const item = masterProductsData.find(p => p.id === id);
            if (item) {
                document.getElementById('masterProductModalTitle').textContent = 'Edit Master Product';
                document.getElementById('editMasterProductId').value = item.id;
                populateBrandDropdowns('masterBrand');
                document.getElementById('masterBrand').value = item.brand;
                document.getElementById('masterProductName').value = item.product;
                document.getElementById('wkDemand').value = item.wkDemand || '';
                populateExpiryDateSelectors(item.expiryDate || '');
                document.getElementById('sku').value = item.sku;
                document.getElementById('price').value = item.price;
                openModal('masterProductModal');
            }
        }
        
        function searchMasterList(searchTerm) {
            const lower = searchTerm.toLowerCase().trim();
            currentMasterListViewData = lower ? masterProductsData.filter(i => Object.values(i).some(v => String(v).toLowerCase().includes(lower))) : [...masterProductsData];
            renderMasterListItems();
        }

        // --- Recycle Bin ---
        function renderRecycleBinItems() {
            const tableBody = document.getElementById('recycle-bin-table');
            if (!tableBody) return;
            const sortedData = sortArray(currentRecycleBinViewData, 'sku', 'asc');
            tableBody.innerHTML = sortedData.map(item => `
                <tr>
                    <td>
                        <button class="btn-success" onclick="restoreItem('${item.id}', '${item.originalCollection}')">‚Ü©Ô∏è Restore</button>
                        <button class="btn-danger" onclick="deleteItemPermanently('${item.id}', '${item.originalCollection}')">‚ùå Permanent Delete</button>
                    </td>
                    <td>${item.sku || ''}</td>
                    <td>${item.originalCollection || ''}</td>
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                </tr>
            `).join('');
        }
        
        async function restoreItem(id, originalCollection) {
            showConfirmModal('Are you sure you want to restore this item?', async (confirmed) => {
                if (confirmed) {
                    try {
                        const itemToRestore = deletedItemsData.find(item => item.id === id && item.originalCollection === originalCollection);
                        if (!itemToRestore) {
                             showNotification('Item not found for restoration.', 'error');
                             return;
                        }

                        if (originalCollection === 'master_products' || originalCollection === 'new_products' || originalCollection === 'staff_claim') { 
                            const sku = itemToRestore.sku;
                            if (sku) {
                                if ( (originalCollection === 'master_products' && masterProductsData.some(p => p.sku === sku && !p.isDeleted && p.id !== id)) ||
                                     (originalCollection === 'new_products' && newProductsData.some(p => p.sku === sku && !p.isDeleted && p.id !== id)) ||
                                     (originalCollection === 'staff_claim' && staffClaimData.some(p => p.sku === sku && !p.isDeleted && p.id !== id)) ) { 
                                     showNotification(`Cannot restore: SKU ${sku} already exists in an active item in ${originalCollection}. Please resolve conflict first.`, 'error');
                                     return;
                                }
                            }
                        }

                        const collectionRef = db.collection(originalCollection);
                        await saveDataToFirestore(collectionRef, id, { isDeleted: false });
                        showNotification('Item restored successfully!', 'success');
                        await updateLocalData();
                    } catch (e) {
                        console.error(`Error restoring item to ${originalCollection}:`, e);
                        showNotification('Error restoring item.', 'error');
                    }
                }
            });
        }

        async function deleteItemPermanently(id, originalCollection) {
            showConfirmModal('WARNING: This will permanently delete this item. Are you sure?', async (confirmed) => {
                if (confirmed) {
                    try {
                        const collectionRef = db.collection(originalCollection);
                        await collectionRef.doc(id).delete();
                        showNotification('Item permanently deleted!', 'success');
                        await updateLocalData();
                    } catch (e) {
                        console.error(`Error permanently deleting item from ${originalCollection}:`, e);
                        showNotification('Error permanently deleting item.', 'error');
                    }
                }
            });
        }
        
        async function emptyRecycleBin() {
            showConfirmModal('WARNING: This will permanently delete ALL items in the Recycle Bin. Are you sure?', async (confirmed) => {
                if (confirmed) {
                    if (deletedItemsData.length === 0) {
                        showNotification('Recycle Bin is already empty.', 'info');
                        return;
                    }
                    const batch = db.batch();
                    let deleteCount = 0;
                    for (const item of deletedItemsData) {
                        try {
                            const collectionRef = db.collection(item.originalCollection);
                            batch.delete(collectionRef.doc(item.id));
                            deleteCount++;
                        } catch (e) {
                            console.error(`Error adding item ${item.id} to batch for permanent deletion:`, e);
                        }
                    }

                    if (deleteCount > 0) {
                        try {
                            await batch.commit();
                            showNotification(`Successfully deleted ${deleteCount} items permanently.`, 'success');
                            await updateLocalData();
                        } catch (e) {
                            console.error("Batch commit for empty recycle bin failed:", e);
                            showNotification('Error emptying recycle bin.', 'error');
                        }
                    } else {
                         showNotification('No items were eligible for deletion, or an error occurred preparing deletions.', 'info');
                    }
                }
            });
        }
        
        function searchRecycleBin(searchTerm) {
            const lower = searchTerm.toLowerCase().trim();
            currentRecycleBinViewData = lower ? deletedItemsData.filter(i => Object.values(i).some(v => String(v).toLowerCase().includes(lower))) : [...deletedItemsData];
            renderRecycleBinItems();
        }
        
        // --- Brands & Statuses ---
        function showAddBrandModal() {
            document.getElementById('addBrandModal').querySelector('form').reset();
            openModal('addBrandModal');
        }
        
        async function saveNewBrand(event) {
            event.preventDefault();
            const newBrandNameInput = document.getElementById('newBrandName');
            const newBrandName = newBrandNameInput.value.trim();

            if (!newBrandName) {
                showNotification('Brand name cannot be empty.', 'error');
                return;
            }
            if (brandsData.some(brand => brand.name.toLowerCase() === newBrandName.toLowerCase())) {
                showNotification('This brand already exists.', 'error');
                return;
            }
            try {
                await saveDataToFirestore(brandsColRef, null, { name: newBrandName, isDeleted: false });
                showNotification('Brand added successfully!', 'success');
                closeModal('addBrandModal'); 
                await updateLocalData(); 
            } catch (e) {
                showNotification('Error adding brand. Check console.', 'error');
                console.error("Error adding new brand:", e);
            }
        }
        
        function showAddStatusModal() {
            document.getElementById('addStatusModal').querySelector('form').reset();
            openModal('addStatusModal');
        }
        
        async function saveNewStatus(event) {
            event.preventDefault();
            const newStatusNameInput = document.getElementById('newStatusName');
            const newStatusName = newStatusNameInput.value.trim();

            if (!newStatusName) {
                showNotification('Status name cannot be empty.', 'error');
                return;
            }
            if (statusesData.some(status => status.name.toLowerCase() === newStatusName.toLowerCase())) {
                showNotification('This status already exists.', 'error');
                return;
            }
            try {
                await saveDataToFirestore(statusesColRef, null, { name: newStatusName, isDeleted: false });
                showNotification('Status added successfully!', 'success');
                closeModal('addStatusModal');
                await updateLocalData();
            } catch (e) {
                showNotification('Error adding status. Check console.', 'error');
                console.error("Error adding new status:", e);
            }
        }
        
        // --- Management & Utilities ---
        function getTableDataForExport(tableKey, dataArray) {
            let headers = [];
            let rows = [];

            if (tableKey === 'inventory') {
                headers = ["Product Code", "Brand", "Product", "Quantity", "Status", "Shipment Date", "Remarks", "Last Updated"];
                rows = dataArray.map(item => [
                    item.sku || '', item.brand || '', item.product || '',
                    item.quantity !== undefined ? item.quantity : '',
                    item.status || '', item.shipmentDate || '', item.remarks || '',
                    item.lastUpdated ? new Date(item.lastUpdated).toLocaleString() : ''
                ]);
            } else if (tableKey === 'new_products') {
                headers = ["Product Code", "Brand", "Product", "Added Date", "Arrival Date", "Quantity", "Notes", "Last Updated"];
                rows = dataArray.map(item => [
                    item.sku || '', item.brand || '', item.product || '',
                    item.addedDate || '', item.arrivalDate || '',
                    item.quantity !== undefined ? item.quantity : '', item.notes || '',
                    item.lastUpdated ? new Date(item.lastUpdated).toLocaleString() : ''
                ]);
            } else if (tableKey === 'to_clear') {
                headers = ["Product Code", "Brand", "Product", "Expiry Date", "First Highlighted", "Initial Bal", "WH Qty", "Store Qty", "Total Qty", "Wk Demand", "Wks Supply", "Supply Status", "Remarks", "Action Plan", "Last Updated"];
                rows = dataArray.map(item => {
                    const totalQty = (Number(item.warehouseQty) || 0) + (Number(item.storeQty) || 0);
                    const weeksSupply = (Number(item.weeklyDemand) || 0) > 0 ? (totalQty / Number(item.weeklyDemand)).toFixed(2) : 'N/A';
                    return [
                        item.sku || '', item.brand || '', item.product || '',
                        item.expiryDate || '', item.firstHighlightedDate || '',
                        item.firstReportedBalance !== undefined ? item.firstReportedBalance : '',
                        item.warehouseQty !== undefined ? item.warehouseQty : '',
                        item.storeQty !== undefined ? item.storeQty : '',
                        totalQty,
                        item.weeklyDemand !== undefined ? item.weeklyDemand : '',
                        weeksSupply, getSupplyStatusText(item), item.remarks || '', item.actionPlan || '',
                        item.lastUpdated ? new Date(item.lastUpdated).toLocaleString() : ''
                    ];
                });
            } else if (tableKey === 'master_products') {
                headers = ["Product Code", "Brand", "Product Name", "WK Demand", "Expiry Date", "Price"];
                rows = dataArray.map(item => {
                    let formattedExpiry = '';
                    if (item.expiryDate) { // Stored as 'YYYY-MM'
                        const [year, month] = item.expiryDate.split('-');
                        const dateObj = new Date(year, month - 1);
                        const monthName = dateObj.toLocaleString('default', { month: 'short' });
                        const shortYear = year.slice(-2);
                        formattedExpiry = `${monthName}-${shortYear}`;
                    }
                    return [
                        item.sku || '',
                        item.brand || '',
                        item.product || '',
                        item.wkDemand !== undefined ? item.wkDemand : '',
                        formattedExpiry,
                        item.price !== undefined ? parseFloat(item.price).toFixed(2) : ''
                    ];
                });
            } else if (tableKey === 'staff_claim') {
                headers = ["Product Code", "Brand", "Product Name", "Price", "Exp. Date", "Import Remarks", "Quantities", "Action Remark"];
                rows = dataArray.map(item => [
                    item.sku || '',
                    item.brand || '',
                    item.product || '',
                    item.price !== undefined ? parseFloat(item.price).toFixed(2) : '',
                    item.expiryDate || '',
                    item.claimRemarks || '',
                    item.warehouseQty !== undefined ? item.warehouseQty : '',
                    item.actionPlan || ''
                ]);
            }
            return { headers, rows };
        }

        async function exportAllData() {
            if (typeof JSZip === 'undefined') {
                showNotification('Export library not loaded. Please try again.', 'error');
                return;
            }

            let zip = new JSZip();
            const collectionsToExport = [
                { key: 'inventory', data: inventoryData, fileName: 'oos_low_stock_products.csv' },
                { key: 'new_products', data: newProductsData, fileName: 'new_products.csv' },
                { key: 'to_clear', data: toClearData, fileName: 'to_clear_products.csv' },
                { key: 'master_products', data: masterProductsData, fileName: 'master_list.csv' },
                { key: 'staff_claim', data: staffClaimData, fileName: 'staff_claim_list.csv' }
            ];

            for (const collectionInfo of collectionsToExport) {
                const { headers, rows } = getTableDataForExport(collectionInfo.key, collectionInfo.data);
                if (rows.length === 0) continue;
                let csvContent = [headers, ...rows].map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
                zip.file(collectionInfo.fileName, csvContent);
            }

            try {
                const content = await zip.generateAsync({ type: "blob" });
                downloadBlob(content, 'inventory_reports.zip');
                showNotification('Data exported as ZIP!', 'success');
            } catch (e) {
                console.error("Error generating zip file:", e);
                showNotification('Error exporting data.', 'error');
            }
        }
        
        function downloadCSV(csvContent, fileName) { 
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a"); 
            const url = URL.createObjectURL(blob); 
            link.setAttribute("href", url); 
            link.setAttribute("download", fileName); 
            document.body.appendChild(link); 
            link.click(); 
            document.body.removeChild(link); 
        }

        function downloadBlob(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        async function loadSampleData() {
            showNotification('Loading sample data... This may take a moment.', 'info');
            const sampleBrands = [
                { name: 'BrandX', isDeleted: false }, { name: 'BrandY', isDeleted: false }, { name: 'BrandZ', isDeleted: false },
                { name: 'BrandA', isDeleted: false }, { name: 'BrandB', isDeleted: false }, { name: 'BrandC', isDeleted: false }
            ];
            const sampleStatuses = [ // "In stock" is not added here by default for OOS/LOW selection logic
                { name: 'OOS', isDeleted: false }, { name: 'Low stock', isDeleted: false }, { name: 'Awaiting Delivery', isDeleted: false }
            ];
            const sampleMasterProducts = [
                { brand: 'BrandX', product: 'Laptop Pro', sku: 'LX1001', wkDemand: 10, expiryDate: '2027-12', price: 1200.00, isDeleted: false },
                { brand: 'BrandY', product: 'Wireless Mouse', sku: 'WM2002', wkDemand: 25, expiryDate: '2026-06', price: 25.00, isDeleted: false },
                { brand: 'BrandX', product: 'Mechanical Keyboard', sku: 'MK3003', wkDemand: 15, expiryDate: '', price: 80.00, isDeleted: false },
                { brand: 'BrandZ', product: 'Smart Speaker', sku: 'SS4004', wkDemand: 5, expiryDate: '2028-01', price: 99.00, isDeleted: false },
                { brand: 'BrandA', product: 'Ergonomic Chair', sku: 'EC5005', wkDemand: 2, expiryDate: '2029-05', price: 350.00, isDeleted: false },
                { brand: 'BrandB', product: 'Old Stock Monitor', sku: 'OSM6006', wkDemand: 1, expiryDate: '2025-07', price: 150.00, isDeleted: false },
                { brand: 'BrandC', product: 'Demo Unit Tablet', sku: 'DUT7007', wkDemand: 0, expiryDate: '2025-08', price: 100.00, isDeleted: false }
            ];
            const sampleInventory = [
                { brand: 'BrandX', product: 'Laptop Pro', sku: 'LX1001', quantity: 5, status: 'Low stock', shipmentDate: '2025-07-01', remarks: 'Partial shipment received', isDeleted: false },
                { brand: 'BrandY', product: 'Wireless Mouse', sku: 'WM2002', quantity: 0, status: 'OOS', shipmentDate: '2025-07-15', remarks: 'Awaiting restock', isDeleted: false },
                { brand: 'BrandX', product: 'Mechanical Keyboard', sku: 'MK3003', quantity: 20, status: 'Low stock', shipmentDate: '', remarks: '', isDeleted: false } // Example of 'In stock' like, but low
            ];
            const sampleNewProducts = [
                { brand: 'BrandZ', product: 'Smart Speaker', sku: 'SS4004', arrivalDate: '2025-06-15', quantity: 50, notes: 'New model launch', addedDate: '2025-05-20', isDeleted: false },
                { brand: 'BrandA', product: 'Ergonomic Chair', sku: 'EC5005', arrivalDate: '2025-06-20', quantity: 15, notes: '', addedDate: '2025-05-25', isDeleted: false }
            ];
            const sampleToClear = [
                { brand: 'BrandB', product: 'Old Stock Monitor', sku: 'OSM6006', expiryDate: '2025-07-31', firstHighlightedDate: '2025-05-01', firstReportedBalance: 20, warehouseQty: 10, storeQty: 5, weeklyDemand: 1, remarks: 'Slight scratch on bezel', actionPlan: 'Promotional discount 20%', isDeleted: false },
                { brand: 'BrandC', product: 'Demo Unit Tablet', sku: 'DUT7007', expiryDate: '2025-08-30', firstHighlightedDate: '2025-05-10', firstReportedBalance: 5, warehouseQty: 1, storeQty: 2, weeklyDemand: 0, remarks: 'Used for display', actionPlan: 'Bundle with accessories', isDeleted: false }
            ];
            const sampleStaffClaim = [
                { brand: 'BrandX', product: 'Faulty Headset', sku: 'FH8008', expiryDate: '2025-10-15', claimRemarks: 'Damaged during transit', warehouseQty: 2, storeQty: 0, actionPlan: 'Claim from supplier', lastUpdated: new Date().toISOString(), isDeleted: false, price: 50.00 },
                { brand: 'BrandY', product: 'Scratched Phone', sku: 'SP9009', expiryDate: '2026-01-20', claimRemarks: 'Customer return', warehouseQty: 0, storeQty: 1, actionPlan: 'Send for repair', lastUpdated: new Date().toISOString(), isDeleted: false, price: 200.00 }
            ];
            const sampleRemarks = [
                { text: 'Damaged during transit', isDeleted: false },
                { text: 'Customer return', isDeleted: false },
                { text: 'Expired product', isDeleted: false }
            ];
            
            const collectionsAndData = [
                { ref: brandsColRef, data: sampleBrands },
                { ref: statusesColRef, data: sampleStatuses },
                { ref: masterProductsColRef, data: sampleMasterProducts },
                { ref: inventoryColRef, data: sampleInventory },
                { ref: newProductsColRef, data: sampleNewProducts },
                { ref: toClearColRef, data: sampleToClear },
                { ref: staffClaimColRef, data: sampleStaffClaim },
                { ref: db.collection('remarks'), data: sampleRemarks }
            ];

            try {
                for (const { ref } of collectionsAndData) {
                    const snapshot = await ref.get();
                    if (snapshot.docs.length > 0) {
                        const deleteBatch = db.batch();
                        snapshot.docs.forEach(doc => deleteBatch.delete(doc.ref));
                        await deleteBatch.commit();
                    }
                }
                const loadBatch = db.batch();
                for (const { ref, data } of collectionsAndData) {
                    data.forEach(item => {
                        const docRef = ref.doc(); 
                        loadBatch.set(docRef, item);
                    });
                }
                await loadBatch.commit();
                showNotification('Sample data loaded successfully!', 'success');
                await updateLocalData();
            } catch (e) {
                console.error("Error loading sample data:", e);
                showNotification('Error loading sample data. Check console.', 'error');
            }
        }
        
        function confirmLoadSampleData() { showConfirmModal('WARNING: This will delete ALL existing data. Are you sure?', async (c) => { if(c) await loadSampleData(); }); }
        
        // --- Sorting ---
        function sortTable(tableKey, column) {
            const state = sortState[tableKey];
            state.direction = (state.column === column && state.direction === 'asc') ? 'desc' : 'asc';
            state.column = column;
            updateAllTablesAndViews();
            updateSortIndicators(tableKey);
        }

        function sortArray(arr, column, direction) {
            if (!column) return arr;
            return [...arr].sort((a, b) => {
                let valA = a[column];
                let valB = b[column];
                const asc = direction === 'asc';
                if (valA === undefined || valA === null || valA === '') return 1;
                if (valB === undefined || valB === null || valB === '') return -1;
                if (typeof valA === 'string' && /^\d{4}-\d{2}/.test(valA)) {
                    valA = new Date(valA);
                    valB = new Date(valB);
                }
                if (valA < valB) return asc ? -1 : 1;
                if (valA > valB) return asc ? 1 : -1;
                return 0;
            });
        }
        
        function updateSortIndicators(tableKey) {
            const containerId = `${tableKey === 'master' ? 'master-table' : (tableKey === 'newProducts' ? 'new-products-table' : tableKey)}-table-container`;
            const container = document.getElementById(containerId);
            container?.querySelectorAll('thead th[data-column-key]').forEach(th => {
                const arrow = th.querySelector('.sort-arrow');
                if(arrow) arrow.textContent = th.dataset.columnKey === sortState[tableKey].column ? (sortState[tableKey].direction === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : '';
            });
        }
        
        // --- Dashboard & Alerts ---
        function updateDashboardStats() {
            document.getElementById('oos-count').textContent = inventoryData.filter(i => i.status === 'OOS').length;
            document.getElementById('low-count').textContent = inventoryData.filter(i => i.status?.toLowerCase().includes('low stock')).length;
            document.getElementById('new-count').textContent = newProductsData.length;
            document.getElementById('to-clear-count').textContent = toClearData.length;
            document.getElementById('staff-claim-count').textContent = staffClaimData.length;
        }

        function updateAlerts() {
            const alertsDiv = document.getElementById('alerts');
            alertsDiv.innerHTML = '';
            let alertContent = '';

            const recentOOS = inventoryData.filter(item => !item.isDeleted && item.status === 'OOS').slice(0, 5);
            const recentLowStock = inventoryData.filter(item => !item.isDeleted && item.status && item.status.toLowerCase().includes('low stock')).slice(0, 5);
            
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const ninetyDaysFromToday = new Date(today);
            ninetyDaysFromToday.setDate(today.getDate() + 90);

            const expiringSoon = toClearData.filter(item => {
                if (!item.isDeleted && item.expiryDate) {
                    try {
                        const expiry = new Date(item.expiryDate);
                        return expiry >= today && expiry <= ninetyDaysFromToday;
                    } catch (e) { return false; }
                }
                return false;
            }).sort((a,b) => new Date(a.expiryDate) - new Date(b.expiryDate)).slice(0, 5);

            if (recentOOS.length > 0) {
                alertContent += '<h4>Out of Stock Items:</h4><ul>' +
                    recentOOS.map(item => `<li><span class="status-badge oos">OOS</span> ${item.product || 'N/A'} (${item.brand || 'N/A'})</li>`).join('') +
                    '</ul>';
            }
            if (recentLowStock.length > 0) {
                alertContent += '<h4>Low Stock Items:</h4><ul>' +
                    recentLowStock.map(item => `<li><span class="status-badge low">Low</span> ${item.product || 'N/A'} (${item.brand || 'N/A'}) - Qty: ${item.quantity}</li>`).join('') +
                    '</ul>';
            }
            if (expiringSoon.length > 0) {
                alertContent += '<h4>Expiring Soon (within 90 days):</h4><ul>' +
                    expiringSoon.map(item => `<li><span class="status-badge alert-status">Expiring</span> ${item.product || 'N/A'} (${item.brand || 'N/A'}) - Expiry: ${item.expiryDate}</li>`).join('') +
                    '</ul>';
            }
            
            const dangerToClearItems = toClearData.filter(item => !item.isDeleted && (getSupplyStatusText(item) === 'Danger' || getSupplyStatusText(item) === 'Expired')).slice(0, 5);

            if (dangerToClearItems.length > 0) {
                alertContent += '<h4>Danger Zone (To Clear):</h4><ul>' +
                    dangerToClearItems.map(item => `<li><span class="status-badge ${getSupplyStatusClass(item)}">${getSupplyStatusText(item)}</span> ${item.product || 'N/A'} (${item.brand || 'N/A'})</li>`).join('') +
                    '</ul>';
            }
            
            alertsDiv.innerHTML = alertContent || '<p>No immediate alerts.</p>';
        }

        function getSupplyStatusClass(item) {
            const expiryDateStr = item.expiryDate;
            const totalQuantity = (Number(item.warehouseQty) || 0) + (Number(item.storeQty) || 0);
            const weeklyDemand = Number(item.weeklyDemand) || 0;
            const today = new Date(); today.setHours(0, 0, 0, 0);

            if (!expiryDateStr) return 'info'; 
            const expiryDate = new Date(expiryDateStr);
            if (expiryDate <= today) return 'danger-status'; 
            if (weeklyDemand <= 0) return 'danger-status'; 

            const daysToSellOut = (totalQuantity / weeklyDemand) * 7;
            const projectedSellOutDate = new Date(today.getTime() + daysToSellOut * 24 * 60 * 60 * 1000);

            const expiryDateMinus9Months = new Date(expiryDate);
            expiryDateMinus9Months.setMonth(expiryDateMinus9Months.getMonth() - 9);
            const expiryDateMinus6Months = new Date(expiryDate);
            expiryDateMinus6Months.setMonth(expiryDateMinus6Months.getMonth() - 6);

            if (projectedSellOutDate <= expiryDateMinus9Months) return 'normal'; 
            else if (projectedSellOutDate <= expiryDateMinus6Months) return 'alert-status'; 
            else return 'danger-status'; 
        }

        function getSupplyStatusText(item) {
            const expiryDateStr = item.expiryDate;
            const totalQuantity = (Number(item.warehouseQty) || 0) + (Number(item.storeQty) || 0);
            const weeklyDemand = Number(item.weeklyDemand) || 0;
            const today = new Date(); today.setHours(0, 0, 0, 0);

            if (!expiryDateStr) return 'N/A';
            const expiryDate = new Date(expiryDateStr);
            if (expiryDate <= today) return 'Expired';
            if (weeklyDemand <= 0) return 'Danger';

            const daysToSellOut = (totalQuantity / weeklyDemand) * 7;
            const projectedSellOutDate = new Date(today.getTime() + daysToSellOut * 24 * 60 * 60 * 1000);
            
            const expiryDateMinus9Months = new Date(expiryDate);
            expiryDateMinus9Months.setMonth(expiryDateMinus9Months.getMonth() - 9);
            const expiryDateMinus6Months = new Date(expiryDate);
            expiryDateMinus6Months.setMonth(expiryDateMinus6Months.getMonth() - 6);

            if (projectedSellOutDate <= expiryDateMinus9Months) return 'Normal';
            else if (projectedSellOutDate <= expiryDateMinus6Months) return 'Alert';
            else return 'Danger';
        }
        
        function updateManagementStats() {
            document.getElementById('total-products').textContent = masterProductsData.length;
            document.getElementById('total-products-all').textContent = new Set(masterProductsData.map(p => p.sku)).size;
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        }
        
        async function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== ''); 
                if (lines.length < 2) { 
                    showNotification('CSV file is empty, invalid, or has no data rows.', 'error');
                    event.target.value = ''; 
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase()); 
                const requiredHeaders = ['product code', 'brand', 'product name']; 
                const missingHeaders = requiredHeaders.filter(rh => !headers.includes(rh));
                if (missingHeaders.length > 0) {
                    showNotification(`CSV missing required headers: ${missingHeaders.join(', ')}.`, 'error');
                    event.target.value = '';
                    return;
                }
                
                const headerMap = {
                    'product code': 'sku', 'brand': 'brand', 'product name': 'product',
                    'wk demand': 'wkDemand', 'expiry date': 'expiryDate', 'price': 'price'
                };

                const importData = [];
                const importedSkusThisBatch = new Set(); 

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    if (values.length !== headers.length) {
                        console.warn(`Skipping CSV row ${i + 1} due to column mismatch.`);
                        continue;
                    }
                    let item = { isDeleted: false }; 
                    let validRow = true;
                    let currentSku = '';

                    headers.forEach((header, index) => {
                        const fieldName = headerMap[header.toLowerCase()];
                        if (fieldName) {
                            let value = values[index];
                            if (fieldName === 'price') item[fieldName] = parseFloat(value) || 0;
                            else if (fieldName === 'wkDemand') item[fieldName] = parseInt(value) || 0;
                            else if (fieldName === 'sku') {
                                currentSku = value.trim();
                                if (!currentSku) validRow = false; 
                                else item[fieldName] = currentSku;
                            }
                            else item[fieldName] = value;
                        }
                    });

                    if (!item.brand || !item.product) validRow = false;

                    if (validRow && currentSku) {
                        if (importedSkusThisBatch.has(currentSku)) {
                            console.warn(`Skipping CSV row ${i+1}: Duplicate SKU '${currentSku}' in CSV.`);
                            validRow = false;
                        } else {
                            importedSkusThisBatch.add(currentSku);
                            importData.push(item);
                        }
                    } else if (!validRow) {
                         console.warn(`Skipping invalid CSV row ${i+1}.`);
                    }
                }

                if (importData.length === 0) {
                    showNotification('No valid data found to import from CSV.', 'error');
                    event.target.value = '';
                    return;
                }

                showConfirmModal(`Found ${importData.length} valid items. Importing will add new items or update existing ones in Master List based on SKU. Continue?`, async (confirmed) => {
                    if (confirmed) {
                        const batch = db.batch();
                        let newItemsCount = 0;
                        let updatedItemsCount = 0;

                        for (const item of importData) {
                            try {
                                const existingProduct = masterProductsData.find(mp => mp.sku === item.sku && !mp.isDeleted);
                                if (existingProduct) { 
                                    const docRef = masterProductsColRef.doc(existingProduct.id);
                                    batch.set(docRef, item, { merge: true }); 
                                    updatedItemsCount++;
                                } else { 
                                    const docRef = masterProductsColRef.doc(); 
                                    const newPayload = { ...item, wkDemand: item.wkDemand || 0, isDeleted: false };
                                    batch.set(docRef, newPayload);
                                    newItemsCount++;
                                }
                            } catch (err) {
                                console.error("Error adding item to batch for import:", item, err);
                            }
                        }

                        if (newItemsCount > 0 || updatedItemsCount > 0) {
                            try {
                                await batch.commit();
                                showNotification(`Successfully imported: ${newItemsCount} new, ${updatedItemsCount} updated.`, 'success');
                                await updateLocalData();
                            } catch (err) {
                                console.error("Batch commit failed for import:", err);
                                showNotification('Error during CSV import batch commit.', 'error');
                            }
                        } else {
                            showNotification('No items were imported.', 'info');
                        }
                    }
                    event.target.value = ''; 
                });
            };
            reader.onerror = () => {
                showNotification('Error reading CSV file.', 'error');
                event.target.value = '';
            };
            reader.readAsText(file);
        }
        
        // --- Initialization ---
        window.onload = async function() {
            if (typeof JSZip === 'undefined') {
                const script = document.createElement('script');
                script.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js";
                script.onload = initializeApp;
                script.onerror = () => {
                    console.error("Failed to load JSZip.");
                    initializeApp(); 
                };
                document.head.appendChild(script);
            } else {
                await initializeApp();
            }
        };

        async function initializeApp() {
            await updateLocalData();
            const activeTab = document.querySelector('.tab.active') || document.querySelector('.tab');
            if(activeTab) {
                switchTab(activeTab, activeTab.getAttribute('onclick').match(/'([^']+)'/)[1]);
            }
            Object.keys(sortState).forEach(updateSortIndicators);
        }

    </script>
</body>
</html>

