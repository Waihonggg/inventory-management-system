<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-radius: 15px;
        }

        /* Headings */
        h1 {
            color: #2c3e50;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
            overflow-x: auto;
            gap: 2px;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            background-color: transparent;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #7f8c8d;
            min-width: 120px;
            text-align: center;
            border: 2px solid transparent;
            border-bottom: none;
        }

        .tab:hover {
            background-color: #f8f9fa;
            color: #2c3e50;
            border-color: #e1e8ed;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Stats Cards for Dashboard */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.urgent {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            line-height: 1;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Controls (Buttons, Search) */
        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Changed to flex-start for better alignment with multiple items */
            flex-wrap: wrap;
            gap: 15px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e1e8ed;
        }
         .controls > * { /* Ensure items in controls don't shrink excessively */
            flex-shrink: 0;
        }


        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        th, td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
            cursor: pointer; /* For sortable headers */
        }
        th .sort-arrow { /* For sort indicators */
            font-size: 0.8em;
            margin-left: 5px;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .oos {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .low {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .normal {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .danger-status {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .alert-status {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        /* Buttons */
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        /* Search Box */
        .search-box {
            padding: 12px 16px;
            width: 280px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: none;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        /* Form Group */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .form-group input:disabled, .form-group select:disabled, .form-group textarea:disabled {
            background-color: #f0f0f0;
            opacity: 0.7;
            cursor: not-allowed;
        }
        .form-group label.disabled-label {
            opacity: 0.5;
        }


        /* Alert Notifications */
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 600;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Confirmation Modal Specific Styles */
        #confirmModal .modal-content {
            text-align: center;
            padding: 40px;
            max-width: 450px;
        }

        #confirmModal .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        #confirmModal .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        #confirmModal .modal-buttons button {
            flex: 1;
            max-width: 150px;
            padding: 12px 25px;
            font-size: 14px;
        }

        /* --- Mobile Responsiveness --- */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            .subtitle {
                font-size: 1rem;
                margin-bottom: 20px;
            }

            .tabs {
                flex-wrap: wrap; /* Allow tabs to wrap to next line */
                justify-content: center; /* Center tabs when wrapped */
                border-bottom: none; /* Remove border when wrapped */
            }

            .tab {
                min-width: unset; /* Remove fixed min-width */
                flex: 1 1 auto; /* Allow tabs to grow/shrink */
                padding: 10px 15px;
                font-size: 10px;
                border-bottom: 2px solid #ecf0f1; /* Add border to each tab */
            }

            .tab.active {
                transform: none; /* Remove transform on active tab */
                box-shadow: none; /* Remove shadow on active tab */
                border-bottom: 2px solid #667eea;
            }

            .stats-cards {
                grid-template-columns: 1fr; /* Stack cards vertically */
            }

            .stat-card {
                padding: 20px;
            }

            .stat-number {
                font-size: 2.5rem;
            }

            .controls {
                flex-direction: column; /* Stack buttons and search vertically */
                align-items: stretch; /* Stretch items to full width */
                padding: 15px;
            }
            .controls .search-box { /* Ensure search box in controls takes full width on mobile */
                 width: 100%;
            }


            button {
                width: 100%;
                margin-bottom: 10px; /* Add space between stacked buttons */
                font-size: 12px;
                padding: 10px 15px;
            }

            .search-box { /* General search box styling for mobile */
                width: 100%; 
            }


            /* Responsive Tables: force table to scroll horizontally */
            table {
                display: block; /* Make table a block element */
                width: 100%;
                overflow-x: auto; /* Enable horizontal scrolling */
                -webkit-overflow-scrolling: touch; /* Smooth scrolling for iOS */
                white-space: nowrap; /* Prevent content from wrapping */
            }

            th, td {
                min-width: 120px; /* Ensure columns have a minimum width */
                padding: 10px;
            }

            .modal-content {
                margin: 20px auto; /* Adjust margin for smaller screens */
                padding: 20px;
                width: 95%; /* Make modal content a bit wider */
            }

            .alert {
                width: calc(100% - 40px); /* Full width minus padding */
                left: 20px;
                right: 20px;
                top: 10px; /* Move notification higher */
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Inventory Management System</h1>
        <p class="subtitle">Professional Inventory Tracking & Management Solution</p>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab(this, 'dashboard')">üìä Dashboard</div>
            <div class="tab" onclick="switchTab(this, 'oos-lowstock')">üì¶ OOS/LOW STOCK</div>
            <div class="tab" onclick="switchTab(this, 'new-products')">‚ú® New Products</div>
            <div class="tab" onclick="switchTab(this, 'to-clear')">üè∑Ô∏è To Clear</div>
            <div class="tab" onclick="switchTab(this, 'master-list')">üìã Master List</div>
            <div class="tab" onclick="switchTab(this, 'recycle-bin')">üóëÔ∏è Recycle Bin</div>
            <div class="tab" onclick="switchTab(this, 'management')">‚öôÔ∏è Management</div>
        </div>
        
        <div id="dashboard" class="tab-content active">
            <div class="stats-cards">
                <div class="stat-card urgent" onclick="showFilteredInventory('OOS')">
                    <div class="stat-number" id="oos-count">0</div>
                    <div class="stat-label">Out of Stock</div>
                </div>
                <div class="stat-card warning" onclick="showFilteredInventory('Low stock')">
                    <div class="stat-number" id="low-count">0</div>
                    <div class="stat-label">Low Stock</div>
                </div>
                <div class="stat-card info" onclick="switchTab(document.querySelector('.tab[onclick*=\'new-products\']'), 'new-products')">
                    <div class="stat-number" id="new-count">0</div>
                    <div class="stat-label">New Products</div>
                </div>
            </div>
            
            <h3>Recent Alerts</h3>
            <div id="alerts" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                <p>Loading alerts...</p>
            </div>
        </div>
        
        <div id="oos-lowstock" class="tab-content">
            <div class="controls">
                <button onclick="showAddProductModal()">‚ûï Add Product</button>
                <input type="text" id="oosSearchInput" class="search-box" placeholder="üîç Search products..." onkeyup="searchInventory(this.value)">
            </div>
            
            <table id="inventory-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('inventory', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'quantity')" data-column-key="quantity">Quantity <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'status')" data-column-key="status">Status <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'expiry')" data-column-key="expiry">Expiry <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'shipment')" data-column-key="shipment">Shipment <span class="sort-arrow"></span></th>
                        <th>Remarks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventory-table">
                    </tbody>
            </table>
        </div>
        
        <div id="new-products" class="tab-content">
            <div class="controls">
                <button onclick="showAddNewProductModal()">‚ûï Add New Product</button>
                <button onclick="mergeNewProductsToMaster()">Merge All to Inventory</button>
                 <input type="text" id="newProductsSearchInput" class="search-box" placeholder="üîç Search new products..." onkeyup="searchNewProducts(this.value)">
            </div>
            
            <table id="new-products-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('newProducts', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'addedDate')" data-column-key="addedDate">Added Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'arrivalDate')" data-column-key="arrivalDate">Arrival Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'quantity')" data-column-key="quantity">Quantity <span class="sort-arrow"></span></th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="new-products-table">
                    </tbody>
            </table>
        </div>
        
        <div id="to-clear" class="tab-content">
            <div class="controls">
                <button onclick="showAddToClearModal()">‚ûï Add Product to Clear</button>
                <input type="text" id="toClearSearchInput" class="search-box" placeholder="üîç Search products to clear..." onkeyup="searchToClear(this.value)">
            </div>
            
            <table id="to-clear-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('toClear', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'category')" data-column-key="category">Category <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'expiryDate')" data-column-key="expiryDate">Expiry Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'firstHighlightedDate')" data-column-key="firstHighlightedDate">First Highlighted <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'firstReportedBalance')" data-column-key="firstReportedBalance">Initial Bal <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'warehouseQty')" data-column-key="warehouseQty">WH Qty <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'storeQty')" data-column-key="storeQty">Store Qty <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'totalQty')" data-column-key="totalQty">Total Qty <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'weeklyDemand')" data-column-key="weeklyDemand">Wk Demand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'weeksSupply')" data-column-key="weeksSupply">Wks Supply <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'supplyStatus')" data-column-key="supplyStatus">Supply Status <span class="sort-arrow"></span></th>
                        <th>Action Plan</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="to-clear-table">
                    </tbody>
            </table>
        </div>
        
        <div id="master-list" class="tab-content">
            <div class="controls">
                <button onclick="showAddMasterProductModal()">‚ûï Add Product</button>
                <input type="text" class="search-box" id="masterListSearchInput" placeholder="üîç Search master products..." onkeyup="searchMasterList(this.value)">
                <button onclick="exportMasterList()">üì• Export List</button>
                <button onclick="document.getElementById('csvFileInput').click()">üì§ Import CSV</button>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importCSV(event)">
            </div>
            
            <table id="master-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('master', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'product')" data-column-key="product">Product Name <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'category')" data-column-key="category">Category <span class="sort-arrow"></span></th>
                        <th>Description</th>
                        <th onclick="sortTable('master', 'price')" data-column-key="price">Price <span class="sort-arrow"></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="master-table">
                    </tbody>
            </table>
        </div>

        <div id="recycle-bin" class="tab-content">
            <div class="controls">
                <h3>Recycle Bin</h3>
                <input type="text" id="recycleBinSearchInput" class="search-box" placeholder="üîç Search recycle bin..." onkeyup="searchRecycleBin(this.value)">
                <button class="btn-danger" onclick="emptyRecycleBin()">üóëÔ∏è Empty Recycle Bin</button>
            </div>
            <table id="recycle-bin-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('recycleBin', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('recycleBin', 'originalCollection')" data-column-key="originalCollection">Original Tab <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('recycleBin', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('recycleBin', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recycle-bin-table">
                    </tbody>
            </table>
        </div>
        
        <div id="management" class="tab-content">
            <div class="controls">
                <button onclick="exportAllData()">üì• Export All Data</button>
                <button onclick="confirmLoadSampleData()">üìä Load Sample Data</button>
            </div>
            
            <h3>System Information</h3>
            <p>Total Products (active): <span id="total-products">0</span></p>
            <p>Total Products (including deleted): <span id="total-products-all">0</span></p>
            <p>Last Synced: <span id="last-updated">Never</span></p>
        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('productModal')">&times;</span>
            <h2 id="productModalTitle">Add New Product</h2>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="editProductId" value="">
                <div class="form-group">
                    <label for="brand">Brand:</label>
                    <select id="brand" required onchange="filterProductsForBrand(this.value, 'productName', 'productsDatalist')">
                        </select>
                </div>
                <div class="form-group">
                    <label for="productName">Product Name:</label>
                    <input type="text" id="productName" list="productsDatalist" required>
                    <datalist id="productsDatalist"></datalist>
                </div>
                <div class="form-group">
                    <label for="inventoryQuantity">Quantity:</label>
                    <input type="number" id="inventoryQuantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="status">Status:</label>
                    <select id="status" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="expiry" id="expiryLabel">Expiry Date:</label>
                    <input type="date" id="expiry">
                </div>
                <div class="form-group">
                    <label for="shipment">Shipment No.:</label>
                    <input type="text" id="shipment">
                </div>
                <div class="form-group">
                    <label for="remarks">Remarks:</label>
                    <textarea id="remarks"></textarea>
                </div>
                <button type="submit">Save Product</button>
            </form>
        </div>
    </div>

    <div id="newProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('newProductModal')">&times;</span>
            <h2 id="newProductModalTitle">Add New Product Entry</h2>
            <form onsubmit="saveNewProduct(event)">
                <input type="hidden" id="editNewProductId" value="">
                <div class="form-group">
                    <label for="newBrand">Brand:</label>
                    <select id="newBrand" required onchange="filterProductsForBrand(this.value, 'newProductName', 'newProductsDatalist')">
                        </select>
                </div>
                <div class="form-group">
                    <label for="newProductName">Product Name:</label>
                    <input type="text" id="newProductName" list="newProductsDatalist" required>
                    <datalist id="newProductsDatalist"></datalist>
                </div>
                <div class="form-group">
                    <label for="arrivalDate">Arrival Date:</label>
                    <input type="date" id="arrivalDate" required>
                </div>
                <div class="form-group">
                    <label for="newProductQuantity">Quantity:</label> <input type="number" id="newProductQuantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="notes">Notes:</label>
                    <textarea id="notes"></textarea>
                </div>
                <button type="submit">Save New Product</button>
            </form>
        </div>
    </div>

    <div id="masterProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('masterProductModal')">&times;</span>
            <h2 id="masterProductModalTitle">Add Master Product</h2>
            <form onsubmit="saveMasterProduct(event)">
                <input type="hidden" id="editMasterProductId" value="">
                <div class="form-group">
                    <label for="masterBrand">Brand:</label>
                    <select id="masterBrand" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="masterProductName">Product Name:</label>
                    <input type="text" id="masterProductName" required>
                </div>
                <div class="form-group">
                    <label for="category">Category:</label>
                    <select id="category" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="description">Description:</label>
                    <textarea id="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="sku">Product Code (SKU):</label>
                    <input type="text" id="sku">
                </div>
                <div class="form-group">
                    <label for="price">Price:</label>
                    <input type="number" id="price" step="0.01" min="0">
                </div>
                <button type="submit">Save Master Product</button>
            </form>
        </div>
    </div>

    <div id="toClearModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('toClearModal')">&times;</span>
            <h2 id="toClearModalTitle">Add Product to Clear</h2>
            <form onsubmit="saveToClear(event)">
                <input type="hidden" id="editToClearId" value="">
                <div class="form-group">
                    <label for="toClearBrand">Brand:</label>
                    <select id="toClearBrand" required onchange="filterProductsForBrand(this.value, 'toClearProductName', 'toClearProductsDatalist')">
                        </select>
                </div>
                <div class="form-group">
                    <label for="toClearProductName">Product Name:</label>
                    <input type="text" id="toClearProductName" list="toClearProductsDatalist" required>
                    <datalist id="toClearProductsDatalist"></datalist>
                </div>
                <div class="form-group">
                    <label for="toClearCategory">Category:</label>
                    <select id="toClearCategory" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="toClearExpiryDate">Expiry Date:</label>
                    <input type="date" id="toClearExpiryDate" required>
                </div>
                <div class="form-group">
                    <label for="toClearFirstHighlightedDate">First Highlighted Date:</label>
                    <input type="date" id="toClearFirstHighlightedDate" required readonly>
                </div>
                <div class="form-group">
                    <label for="toClearFirstReportedBalance">First Reported Balance (Total Qty):</label>
                    <input type="number" id="toClearFirstReportedBalance" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearWarehouseQty">Warehouse Qty:</label>
                    <input type="number" id="toClearWarehouseQty" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearStoreQty">Store Qty:</label>
                    <input type="number" id="toClearStoreQty" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearWeeklyDemand">Weekly Demand:</label>
                    <input type="number" id="toClearWeeklyDemand" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearActionPlan">Action Plan:</label>
                    <textarea id="toClearActionPlan"></textarea>
                </div>
                <button type="submit">Save Product to Clear</button>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2>Confirmation</h2>
            <p id="confirmMessage"></p>
            <div class="modal-buttons">
                <button class="btn-danger" id="confirmNo">No</button>
                <button class="btn-success" id="confirmYes">Yes</button>
            </div>
        </div>
    </div>

    <div id="addBrandModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addBrandModal')">&times;</span>
            <h2>Add New Brand</h2>
            <form onsubmit="saveNewBrand(event)">
                <div class="form-group">
                    <label for="newBrandName">Brand Name:</label>
                    <input type="text" id="newBrandName" required>
                </div>
                <button type="submit">Add Brand</button>
            </form>
        </div>
    </div>

    <div id="addStatusModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addStatusModal')">&times;</span>
            <h2>Add New Status</h2>
            <form onsubmit="saveNewStatus(event)">
                <div class="form-group">
                    <label for="newStatusName">Status Name:</label>
                    <input type="text" id="newStatusName" required>
                </div>
                <button type="submit">Add Status</button>
            </form>
        </div>
    </div>

    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addCategoryModal')">&times;</span>
            <h2>Add New Category</h2>
            <form onsubmit="saveNewCategory(event)">
                <div class="form-group">
                    <label for="newCategoryName">Category Name:</label>
                    <input type="text" id="newCategoryName" required>
                </div>
                <button type="submit">Add Category</button>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDo1-y0Vj4XTQeeEUQK_6Y2wqDs94TOAX0", // Replace with your actual API key
            authDomain: "inventory-c3bac.firebaseapp.com",
            projectId: "inventory-c3bac",
            storageBucket: "inventory-c3bac.appspot.com", // Corrected storage bucket
            messagingSenderId: "261015083855",
            appId: "1:261015083855:web:e167f359928eb8ed8cc33a",
            measurementId: "G-V744486L78"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global data arrays to hold fetched data
        let inventoryData = [];
        let newProductsData = [];
        let toClearData = [];
        let masterProductsData = [];
        let deletedItemsData = []; // For Recycle Bin
        let brandsData = []; 
        let statusesData = []; 
        let categoriesData = []; 

        // Data for current views (used for filtering and sorting)
        let currentInventoryViewData = [];
        let currentNewProductsViewData = [];
        let currentToClearViewData = [];
        let currentMasterListViewData = [];
        let currentRecycleBinViewData = [];


        // Firestore collection references
        const inventoryColRef = db.collection('inventory');
        const newProductsColRef = db.collection('new_products');
        const toClearColRef = db.collection('to_clear');
        const masterProductsColRef = db.collection('master_products');
        // const deletedItemsColRef = db.collection('deleted_items'); // Not used directly, items are marked in original collections
        const brandsColRef = db.collection('brands'); 
        const statusesColRef = db.collection('statuses'); 
        const categoriesColRef = db.collection('categories'); 

        // Sort state for tables
        let sortState = {
            inventory: { column: null, direction: 'asc' },
            newProducts: { column: null, direction: 'asc' },
            master: { column: null, direction: 'asc' },
            toClear: { column: null, direction: 'asc' },
            recycleBin: { column: null, direction: 'asc' }
        };


        // --- Notification System ---
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.classList.add('alert', `alert-${type}`);
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // --- Firestore Data Operations ---
        async function fetchDataFromFirestore(collectionRef, includeDeleted = false) {
            let data = [];
            let query = collectionRef;
            if (!includeDeleted) {
                // Only fetch items not marked as deleted if includeDeleted is false
                query = collectionRef.where("isDeleted", "==", false);
            }
            
            try {
                const querySnapshot = await query.get();
                querySnapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error(`Error fetching data from ${collectionRef.id}:`, error);
                // If it's a "missing index" error, log a more specific message
                if (error.code === 'failed-precondition') {
                    console.warn(`Firestore query for ${collectionRef.id} might require an index. Check Firestore console. Query details: where("isDeleted", "==", false)`);
                }
                showNotification(`Error loading data from ${collectionRef.id}. Check console.`, 'error');
            }
            return data;
        }
        
        async function fetchAllDataForRecycleBin() {
            const collectionsToFetchFrom = [inventoryColRef, newProductsColRef, toClearColRef, masterProductsColRef];
            let allDeletedItems = [];
            for (const colRef of collectionsToFetchFrom) {
                try {
                    const querySnapshot = await colRef.where("isDeleted", "==", true).get();
                    querySnapshot.forEach((doc) => {
                        allDeletedItems.push({ id: doc.id, ...doc.data(), originalCollection: colRef.id });
                    });
                } catch (error) {
                     console.error(`Error fetching deleted items from ${colRef.id}:`, error);
                     if (error.code === 'failed-precondition') {
                        console.warn(`Firestore query for deleted items in ${colRef.id} might require an index for 'isDeleted'. Check Firestore console.`);
                     }
                }
            }
            return allDeletedItems;
        }


        async function saveDataToFirestore(collectionRef, docId, data) {
            try {
                if (docId) {
                    await collectionRef.doc(docId).update(data);
                } else {
                    const docRef = await collectionRef.add(data);
                    return docRef.id; 
                }
                return docId; 
            } catch (error) {
                console.error(`Error saving data to ${collectionRef.id}:`, error);
                showNotification(`Error saving data to server for ${collectionRef.id}.`, 'error');
                throw error; 
            }
        }

        // --- Update Local Data & UI ---
        async function updateLocalData() {
            try {
                inventoryData = await fetchDataFromFirestore(inventoryColRef);
                newProductsData = await fetchDataFromFirestore(newProductsColRef);
                toClearData = await fetchDataFromFirestore(toClearColRef);
                masterProductsData = await fetchDataFromFirestore(masterProductsColRef);
                deletedItemsData = await fetchAllDataForRecycleBin(); // Fetches all items where isDeleted == true

                brandsData = await fetchDataFromFirestore(brandsColRef);
                statusesData = await fetchDataFromFirestore(statusesColRef);
                categoriesData = await fetchDataFromFirestore(categoriesColRef);

                // Initialize current view data
                currentInventoryViewData = inventoryData.filter(item => item.status === 'OOS' || item.status.includes('Low stock'));
                currentNewProductsViewData = [...newProductsData];
                currentToClearViewData = [...toClearData];
                currentMasterListViewData = [...masterProductsData];
                currentRecycleBinViewData = [...deletedItemsData];


                updateAllTablesAndViews(); // This will call individual updateTable functions
                updateDashboardStats();
                updateAlerts();
                updateManagementStats();
                populateProductDatalists(); 
                setupDynamicDropdowns(); 
            } catch (error) {
                console.error("Error updating local data from Firestore:", error);
                showNotification('Error loading data from server. Please check your internet connection or Firebase setup.', 'error');
            }
        }
        
        function updateAllTablesAndViews() {
            // Call the specific render functions which will use the currentViewData and apply sorting
            renderInventoryItems();
            renderNewProductsItems();
            renderMasterListItems();
            renderToClearItems();
            renderRecycleBinItems();
        }


        // --- Dynamic Dropdowns ---
        function setupDynamicDropdowns() {
            populateBrandDropdowns('brand');
            populateBrandDropdowns('newBrand');
            populateBrandDropdowns('masterBrand');
            populateBrandDropdowns('toClearBrand');

            populateStatusDropdowns('status'); // For productModal

            populateCategoryDropdowns('category'); // For masterProductModal
            populateCategoryDropdowns('toClearCategory'); // For toClearModal
        }

        function populateBrandDropdowns(selectId) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;
            const currentValue = selectElement.value;
            selectElement.innerHTML = '<option value="">Select Brand</option>';
            
            const uniqueBrandsFromMaster = [...new Set(masterProductsData.map(item => item.brand).filter(Boolean))];
            let allUniqueBrands = [...uniqueBrandsFromMaster];
            brandsData.forEach(brandDoc => {
                if (brandDoc.name && !allUniqueBrands.includes(brandDoc.name)) {
                    allUniqueBrands.push(brandDoc.name);
                }
            });
            allUniqueBrands.sort((a, b) => a.localeCompare(b));
            allUniqueBrands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                selectElement.appendChild(option);
            });
            const addNewOption = document.createElement('option');
            addNewOption.value = 'add_new_brand';
            addNewOption.textContent = '+ Add New Brand...';
            selectElement.appendChild(addNewOption);
            if (currentValue && selectElement.querySelector(`option[value="${currentValue}"]`)) {
                selectElement.value = currentValue;
            }
            selectElement.removeEventListener('change', handleDynamicDropdownChange);
            selectElement.addEventListener('change', handleDynamicDropdownChange);
        }

        function populateStatusDropdowns(selectId) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;
            const currentValue = selectElement.value;
            selectElement.innerHTML = '<option value="">Select Status</option>';
            
            const uniqueStatusesFromInventory = [...new Set(inventoryData.map(item => item.status).filter(Boolean))];
            let allUniqueStatuses = [...uniqueStatusesFromInventory];
            statusesData.forEach(statusDoc => {
                if (statusDoc.name && !allUniqueStatuses.includes(statusDoc.name)) {
                    allUniqueStatuses.push(statusDoc.name);
                }
            });
            const predefinedStatuses = ['OOS', 'Low stock', 'In Stock']; // Ensure these are options
            predefinedStatuses.forEach(status => {
                if (!allUniqueStatuses.includes(status)) {
                    allUniqueStatuses.push(status);
                }
            });
            allUniqueStatuses.sort((a, b) => a.localeCompare(b));
            allUniqueStatuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                selectElement.appendChild(option);
            });
            const addNewOption = document.createElement('option');
            addNewOption.value = 'add_new_status';
            addNewOption.textContent = '+ Add New Status...';
            selectElement.appendChild(addNewOption);
            if (currentValue && selectElement.querySelector(`option[value="${currentValue}"]`)) {
                selectElement.value = currentValue;
            }
            selectElement.removeEventListener('change', handleDynamicDropdownChange);
            selectElement.addEventListener('change', handleDynamicDropdownChange);
        }

        function populateCategoryDropdowns(selectId) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;
            const currentValue = selectElement.value;
            selectElement.innerHTML = '<option value="">Select Category</option>';
            
            const uniqueCategoriesFromMaster = [...new Set(masterProductsData.map(item => item.category).filter(Boolean))];
            let allUniqueCategories = [...uniqueCategoriesFromMaster];
            categoriesData.forEach(categoryDoc => {
                if (categoryDoc.name && !allUniqueCategories.includes(categoryDoc.name)) {
                    allUniqueCategories.push(categoryDoc.name);
                }
            });
            allUniqueCategories.sort((a, b) => a.localeCompare(b));
            allUniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                selectElement.appendChild(option);
            });
            const addNewOption = document.createElement('option');
            addNewOption.value = 'add_new_category';
            addNewOption.textContent = '+ Add New Category...';
            selectElement.appendChild(addNewOption);
            if (currentValue && selectElement.querySelector(`option[value="${currentValue}"]`)) {
                selectElement.value = currentValue;
            }
            selectElement.removeEventListener('change', handleDynamicDropdownChange);
            selectElement.addEventListener('change', handleDynamicDropdownChange);
        }

        function handleDynamicDropdownChange() {
            const selectElement = this;
            if (selectElement.value.startsWith('add_new_')) {
                const type = selectElement.value.replace('add_new_', '');
                // Store the ID of the select element that triggered this, to potentially re-focus or re-select later
                const callingSelectId = selectElement.id; 
                switch (type) {
                    case 'brand':
                        showAddBrandModal(callingSelectId);
                        break;
                    case 'status':
                        showAddStatusModal(callingSelectId);
                        break;
                    case 'category':
                        showAddCategoryModal(callingSelectId);
                        break;
                }
                // Don't reset selection immediately, allow modal to handle and then repopulate/reselect
            }
        }
        
        function populateProductDatalists() { /* Called by updateLocalData, ensures masterProductsData is fresh for filtering */ }

        function filterProductsForBrand(selectedBrand, productInputId, datalistId) {
            const productInput = document.getElementById(productInputId);
            const datalist = document.getElementById(datalistId);
            datalist.innerHTML = ''; 

            if (selectedBrand && selectedBrand !== 'add_new_brand') {
                const filteredProducts = masterProductsData.filter(item => item.brand === selectedBrand && item.product);
                filteredProducts.sort((a, b) => (a.product || '').localeCompare(b.product || ''));
                filteredProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.product; // Datalist option text is its value
                    datalist.appendChild(option);
                });
            }
            const currentProductValue = productInput.value;
            if (currentProductValue && selectedBrand && !masterProductsData.some(p => p.brand === selectedBrand && p.product === currentProductValue)) {
                productInput.value = '';
            }
        }

        // --- Tab Switching Logic ---
        function switchTab(clickedTabElement, tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            clickedTabElement.classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // Reset search fields and update views for specific tabs
            if (tabId === 'oos-lowstock') {
                document.getElementById('oosSearchInput').value = ''; // Reset search
                currentInventoryViewData = inventoryData.filter(item => item.status === 'OOS' || item.status.includes('Low stock'));
                renderInventoryItems();
            } else if (tabId === 'new-products') {
                document.getElementById('newProductsSearchInput').value = '';
                currentNewProductsViewData = [...newProductsData];
                renderNewProductsItems();
            } else if (tabId === 'master-list') {
                document.getElementById('masterListSearchInput').value = '';
                currentMasterListViewData = [...masterProductsData];
                renderMasterListItems();
            } else if (tabId === 'to-clear') {
                document.getElementById('toClearSearchInput').value = '';
                currentToClearViewData = [...toClearData];
                renderToClearItems();
            } else if (tabId === 'recycle-bin') {
                 document.getElementById('recycleBinSearchInput').value = '';
                currentRecycleBinViewData = [...deletedItemsData];
                renderRecycleBinItems();
            }
            // Update sort indicators for the newly active table
            const tableKey = tabId === 'oos-lowstock' ? 'inventory' : tabId.replace('-', ''); // Simplified mapping
            if (sortState[tableKey]) {
                 updateSortIndicators(tableKey);
            }
        }

        // --- Generic Sorting Function ---
        function sortData(data, column, direction, numericColumns = [], dateColumns = []) {
            if (!column) return data; // No column to sort by

            return [...data].sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                // Handle undefined or null values by pushing them to the end
                if (valA === undefined || valA === null) valA = direction === 'asc' ? Infinity : -Infinity;
                if (valB === undefined || valB === null) valB = direction === 'asc' ? Infinity : -Infinity;


                if (numericColumns.includes(column)) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                } else if (dateColumns.includes(column)) {
                    valA = valA ? new Date(valA).getTime() : 0; // Convert dates to timestamps for comparison
                    valB = valB ? new Date(valB).getTime() : 0;
                     if (valA === 0) valA = direction === 'asc' ? Infinity : -Infinity; // Push invalid/empty dates to end
                     if (valB === 0) valB = direction === 'asc' ? Infinity : -Infinity;
                } else { // String comparison (case-insensitive)
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        function sortTable(tableKey, columnName) {
            const currentTableSortState = sortState[tableKey];
            if (currentTableSortState.column === columnName) {
                currentTableSortState.direction = currentTableSortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentTableSortState.column = columnName;
                currentTableSortState.direction = 'asc';
            }

            // Call the appropriate render function, which will use the new sort state
            switch (tableKey) {
                case 'inventory': renderInventoryItems(); break;
                case 'newProducts': renderNewProductsItems(); break;
                case 'master': renderMasterListItems(); break;
                case 'toClear': renderToClearItems(); break;
                case 'recycleBin': renderRecycleBinItems(); break;
            }
            updateSortIndicators(tableKey);
        }

        function updateSortIndicators(tableKey) {
            const tableContainerId = tableKey === 'inventory' ? 'inventory-table-container' : `${tableKey}-table-container`;
            const tableContainer = document.getElementById(tableContainerId);
            if (!tableContainer) return;

            const headers = tableContainer.querySelectorAll('thead th[data-column-key]');
            headers.forEach(th => {
                const columnKey = th.dataset.columnKey;
                const arrowSpan = th.querySelector('.sort-arrow');
                if (!arrowSpan) return; // Should not happen if HTML is correct

                if (sortState[tableKey] && sortState[tableKey].column === columnKey) {
                    arrowSpan.textContent = sortState[tableKey].direction === 'asc' ? ' ‚Üë' : ' ‚Üì';
                } else {
                    arrowSpan.textContent = ' ‚áÖ'; // Default symbol or empty
                }
            });
        }


        // --- Table Rendering Functions ---
        function renderInventoryItems() {
            const tbody = document.getElementById('inventory-table');
            tbody.innerHTML = '';
            const numericCols = ['quantity'];
            const dateCols = ['expiry'];
            const sortedData = sortData(currentInventoryViewData, sortState.inventory.column, sortState.inventory.direction, numericCols, dateCols);

            if (sortedData.length === 0) {
                const row = tbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 9;
                cell.textContent = "No products found for this view.";
                cell.style.textAlign = "center";
                cell.style.padding = "20px";
                return;
            }
            sortedData.forEach(item => {
                const row = tbody.insertRow();
                const statusClass = item.status === 'OOS' ? 'oos' : (item.status && item.status.includes('Low stock') ? 'low' : 'normal');
                row.innerHTML = `
                    <td>${item.sku || 'N/A'}</td>
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td>${item.quantity !== undefined ? item.quantity : 'N/A'}</td>
                    <td><span class="status-badge ${statusClass}">${item.status || 'N/A'}</span></td>
                    <td>${item.expiry || ''}</td>
                    <td>${item.shipment || ''}</td>
                    <td>${item.remarks || ''}</td>
                    <td>
                        <button class="btn-info" onclick="showEditProductModal('${item.id}')">Edit</button>
                        <button class="btn-danger" onclick="softDeleteProduct('${item.id}')">Delete</button>
                    </td>
                `;
            });
        }

        function renderNewProductsItems() {
            const tbody = document.getElementById('new-products-table');
            tbody.innerHTML = '';
            const numericCols = ['quantity'];
            const dateCols = ['addedDate', 'arrivalDate'];
            const sortedData = sortData(currentNewProductsViewData, sortState.newProducts.column, sortState.newProducts.direction, numericCols, dateCols);

            if (sortedData.length === 0) { /* ... no data message ... */ 
                const row = tbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 8;
                cell.textContent = "No new products found.";
                cell.style.textAlign = "center";
                cell.style.padding = "20px";
                return;
            }
            sortedData.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.sku || 'N/A'}</td>
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td>${item.addedDate || 'N/A'}</td>
                    <td>${item.arrivalDate || 'N/A'}</td>
                    <td>${item.quantity !== undefined ? item.quantity : 'N/A'}</td>
                    <td>${item.notes || ''}</td>
                    <td>
                        <button class="btn-info" onclick="showEditNewProductModal('${item.id}')">Edit</button>
                        <button class="btn-danger" onclick="softDeleteNewProduct('${item.id}')">Delete</button>
                    </td>
                `;
            });
        }

        function renderMasterListItems() {
            const tbody = document.getElementById('master-table');
            tbody.innerHTML = '';
            const numericCols = ['price'];
            const sortedData = sortData(currentMasterListViewData, sortState.master.column, sortState.master.direction, numericCols);

            if (sortedData.length === 0) { /* ... no data message ... */ 
                const row = tbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 7;
                cell.textContent = "No master products found.";
                cell.style.textAlign = "center";
                cell.style.padding = "20px";
                return;
            }
            sortedData.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.sku || 'N/A'}</td>
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td>${item.category || ''}</td>
                    <td>${item.description || ''}</td>
                    <td>${item.price !== undefined ? parseFloat(item.price).toFixed(2) : 'N/A'}</td>
                    <td>
                        <button class="btn-info" onclick="showEditMasterProductModal('${item.id}')">Edit</button>
                        <button class="btn-danger" onclick="softDeleteMasterProduct('${item.id}')">Delete</button>
                    </td>
                `;
            });
        }

        function renderToClearItems() {
            const tbody = document.getElementById('to-clear-table');
            tbody.innerHTML = '';
            const numericCols = ['firstReportedBalance', 'warehouseQty', 'storeQty', 'totalQty', 'weeklyDemand', 'weeksSupply'];
            const dateCols = ['expiryDate', 'firstHighlightedDate'];

            // Calculate totalQty and weeksSupply before sorting if not already present
            const dataWithCalculations = currentToClearViewData.map(item => {
                const warehouseQty = item.warehouseQty || 0;
                const storeQty = item.storeQty || 0;
                const totalQty = warehouseQty + storeQty;
                const weeklyDemand = item.weeklyDemand || 0;
                const weeksSupply = weeklyDemand > 0 ? parseFloat((totalQty / weeklyDemand).toFixed(1)) : Infinity; // Infinity for N/A to sort last if asc

                let supplyStatusText = 'N/A';
                if (weeksSupply !== Infinity && weeksSupply >= 0) {
                    if (weeksSupply < 4) supplyStatusText = 'Low Supply';
                    else if (weeksSupply <= 12) supplyStatusText = 'Good Supply';
                    else supplyStatusText = 'Excess Supply';
                }
                
                return { ...item, totalQty, weeksSupply, supplyStatusText };
            });
            
            const sortedData = sortData(dataWithCalculations, sortState.toClear.column, sortState.toClear.direction, numericCols, dateCols);

            if (sortedData.length === 0) { /* ... no data message ... */ 
                const row = tbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 15;
                cell.textContent = "No products to clear found.";
                cell.style.textAlign = "center";
                cell.style.padding = "20px";
                return;
            }
            sortedData.forEach(item => {
                const row = tbody.insertRow();
                let categoryClass = '';
                if (item.category === 'Short Expiry') categoryClass = 'oos';
                else if (item.category === 'Excess Stock') categoryClass = 'low';
                else categoryClass = 'normal';

                let supplyStatusClass = '';
                if (item.supplyStatusText === 'Low Supply') supplyStatusClass = 'danger-status';
                else if (item.supplyStatusText === 'Good Supply') supplyStatusClass = 'normal';
                else if (item.supplyStatusText === 'Excess Supply') supplyStatusClass = 'alert-status';

                row.innerHTML = `
                    <td>${item.sku || 'N/A'}</td>
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td><span class="status-badge ${categoryClass}">${item.category || ''}</span></td>
                    <td>${item.expiryDate || 'N/A'}</td>
                    <td>${item.firstHighlightedDate || 'N/A'}</td>
                    <td>${item.firstReportedBalance !== undefined ? item.firstReportedBalance : 'N/A'}</td>
                    <td>${item.warehouseQty !== undefined ? item.warehouseQty : 'N/A'}</td>
                    <td>${item.storeQty !== undefined ? item.storeQty : 'N/A'}</td>
                    <td>${item.totalQty}</td>
                    <td>${item.weeklyDemand !== undefined ? item.weeklyDemand : 'N/A'}</td>
                    <td>${item.weeksSupply === Infinity || item.weeksSupply === -Infinity ? 'N/A' : item.weeksSupply}</td>
                    <td><span class="status-badge ${supplyStatusClass}">${item.supplyStatusText}</span></td>
                    <td>${item.actionPlan || ''}</td>
                    <td>
                        <button class="btn-info" onclick="showEditToClearModal('${item.id}')">Edit</button>
                        <button class="btn-danger" onclick="softDeleteToClear('${item.id}')">Delete</button>
                    </td>
                `;
            });
        }

        function renderRecycleBinItems() {
            const tbody = document.getElementById('recycle-bin-table');
            tbody.innerHTML = '';
            const sortedData = sortData(currentRecycleBinViewData, sortState.recycleBin.column, sortState.recycleBin.direction);

            if (sortedData.length === 0) { /* ... no data message ... */ 
                const row = tbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5;
                cell.textContent = "Recycle Bin is empty.";
                cell.style.textAlign = "center";
                cell.style.padding = "20px";
                return;
            }
            sortedData.forEach(item => {
                const row = tbody.insertRow();
                const originalTabDisplay = item.originalCollection ? item.originalCollection.replace('_', ' ').replace(/\b\w/g, char => char.toUpperCase()) : 'Unknown';
                row.innerHTML = `
                    <td>${item.sku || 'N/A'}</td>
                    <td>${originalTabDisplay}</td>
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td>
                        <button class="btn-info" onclick="restoreItem('${item.id}', '${item.originalCollection}')">Restore</button>
                        <button class="btn-danger" onclick="hardDeleteItem('${item.id}', '${item.originalCollection}')">Permanently Delete</button>
                    </td>
                `;
            });
        }

        // --- Dashboard & Alerts Updates ---
        function updateDashboardStats() {
            document.getElementById('oos-count').textContent = inventoryData.filter(item => item.status === 'OOS').length;
            document.getElementById('low-count').textContent = inventoryData.filter(item => item.status && item.status.includes('Low stock')).length; // Changed to Low stock
            document.getElementById('new-count').textContent = newProductsData.length;
        }

        function updateAlerts() {
            const alertsDiv = document.getElementById('alerts');
            alertsDiv.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let hasAlerts = false;

            const lowStockAlerts = inventoryData.filter(item => item.status && item.status.includes('Low stock'));
            if (lowStockAlerts.length > 0) {
                lowStockAlerts.forEach(item => {
                    alertsDiv.innerHTML += `<p class="alert-status status-badge">${item.product} (${item.brand}) is Low Stock (Qty: ${item.quantity}).</p>`;
                });
                hasAlerts = true;
            }
            const oosAlerts = inventoryData.filter(item => item.status === 'OOS');
            if (oosAlerts.length > 0) {
                oosAlerts.forEach(item => {
                    alertsDiv.innerHTML += `<p class="danger-status status-badge">${item.product} (${item.brand}) is Out of Stock!</p>`;
                });
                hasAlerts = true;
            }
            const expiryAlerts = inventoryData.filter(item => {
                if (!item.expiry || item.status === 'OOS' || (item.status && item.status.includes('Low stock'))) return false; // Exclude OOS/Low stock from expiry alerts as per new rule
                const expiryDate = new Date(item.expiry);
                const threeMonthsLater = new Date(today);
                threeMonthsLater.setMonth(today.getMonth() + 3);
                return expiryDate <= threeMonthsLater && expiryDate >= today;
            });
            if (expiryAlerts.length > 0) {
                expiryAlerts.forEach(item => {
                    alertsDiv.innerHTML += `<p class="warning status-badge">Expiry Alert: ${item.product} (${item.brand}) expires on ${item.expiry}.</p>`;
                });
                hasAlerts = true;
            }
            if (newProductsData.length > 0) {
                alertsDiv.innerHTML += `<p class="info status-badge">You have ${newProductsData.length} new products to review and merge.</p>`;
                hasAlerts = true;
            }
            if (!hasAlerts) {
                alertsDiv.innerHTML = '<p>No new alerts at this time.</p>';
            }
        }

        function updateManagementStats() {
            const totalActive = inventoryData.length + newProductsData.length + masterProductsData.length + toClearData.length;
            const totalAll = totalActive + deletedItemsData.length; 
            document.getElementById('total-products').textContent = totalActive;
            document.getElementById('total-products-all').textContent = totalAll;
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        }

        // --- Modal Display & Logic ---
        function handleProductModalStatusChange() {
            const statusSelect = document.getElementById('status');
            const expiryInput = document.getElementById('expiry');
            const expiryLabel = document.getElementById('expiryLabel');

            if (statusSelect.value === 'OOS' || statusSelect.value.includes('Low stock')) {
                expiryInput.disabled = true;
                expiryInput.value = ''; // Clear value
                expiryLabel.classList.add('disabled-label');
            } else {
                expiryInput.disabled = false;
                expiryLabel.classList.remove('disabled-label');
            }
        }

        async function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('editProductId').value = '';
            document.getElementById('brand').value = '';
            document.getElementById('productName').value = ''; 
            document.getElementById('productsDatalist').innerHTML = ''; 
            document.getElementById('inventoryQuantity').value = ''; 
            document.getElementById('status').value = '';
            document.getElementById('expiry').value = '';
            document.getElementById('shipment').value = '';
            document.getElementById('remarks').value = '';
            
            populateBrandDropdowns('brand'); 
            populateStatusDropdowns('status'); 
            
            handleProductModalStatusChange(); // Initial check
            document.getElementById('status').addEventListener('change', handleProductModalStatusChange); // Add listener

            document.getElementById('productModal').style.display = 'block';
        }

        async function showEditProductModal(id) {
            const productSnap = await inventoryColRef.doc(id).get();
            if (!productSnap.exists) {
                showNotification("Product not found!", "error");
                return;
            }
            const item = productSnap.data();
            document.getElementById('productModalTitle').textContent = 'Edit Product';
            document.getElementById('editProductId').value = id;

            populateBrandDropdowns('brand'); 
            document.getElementById('brand').value = item.brand || '';
            filterProductsForBrand(item.brand || '', 'productName', 'productsDatalist'); 
            document.getElementById('productName').value = item.product || ''; 

            document.getElementById('inventoryQuantity').value = item.quantity !== undefined ? item.quantity : '';
            
            populateStatusDropdowns('status'); 
            document.getElementById('status').value = item.status || '';
            
            document.getElementById('expiry').value = item.expiry || '';
            document.getElementById('shipment').value = item.shipment || '';
            document.getElementById('remarks').value = item.remarks || '';

            handleProductModalStatusChange(); // Initial check based on loaded status
            document.getElementById('status').addEventListener('change', handleProductModalStatusChange); // Add listener

            document.getElementById('productModal').style.display = 'block';
        }
        
        // Add listeners to status dropdown in productModal
        document.addEventListener('DOMContentLoaded', () => {
            const statusSelect = document.getElementById('status');
            if (statusSelect) {
                statusSelect.addEventListener('change', handleProductModalStatusChange);
            }
        });


        async function showAddNewProductModal() {
            document.getElementById('newProductModalTitle').textContent = 'Add New Product Entry';
            document.getElementById('editNewProductId').value = '';
            document.getElementById('newBrand').value = '';
            document.getElementById('newProductName').value = ''; 
            document.getElementById('newProductsDatalist').innerHTML = ''; 
            document.getElementById('arrivalDate').value = '';
            document.getElementById('newProductQuantity').value = ''; // Corrected ID
            document.getElementById('notes').value = '';
            populateBrandDropdowns('newBrand'); 
            document.getElementById('newProductModal').style.display = 'block';
        }

        async function showEditNewProductModal(id) {
            const productSnap = await newProductsColRef.doc(id).get();
            if (!productSnap.exists) {
                showNotification("New product entry not found!", "error"); return;
            }
            const item = productSnap.data();
            document.getElementById('newProductModalTitle').textContent = 'Edit New Product Entry';
            document.getElementById('editNewProductId').value = id;
            populateBrandDropdowns('newBrand'); 
            document.getElementById('newBrand').value = item.brand || '';
            filterProductsForBrand(item.brand || '', 'newProductName', 'newProductsDatalist'); 
            document.getElementById('newProductName').value = item.product || ''; 
            document.getElementById('arrivalDate').value = item.arrivalDate || '';
            document.getElementById('newProductQuantity').value = item.quantity !== undefined ? item.quantity : ''; // Corrected ID
            document.getElementById('notes').value = item.notes || '';
            document.getElementById('newProductModal').style.display = 'block';
        }

        async function showAddMasterProductModal() {
            document.getElementById('masterProductModalTitle').textContent = 'Add Master Product';
            document.getElementById('editMasterProductId').value = '';
            document.getElementById('masterBrand').value = '';
            document.getElementById('masterProductName').value = '';
            document.getElementById('category').value = '';
            document.getElementById('description').value = '';
            document.getElementById('sku').value = '';
            document.getElementById('price').value = '';
            populateBrandDropdowns('masterBrand'); 
            populateCategoryDropdowns('category'); 
            document.getElementById('masterProductModal').style.display = 'block';
        }

        async function showEditMasterProductModal(id) {
            const productSnap = await masterProductsColRef.doc(id).get();
            if (!productSnap.exists) {
                showNotification("Master product not found!", "error"); return;
            }
            const item = productSnap.data();
            document.getElementById('masterProductModalTitle').textContent = 'Edit Master Product';
            document.getElementById('editMasterProductId').value = id;
            populateBrandDropdowns('masterBrand'); 
            document.getElementById('masterBrand').value = item.brand || '';
            document.getElementById('masterProductName').value = item.product || '';
            populateCategoryDropdowns('category'); 
            document.getElementById('category').value = item.category || '';
            document.getElementById('description').value = item.description || '';
            document.getElementById('sku').value = item.sku || '';
            document.getElementById('price').value = item.price !== undefined ? item.price : '';
            document.getElementById('masterProductModal').style.display = 'block';
        }

        async function showAddToClearModal() {
            document.getElementById('toClearModalTitle').textContent = 'Add Product to Clear';
            document.getElementById('editToClearId').value = '';
            document.getElementById('toClearBrand').value = '';
            document.getElementById('toClearProductName').value = ''; 
            document.getElementById('toClearProductsDatalist').innerHTML = ''; 
            document.getElementById('toClearCategory').value = '';
            document.getElementById('toClearExpiryDate').value = '';
            document.getElementById('toClearWarehouseQty').value = ''; 
            document.getElementById('toClearStoreQty').value = ''; 
            document.getElementById('toClearWeeklyDemand').value = '';
            document.getElementById('toClearActionPlan').value = '';
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('toClearFirstHighlightedDate').value = today;
            document.getElementById('toClearFirstReportedBalance').value = ''; 
            populateBrandDropdowns('toClearBrand'); 
            populateCategoryDropdowns('toClearCategory'); 
            document.getElementById('toClearModal').style.display = 'block';
        }

        async function showEditToClearModal(id) {
            const productSnap = await toClearColRef.doc(id).get();
            if (!productSnap.exists) {
                showNotification("To Clear product not found!", "error"); return;
            }
            const item = productSnap.data();
            document.getElementById('toClearModalTitle').textContent = 'Edit Product to Clear';
            document.getElementById('editToClearId').value = id;
            populateBrandDropdowns('toClearBrand'); 
            document.getElementById('toClearBrand').value = item.brand || '';
            filterProductsForBrand(item.brand || '', 'toClearProductName', 'toClearProductsDatalist'); 
            document.getElementById('toClearProductName').value = item.product || ''; 
            populateCategoryDropdowns('toClearCategory'); 
            document.getElementById('toClearCategory').value = item.category || '';
            document.getElementById('toClearExpiryDate').value = item.expiryDate || '';
            document.getElementById('toClearFirstHighlightedDate').value = item.firstHighlightedDate || '';
            document.getElementById('toClearFirstReportedBalance').value = item.firstReportedBalance !== undefined ? item.firstReportedBalance : '';
            document.getElementById('toClearWarehouseQty').value = item.warehouseQty !== undefined ? item.warehouseQty : '';
            document.getElementById('toClearStoreQty').value = item.storeQty !== undefined ? item.storeQty : '';
            document.getElementById('toClearWeeklyDemand').value = item.weeklyDemand !== undefined ? item.weeklyDemand : '';
            document.getElementById('toClearActionPlan').value = item.actionPlan || '';
            document.getElementById('toClearModal').style.display = 'block';
        }
        
        function showAddBrandModal(callingSelectId) {
            document.getElementById('newBrandName').value = '';
            document.getElementById('newBrandName').dataset.callingSelect = callingSelectId || ''; // Store which dropdown called this
            document.getElementById('addBrandModal').style.display = 'block';
        }
        function showAddStatusModal(callingSelectId) {
            document.getElementById('newStatusName').value = '';
            document.getElementById('newStatusName').dataset.callingSelect = callingSelectId || '';
            document.getElementById('addStatusModal').style.display = 'block';
        }
        function showAddCategoryModal(callingSelectId) {
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryName').dataset.callingSelect = callingSelectId || '';
            document.getElementById('addCategoryModal').style.display = 'block';
        }


        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Clean up event listeners specific to modals if they were added dynamically
            if (modalId === 'productModal') {
                document.getElementById('status').removeEventListener('change', handleProductModalStatusChange);
            }
        }

        // Confirmation Modal Logic
        let confirmAction = null; 
        function showConfirmModal(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').style.display = 'block';
            confirmAction = callback;
        }
        document.getElementById('confirmYes').onclick = function() {
            if (confirmAction) confirmAction(true);
            closeModal('confirmModal');
            confirmAction = null; 
        };
        document.getElementById('confirmNo').onclick = function() {
            if (confirmAction) confirmAction(false);
            closeModal('confirmModal');
            confirmAction = null; 
        };

        // --- Save Functions ---
        async function saveProduct(event) { // For OOS/Low Stock Tab
            event.preventDefault();
            const editId = document.getElementById('editProductId').value;
            const selectedBrand = document.getElementById('brand').value;
            const selectedProduct = document.getElementById('productName').value;
            const productSku = getSkuForProduct(selectedBrand, selectedProduct);
            const statusValue = document.getElementById('status').value;
            let expiryValue = document.getElementById('expiry').value;

            if (statusValue === 'OOS' || statusValue.includes('Low stock')) {
                expiryValue = ''; // Ensure expiry is empty if OOS/Low stock
            }

            const productData = {
                brand: selectedBrand,
                product: selectedProduct,
                sku: productSku, 
                quantity: parseInt(document.getElementById('inventoryQuantity').value),
                status: statusValue,
                expiry: expiryValue,
                shipment: document.getElementById('shipment').value,
                remarks: document.getElementById('remarks').value,
                isDeleted: false
            };
            try {
                await saveDataToFirestore(inventoryColRef, editId, productData);
                showNotification(editId ? 'Product updated successfully!' : 'Product added successfully!', 'success');
                closeModal('productModal');
                event.target.reset();
                await updateLocalData(); 
            } catch (e) { /* Error handled by saveDataToFirestore */ }
        }

        async function saveNewProduct(event) {
            event.preventDefault();
            const editId = document.getElementById('editNewProductId').value;
            const selectedBrand = document.getElementById('newBrand').value;
            const selectedProduct = document.getElementById('newProductName').value;
            const productSku = getSkuForProduct(selectedBrand, selectedProduct);
            const newProductData = {
                brand: selectedBrand,
                product: selectedProduct,
                sku: productSku, 
                addedDate: new Date().toISOString().slice(0, 10), 
                arrivalDate: document.getElementById('arrivalDate').value,
                quantity: parseInt(document.getElementById('newProductQuantity').value), // Corrected ID
                notes: document.getElementById('notes').value,
                isDeleted: false
            };
            try {
                await saveDataToFirestore(newProductsColRef, editId, newProductData);
                showNotification(editId ? 'New product updated!' : 'New product added!', 'success');
                closeModal('newProductModal');
                event.target.reset();
                await updateLocalData();
            } catch (e) { /* Handled */ }
        }

        async function saveMasterProduct(event) {
            event.preventDefault();
            const editId = document.getElementById('editMasterProductId').value;
            const masterProductData = {
                brand: document.getElementById('masterBrand').value,
                product: document.getElementById('masterProductName').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                sku: document.getElementById('sku').value.trim(), // Trim SKU
                price: parseFloat(document.getElementById('price').value) || 0,
                isDeleted: false
            };

            // Basic SKU validation (optional, but good practice)
            if (!masterProductData.sku) {
                showNotification('Product Code (SKU) is required for Master Product.', 'error');
                return;
            }
            // Check for duplicate SKU if adding new
            if (!editId && masterProductsData.some(p => p.sku === masterProductData.sku)) {
                 showNotification(`SKU "${masterProductData.sku}" already exists in Master List.`, 'error');
                 return;
            }
            // Check for duplicate SKU if editing and SKU changed
            if (editId) {
                const originalProduct = masterProductsData.find(p => p.id === editId);
                if (originalProduct && originalProduct.sku !== masterProductData.sku && masterProductsData.some(p => p.sku === masterProductData.sku && p.id !== editId)) {
                    showNotification(`SKU "${masterProductData.sku}" already exists for another product.`, 'error');
                    return;
                }
            }


            try {
                await saveDataToFirestore(masterProductsColRef, editId, masterProductData);
                showNotification(editId ? 'Master product updated!' : 'Master product added!', 'success');
                closeModal('masterProductModal');
                event.target.reset();
                await updateLocalData();
            } catch (e) { /* Handled */ }
        }

        async function saveToClear(event) {
            event.preventDefault();
            const editId = document.getElementById('editToClearId').value;
            const warehouseQty = parseInt(document.getElementById('toClearWarehouseQty').value) || 0;
            const storeQty = parseInt(document.getElementById('toClearStoreQty').value) || 0;
            const totalQty = warehouseQty + storeQty;
            const selectedBrand = document.getElementById('toClearBrand').value;
            const selectedProduct = document.getElementById('toClearProductName').value;
            const productSku = getSkuForProduct(selectedBrand, selectedProduct);
            const toClearProductData = {
                brand: selectedBrand,
                product: selectedProduct,
                sku: productSku, 
                category: document.getElementById('toClearCategory').value,
                expiryDate: document.getElementById('toClearExpiryDate').value,
                firstHighlightedDate: document.getElementById('toClearFirstHighlightedDate').value,
                firstReportedBalance: editId ? (await toClearColRef.doc(editId).get()).data().firstReportedBalance : totalQty, 
                warehouseQty: warehouseQty,
                storeQty: storeQty,
                weeklyDemand: parseInt(document.getElementById('toClearWeeklyDemand').value) || 0,
                actionPlan: document.getElementById('toClearActionPlan').value,
                isDeleted: false
            };
            try {
                await saveDataToFirestore(toClearColRef, editId, toClearProductData);
                showNotification(editId ? 'Product to Clear updated!' : 'Product added to Clear!', 'success');
                closeModal('toClearModal');
                event.target.reset();
                await updateLocalData();
            } catch (e) { /* Handled */ }
        }

        async function saveNewBrand(event) {
            event.preventDefault();
            const brandNameInput = document.getElementById('newBrandName');
            const brandName = brandNameInput.value.trim();
            const callingSelectId = brandNameInput.dataset.callingSelect;

            if (!brandName) {
                showNotification('Brand name cannot be empty.', 'error'); return;
            }
            try {
                const existingBrands = brandsData.map(b => b.name.toLowerCase());
                if (existingBrands.includes(brandName.toLowerCase())) {
                    showNotification(`Brand '${brandName}' already exists.`, 'warning');
                } else {
                    await brandsColRef.add({ name: brandName });
                    showNotification(`Brand '${brandName}' added successfully!`, 'success');
                }
                brandNameInput.value = '';
                closeModal('addBrandModal');
                await updateLocalData(); 
                if (callingSelectId) {
                    const selectElement = document.getElementById(callingSelectId);
                    if (selectElement) {
                         // Find the option by text content as value might be the same
                        const optionToSelect = Array.from(selectElement.options).find(opt => opt.textContent === brandName);
                        if (optionToSelect) {
                            selectElement.value = optionToSelect.value;
                        } else { // If not found by text, try by value (if brandName was used as value)
                             if (selectElement.querySelector(`option[value="${brandName}"]`)) {
                                selectElement.value = brandName;
                             }
                        }
                        // Trigger change if needed for other logic (e.g. product datalist filtering)
                        if (typeof selectElement.onchange === 'function') {
                            selectElement.onchange();
                        }
                    }
                }
            } catch (e) {
                console.error("Error adding new brand:", e);
                showNotification('Error adding new brand.', 'error');
            }
        }

        async function saveNewStatus(event) {
            event.preventDefault();
            const statusNameInput = document.getElementById('newStatusName');
            const statusName = statusNameInput.value.trim();
            const callingSelectId = statusNameInput.dataset.callingSelect;
            if (!statusName) {
                showNotification('Status name cannot be empty.', 'error'); return;
            }
            try {
                const existingStatuses = statusesData.map(s => s.name.toLowerCase());
                if (existingStatuses.includes(statusName.toLowerCase())) {
                    showNotification(`Status '${statusName}' already exists.`, 'warning');
                } else {
                    await statusesColRef.add({ name: statusName });
                    showNotification(`Status '${statusName}' added successfully!`, 'success');
                }
                statusNameInput.value = '';
                closeModal('addStatusModal');
                await updateLocalData();
                if (callingSelectId && document.getElementById(callingSelectId).querySelector(`option[value="${statusName}"]`)) {
                    document.getElementById(callingSelectId).value = statusName;
                }
            } catch (e) {
                console.error("Error adding new status:", e);
                showNotification('Error adding new status.', 'error');
            }
        }

        async function saveNewCategory(event) {
            event.preventDefault();
            const categoryNameInput = document.getElementById('newCategoryName');
            const categoryName = categoryNameInput.value.trim();
            const callingSelectId = categoryNameInput.dataset.callingSelect;
            if (!categoryName) {
                showNotification('Category name cannot be empty.', 'error'); return;
            }
            try {
                const existingCategories = categoriesData.map(c => c.name.toLowerCase());
                if (existingCategories.includes(categoryName.toLowerCase())) {
                    showNotification(`Category '${categoryName}' already exists.`, 'warning');
                } else {
                    await categoriesColRef.add({ name: categoryName });
                    showNotification(`Category '${categoryName}' added successfully!`, 'success');
                }
                categoryNameInput.value = '';
                closeModal('addCategoryModal');
                await updateLocalData();
                if (callingSelectId && document.getElementById(callingSelectId).querySelector(`option[value="${categoryName}"]`)) {
                    document.getElementById(callingSelectId).value = categoryName;
                }
            } catch (e) {
                console.error("Error adding new category:", e);
                showNotification('Error adding new category.', 'error');
            }
        }

        function getSkuForProduct(brand, product) {
            const masterProduct = masterProductsData.find(item => item.brand === brand && item.product === product);
            return masterProduct ? masterProduct.sku : ''; // Return empty if not found in master, user might need to add to master first
        }

        // --- Search Functions ---
        function searchInventory(query) { // For OOS/Low Stock Tab
            const lowerQuery = query.toLowerCase();
            const oosLowBase = inventoryData.filter(item => item.status === 'OOS' || item.status.includes('Low stock'));
            currentInventoryViewData = oosLowBase.filter(item =>
                (item.product && item.product.toLowerCase().includes(lowerQuery)) ||
                (item.brand && item.brand.toLowerCase().includes(lowerQuery)) ||
                (item.sku && item.sku.toLowerCase().includes(lowerQuery))
            );
            renderInventoryItems();
        }
        
        function searchNewProducts(query) {
            const lowerQuery = query.toLowerCase();
            currentNewProductsViewData = newProductsData.filter(item =>
                (item.product && item.product.toLowerCase().includes(lowerQuery)) ||
                (item.brand && item.brand.toLowerCase().includes(lowerQuery)) ||
                (item.sku && item.sku.toLowerCase().includes(lowerQuery))
            );
            renderNewProductsItems();
        }

        function searchMasterList(query) {
            const lowerQuery = query.toLowerCase();
            currentMasterListViewData = masterProductsData.filter(item =>
                (item.product && item.product.toLowerCase().includes(lowerQuery)) ||
                (item.brand && item.brand.toLowerCase().includes(lowerQuery)) ||
                (item.sku && item.sku.toLowerCase().includes(lowerQuery)) ||
                (item.category && item.category.toLowerCase().includes(lowerQuery)) ||
                (item.description && item.description.toLowerCase().includes(lowerQuery))
            );
            renderMasterListItems();
        }
        
        function searchToClear(query) {
            const lowerQuery = query.toLowerCase();
            currentToClearViewData = toClearData.filter(item =>
                (item.product && item.product.toLowerCase().includes(lowerQuery)) ||
                (item.brand && item.brand.toLowerCase().includes(lowerQuery)) ||
                (item.sku && item.sku.toLowerCase().includes(lowerQuery)) ||
                (item.category && item.category.toLowerCase().includes(lowerQuery))
            );
            renderToClearItems();
        }

        function searchRecycleBin(query) {
            const lowerQuery = query.toLowerCase();
            currentRecycleBinViewData = deletedItemsData.filter(item =>
                (item.product && item.product.toLowerCase().includes(lowerQuery)) ||
                (item.brand && item.brand.toLowerCase().includes(lowerQuery)) ||
                (item.sku && item.sku.toLowerCase().includes(lowerQuery)) ||
                (item.originalCollection && item.originalCollection.toLowerCase().includes(lowerQuery))
            );
            renderRecycleBinItems();
        }


        function showFilteredInventory(status) { // Called from Dashboard
            // First, switch to the OOS/Low Stock tab
            const tabElement = document.querySelector('.tab[onclick*=\'oos-lowstock\']');
            if (tabElement && !tabElement.classList.contains('active')) {
                switchTab(tabElement, 'oos-lowstock'); // This will reset search and set default view
            }
            // Then, apply the specific filter from the dashboard click
            currentInventoryViewData = inventoryData.filter(item => item.status === status);
            document.getElementById('oosSearchInput').value = ''; // Clear search field on this tab
            renderInventoryItems();
        }

        // --- Merge Functions ---
        async function mergeNewProductsToMaster() {
            if (newProductsData.length === 0) {
                showNotification('No new products to merge.', 'info'); return;
            }
            showConfirmModal(`Are you sure you want to merge all ${newProductsData.length} new products into the Inventory and clear the New Products list?`, async (confirmed) => {
                if (!confirmed) return;
                const batch = db.batch();
                const productsToMerge = [];
                for (const newProduct of newProductsData) {
                    const existingInventoryProduct = inventoryData.find(item => item.sku === newProduct.sku && newProduct.sku); // Ensure SKU exists
                    if (existingInventoryProduct) {
                        const updatedQuantity = (existingInventoryProduct.quantity || 0) + (newProduct.quantity || 0);
                        const inventoryDocRef = inventoryColRef.doc(existingInventoryProduct.id);
                        batch.update(inventoryDocRef, { quantity: updatedQuantity, arrivalDate: newProduct.arrivalDate });
                    } else {
                        const inventoryItem = {
                            brand: newProduct.brand, product: newProduct.product, sku: newProduct.sku,
                            quantity: newProduct.quantity || 0, status: "In Stock", 
                            expiry: "", shipment: "", remarks: "", arrivalDate: newProduct.arrivalDate, isDeleted: false
                        };
                        const newInventoryDocRef = inventoryColRef.doc(); // Auto-generate ID
                        batch.set(newInventoryDocRef, inventoryItem);
                    }
                    const newProductDocRef = newProductsColRef.doc(newProduct.id);
                    batch.delete(newProductDocRef);
                    productsToMerge.push(newProduct); 
                }
                try {
                    await batch.commit(); 
                    await updateLocalData();
                    showNotification(`${productsToMerge.length} new products merged!`, 'success');
                } catch (e) {
                    console.error("Error merging new products:", e);
                    showNotification('Error merging new products.', 'error');
                }
            });
        }

        // --- Delete & Restore Functions ---
        async function softDelete(docId, collectionRef, itemName = "item") {
             showConfirmModal(`Are you sure you want to move this ${itemName} to the Recycle Bin?`, async (confirmed) => {
                if (confirmed) {
                    try {
                        await collectionRef.doc(docId).update({
                            isDeleted: true,
                            deletedDate: new Date().toISOString().slice(0, 10)
                            // originalCollection is implicitly known by the collectionRef or added when fetching for recycle bin
                        });
                        showNotification(`${itemName.charAt(0).toUpperCase() + itemName.slice(1)} moved to Recycle Bin!`, 'success');
                        await updateLocalData();
                    } catch (e) {
                        console.error(`Error moving ${itemName} to Recycle Bin: `, e);
                        showNotification(`Error moving ${itemName} to Recycle Bin.`, 'error');
                    }
                }
            });
        }

        function softDeleteProduct(id) { softDelete(id, inventoryColRef, "product"); }
        function softDeleteNewProduct(id) { softDelete(id, newProductsColRef, "new product entry"); }
        function softDeleteMasterProduct(id) { softDelete(id, masterProductsColRef, "master product"); }
        function softDeleteToClear(id) { softDelete(id, toClearColRef, "'To Clear' product"); }


        async function restoreItem(id, originalCollectionName) {
            showConfirmModal(`Restore this item to its original list (${originalCollectionName.replace('_', ' ').replace(/\b\w/g, char => char.toUpperCase())})?`, async (confirmed) => {
                if (confirmed) {
                    try {
                        const collectionRef = db.collection(originalCollectionName);
                        await collectionRef.doc(id).update({
                            isDeleted: false,
                            deletedDate: firebase.firestore.FieldValue.delete(), 
                        });
                        showNotification('Item restored successfully!', 'success');
                        await updateLocalData();
                    } catch (e) {
                        console.error("Error restoring item: ", e);
                        showNotification('Error restoring item.', 'error');
                    }
                }
            });
        }

        async function hardDeleteItem(id, originalCollectionName) {
            showConfirmModal("PERMANENTLY delete this item? This cannot be undone.", async (confirmed) => {
                if (confirmed) {
                    try {
                        await db.collection(originalCollectionName).doc(id).delete();
                        showNotification('Item permanently deleted!', 'success');
                        await updateLocalData();
                    } catch (e) {
                        console.error("Error permanently deleting document: ", e);
                        showNotification('Error permanently deleting item.', 'error');
                    }
                }
            });
        }

        async function emptyRecycleBin() {
            showConfirmModal('WARNING: PERMANENTLY delete ALL items in the Recycle Bin? This cannot be undone.', async (confirmed) => {
                if (confirmed) {
                    if (deletedItemsData.length === 0) {
                        showNotification('Recycle Bin is already empty.', 'info');
                        return;
                    }
                    try {
                        const batch = db.batch();
                        deletedItemsData.forEach(item => {
                            const docRef = db.collection(item.originalCollection).doc(item.id);
                            batch.delete(docRef);
                        });
                        await batch.commit();
                        showNotification('Recycle Bin emptied successfully!', 'success');
                        await updateLocalData();
                    } catch (e) {
                        console.error("Error emptying Recycle Bin:", e);
                        showNotification('Error emptying Recycle Bin.', 'error');
                    }
                }
            });
        }

        // --- Export & Import Functions ---
        function convertToCSV(data, headers) {
            if (!data || data.length === 0) return headers.join(',') + '\n';
            const csvRows = [];
            csvRows.push(headers.join(',')); 
            data.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header] !== undefined && row[header] !== null ? row[header] : '';
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                        return `"${value.replace(/"/g, '""')}"`; 
                    }
                    return value;
                });
                csvRows.push(values.join(','));
            });
            return csvRows.join('\n');
        }

        async function exportMasterList() {
            try {
                // Fetch non-deleted master products for export
                const activeMasterProducts = masterProductsData.filter(p => !p.isDeleted);
                const headers = ['sku', 'brand', 'product', 'category', 'description', 'price'];
                const csv = convertToCSV(activeMasterProducts, headers);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'master_product_list.csv';
                link.click();
                URL.revokeObjectURL(link.href);
                showNotification('Master List exported successfully!', 'success');
            } catch (e) {
                console.error("Error exporting master list:", e);
                showNotification('Error exporting Master List.', 'error');
            }
        }

        async function exportAllData() {
            try {
                let csvContent = "";
                const fetchOptions = { includeDeleted: true }; // Fetch all data including soft-deleted for backup

                csvContent += "INVENTORY DATA\n";
                const invHeaders = ['sku', 'brand', 'product', 'quantity', 'status', 'expiry', 'shipment', 'remarks', 'isDeleted', 'deletedDate', 'originalCollection'];
                csvContent += convertToCSV(await fetchDataFromFirestore(inventoryColRef, true), invHeaders);

                csvContent += "\n\nNEW PRODUCTS DATA\n";
                const newProdHeaders = ['sku', 'brand', 'product', 'addedDate', 'arrivalDate', 'quantity', 'notes', 'isDeleted', 'deletedDate', 'originalCollection'];
                csvContent += convertToCSV(await fetchDataFromFirestore(newProductsColRef, true), newProdHeaders);

                csvContent += "\n\nTO CLEAR DATA\n";
                const toClearHeaders = ['sku', 'brand', 'product', 'category', 'expiryDate', 'firstHighlightedDate', 'firstReportedBalance', 'warehouseQty', 'storeQty', 'weeklyDemand', 'actionPlan', 'isDeleted', 'deletedDate', 'originalCollection'];
                csvContent += convertToCSV(await fetchDataFromFirestore(toClearColRef, true), toClearHeaders);

                csvContent += "\n\nMASTER PRODUCTS DATA\n";
                const masterHeaders = ['sku', 'brand', 'product', 'category', 'description', 'price', 'isDeleted', 'deletedDate', 'originalCollection'];
                csvContent += convertToCSV(await fetchDataFromFirestore(masterProductsColRef, true), masterHeaders);
                
                csvContent += "\n\nBRANDS DATA\n";
                csvContent += convertToCSV(await fetchDataFromFirestore(brandsColRef, true), ['name', 'id']); // Include ID if needed

                csvContent += "\n\nSTATUSES DATA\n";
                csvContent += convertToCSV(await fetchDataFromFirestore(statusesColRef, true), ['name', 'id']);

                csvContent += "\n\nCATEGORIES DATA\n";
                csvContent += convertToCSV(await fetchDataFromFirestore(categoriesColRef, true), ['name', 'id']);

                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); // Added BOM for Excel
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'all_inventory_data_backup.csv';
                link.click();
                URL.revokeObjectURL(link.href);
                showNotification('All data exported successfully!', 'success');
            } catch (e) {
                console.error("Error exporting all data:", e);
                showNotification('Error exporting all data.', 'error');
            }
        }
        
        async function parseCSVAndUpload(csvText) {
            const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length <= 1) {
                showNotification('CSV file is empty or has no data rows!', 'error'); return;
            }
            const headers = parseCSVLine(lines[0]);
            const dataLines = lines.slice(1);

            // Flexible header mapping (common names for master list)
            const headerMap = {
                "sku": "sku", "product code": "sku",
                "brand": "brand",
                "product": "product", "product name": "product",
                "category": "category",
                "description": "description",
                "price": "price"
            };
            const mappedIndices = {};
            headers.forEach((h, i) => {
                const lowerH = h.toLowerCase();
                if (headerMap[lowerH]) {
                    mappedIndices[headerMap[lowerH]] = i;
                }
            });

            if (!mappedIndices.sku || !mappedIndices.brand || !mappedIndices.product) {
                showNotification('CSV must contain at least "SKU", "Brand", and "Product Name" headers.', 'error');
                return;
            }

            const productsToBatch = [];
            const existingSkus = masterProductsData.map(p => p.sku);

            for (const line of dataLines) {
                const values = parseCSVLine(line);
                const productData = { isDeleted: false }; // Default for new imports
                let validRow = true;

                for (const key in mappedIndices) {
                    let value = values[mappedIndices[key]] ? values[mappedIndices[key]].trim() : '';
                    if (key === 'price') value = parseFloat(value) || 0;
                    productData[key] = value;
                }

                if (!productData.sku) {
                    console.warn(`Skipping row, missing SKU: ${line}`);
                    continue; 
                }
                if (existingSkus.includes(productData.sku)) {
                    showNotification(`Skipping duplicate SKU: ${productData.sku}`, 'warning');
                    continue; 
                }
                productsToBatch.push(productData);
            }

            if (productsToBatch.length === 0) {
                showNotification('No valid new products found in CSV to import.', 'info'); return;
            }

            const batch = db.batch();
            productsToBatch.forEach(product => {
                const newProductDocRef = masterProductsColRef.doc(); // Auto-generate ID
                batch.set(newProductDocRef, product);
            });

            try {
                await batch.commit();
                showNotification(`${productsToBatch.length} products imported successfully to Master List!`, 'success');
                await updateLocalData();
            } catch (error) {
                console.error("Error importing CSV to Firestore:", error);
                showNotification('Error importing CSV. Check console.', 'error');
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"' && (i === 0 || line[i-1] !== '\\')) { // Handle escaped quotes later if needed
                    if (inQuotes && i + 1 < line.length && line[i+1] === '"') { // Double quote inside quoted field
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }


        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) {
                showNotification('No file selected!', 'error'); return;
            }
            const reader = new FileReader();
            reader.onload = async function(e) {
                await parseCSVAndUpload(e.target.result); 
            };
            reader.readAsText(file);
            event.target.value = ''; 
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id); // Use closeModal to handle specific cleanup
            }
        }

        // Sample Data Loading
        const sampleData = { /* ... Same sample data as before ... */ };
        // (Sample data and loadSampleData function remain largely unchanged from original, ensure it includes new collections if needed)
         async function loadSampleData() {
            showNotification('Loading sample data... This might take a moment.', 'info');
            try {
                // Clear existing data from collections
                const collectionsToClear = [
                    inventoryColRef, newProductsColRef, toClearColRef, masterProductsColRef,
                    brandsColRef, statusesColRef, categoriesColRef
                ];
                // Also need to clear items marked as isDeleted true from their original collections
                // For simplicity, we'll just delete all documents in these collections.
                // A more robust clear would handle items marked as deleted if they are not in a separate deletedItems collection.

                for (const colRef of collectionsToClear) {
                    const snapshot = await colRef.get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                }
                
                // Add sample data (ensure sampleData structure matches collection names)
                const sampleDataSets = {
                    inventory: [
                        { brand: "Greenlife", product: "GL CALCIUM GUMMIES", sku: "GL-CG-001", quantity: 0, status: "OOS", expiry: "", shipment: "", remarks: "", isDeleted: false },
                        { brand: "Greenlife", product: "GL VIT C + ZINC", sku: "GL-VCZ-002", quantity: 0, status: "OOS", expiry: "", shipment: "", remarks: "", isDeleted: false },
                        { brand: "NN", product: "NORDIC KIDS VIT C GUM 60'S", sku: "NN-KVC-001", quantity: 5, status: "Low stock", expiry: "2025-08-10", shipment: "", remarks: "", isDeleted: false },
                        { brand: "ENZYMEDICA", product: "DIGEST + PROBIOTICS 30'S", sku: "EZ-DPR-001", quantity: 8, status: "Low stock", expiry: "2025-09-15", shipment: "", remarks: "", isDeleted: false },
                        { brand: "NaturesPlus", product: "SOURCE OF LIFE GOLD", sku: "NP-SLG-001", quantity: 25, status: "In Stock", expiry: "2026-10-01", shipment: "", remarks: "Regular stock", isDeleted: false },
                        { brand: "Greenlife", product: "GL MAGNESIUM POWDER", sku: "GL-MP-005", quantity: 12, status: "In Stock", expiry: "2025-12-31", shipment: "SH001", remarks: "New batch arrived", isDeleted: false }
                    ],
                    new_products: [
                        { brand: "NewBrandX", product: "New Product Alpha", sku: "NBX-PA-001", addedDate: "2025-05-20", arrivalDate: "2025-05-25", quantity: 50, notes: "Trial product", isDeleted: false }
                    ],
                    to_clear: [
                        { brand: "NN", product: "NORDIC OMEGA KIDS", sku: "NN-OK-002", category: "Short Expiry", expiryDate: "2025-07-15", firstHighlightedDate: "2025-05-01", firstReportedBalance: 20, warehouseQty: 10, storeQty: 5, weeklyDemand: 2, actionPlan: "Promote heavily", isDeleted: false }
                    ],
                    master_products: [
                        { brand: "Greenlife", product: "GL CALCIUM GUMMIES", category: "Vitamins", description: "Chewable calcium supplement", sku: "GL-CG-001", price: 15.00, isDeleted: false },
                        { brand: "Greenlife", product: "GL VIT C + ZINC", category: "Vitamins", description: "Immune support formula", sku: "GL-VCZ-002", price: 12.50, isDeleted: false },
                        { brand: "NN", product: "NORDIC KIDS VIT C GUM 60'S", category: "Vitamins", description: "Kids chewable Vitamin C", sku: "NN-KVC-001", price: 18.00, isDeleted: false },
                        { brand: "NN", product: "NORDIC OMEGA KIDS", category: "Omega", description: "Kids Omega-3 DHA Gummy", sku: "NN-OK-002", price: 25.00, isDeleted: false },
                        { brand: "NaturesPlus", product: "SOURCE OF LIFE GOLD", category: "Multivitamins", description: "Whole food based multivitamin", sku: "NP-SLG-001", price: 50.00, isDeleted: false },
                        { brand: "ENZYMEDICA", product: "DIGEST + PROBIOTICS 30'S", category: "Digestive Health", description: "Enzymes and probiotics combo", sku: "EZ-DPR-001", price: 35.00, isDeleted: false },
                    ],
                    brands: [ { name: "Greenlife" }, { name: "NN" }, { name: "NaturesPlus" }, { name: "ENZYMEDICA" }, { name: "NewBrandX" } ],
                    statuses: [ { name: "OOS" }, { name: "Low stock" }, { name: "In Stock" }, { name: "Discontinued" } ],
                    categories: [ { name: "Vitamins" }, { name: "Omega" }, { name: "Multivitamins" }, { name: "Digestive Health" }, { name: "Probiotics" } ]
                };


                for (const collectionKey in sampleDataSets) {
                    const collectionRef = db.collection(collectionKey); // Assumes collectionKey matches Firestore collection name
                    const dataToLoad = sampleDataSets[collectionKey];
                    const batch = db.batch();
                    dataToLoad.forEach(item => {
                        const docRef = collectionRef.doc(); // Auto-generate ID
                        batch.set(docRef, item);
                    });
                    await batch.commit();
                }
                showNotification('Sample data loaded successfully!', 'success');
                await updateLocalData(); // Refresh all UI
            } catch (e) {
                console.error("Error loading sample data:", e);
                showNotification('Error loading sample data. Check console for details.', 'error');
            }
        }


        function confirmLoadSampleData() {
            showConfirmModal('WARNING: This will delete ALL existing data and load sample data. Are you sure?', async (confirmed) => {
                if (confirmed) {
                    await loadSampleData();
                }
            });
        }

        // Initialize on load
        window.onload = async function() {
            await updateLocalData();
            const dashboardTab = document.querySelector('.tab[onclick*=\'dashboard\']');
            if (dashboardTab) {
                switchTab(dashboardTab, 'dashboard');
            } else {
                document.getElementById('dashboard').classList.add('active'); // Fallback
            }
            // Initialize sort indicators for all tables
            Object.keys(sortState).forEach(tableKey => updateSortIndicators(tableKey));
        };
    </script>
</body>
</html>
