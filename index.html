<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-radius: 15px;
        }

        /* Headings */
        h1 {
            color: #2c3e50;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
            overflow-x: auto;
            gap: 2px;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            background-color: transparent;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #7f8c8d;
            min-width: 120px;
            text-align: center;
            border: 2px solid transparent;
            border-bottom: none;
        }

        .tab:hover {
            background-color: #f8f9fa;
            color: #2c3e50;
            border-color: #e1e8ed;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Stats Cards for Dashboard */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.urgent {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            line-height: 1;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Controls (Buttons, Search) */
        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Changed to flex-start for better alignment with multiple items */
            flex-wrap: wrap;
            gap: 15px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e1e8ed;
        }
         .controls > * { /* Ensure items in controls don't shrink excessively */
            flex-shrink: 0;
        }


        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        th, td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
            cursor: pointer; /* For sortable headers */
        }
        th .sort-arrow { /* For sort indicators */
            font-size: 0.8em;
            margin-left: 5px;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .oos {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .low {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .normal {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .danger-status {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .alert-status {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        /* Buttons */
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        /* Search Box */
        .search-box {
            padding: 12px 16px;
            width: 280px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: none;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        /* Form Group */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .form-group input:disabled, .form-group select:disabled, .form-group textarea:disabled {
            background-color: #f0f0f0;
            opacity: 0.7;
            cursor: not-allowed;
        }
        .form-group label.disabled-label {
            opacity: 0.5;
        }


        /* Alert Notifications */
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 600;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Confirmation Modal Specific Styles */
        #confirmModal .modal-content {
            text-align: center;
            padding: 40px;
            max-width: 450px;
        }

        #confirmModal .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        #confirmModal .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        #confirmModal .modal-buttons button {
            flex: 1;
            max-width: 150px;
            padding: 12px 25px;
            font-size: 14px;
        }

        /* --- Mobile Responsiveness --- */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            .subtitle {
                font-size: 1rem;
                margin-bottom: 20px;
            }

            .tabs {
                flex-wrap: wrap; /* Allow tabs to wrap to next line */
                justify-content: center; /* Center tabs when wrapped */
                border-bottom: none; /* Remove border when wrapped */
            }

            .tab {
                min-width: unset; /* Remove fixed min-width */
                flex: 1 1 auto; /* Allow tabs to grow/shrink */
                padding: 10px 15px;
                font-size: 10px;
                border-bottom: 2px solid #ecf0f1; /* Add border to each tab */
            }

            .tab.active {
                transform: none; /* Remove transform on active tab */
                box-shadow: none; /* Remove shadow on active tab */
                border-bottom: 2px solid #667eea;
            }

            .stats-cards {
                grid-template-columns: 1fr; /* Stack cards vertically */
            }

            .stat-card {
                padding: 20px;
            }

            .stat-number {
                font-size: 2.5rem;
            }

            .controls {
                flex-direction: column; /* Stack buttons and search vertically */
                align-items: stretch; /* Stretch items to full width */
                padding: 15px;
            }
            .controls .search-box { /* Ensure search box in controls takes full width on mobile */
                 width: 100%;
            }


            button {
                width: 100%;
                margin-bottom: 10px; /* Add space between stacked buttons */
                font-size: 12px;
                padding: 10px 15px;
            }

            .search-box { /* General search box styling for mobile */
                width: 100%; 
            }


            /* Responsive Tables: force table to scroll horizontally */
            table {
                display: block; /* Make table a block element */
                width: 100%;
                overflow-x: auto; /* Enable horizontal scrolling */
                -webkit-overflow-scrolling: touch; /* Smooth scrolling for iOS */
                white-space: nowrap; /* Prevent content from wrapping */
            }

            th, td {
                min-width: 120px; /* Ensure columns have a minimum width */
                padding: 10px;
            }

            .modal-content {
                margin: 20px auto; /* Adjust margin for smaller screens */
                padding: 20px;
                width: 95%; /* Make modal content a bit wider */
            }

            .alert {
                width: calc(100% - 40px); /* Full width minus padding */
                left: 20px;
                right: 20px;
                top: 10px; /* Move notification higher */
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Inventory Management System</h1>
        <p class="subtitle">Professional Inventory Tracking & Management Solution</p>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab(this, 'dashboard')">📊 Dashboard</div>
            <div class="tab" onclick="switchTab(this, 'oos-lowstock')">📦 OOS/LOW STOCK</div>
            <div class="tab" onclick="switchTab(this, 'new-products')">✨ New Products</div>
            <div class="tab" onclick="switchTab(this, 'to-clear')">🏷️ To Clear</div>
            <div class="tab" onclick="switchTab(this, 'master-list')">📋 Master List</div>
            <div class="tab" onclick="switchTab(this, 'recycle-bin')">🗑️ Recycle Bin</div>
            <div class="tab" onclick="switchTab(this, 'management')">⚙️ Management</div>
        </div>
        
        <div id="dashboard" class="tab-content active">
            <div class="stats-cards">
                <div class="stat-card urgent" onclick="showFilteredInventory('OOS')">
                    <div class="stat-number" id="oos-count">0</div>
                    <div class="stat-label">Out of Stock</div>
                </div>
                <div class="stat-card warning" onclick="showFilteredInventory('Low stock')">
                    <div class="stat-number" id="low-count">0</div>
                    <div class="stat-label">Low Stock</div>
                </div>
                <div class="stat-card info" onclick="switchTab(document.querySelector('.tab[onclick*=\'new-products\']'), 'new-products')">
                    <div class="stat-number" id="new-count">0</div>
                    <div class="stat-label">New Products</div>
                </div>
            </div>
            
            <h3>Recent Alerts</h3>
            <div id="alerts" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                <p>Loading alerts...</p>
            </div>
        </div>
        
        <div id="oos-lowstock" class="tab-content">
            <div class="controls">
                <button onclick="showAddProductModal()">➕ Add Product</button>
                <input type="text" id="oosSearchInput" class="search-box" placeholder="🔍 Search products..." onkeyup="searchInventory(this.value)">
            </div>
            
            <table id="inventory-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('inventory', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'quantity')" data-column-key="quantity">Quantity <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'status')" data-column-key="status">Status <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('inventory', 'shipment')" data-column-key="shipment">Shipment <span class="sort-arrow"></span></th>
                        <th>Remarks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventory-table">
                    </tbody>
            </table>
        </div>
        
        <div id="new-products" class="tab-content">
            <div class="controls">
                <button onclick="showAddNewProductModal()">➕ Add New Product</button>
                <button onclick="mergeNewProductsToMaster()">Merge All to Inventory</button>
                 <input type="text" id="newProductsSearchInput" class="search-box" placeholder="🔍 Search new products..." onkeyup="searchNewProducts(this.value)">
            </div>
            
            <table id="new-products-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('newProducts', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'addedDate')" data-column-key="addedDate">Added Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'arrivalDate')" data-column-key="arrivalDate">Arrival Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('newProducts', 'quantity')" data-column-key="quantity">Quantity <span class="sort-arrow"></span></th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="new-products-table">
                    </tbody>
            </table>
        </div>
        
        <div id="to-clear" class="tab-content">
            <div class="controls">
                <button onclick="showAddToClearModal()">➕ Add Product to Clear</button>
                <input type="text" id="toClearSearchInput" class="search-box" placeholder="🔍 Search products to clear..." onkeyup="searchToClear(this.value)">
            </div>
            
            <table id="to-clear-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('toClear', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'category')" data-column-key="category">Category <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'expiryDate')" data-column-key="expiryDate">Expiry Date <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'firstHighlightedDate')" data-column-key="firstHighlightedDate">First Highlighted <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'firstReportedBalance')" data-column-key="firstReportedBalance">Initial Bal <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'warehouseQty')" data-column-key="warehouseQty">WH Qty <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'storeQty')" data-column-key="storeQty">Store Qty <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'totalQty')" data-column-key="totalQty">Total Qty <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'weeklyDemand')" data-column-key="weeklyDemand">Wk Demand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'weeksSupply')" data-column-key="weeksSupply">Wks Supply <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('toClear', 'supplyStatus')" data-column-key="supplyStatus">Supply Status <span class="sort-arrow"></span></th>
                        <th>Action Plan</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="to-clear-table">
                    </tbody>
            </table>
        </div>
        
        <div id="master-list" class="tab-content">
            <div class="controls">
                <button onclick="showAddMasterProductModal()">➕ Add Product</button>
                <input type="text" class="search-box" id="masterListSearchInput" placeholder="🔍 Search master products..." onkeyup="searchMasterList(this.value)">
                <button onclick="exportMasterList()">📥 Export List</button>
                <button onclick="document.getElementById('csvFileInput').click()">📤 Import CSV</button>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importCSV(event)">
            </div>
            
            <table id="master-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('master', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'product')" data-column-key="product">Product Name <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('master', 'category')" data-column-key="category">Category <span class="sort-arrow"></span></th>
                        <th>Description</th>
                        <th onclick="sortTable('master', 'price')" data-column-key="price">Price <span class="sort-arrow"></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="master-table">
                    </tbody>
            </table>
        </div>

        <div id="recycle-bin" class="tab-content">
            <div class="controls">
                <h3>Recycle Bin</h3>
                <input type="text" id="recycleBinSearchInput" class="search-box" placeholder="🔍 Search recycle bin..." onkeyup="searchRecycleBin(this.value)">
                <button class="btn-danger" onclick="emptyRecycleBin()">🗑️ Empty Recycle Bin</button>
            </div>
            <table id="recycle-bin-table-container">
                <thead>
                    <tr>
                        <th onclick="sortTable('recycleBin', 'sku')" data-column-key="sku">Product Code <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('recycleBin', 'originalCollection')" data-column-key="originalCollection">Original Tab <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('recycleBin', 'brand')" data-column-key="brand">Brand <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('recycleBin', 'product')" data-column-key="product">Product <span class="sort-arrow"></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recycle-bin-table">
                    </tbody>
            </table>
        </div>
        
        <div id="management" class="tab-content">
            <div class="controls">
                <button onclick="exportAllData()">📥 Export All Data</button>
                <button onclick="confirmLoadSampleData()">📊 Load Sample Data</button>
            </div>
            
            <h3>System Information</h3>
            <p>Total Products (active): <span id="total-products">0</span></p>
            <p>Total Products (including deleted): <span id="total-products-all">0</span></p>
            <p>Last Synced: <span id="last-updated">Never</span></p>
        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('productModal')">&times;</span>
            <h2 id="productModalTitle">Add New Product</h2>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="editProductId" value="">
                <div class="form-group">
                    <label for="brand">Brand:</label>
                    <select id="brand" required onchange="filterProductsForBrand(this.value, 'productName', 'productsDatalist')">
                        </select>
                </div>
                <div class="form-group">
                    <label for="productName">Product Name:</label>
                    <input type="text" id="productName" list="productsDatalist" required>
                    <datalist id="productsDatalist"></datalist>
                </div>
                <div class="form-group">
                    <label for="inventoryQuantity">Quantity:</label>
                    <input type="number" id="inventoryQuantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="status">Status:</label>
                    <select id="status" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="shipment">Shipment No.:</label>
                    <input type="text" id="shipment">
                </div>
                <div class="form-group">
                    <label for="remarks">Remarks:</label>
                    <textarea id="remarks"></textarea>
                </div>
                <button type="submit">Save Product</button>
            </form>
        </div>
    </div>

    <div id="newProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('newProductModal')">&times;</span>
            <h2 id="newProductModalTitle">Add New Product Entry</h2>
            <form onsubmit="saveNewProduct(event)">
                <input type="hidden" id="editNewProductId" value="">
                <div class="form-group">
                    <label for="newBrand">Brand:</label>
                    <select id="newBrand" required onchange="filterProductsForBrand(this.value, 'newProductName', 'newProductsDatalist')">
                        </select>
                </div>
                <div class="form-group">
                    <label for="newProductSku">Product Code (SKU):</label>
                    <input type="text" id="newProductSku" required>
                </div>
                <div class="form-group">
                    <label for="newProductName">Product Name:</label>
                    <input type="text" id="newProductName" list="newProductsDatalist" required>
                    <datalist id="newProductsDatalist"></datalist>
                </div>
                <div class="form-group">
                    <label for="arrivalDate">Arrival Date:</label>
                    <input type="date" id="arrivalDate" required>
                </div>
                <div class="form-group">
                    <label for="newProductQuantity">Quantity:</label> <input type="number" id="newProductQuantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="notes">Notes:</label>
                    <textarea id="notes"></textarea>
                </div>
                <button type="submit">Save New Product</button>
            </form>
        </div>
    </div>

    <div id="masterProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('masterProductModal')">&times;</span>
            <h2 id="masterProductModalTitle">Add Master Product</h2>
            <form onsubmit="saveMasterProduct(event)">
                <input type="hidden" id="editMasterProductId" value="">
                <div class="form-group">
                    <label for="masterBrand">Brand:</label>
                    <select id="masterBrand" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="masterProductName">Product Name:</label>
                    <input type="text" id="masterProductName" required>
                </div>
                <div class="form-group">
                    <label for="category">Category:</label>
                    <select id="category" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="description">Description:</label>
                    <textarea id="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="sku">Product Code (SKU):</label>
                    <input type="text" id="sku">
                </div>
                <div class="form-group">
                    <label for="price">Price:</label>
                    <input type="number" id="price" step="0.01" min="0">
                </div>
                <button type="submit">Save Master Product</button>
            </form>
        </div>
    </div>

    <div id="toClearModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('toClearModal')">&times;</span>
            <h2 id="toClearModalTitle">Add Product to Clear</h2>
            <form onsubmit="saveToClear(event)">
                <input type="hidden" id="editToClearId" value="">
                <div class="form-group">
                    <label for="toClearBrand">Brand:</label>
                    <select id="toClearBrand" required onchange="filterProductsForBrand(this.value, 'toClearProductName', 'toClearProductsDatalist')">
                        </select>
                </div>
                <div class="form-group">
                    <label for="toClearProductName">Product Name:</label>
                    <input type="text" id="toClearProductName" list="toClearProductsDatalist" required>
                    <datalist id="toClearProductsDatalist"></datalist>
                </div>
                <div class="form-group">
                    <label for="toClearCategory">Category:</label>
                    <select id="toClearCategory" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="toClearExpiryDate">Expiry Date:</label>
                    <input type="date" id="toClearExpiryDate" required>
                </div>
                <div class="form-group">
                    <label for="toClearFirstHighlightedDate">First Highlighted Date:</label>
                    <input type="date" id="toClearFirstHighlightedDate" required readonly>
                </div>
                <div class="form-group">
                    <label for="toClearFirstReportedBalance">First Reported Balance (Total Qty):</label>
                    <input type="number" id="toClearFirstReportedBalance" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearWarehouseQty">Warehouse Qty:</label>
                    <input type="number" id="toClearWarehouseQty" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearStoreQty">Store Qty:</label>
                    <input type="number" id="toClearStoreQty" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearWeeklyDemand">Weekly Demand:</label>
                    <input type="number" id="toClearWeeklyDemand" min="0">
                </div>
                <div class="form-group">
                    <label for="toClearActionPlan">Action Plan:</label>
                    <textarea id="toClearActionPlan"></textarea>
                </div>
                <button type="submit">Save Product to Clear</button>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2>Confirmation</h2>
            <p id="confirmMessage"></p>
            <div class="modal-buttons">
                <button class="btn-danger" id="confirmNo">No</button>
                <button class="btn-success" id="confirmYes">Yes</button>
            </div>
        </div>
    </div>

    <div id="addBrandModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addBrandModal')">&times;</span>
            <h2>Add New Brand</h2>
            <form onsubmit="saveNewBrand(event)">
                <div class="form-group">
                    <label for="newBrandName">Brand Name:</label>
                    <input type="text" id="newBrandName" required>
                </div>
                <button type="submit">Add Brand</button>
            </form>
        </div>
    </div>

    <div id="addStatusModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addStatusModal')">&times;</span>
            <h2>Add New Status</h2>
            <form onsubmit="saveNewStatus(event)">
                <div class="form-group">
                    <label for="newStatusName">Status Name:</label>
                    <input type="text" id="newStatusName" required>
                </div>
                <button type="submit">Add Status</button>
            </form>
        </div>
    </div>

    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addCategoryModal')">&times;</span>
            <h2>Add New Category</h2>
            <form onsubmit="saveNewCategory(event)">
                <div class="form-group">
                    <label for="newCategoryName">Category Name:</label>
                    <input type="text" id="newCategoryName" required>
                </div>
                <button type="submit">Add Category</button>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDo1-y0Vj4XTQeeEUQK_6Y2wqDs94TOAX0", // Replace with your actual API key
            authDomain: "inventory-c3bac.firebaseapp.com",
            projectId: "inventory-c3bac",
            storageBucket: "inventory-c3bac.appspot.com", // Corrected storage bucket
            messagingSenderId: "261015083855",
            appId: "1:261015083855:web:e167f359928eb8ed8cc33a",
            measurementId: "G-V744486L78"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global data arrays to hold fetched data
        let inventoryData = [];
        let newProductsData = [];
        let toClearData = [];
        let masterProductsData = [];
        let deletedItemsData = []; // For Recycle Bin
        let brandsData = []; 
        let statusesData = []; 
        let categoriesData = []; 

        // Data for current views (used for filtering and sorting)
        let currentInventoryViewData = [];
        let currentNewProductsViewData = [];
        let currentToClearViewData = [];
        let currentMasterListViewData = [];
        let currentRecycleBinViewData = [];

        // Firestore collection references
        const inventoryColRef = db.collection('inventory');
        const newProductsColRef = db.collection('new_products');
        const toClearColRef = db.collection('to_clear');
        const masterProductsColRef = db.collection('master_products');
        const brandsColRef = db.collection('brands');
        const statusesColRef = db.collection('statuses');
        const categoriesColRef = db.collection('categories');

        // Sort state for tables
        let sortState = {
            inventory: { column: null, direction: 'asc' },
            newProducts: { column: null, direction: 'asc' },
            master: { column: null, direction: 'asc' },
            toClear: { column: null, direction: 'asc' },
            recycleBin: { column: null, direction: 'asc' }
        };

        // --- Notification System ---
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.classList.add('alert', `alert-${type}`);
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // --- Confirmation Modal ---
        let confirmCallback = null;
        function showConfirmModal(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').style.display = 'block';
            confirmCallback = callback;
        }

        document.getElementById('confirmYes').onclick = () => {
            if (confirmCallback) {
                confirmCallback(true);
            }
            document.getElementById('confirmModal').style.display = 'none';
        };

        document.getElementById('confirmNo').onclick = () => {
            if (confirmCallback) {
                confirmCallback(false);
            }
            document.getElementById('confirmModal').style.display = 'none';
        };


        // --- Firestore Data Operations ---
        async function fetchDataFromFirestore(collectionRef, includeDeleted = false) {
            let data = [];
            let query = collectionRef;
            if (!includeDeleted) {
                query = collectionRef.where("isDeleted", "==", false);
            }
            try {
                const querySnapshot = await query.get();
                querySnapshot.forEach((doc) => {
                    data.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error(`Error fetching data from ${collectionRef.id}:`, error);
                if (error.code === 'failed-precondition') {
                    console.warn(`Firestore query for ${collectionRef.id} might require an index. Check Firestore console. Query details: where("isDeleted", "==", false)`);
                }
                showNotification(`Error loading data from ${collectionRef.id}. Check console.`, 'error');
            }
            return data;
        }

        async function fetchAllDataForRecycleBin() {
            const collectionsToFetchFrom = [inventoryColRef, newProductsColRef, toClearColRef, masterProductsColRef];
            let allDeletedItems = [];
            for (const colRef of collectionsToFetchFrom) {
                try {
                    const querySnapshot = await colRef.where("isDeleted", "==", true).get();
                    querySnapshot.forEach((doc) => {
                        allDeletedItems.push({ id: doc.id, ...doc.data(), originalCollection: colRef.id });
                    });
                } catch (error) {
                    console.error(`Error fetching deleted items from ${colRef.id}:`, error);
                    if (error.code === 'failed-precondition') {
                        console.warn(`Firestore query for deleted items in ${colRef.id} might require an index for 'isDeleted'. Check Firestore console.`);
                    }
                }
            }
            return allDeletedItems;
        }

        async function saveDataToFirestore(collectionRef, docId, data) {
            try {
                if (docId) {
                    await collectionRef.doc(docId).update(data);
                } else {
                    const docRef = await collectionRef.add(data);
                    return docRef.id;
                }
                return docId;
            } catch (error) {
                console.error(`Error saving data to ${collectionRef.id}:`, error);
                showNotification(`Error saving data to server for ${collectionRef.id}.`, 'error');
                throw error;
            }
        }

        // --- Update Local Data & UI ---
        async function updateLocalData() {
            try {
                inventoryData = await fetchDataFromFirestore(inventoryColRef);
                newProductsData = await fetchDataFromFirestore(newProductsColRef);
                toClearData = await fetchDataFromFirestore(toClearColRef);
                masterProductsData = await fetchDataFromFirestore(masterProductsColRef);
                deletedItemsData = await fetchAllDataForRecycleBin(); // Fetches all items where isDeleted == true
                brandsData = await fetchDataFromFirestore(brandsColRef);
                statusesData = await fetchDataFromFirestore(statusesColRef);
                categoriesData = await fetchDataFromFirestore(categoriesColRef);

                // Initialize current view data
                currentInventoryViewData = inventoryData.filter(item => item.status === 'OOS' || item.status.includes('Low stock'));
                currentNewProductsViewData = [...newProductsData];
                currentToClearViewData = [...toClearData];
                currentMasterListViewData = [...masterProductsData];
                currentRecycleBinViewData = [...deletedItemsData];

                updateAllTablesAndViews(); // This will call individual updateTable functions
                updateDashboardStats();
                updateAlerts();
                updateManagementStats();
                populateProductDatalists();
                setupDynamicDropdowns();
            } catch (error) {
                console.error("Error updating local data from Firestore:", error);
                showNotification('Error loading data from server. Please check your internet connection or Firebase setup.', 'error');
            }
        }

        function updateAllTablesAndViews() {
            // Call the specific render functions which will use the currentViewData and apply sorting
            renderInventoryItems();
            renderNewProductsItems();
            renderMasterListItems();
            renderToClearItems();
            renderRecycleBinItems();
        }

        // --- Dynamic Dropdowns ---
        function setupDynamicDropdowns() {
            populateBrandDropdowns('brand');
            populateBrandDropdowns('newBrand');
            populateBrandDropdowns('masterBrand');
            populateBrandDropdowns('toClearBrand');
            populateStatusDropdowns('status'); // For productModal
            populateCategoryDropdowns('category'); // For masterProductModal
            populateCategoryDropdowns('toClearCategory'); // For toClearModal
        }

        function populateBrandDropdowns(selectId) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;

            const currentValue = selectElement.value;
            selectElement.innerHTML = '<option value="">Select Brand</option>';

            const uniqueBrandsFromMaster = [...new Set(masterProductsData.map(item => item.brand).filter(Boolean))];
            let allUniqueBrands = [...uniqueBrandsFromMaster];
            brandsData.forEach(brandDoc => {
                if (brandDoc.name && !allUniqueBrands.includes(brandDoc.name)) {
                    allUniqueBrands.push(brandDoc.name);
                }
            });
            allUniqueBrands.sort((a, b) => a.localeCompare(b));

            allUniqueBrands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                selectElement.appendChild(option);
            });

            const addNewOption = document.createElement('option');
            addNewOption.value = 'add_new_brand';
            addNewOption.textContent = '+ Add New Brand...';
            selectElement.appendChild(addNewOption);

            if (currentValue && selectElement.querySelector(`option[value="${currentValue}"]`)) {
                selectElement.value = currentValue;
            }
            selectElement.removeEventListener('change', handleDynamicDropdownChange);
            selectElement.addEventListener('change', handleDynamicDropdownChange);
        }

        function populateStatusDropdowns(selectId) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;

            const currentValue = selectElement.value;
            selectElement.innerHTML = '<option value="">Select Status</option>';

            const uniqueStatusesFromInventory = [...new Set(inventoryData.map(item => item.status).filter(Boolean))];
            let allUniqueStatuses = [...uniqueStatusesFromInventory];
            statusesData.forEach(statusDoc => {
                if (statusDoc.name && !allUniqueStatuses.includes(statusDoc.name)) {
                    allUniqueStatuses.push(statusDoc.name);
                }
            });
            allUniqueStatuses.sort((a, b) => a.localeCompare(b));

            allUniqueStatuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                selectElement.appendChild(option);
            });

            const addNewOption = document.createElement('option');
            addNewOption.value = 'add_new_status';
            addNewOption.textContent = '+ Add New Status...';
            selectElement.appendChild(addNewOption);

            if (currentValue && selectElement.querySelector(`option[value="${currentValue}"]`)) {
                selectElement.value = currentValue;
            }
            selectElement.removeEventListener('change', handleDynamicDropdownChange);
            selectElement.addEventListener('change', handleDynamicDropdownChange);
        }

        function populateCategoryDropdowns(selectId) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;

            const currentValue = selectElement.value;
            selectElement.innerHTML = '<option value="">Select Category</option>';

            const uniqueCategoriesFromMaster = [...new Set(masterProductsData.map(item => item.category).filter(Boolean))];
            let allUniqueCategories = [...uniqueCategoriesFromMaster];
            categoriesData.forEach(categoryDoc => {
                if (categoryDoc.name && !allUniqueCategories.includes(categoryDoc.name)) {
                    allUniqueCategories.push(categoryDoc.name);
                }
            });
            allUniqueCategories.sort((a, b) => a.localeCompare(b));

            allUniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                selectElement.appendChild(option);
            });

            const addNewOption = document.createElement('option');
            addNewOption.value = 'add_new_category';
            addNewOption.textContent = '+ Add New Category...';
            selectElement.appendChild(addNewOption);

            if (currentValue && selectElement.querySelector(`option[value="${currentValue}"]`)) {
                selectElement.value = currentValue;
            }
            selectElement.removeEventListener('change', handleDynamicDropdownChange);
            selectElement.addEventListener('change', handleDynamicDropdownChange);
        }

        function handleDynamicDropdownChange(event) {
            const selectElement = event.target;
            if (selectElement.value === 'add_new_brand') {
                showAddBrandModal();
                selectElement.value = ''; // Reset to blank or previous selection
            } else if (selectElement.value === 'add_new_status') {
                showAddStatusModal();
                selectElement.value = '';
            } else if (selectElement.value === 'add_new_category') {
                showAddCategoryModal();
                selectElement.value = '';
            }
        }

        // --- Product Datalists (for autocomplete) ---
        function populateProductDatalists() {
            const productsDatalist = document.getElementById('productsDatalist');
            const newProductsDatalist = document.getElementById('newProductsDatalist');
            const toClearProductsDatalist = document.getElementById('toClearProductsDatalist');

            if (productsDatalist) productsDatalist.innerHTML = '';
            if (newProductsDatalist) newProductsDatalist.innerHTML = '';
            if (toClearProductsDatalist) toClearProductsDatalist.innerHTML = '';

            const allProductNames = [...new Set(masterProductsData.map(item => item.product).filter(Boolean))].sort();

            allProductNames.forEach(productName => {
                const option1 = document.createElement('option');
                option1.value = productName;
                if (productsDatalist) productsDatalist.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = productName;
                if (newProductsDatalist) newProductsDatalist.appendChild(option2);

                const option3 = document.createElement('option');
                option3.value = productName;
                if (toClearProductsDatalist) toClearProductsDatalist.appendChild(option3);
            });
        }

        function filterProductsForBrand(brand, productNameInputId, datalistId) {
            const productNameInput = document.getElementById(productNameInputId);
            const datalist = document.getElementById(datalistId);
            if (!productNameInput || !datalist) return;

            datalist.innerHTML = '';
            const filteredProducts = masterProductsData.filter(item => item.brand === brand);
            const uniqueProductNames = [...new Set(filteredProducts.map(item => item.product).filter(Boolean))].sort();

            uniqueProductNames.forEach(productName => {
                const option = document.createElement('option');
                option.value = productName;
                datalist.appendChild(option);
            });

            // If the current product name is not in the new filtered list, clear it
            if (productNameInput.value && !uniqueProductNames.includes(productNameInput.value)) {
                productNameInput.value = '';
            }
        }

        // --- Tab Switching ---
        function switchTab(clickedTab, tabId) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            clickedTab.classList.add('active');

            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            // Re-render table for the newly active tab to apply current sort/filter
            if (tabId === 'oos-lowstock') {
                renderInventoryItems();
            } else if (tabId === 'new-products') {
                renderNewProductsItems();
            } else if (tabId === 'to-clear') {
                renderToClearItems();
            } else if (tabId === 'master-list') {
                renderMasterListItems();
            } else if (tabId === 'recycle-bin') {
                renderRecycleBinItems();
            }
        }

        // --- Modals ---
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Clear form fields when closing modals if needed
            if (modalId === 'productModal') {
                document.getElementById('productModal').querySelector('form').reset();
                document.getElementById('editProductId').value = '';
            } else if (modalId === 'newProductModal') {
                document.getElementById('newProductModal').querySelector('form').reset();
                document.getElementById('editNewProductId').value = '';
            } else if (modalId === 'masterProductModal') {
                document.getElementById('masterProductModal').querySelector('form').reset();
                document.getElementById('editMasterProductId').value = '';
            } else if (modalId === 'toClearModal') {
                document.getElementById('toClearModal').querySelector('form').reset();
                document.getElementById('editToClearId').value = '';
            } else if (modalId === 'addBrandModal') {
                document.getElementById('addBrandModal').querySelector('form').reset();
            } else if (modalId === 'addStatusModal') {
                document.getElementById('addStatusModal').querySelector('form').reset();
            } else if (modalId === 'addCategoryModal') {
                document.getElementById('addCategoryModal').querySelector('form').reset();
            }
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        }

        // --- CRUD Operations & Rendering ---

        // Inventory (OOS/Low Stock)
        function renderInventoryItems() {
            const tableBody = document.getElementById('inventory-table');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            const sortedData = sortArray(currentInventoryViewData, sortState.inventory.column, sortState.inventory.direction);

            sortedData.forEach(item => {
                // Filter out 'In stock' for OOS/Low Stock tab explicitly if somehow it got here
                if (item.status && item.status.toLowerCase() === 'in stock') return; 

                const row = tableBody.insertRow();
                row.insertCell().textContent = item.sku || '';
                row.insertCell().textContent = item.brand || '';
                row.insertCell().textContent = item.product || '';
                row.insertCell().textContent = item.quantity !== undefined ? item.quantity : '';
                const statusCell = row.insertCell();
                statusCell.innerHTML = `<span class="status-badge ${item.status === 'OOS' ? 'oos' : 'low'}">${item.status || ''}</span>`;
                // REMOVED: Expiry Date cell
                row.insertCell().textContent = item.shipment || '';
                row.insertCell().textContent = item.remarks || '';

                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn-info" onclick="editProduct('${item.id}')">✏️ Edit</button>
                    <button class="btn-danger" onclick="moveToRecycleBin('${item.id}', 'inventory')">🗑️ Delete</button>
                `;
            });
        }

        function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('editProductId').value = '';
            document.getElementById('productModal').querySelector('form').reset();
            populateBrandDropdowns('brand'); // Re-populate brands
            populateStatusDropdowns('status'); // Re-populate statuses
            openModal('productModal');
        }

        async function saveProduct(event) {
            event.preventDefault();
            const id = document.getElementById('editProductId').value;
            const data = {
                brand: document.getElementById('brand').value,
                product: document.getElementById('productName').value,
                quantity: parseInt(document.getElementById('inventoryQuantity').value),
                status: document.getElementById('status').value,
                // REMOVED: Expiry Date field
                shipment: document.getElementById('shipment').value,
                remarks: document.getElementById('remarks').value,
                isDeleted: false // Ensure this flag is set
            };

            try {
                await saveDataToFirestore(inventoryColRef, id, data);
                showNotification('Product saved successfully!', 'success');
                closeModal('productModal');
                await updateLocalData(); // Refresh data and UI
            } catch (e) {
                // Error handled by saveDataToFirestore
            }
        }

        async function editProduct(id) {
            const item = inventoryData.find(p => p.id === id);
            if (item) {
                document.getElementById('productModalTitle').textContent = 'Edit Product';
                document.getElementById('editProductId').value = item.id;
                document.getElementById('brand').value = item.brand;
                document.getElementById('productName').value = item.product;
                document.getElementById('inventoryQuantity').value = item.quantity;
                document.getElementById('status').value = item.status;
                // document.getElementById('expiry').value = item.expiry; // REMOVED
                document.getElementById('shipment').value = item.shipment;
                document.getElementById('remarks').value = item.remarks;
                populateBrandDropdowns('brand');
                populateStatusDropdowns('status');
                filterProductsForBrand(item.brand, 'productName', 'productsDatalist');
                openModal('productModal');
            }
        }

        function showFilteredInventory(statusFilter) {
            currentInventoryViewData = inventoryData.filter(item => item.status && item.status.toLowerCase().includes(statusFilter.toLowerCase()));
            renderInventoryItems();
            // Switch to OOS/LOW STOCK tab
            const oosLowStockTab = document.querySelector('.tab[onclick*=\'oos-lowstock\']');
            if (oosLowStockTab) {
                switchTab(oosLowStockTab, 'oos-lowstock');
            }
        }

        function searchInventory(searchTerm) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            currentInventoryViewData = inventoryData.filter(item =>
                (item.brand && item.brand.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.product && item.product.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.sku && item.sku.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.status && item.status.toLowerCase().includes(lowerCaseSearchTerm))
            );
            renderInventoryItems();
        }


        // New Products
        function renderNewProductsItems() {
            const tableBody = document.getElementById('new-products-table');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            const sortedData = sortArray(currentNewProductsViewData, sortState.newProducts.column, sortState.newProducts.direction);

            sortedData.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.sku || ''; // Added SKU
                row.insertCell().textContent = item.brand || '';
                row.insertCell().textContent = item.product || '';
                row.insertCell().textContent = item.addedDate || '';
                row.insertCell().textContent = item.arrivalDate || '';
                row.insertCell().textContent = item.quantity !== undefined ? item.quantity : '';
                row.insertCell().textContent = item.notes || '';

                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn-info" onclick="editNewProduct('${item.id}')">✏️ Edit</button>
                    <button class="btn-success" onclick="moveNewProductToMaster('${item.id}')">✅ Approve</button>
                    <button class="btn-danger" onclick="moveToRecycleBin('${item.id}', 'new_products')">🗑️ Delete</button>
                `;
            });
        }

        function showAddNewProductModal() {
            document.getElementById('newProductModalTitle').textContent = 'Add New Product Entry';
            document.getElementById('editNewProductId').value = '';
            document.getElementById('newProductModal').querySelector('form').reset();
            document.getElementById('arrivalDate').valueAsDate = new Date(); // Set default arrival date
            populateBrandDropdowns('newBrand'); // Re-populate brands
            openModal('newProductModal');
        }

        async function saveNewProduct(event) {
            event.preventDefault();
            const id = document.getElementById('editNewProductId').value;
            const data = {
                brand: document.getElementById('newBrand').value,
                sku: document.getElementById('newProductSku').value, // Added SKU
                product: document.getElementById('newProductName').value,
                arrivalDate: document.getElementById('arrivalDate').value,
                quantity: parseInt(document.getElementById('newProductQuantity').value),
                notes: document.getElementById('notes').value,
                addedDate: id ? (newProductsData.find(item => item.id === id)?.addedDate || new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0],
                isDeleted: false // Ensure this flag is set
            };

            try {
                await saveDataToFirestore(newProductsColRef, id, data);
                showNotification('New product entry saved successfully!', 'success');
                closeModal('newProductModal');
                await updateLocalData(); // Refresh data and UI
            } catch (e) {
                // Error handled by saveDataToFirestore
            }
        }

        async function editNewProduct(id) {
            const item = newProductsData.find(p => p.id === id);
            if (item) {
                document.getElementById('newProductModalTitle').textContent = 'Edit New Product Entry';
                document.getElementById('editNewProductId').value = item.id;
                document.getElementById('newBrand').value = item.brand;
                document.getElementById('newProductSku').value = item.sku || ''; // Added SKU
                document.getElementById('newProductName').value = item.product;
                document.getElementById('arrivalDate').value = item.arrivalDate;
                document.getElementById('newProductQuantity').value = item.quantity;
                document.getElementById('notes').value = item.notes;
                populateBrandDropdowns('newBrand');
                filterProductsForBrand(item.brand, 'newProductName', 'newProductsDatalist');
                openModal('newProductModal');
            }
        }

        async function moveNewProductToMaster(id) {
            showConfirmModal('Are you sure you want to approve this new product and move it to Master List?', async (confirmed) => {
                if (confirmed) {
                    const item = newProductsData.find(p => p.id === id);
                    if (item) {
                        try {
                            // Add/Update in Master List
                            const masterProductExists = masterProductsData.find(mp => mp.sku === item.sku); // Check by SKU
                            const masterProductId = masterProductExists ? masterProductExists.id : null;
                            const masterProductData = {
                                brand: item.brand,
                                product: item.product,
                                sku: item.sku,
                                category: 'Uncategorized', // Default category for new
                                description: item.notes || '',
                                price: 0.00, // Default price for new
                                isDeleted: false
                            };
                            await saveDataToFirestore(masterProductsColRef, masterProductId, masterProductData);

                            // Add to Inventory
                            const inventoryProductData = {
                                brand: item.brand,
                                product: item.product,
                                sku: item.sku,
                                quantity: item.quantity,
                                status: 'In stock', // Default status when moving from new products
                                shipment: '',
                                remarks: 'Added from New Products',
                                isDeleted: false,
                                expiry: '' // Initialize expiry as empty
                            };
                            await saveDataToFirestore(inventoryColRef, null, inventoryProductData); // Create new inventory entry

                            // Mark as deleted in New Products
                            await saveDataToFirestore(newProductsColRef, item.id, { isDeleted: true });

                            showNotification('Product approved and moved to Master List and Inventory!', 'success');
                            await updateLocalData(); // Refresh all UI
                        } catch (e) {
                            console.error("Error moving new product to master:", e);
                            showNotification('Error moving product.', 'error');
                        }
                    }
                }
            });
        }

        async function mergeNewProductsToMaster() {
            showConfirmModal('Are you sure you want to merge ALL new products to Master List? This will mark them as approved and add to Inventory.', async (confirmed) => {
                if (confirmed) {
                    const batch = db.batch();
                    let successCount = 0;
                    let errorCount = 0;

                    for (const item of newProductsData) {
                        if (!item.isDeleted) {
                            try {
                                // Add/Update in Master List
                                const masterProductExists = masterProductsData.find(mp => mp.sku === item.sku);
                                const masterProductRef = masterProductExists ? masterProductsColRef.doc(masterProductExists.id) : masterProductsColRef.doc();
                                const masterProductData = {
                                    brand: item.brand,
                                    product: item.product,
                                    sku: item.sku,
                                    category: 'Uncategorized',
                                    description: item.notes || '',
                                    price: 0.00,
                                    isDeleted: false
                                };
                                batch.set(masterProductRef, masterProductData, { merge: true }); // Use merge: true to avoid overwriting existing fields if any

                                // Add to Inventory
                                const inventoryProductRef = inventoryColRef.doc();
                                const inventoryProductData = {
                                    brand: item.brand,
                                    product: item.product,
                                    sku: item.sku,
                                    quantity: item.quantity,
                                    status: 'In stock',
                                    shipment: '',
                                    remarks: 'Added from New Products (Batch Merge)',
                                    isDeleted: false,
                                    expiry: '' // Initialize expiry as empty
                                };
                                batch.set(inventoryProductRef, inventoryProductData);

                                // Mark as deleted in New Products
                                const newProductRef = newProductsColRef.doc(item.id);
                                batch.update(newProductRef, { isDeleted: true });
                                successCount++;
                            } catch (e) {
                                console.error(`Error processing new product ${item.id} for merge:`, e);
                                errorCount++;
                            }
                        }
                    }

                    if (successCount > 0) {
                        try {
                            await batch.commit();
                            showNotification(`Successfully merged ${successCount} new products.`, 'success');
                            await updateLocalData(); // Refresh all UI
                        } catch (e) {
                            console.error("Batch commit failed:", e);
                            showNotification('Error committing batch merge. Some products might not have been merged.', 'error');
                        }
                    } else {
                        showNotification('No new products to merge.', 'info');
                    }
                }
            });
        }

        function searchNewProducts(searchTerm) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            currentNewProductsViewData = newProductsData.filter(item =>
                (item.brand && item.brand.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.product && item.product.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.sku && item.sku.toLowerCase().includes(lowerCaseSearchTerm)) // Added SKU search
            );
            renderNewProductsItems();
        }

        // To Clear
        function renderToClearItems() {
            const tableBody = document.getElementById('to-clear-table');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            const sortedData = sortArray(currentToClearViewData, sortState.toClear.column, sortState.toClear.direction);

            sortedData.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.sku || '';
                row.insertCell().textContent = item.brand || '';
                row.insertCell().textContent = item.product || '';
                row.insertCell().textContent = item.category || '';
                row.insertCell().textContent = item.expiryDate || '';
                row.insertCell().textContent = item.firstHighlightedDate || '';
                row.insertCell().textContent = item.firstReportedBalance !== undefined ? item.firstReportedBalance : '';
                row.insertCell().textContent = item.warehouseQty !== undefined ? item.warehouseQty : '';
                row.insertCell().textContent = item.storeQty !== undefined ? item.storeQty : '';
                const totalQty = (item.warehouseQty || 0) + (item.storeQty || 0);
                row.insertCell().textContent = totalQty;
                row.insertCell().textContent = item.weeklyDemand !== undefined ? item.weeklyDemand : '';
                const weeksSupply = item.weeklyDemand > 0 ? (totalQty / item.weeklyDemand).toFixed(2) : 'N/A';
                row.insertCell().textContent = weeksSupply;
                const supplyStatusClass = getSupplyStatusClass(weeksSupply);
                row.insertCell().innerHTML = `<span class="status-badge ${supplyStatusClass}">${getSupplyStatusText(weeksSupply)}</span>`;
                row.insertCell().textContent = item.actionPlan || '';

                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn-info" onclick="editToClear('${item.id}')">✏️ Edit</button>
                    <button class="btn-danger" onclick="moveToRecycleBin('${item.id}', 'to_clear')">🗑️ Delete</button>
                `;
            });
        }

        function showAddToClearModal() {
            document.getElementById('toClearModalTitle').textContent = 'Add Product to Clear';
            document.getElementById('editToClearId').value = '';
            document.getElementById('toClearModal').querySelector('form').reset();
            document.getElementById('toClearFirstHighlightedDate').valueAsDate = new Date(); // Set today's date
            populateBrandDropdowns('toClearBrand');
            populateCategoryDropdowns('toClearCategory');
            openModal('toClearModal');
        }

        async function saveToClear(event) {
            event.preventDefault();
            const id = document.getElementById('editToClearId').value;
            const data = {
                brand: document.getElementById('toClearBrand').value,
                product: document.getElementById('toClearProductName').value,
                category: document.getElementById('toClearCategory').value,
                expiryDate: document.getElementById('toClearExpiryDate').value,
                firstHighlightedDate: document.getElementById('toClearFirstHighlightedDate').value,
                firstReportedBalance: parseInt(document.getElementById('toClearFirstReportedBalance').value || '0'), // Ensure number parsing
                warehouseQty: parseInt(document.getElementById('toClearWarehouseQty').value || '0'),
                storeQty: parseInt(document.getElementById('toClearStoreQty').value || '0'),
                weeklyDemand: parseInt(document.getElementById('toClearWeeklyDemand').value || '0'),
                actionPlan: document.getElementById('toClearActionPlan').value,
                sku: getSkuForProduct(document.getElementById('toClearBrand').value, document.getElementById('toClearProductName').value), // Get SKU
                isDeleted: false // Ensure this flag is set
            };

            try {
                await saveDataToFirestore(toClearColRef, id, data);
                showNotification('Product to clear saved successfully!', 'success');
                closeModal('toClearModal');
                await updateLocalData(); // Refresh data and UI
            } catch (e) {
                // Error handled by saveDataToFirestore
            }
        }

        async function editToClear(id) {
            const item = toClearData.find(p => p.id === id);
            if (item) {
                document.getElementById('toClearModalTitle').textContent = 'Edit Product to Clear';
                document.getElementById('editToClearId').value = item.id;
                document.getElementById('toClearBrand').value = item.brand;
                document.getElementById('toClearProductName').value = item.product;
                document.getElementById('toClearCategory').value = item.category;
                document.getElementById('toClearExpiryDate').value = item.expiryDate;
                document.getElementById('toClearFirstHighlightedDate').value = item.firstHighlightedDate;
                document.getElementById('toClearFirstReportedBalance').value = item.firstReportedBalance;
                document.getElementById('toClearWarehouseQty').value = item.warehouseQty;
                document.getElementById('toClearStoreQty').value = item.storeQty;
                document.getElementById('toClearWeeklyDemand').value = item.weeklyDemand;
                document.getElementById('toClearActionPlan').value = item.actionPlan;
                populateBrandDropdowns('toClearBrand');
                populateCategoryDropdowns('toClearCategory');
                filterProductsForBrand(item.brand, 'toClearProductName', 'toClearProductsDatalist');
                openModal('toClearModal');
            }
        }

        function searchToClear(searchTerm) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            currentToClearViewData = toClearData.filter(item =>
                (item.brand && item.brand.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.product && item.product.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.sku && item.sku.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.category && item.category.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.actionPlan && item.actionPlan.toLowerCase().includes(lowerCaseSearchTerm))
            );
            renderToClearItems();
        }

        // Helper to get SKU from master list
        function getSkuForProduct(brand, product) {
            const masterProduct = masterProductsData.find(item => item.brand === brand && item.product === product);
            return masterProduct ? masterProduct.sku : '';
        }

        function getSupplyStatusClass(weeksSupply) {
            if (weeksSupply === 'N/A') return 'info';
            const ws = parseFloat(weeksSupply);
            if (ws < 4) return 'danger-status';
            if (ws >= 4 && ws <= 8) return 'alert-status';
            return 'normal';
        }

        function getSupplyStatusText(weeksSupply) {
            if (weeksSupply === 'N/A') return 'N/A';
            const ws = parseFloat(weeksSupply);
            if (ws < 4) return 'Danger';
            if (ws >= 4 && ws <= 8) return 'Alert';
            return 'Normal';
        }


        // Master List
        function renderMasterListItems() {
            const tableBody = document.getElementById('master-table');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            const sortedData = sortArray(currentMasterListViewData, sortState.master.column, sortState.master.direction);

            sortedData.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.sku || '';
                row.insertCell().textContent = item.brand || '';
                row.insertCell().textContent = item.product || '';
                row.insertCell().textContent = item.category || '';
                row.insertCell().textContent = item.description || '';
                row.insertCell().textContent = item.price !== undefined ? parseFloat(item.price).toFixed(2) : '';

                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn-info" onclick="editMasterProduct('${item.id}')">✏️ Edit</button>
                    <button class="btn-danger" onclick="moveToRecycleBin('${item.id}', 'master_products')">🗑️ Delete</button>
                `;
            });
        }

        function showAddMasterProductModal() {
            document.getElementById('masterProductModalTitle').textContent = 'Add Master Product';
            document.getElementById('editMasterProductId').value = '';
            document.getElementById('masterProductModal').querySelector('form').reset();
            populateBrandDropdowns('masterBrand');
            populateCategoryDropdowns('category');
            openModal('masterProductModal');
        }

        async function saveMasterProduct(event) {
            event.preventDefault();
            const id = document.getElementById('editMasterProductId').value;
            const data = {
                brand: document.getElementById('masterBrand').value,
                product: document.getElementById('masterProductName').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                sku: document.getElementById('sku').value,
                price: parseFloat(document.getElementById('price').value || '0'),
                isDeleted: false // Ensure this flag is set
            };

            try {
                await saveDataToFirestore(masterProductsColRef, id, data);
                showNotification('Master product saved successfully!', 'success');
                closeModal('masterProductModal');
                await updateLocalData(); // Refresh data and UI
            } catch (e) {
                // Error handled by saveDataToFirestore
            }
        }

        async function editMasterProduct(id) {
            const item = masterProductsData.find(p => p.id === id);
            if (item) {
                document.getElementById('masterProductModalTitle').textContent = 'Edit Master Product';
                document.getElementById('editMasterProductId').value = item.id;
                document.getElementById('masterBrand').value = item.brand;
                document.getElementById('masterProductName').value = item.product;
                document.getElementById('category').value = item.category;
                document.getElementById('description').value = item.description;
                document.getElementById('sku').value = item.sku;
                document.getElementById('price').value = item.price;
                populateBrandDropdowns('masterBrand');
                populateCategoryDropdowns('category');
                openModal('masterProductModal');
            }
        }

        function searchMasterList(searchTerm) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            currentMasterListViewData = masterProductsData.filter(item =>
                (item.brand && item.brand.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.product && item.product.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.sku && item.sku.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.category && item.category.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.description && item.description.toLowerCase().includes(lowerCaseSearchTerm))
            );
            renderMasterListItems();
        }

        function exportMasterList() {
            const headers = ["Product Code", "Brand", "Product Name", "Category", "Description", "Price"];
            const rows = currentMasterListViewData.map(item => [
                item.sku || '',
                item.brand || '',
                item.product || '',
                item.category || '',
                item.description || '',
                item.price !== undefined ? parseFloat(item.price).toFixed(2) : ''
            ]);

            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',') + '\n';
            });

            downloadCSV(csvContent, 'master_list.csv');
            showNotification('Master list exported!', 'success');
        }

        // Recycle Bin
        function renderRecycleBinItems() {
            const tableBody = document.getElementById('recycle-bin-table');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            const sortedData = sortArray(currentRecycleBinViewData, sortState.recycleBin.column, sortState.recycleBin.direction);

            sortedData.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.sku || '';
                row.insertCell().textContent = item.originalCollection || '';
                row.insertCell().textContent = item.brand || '';
                row.insertCell().textContent = item.product || '';

                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn-success" onclick="restoreItem('${item.id}', '${item.originalCollection}')">↩️ Restore</button>
                    <button class="btn-danger" onclick="deleteItemPermanently('${item.id}', '${item.originalCollection}')">❌ Permanent Delete</button>
                `;
            });
        }

        async function moveToRecycleBin(id, collectionName) {
            showConfirmModal('Are you sure you want to move this item to Recycle Bin?', async (confirmed) => {
                if (confirmed) {
                    try {
                        const collectionRef = db.collection(collectionName);
                        await saveDataToFirestore(collectionRef, id, { isDeleted: true });
                        showNotification('Item moved to Recycle Bin!', 'success');
                        await updateLocalData(); // Refresh all UI
                    } catch (e) {
                        console.error(`Error moving item to recycle bin from ${collectionName}:`, e);
                        showNotification('Error moving item to Recycle Bin.', 'error');
                    }
                }
            });
        }

        async function restoreItem(id, originalCollection) {
            showConfirmModal('Are you sure you want to restore this item?', async (confirmed) => {
                if (confirmed) {
                    try {
                        const collectionRef = db.collection(originalCollection);
                        await saveDataToFirestore(collectionRef, id, { isDeleted: false });
                        showNotification('Item restored successfully!', 'success');
                        await updateLocalData(); // Refresh all UI
                    } catch (e) {
                        console.error(`Error restoring item to ${originalCollection}:`, e);
                        showNotification('Error restoring item.', 'error');
                    }
                }
            });
        }

        async function deleteItemPermanently(id, originalCollection) {
            showConfirmModal('WARNING: This will permanently delete this item. Are you sure?', async (confirmed) => {
                if (confirmed) {
                    try {
                        const collectionRef = db.collection(originalCollection);
                        await collectionRef.doc(id).delete();
                        showNotification('Item permanently deleted!', 'success');
                        await updateLocalData(); // Refresh all UI
                    } catch (e) {
                        console.error(`Error permanently deleting item from ${originalCollection}:`, e);
                        showNotification('Error permanently deleting item.', 'error');
                    }
                }
            });
        }

        async function emptyRecycleBin() {
            showConfirmModal('WARNING: This will permanently delete ALL items in the Recycle Bin. Are you sure?', async (confirmed) => {
                if (confirmed) {
                    const batch = db.batch();
                    let deleteCount = 0;
                    for (const item of deletedItemsData) {
                        try {
                            const collectionRef = db.collection(item.originalCollection);
                            batch.delete(collectionRef.doc(item.id));
                            deleteCount++;
                        } catch (e) {
                            console.error(`Error adding item ${item.id} to batch for permanent deletion:`, e);
                        }
                    }

                    if (deleteCount > 0) {
                        try {
                            await batch.commit();
                            showNotification(`Successfully deleted ${deleteCount} items permanently.`, 'success');
                            await updateLocalData(); // Refresh all UI
                        } catch (e) {
                            console.error("Batch commit for empty recycle bin failed:", e);
                            showNotification('Error emptying recycle bin. Some items might not have been deleted.', 'error');
                        }
                    } else {
                        showNotification('Recycle Bin is already empty.', 'info');
                    }
                }
            });
        }

        function searchRecycleBin(searchTerm) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            currentRecycleBinViewData = deletedItemsData.filter(item =>
                (item.brand && item.brand.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.product && item.product.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.sku && item.sku.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (item.originalCollection && item.originalCollection.toLowerCase().includes(lowerCaseSearchTerm))
            );
            renderRecycleBinItems();
        }

        // Management Tab Functions
        async function exportAllData() {
            const allCollections = {
                inventory: inventoryData.map(item => { const { id, isDeleted, ...rest } = item; return rest; }),
                new_products: newProductsData.map(item => { const { id, isDeleted, ...rest } = item; return rest; }),
                to_clear: toClearData.map(item => { const { id, isDeleted, ...rest } = item; return rest; }),
                master_products: masterProductsData.map(item => { const { id, isDeleted, ...rest } = item; return rest; }),
                brands: brandsData.map(item => { const { id, ...rest } = item; return rest; }),
                statuses: statusesData.map(item => { const { id, ...rest } = item; return rest; }),
                categories: categoriesData.map(item => { const { id, ...rest } = item; return rest; }),
                deleted_items: deletedItemsData.map(item => { const { id, isDeleted, ...rest } = item; return rest; }) // Keep originalCollection for deleted items
            };

            let zip = new JSZip();

            for (const collectionName in allCollections) {
                const data = allCollections[collectionName];
                if (data.length === 0) continue;

                // Dynamically get headers from the first item
                const headers = Object.keys(data[0]);
                let csvContent = headers.map(header => `"${String(header).replace(/"/g, '""')}"`).join(',') + '\n';
                data.forEach(item => {
                    const row = headers.map(header => {
                        const value = item[header];
                        return `"${String(value !== undefined ? value : '').replace(/"/g, '""')}"`;
                    }).join(',');
                    csvContent += row + '\n';
                });
                zip.file(`${collectionName}.csv`, csvContent);
            }

            try {
                const content = await zip.generateAsync({ type: "blob" });
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'all_inventory_data.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('All data exported as ZIP!', 'success');
            } catch (e) {
                console.error("Error generating zip file:", e);
                showNotification('Error exporting all data.', 'error');
            }
        }

        // For sample data loading
        async function loadSampleData() {
            showNotification('Loading sample data... This may take a moment.', 'info');
            const dataToLoad = [
                // Sample Inventory Data
                { brand: 'BrandX', product: 'Laptop Pro', sku: 'LX1001', quantity: 5, status: 'Low stock', expiry: '', shipment: 'SHP001', remarks: '', isDeleted: false },
                { brand: 'BrandY', product: 'Wireless Mouse', sku: 'WM2002', quantity: 0, status: 'OOS', expiry: '', shipment: 'SHP002', remarks: 'Awaiting restock', isDeleted: false },
                { brand: 'BrandX', product: 'Mechanical Keyboard', sku: 'MK3003', quantity: 20, status: 'In stock', expiry: '', shipment: 'SHP003', remarks: '', isDeleted: false },
                // Sample New Products Data
                { brand: 'BrandZ', product: 'Smart Speaker', sku: 'SS4004', arrivalDate: '2025-06-15', quantity: 50, notes: 'New model launch', addedDate: '2025-05-20', isDeleted: false },
                { brand: 'BrandA', product: 'Ergonomic Chair', sku: 'EC5005', arrivalDate: '2025-06-20', quantity: 15, notes: '', addedDate: '2025-05-25', isDeleted: false },
                // Sample To Clear Data
                { brand: 'BrandB', product: 'Old Stock Monitor', sku: 'OSM6006', category: 'Electronics', expiryDate: '2025-07-31', firstHighlightedDate: '2025-05-01', firstReportedBalance: 1000, warehouseQty: 10, storeQty: 5, weeklyDemand: 3, actionPlan: 'Promotional discount', isDeleted: false }, // Adjusted sample data for initial balance test
                { brand: 'BrandC', product: 'Demo Unit Tablet', sku: 'DUT7007', category: 'Electronics', expiryDate: '2025-08-30', firstHighlightedDate: '2025-05-10', firstReportedBalance: 3, warehouseQty: 1, storeQty: 2, weeklyDemand: 1, actionPlan: 'Clearance sale', isDeleted: false },
                // Sample Master Products Data
                { brand: 'BrandX', product: 'Laptop Pro', sku: 'LX1001', category: 'Electronics', description: 'High performance laptop', price: 1200.00, isDeleted: false },
                { brand: 'BrandY', product: 'Wireless Mouse', sku: 'WM2002', category: 'Accessories', description: 'Ergonomic wireless mouse', price: 25.00, isDeleted: false },
                { brand: 'BrandX', product: 'Mechanical Keyboard', sku: 'MK3003', category: 'Accessories', description: 'RGB Mechanical Keyboard', price: 80.00, isDeleted: false },
                { brand: 'BrandZ', product: 'Smart Speaker', sku: 'SS4004', category: 'Smart Home', description: 'Voice activated smart speaker', price: 99.00, isDeleted: false },
                { brand: 'BrandA', product: 'Ergonomic Chair', sku: 'EC5005', category: 'Office Furniture', description: 'Adjustable ergonomic office chair', price: 350.00, isDeleted: false },
                { brand: 'BrandB', product: 'Old Stock Monitor', sku: 'OSM6006', category: 'Electronics', description: '1080p LED Monitor', price: 150.00, isDeleted: false },
                { brand: 'BrandC', product: 'Demo Unit Tablet', sku: 'DUT7007', category: 'Electronics', description: 'Compact Android Tablet', price: 100.00, isDeleted: false },
                // Sample Brands
                { name: 'BrandX', isDeleted: false },
                { name: 'BrandY', isDeleted: false },
                { name: 'BrandZ', isDeleted: false },
                { name: 'BrandA', isDeleted: false },
                { name: 'BrandB', isDeleted: false },
                { name: 'BrandC', isDeleted: false },
                // Sample Statuses
                { name: 'OOS', isDeleted: false },
                { name: 'Low stock', isDeleted: false },
                { name: 'In stock', isDeleted: false },
                // Sample Categories
                { name: 'Electronics', isDeleted: false },
                { name: 'Accessories', isDeleted: false },
                { name: 'Smart Home', isDeleted: false },
                { name: 'Office Furniture', isDeleted: false }
            ];

            // Clear existing data in all collections
            const collectionsToClear = [
                inventoryColRef, newProductsColRef, toClearColRef, masterProductsColRef,
                brandsColRef, statusesColRef, categoriesColRef
            ];

            try {
                for (const colRef of collectionsToClear) {
                    const snapshot = await colRef.get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                }

                // Load sample data
                const batch = db.batch();
                dataToLoad.forEach(item => {
                    let collectionRef;
                    if (item.product && item.status) { // Heuristic for inventory
                        collectionRef = inventoryColRef;
                    } else if (item.product && item.arrivalDate) { // Heuristic for new products
                        collectionRef = newProductsColRef;
                    } else if (item.product && item.firstHighlightedDate) { // Heuristic for to clear
                        collectionRef = toClearColRef;
                    } else if (item.product && item.price) { // Heuristic for master products
                        collectionRef = masterProductsColRef;
                    } else if (item.name && !item.product && !item.status && !item.category) { // Heuristic for brands/statuses/categories
                        if (['BrandX', 'BrandY', 'BrandZ', 'BrandA', 'BrandB', 'BrandC'].includes(item.name)) {
                            collectionRef = brandsColRef;
                        } else if (['OOS', 'Low stock', 'In stock'].includes(item.name)) {
                            collectionRef = statusesColRef;
                        } else if (['Electronics', 'Accessories', 'Smart Home', 'Office Furniture'].includes(item.name)) {
                            collectionRef = categoriesColRef;
                        }
                    }
                    if (collectionRef) {
                        const docRef = collectionRef.doc(); // Auto-generate ID
                        batch.set(docRef, item);
                    }
                });
                await batch.commit();
                showNotification('Sample data loaded successfully!', 'success');
                await updateLocalData(); // Refresh all UI
            } catch (e) {
                console.error("Error loading sample data:", e);
                showNotification('Error loading sample data. Check console for details.', 'error');
            }
        }


        function confirmLoadSampleData() {
            showConfirmModal('WARNING: This will delete ALL existing data and load sample data. Are you sure?', async (confirmed) => {
                if (confirmed) {
                    await loadSampleData();
                }
            });
        }

        // Sorting
        function sortTable(tableKey, column) {
            const tableSortState = sortState[tableKey];
            if (tableSortState.column === column) {
                tableSortState.direction = tableSortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                tableSortState.column = column;
                tableSortState.direction = 'asc';
            }
            updateSortIndicators(tableKey);
            // Re-render the specific table with sorted data
            if (tableKey === 'inventory') {
                renderInventoryItems();
            } else if (tableKey === 'newProducts') {
                renderNewProductsItems();
            } else if (tableKey === 'master') {
                renderMasterListItems();
            } else if (tableKey === 'toClear') {
                renderToClearItems();
            } else if (tableKey === 'recycleBin') {
                renderRecycleBinItems();
            }
        }

        function sortArray(arr, column, direction) {
            if (!column) return arr; // No column to sort by

            return [...arr].sort((a, b) => {
                const valA = a[column];
                const valB = b[column];

                if (typeof valA === 'string' && typeof valB === 'string') {
                    return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return direction === 'asc' ? valA - valB : valB - valA;
                }
                // Fallback for mixed types or other cases
                if (valA === undefined || valA === null) return direction === 'asc' ? 1 : -1;
                if (valB === undefined || valB === null) return direction === 'asc' ? -1 : 1;
                return 0;
            });
        }

        function updateSortIndicators(tableKey) {
            const table = document.getElementById(`${tableKey}-table-container`);
            if (!table) return;

            const headers = table.querySelectorAll('th[data-column-key]');
            headers.forEach(header => {
                const arrowSpan = header.querySelector('.sort-arrow');
                if (arrowSpan) {
                    arrowSpan.textContent = ''; // Clear existing arrow
                }
                if (header.dataset.columnKey === sortState[tableKey].column) {
                    if (arrowSpan) {
                        arrowSpan.textContent = sortState[tableKey].direction === 'asc' ? ' ▲' : ' ▼';
                    }
                }
            });
        }

        // Dashboard Stats
        function updateDashboardStats() {
            document.getElementById('oos-count').textContent = inventoryData.filter(item => item.status === 'OOS' && !item.isDeleted).length;
            document.getElementById('low-count').textContent = inventoryData.filter(item => item.status.includes('Low stock') && !item.isDeleted).length;
            document.getElementById('new-count').textContent = newProductsData.filter(item => !item.isDeleted).length;
        }

        function updateAlerts() {
            const alertsDiv = document.getElementById('alerts');
            alertsDiv.innerHTML = '';
            const recentOOS = inventoryData.filter(item => item.status === 'OOS' && !item.isDeleted).slice(0, 5);
            const recentLowStock = inventoryData.filter(item => item.status.includes('Low stock') && !item.isDeleted).slice(0, 5);
            const expiringSoon = toClearData.filter(item => {
                if (item.expiryDate) {
                    const today = new Date();
                    const expiry = new Date(item.expiryDate);
                    const diffTime = expiry.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays <= 90 && diffDays >= 0 && !item.isDeleted; // Expiring within 90 days
                }
                return false;
            }).slice(0, 5);

            if (recentOOS.length > 0) {
                alertsDiv.innerHTML += '<h4>Out of Stock Items:</h4><ul>' +
                    recentOOS.map(item => `<li><span class="status-badge oos">OOS</span> ${item.product} (${item.brand})</li>`).join('') +
                    '</ul>';
            }
            if (recentLowStock.length > 0) {
                alertsDiv.innerHTML += '<h4>Low Stock Items:</h4><ul>' +
                    recentLowStock.map(item => `<li><span class="status-badge low">Low</span> ${item.product} (${item.brand}) - Qty: ${item.quantity}</li>`).join('') +
                    '</ul>';
            }
            if (expiringSoon.length > 0) {
                alertsDiv.innerHTML += '<h4>Expiring Soon Items:</h4><ul>' +
                    expiringSoon.map(item => `<li><span class="status-badge alert-status">Expiring</span> ${item.product} (${item.brand}) - Expiry: ${item.expiryDate}</li>`).join('') +
                    '</ul>';
            }
            if (recentOOS.length === 0 && recentLowStock.length === 0 && expiringSoon.length === 0) {
                alertsDiv.innerHTML = '<p>No immediate alerts.</p>';
            }
        }

        function updateManagementStats() {
            document.getElementById('total-products').textContent = masterProductsData.filter(item => !item.isDeleted).length;
            document.getElementById('total-products-all').textContent = masterProductsData.length + newProductsData.length + inventoryData.length + toClearData.length; // More comprehensive count
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        }

        // CSV Import/Export Helper
        function downloadCSV(csvContent, fileName) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                showNotification('Your browser does not support downloading files directly. Please copy the content.', 'error');
            }
        }

        // Basic CSV import - needs significant error handling and data mapping for production
        async function importCSV(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) {
                    showNotification('CSV file is empty or invalid.', 'error');
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const importData = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    if (values.length !== headers.length) {
                        console.warn(`Skipping row ${i + 1} due to column mismatch.`);
                        continue;
                    }
                    let item = {};
                    headers.forEach((header, index) => {
                        // Simple type conversion, needs more robust handling for dates/numbers
                        let value = values[index];
                        if (header === 'quantity' || header === 'price' || header === 'firstReportedBalance' || header === 'warehouseQty' || header === 'storeQty' || header === 'weeklyDemand') {
                            item[header] = parseFloat(value) || 0;
                        } else {
                            item[header] = value;
                        }
                    });
                    item.isDeleted = false; // Always import as not deleted
                    importData.push(item);
                }

                if (importData.length === 0) {
                    showNotification('No valid data found to import from CSV.', 'error');
                    return;
                }

                showConfirmModal(`Importing will add ${importData.length} items to Master List. Continue?`, async (confirmed) => {
                    if (confirmed) {
                        const batch = db.batch();
                        let importedCount = 0;
                        for (const item of importData) {
                            try {
                                // Assuming import is for master products
                                const existingProduct = masterProductsData.find(mp => mp.sku === item.sku);
                                const docRef = existingProduct ? masterProductsColRef.doc(existingProduct.id) : masterProductsColRef.doc();
                                batch.set(docRef, item, { merge: true }); // Merge to update existing or set new
                                importedCount++;
                            } catch (e) {
                                console.error("Error adding item to batch for import:", item, e);
                            }
                        }

                        if (importedCount > 0) {
                            try {
                                await batch.commit();
                                showNotification(`Successfully imported ${importedCount} items!`, 'success');
                                await updateLocalData(); // Refresh UI
                            } catch (e) {
                                console.error("Batch commit failed for import:", e);
                                showNotification('Error during CSV import batch commit.', 'error');
                            }
                        } else {
                            showNotification('No items were imported.', 'info');
                        }
                    }
                });
            };
            reader.readAsText(file);
        }

        // Initialize on load
        window.onload = async function() {
            await updateLocalData();
            const dashboardTab = document.querySelector('.tab[onclick*=\'dashboard\']');
            if (dashboardTab) {
                switchTab(dashboardTab, 'dashboard');
            } else {
                document.getElementById('dashboard').classList.add('active'); // Fallback
            }
            // Initialize sort indicators for all tables
            Object.keys(sortState).forEach(tableKey => updateSortIndicators(tableKey));
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</body>
</html>
