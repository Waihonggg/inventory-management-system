<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-radius: 15px;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
            overflow-x: auto;
            gap: 2px;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            background-color: transparent;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #7f8c8d;
            min-width: 120px;
            text-align: center;
            border: 2px solid transparent;
            border-bottom: none;
        }

        .tab:hover {
            background-color: #f8f9fa;
            color: #2c3e50;
            border-color: #e1e8ed;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.urgent {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .stat-card.good {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            line-height: 1;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 15px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e1e8ed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        th, td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .oos {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .low {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .normal {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .search-box {
            padding: 12px 16px;
            width: 280px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: none;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 600;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Inventory Management System</h1>
        <p class="subtitle">Professional Inventory Tracking & Management Solution</p>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</div>
            <div class="tab" onclick="switchTab('inventory')">üì¶ Inventory</div>
            <div class="tab" onclick="switchTab('new-products')">‚ú® New Products</div>
            <div class="tab" onclick="switchTab('to-clear')">üè∑Ô∏è To Clear</div>
            <div class="tab" onclick="switchTab('master-list')">üìã Master List</div>
            <div class="tab" onclick="switchTab('recycle-bin')">üóëÔ∏è Recycle Bin</div>
            <div class="tab" onclick="switchTab('management')">‚öôÔ∏è Management</div>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="stats-cards">
                <div class="stat-card urgent" onclick="showFilteredInventory('OOS')">
                    <div class="stat-number" id="oos-count">0</div>
                    <div class="stat-label">Out of Stock</div>
                </div>
                <div class="stat-card warning" onclick="showFilteredInventory('Low stock')">
                    <div class="stat-number" id="low-count">0</div>
                    <div class="stat-label">Low Stock</div>
                </div>
                <div class="stat-card good" onclick="showFilteredInventory('In Stock')">
                    <div class="stat-number" id="in-stock-count">0</div>
                    <div class="stat-label">In Stock</div>
                </div>
                <div class="stat-card info" onclick="switchTab('new-products')">
                    <div class="stat-number" id="new-count">0</div>
                    <div class="stat-label">New Products</div>
                </div>
            </div>

            <h3>Recent Alerts</h3>
            <div id="alerts" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                <p>Loading alerts...</p>
            </div>
        </div>

        <div id="inventory" class="tab-content">
            <div class="controls">
                <button onclick="showAddProductModal()">‚ûï Add Product</button>
                <input type="text" class="search-box" placeholder="üîç Search products..." onkeyup="searchInventory(this.value)">
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Brand</th>
                        <th>Product</th>
                        <th>Status</th>
                        <th>Expiry</th>
                        <th>Shipment</th>
                        <th>Remarks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventory-table">
                    </tbody>
            </table>
        </div>

        <div id="new-products" class="tab-content">
            <div class="controls">
                <button onclick="showAddNewProductModal()">‚ûï Add New Product</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Brand</th>
                        <th>Product</th>
                        <th>Added Date</th>
                        <th>Arrival Date</th>
                        <th>Quantity</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="new-products-table">
                    </tbody>
            </table>
        </div>

        <div id="to-clear" class="tab-content">
            <div class="controls">
                <button onclick="showAddToClearModal()">‚ûï Add Product to Clear</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Brand</th>
                        <th>Product</th>
                        <th>Category</th>
                        <th>Expiry Date</th>
                        <th>Total Qty</th>
                        <th>Weekly Demand</th>
                        <th>Action Plan</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="to-clear-table">
                    </tbody>
            </table>
        </div>

        <div id="master-list" class="tab-content">
            <div class="controls">
                <button onclick="showAddMasterProductModal()">‚ûï Add Product</button>
                <button onclick="exportMasterList()">üì• Export List</button>
                <button onclick="document.getElementById('csvFileInput').click()">üì§ Import CSV</button>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importCSV(event)">
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Brand</th>
                        <th>Product Name</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>SKU</th>
                        <th>Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="master-table">
                    </tbody>
            </table>
        </div>

        <div id="recycle-bin" class="tab-content">
            <div class="controls">
                <h3>Recycle Bin</h3>
                <button class="btn-danger" onclick="emptyRecycleBin()">üóëÔ∏è Empty Recycle Bin</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Original Tab</th>
                        <th>Brand</th>
                        <th>Product</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recycle-bin-table">
                    </tbody>
            </table>
        </div>

        <div id="management" class="tab-content">
            <div class="controls">
                <button onclick="exportAllData()">üì• Export All Data</button>
                <button onclick="loadSampleDataWrapper()">üìä Load Sample Data</button>
            </div>

            <h3>System Information</h3>
            <p>Total Products (active): <span id="total-products">0</span></p>
            <p>Total Products (including deleted): <span id="total-products-all">0</span></p>
            <p>Last Synced: <span id="last-updated">Never</span></p>
        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('productModal')">&times;</span>
            <h2 id="productModalTitle">Add New Product</h2>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="editProductId" value="">
                <div class="form-group">
                    <label>Brand:</label>
                    <select id="brand" required>
                        <option value="">Select Brand</option>
                        <option value="Greenlife">Greenlife</option>
                        <option value="NN">Nordic Naturals</option>
                        <option value="NaturesPlus">NaturesPlus</option>
                        <option value="ENZYMEDICA">ENZYMEDICA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Product Name:</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>Status:</label>
                    <select id="status" required>
                        <option value="">Select Status</option>
                        <option value="OOS">Out of Stock</option>
                        <option value="Low stock">Low Stock</option>
                        <option value="In Stock">In Stock</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Expiry Date:</label>
                    <input type="date" id="expiry">
                </div>
                <div class="form-group">
                    <label>Estimated Shipment:</label>
                    <input type="date" id="shipment">
                </div>
                <div class="form-group">
                    <label>Remarks:</label>
                    <textarea id="remarks"></textarea>
                </div>
                <button type="submit">Save Product</button>
            </form>
        </div>
    </div>

    <div id="newProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('newProductModal')">&times;</span>
            <h2 id="newProductModalTitle">Add New Product</h2>
            <form onsubmit="saveNewProduct(event)">
                <input type="hidden" id="editNewProductId" value="">
                <div class="form-group">
                    <label>Brand:</label>
                    <select id="newBrand" required>
                        <option value="">Select Brand</option>
                        <option value="Greenlife">Greenlife</option>
                        <option value="NN">Nordic Naturals</option>
                        <option value="NaturesPlus">NaturesPlus</option>
                        <option value="ENZYMEDICA">ENZYMEDICA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Product Name:</label>
                    <input type="text" id="newProductName" required>
                </div>
                <div class="form-group">
                    <label>Quantity:</label>
                    <input type="number" id="quantity" required min="1">
                </div>
                <div class="form-group">
                    <label>Arrival Date:</label>
                    <input type="date" id="arrivalDate">
                </div>
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea id="notes"></textarea>
                </div>
                <button type="submit">Save New Product</button>
            </form>
        </div>
    </div>

    <div id="masterProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('masterProductModal')">&times;</span>
            <h2 id="masterProductModalTitle">Add Master Product</h2>
            <form onsubmit="saveMasterProduct(event)">
                <input type="hidden" id="editMasterProductId" value="">
                <div class="form-group">
                    <label>Brand:</label>
                    <select id="masterBrand" required>
                        <option value="">Select Brand</option>
                        <option value="Greenlife">Greenlife</option>
                        <option value="NN">Nordic Naturals</option>
                        <option value="NaturesPlus">NaturesPlus</option>
                        <option value="ENZYMEDICA">ENZYMEDICA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Product Name:</label>
                    <input type="text" id="masterProductName" required>
                </div>
                <div class="form-group">
                    <label>Category:</label>
                    <select id="category" required>
                        <option value="">Select Category</option>
                        <option value="Vitamins">Vitamins</option>
                        <option value="Probiotics">Probiotics</option>
                        <option value="Joint Support">Joint Support</option>
                        <option value="Digestive Health">Digestive Health</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="description"></textarea>
                </div>
                <div class="form-group">
                    <label>SKU:</label>
                    <input type="text" id="sku">
                </div>
                <div class="form-group">
                    <label>Price:</label>
                    <input type="number" id="price" step="0.01" min="0">
                </div>
                <button type="submit">Save Master Product</button>
            </form>
        </div>
    </div>

    <div id="toClearModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('toClearModal')">&times;</span>
            <h2 id="toClearModalTitle">Add Product to Clear</h2>
            <form onsubmit="saveToClear(event)">
                <input type="hidden" id="editToClearId" value="">
                <div class="form-group">
                    <label>Brand:</label>
                    <select id="toClearBrand" required>
                        <option value="">Select Brand</option>
                        <option value="Greenlife">Greenlife</option>
                        <option value="NN">Nordic Naturals</option>
                        <option value="NaturesPlus">NaturesPlus</option>
                        <option value="ENZYMEDICA">ENZYMEDICA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Product Name:</label>
                    <input type="text" id="toClearProductName" required>
                </div>
                <div class="form-group">
                    <label>Category:</label>
                    <select id="toClearCategory" required>
                        <option value="">Select Category</option>
                        <option value="Short Expiry">Short Expiry</option>
                        <option value="Excess Stock">Excess Stock</option>
                        <option value="Discontinued">Discontinued</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Expiry Date:</label>
                    <input type="date" id="toClearExpiryDate" required>
                </div>
                <div class="form-group">
                    <label>Total Quantity:</label>
                    <input type="number" id="toClearTotalQty" required min="1">
                </div>
                <div class="form-group">
                    <label>Weekly Demand:</label>
                    <input type="number" id="toClearWeeklyDemand" step="0.1" min="0" required>
                </div>
                <div class="form-group">
                    <label>Action Plan:</label>
                    <textarea id="toClearActionPlan" required></textarea>
                </div>
                <button type="submit">Save Product</button>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <script>
        // Your Firebase project configuration
        // REPLACE WITH YOUR ACTUAL FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID", // e.g., "inventory-c3bac"
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Data storage (will be populated from Firestore)
        let inventoryData = [];
        let newProductsData = [];
        let toClearData = [];
        let masterProductsData = [];
        let deletedItemsData = []; // For the Recycle Bin

        // Helper function to show notifications
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Load sample data into Firestore if collections are empty
        async function loadSampleDataWrapper() {
            if (!confirm('This will load sample data. If data already exists, it will not be overwritten. Continue?')) {
                return;
            }

            const collections = ['inventory', 'new_products', 'to_clear', 'master_products'];
            let shouldLoad = false;

            // Check if any collections are empty
            for (const colName of collections) {
                const snapshot = await db.collection(colName).limit(1).get();
                if (snapshot.empty) {
                    shouldLoad = true;
                    break;
                }
            }

            if (!shouldLoad) {
                showNotification('Data already exists in Firestore. Not loading sample data.', 'info');
                return;
            }

            // Sample data definition (now with isDeleted: false)
            const sampleInventory = [
                { id: 'GL001', brand: "Greenlife", product: "ENZ PEARLS ACIDOPHILUS", status: "OOS", expiry: "", shipment: "", remarks: "", isDeleted: false },
                { id: 'GL002', brand: "Greenlife", product: "GL VIT C + ZINC", status: "OOS", expiry: "", shipment: "", remarks: "", isDeleted: false },
                { id: 'NN001', brand: "NN", product: "NORDIC KIDS VIT C GUM 60'S", status: "Low stock", expiry: "", shipment: "", remarks: "", isDeleted: false },
                { id: 'ENZ001', brand: "ENZYMEDICA", product: "DIGEST + PROBIOTICS 30'S", status: "In Stock", expiry: "", shipment: "", remarks: "", isDeleted: false }
            ];

            const sampleNewProducts = [
                { id: 'GLNP01', brand: "Greenlife", product: "GL SUPER PROBIOTIC", addedDate: "2024-01-15", arrivalDate: "2024-02-01", quantity: 60, notes: "New formula", isDeleted: false },
                { id: 'NNNP02', brand: "NN", product: "NORDIC OMEGA FOCUS", addedDate: "2024-01-20", arrivalDate: "2024-02-15", quantity: 48, notes: "Cognitive support", isDeleted: false }
            ];

            const sampleToClear = [
                { id: 'GLTC01', brand: "Greenlife", product: "GL VITAMIN B COMPLEX", category: "Short Expiry", expiryDate: "2024-03-15", totalQty: 24, weeklyDemand: 3.5, actionPlan: "20% discount promotion", isDeleted: false },
                { id: 'NNTC02', brand: "NN", product: "VITAMIN C GUMMIES", category: "Discontinued", expiryDate: "2024-12-10", totalQty: 18, weeklyDemand: 2.0, actionPlan: "Clear with 30% discount", isDeleted: false }
            ];

            const sampleMasterProducts = [
                { id: 'GLMP01', brand: "Greenlife", product: "ENZ PEARLS ACIDOPHILUS", category: "Probiotics", description: "Probiotic supplement", sku: "GL001", price: 18.50, isDeleted: false },
                { id: 'GLMP02', brand: "Greenlife", product: "GL VIT C + ZINC", category: "Vitamins", description: "Immune support", sku: "GL002", price: 15.99, isDeleted: false },
                { id: 'NNMP01', brand: "NN", product: "NORDIC KIDS VIT C GUM", category: "Vitamins", description: "Kids vitamin C", sku: "NN001", price: 12.50, isDeleted: false },
                { id: 'ENZMP01', brand: "ENZYMEDICA", product: "DIGEST + PROBIOTICS", category: "Digestive Health", description: "Digestive enzymes", sku: "ENZ001", price: 28.50, isDeleted: false }
            ];

            try {
                // Add sample inventory
                for (const item of sampleInventory) {
                    await db.collection('inventory').add(item);
                }
                // Add sample new products
                for (const item of sampleNewProducts) {
                    await db.collection('new_products').add(item);
                }
                // Add sample to clear
                for (const item of sampleToClear) {
                    await db.collection('to_clear').add(item);
                }
                // Add sample master products
                for (const item of sampleMasterProducts) {
                    await db.collection('master_products').add(item);
                }

                showNotification('Sample data loaded to Firestore successfully!');
                await updateLocalData(); // Refresh data from Firestore
            } catch (error) {
                console.error("Error loading sample data to Firestore:", error);
                showNotification('Error loading sample data. Check console for details.', 'error');
            }
        }

        // Fetch data from Firestore
        async function fetchDataFromFirestore(collectionName) {
            try {
                const snapshot = await db.collection(collectionName).get();
                const data = [];
                snapshot.forEach(doc => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                return data;
            } catch (error) {
                console.error(`Error fetching data from ${collectionName}:`, error);
                showNotification(`Error loading data from server for ${collectionName}.`, 'error');
                return [];
            }
        }

        // Save data to Firestore
        async function saveDataToFirestore(collectionName, docId, data) {
            try {
                if (docId) {
                    await db.collection(collectionName).doc(docId).update(data);
                } else {
                    const docRef = await db.collection(collectionName).add(data);
                    return docRef.id; // Return the new document ID
                }
                return docId; // Return original docId for updates
            } catch (error) {
                console.error(`Error saving data to ${collectionName}:`, error);
                showNotification(`Error saving data to server for ${collectionName}.`, 'error');
                throw error; // Propagate error for calling functions to handle
            }
        }

        // Update local data from Firestore and then refresh tables
        async function updateLocalData() {
            inventoryData = (await fetchDataFromFirestore('inventory')).filter(item => !item.isDeleted);
            newProductsData = (await fetchDataFromFirestore('new_products')).filter(item => !item.isDeleted);
            toClearData = (await fetchDataFromFirestore('to_clear')).filter(item => !item.isDeleted);
            masterProductsData = (await fetchDataFromFirestore('master_products')).filter(item => !item.isDeleted);
            
            // Get all deleted items for the Recycle Bin
            const allCollections = ['inventory', 'new_products', 'to_clear', 'master_products'];
            deletedItemsData = [];
            for (const col of allCollections) {
                const items = await fetchDataFromFirestore(col);
                items.filter(item => item.isDeleted)
                     .forEach(item => deletedItemsData.push({ ...item, originalCollection: col }));
            }

            updateAllTables();
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => tab.classList.remove('active'));

            // Remove active class from all tab buttons
            const allTabButtons = document.querySelectorAll('.tab');
            allTabButtons.forEach(btn => btn.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName).classList.add('active');

            // Add active class to the corresponding tab button
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(btn => {
                if (btn.textContent.toLowerCase().includes(tabName.replace('-', ' ').replace('recycle-bin', 'recycle bin'))) {
                    btn.classList.add('active');
                }
            });

            // Update data when switching tabs (ensures latest data is shown)
            updateAllTables();
        }

        // Show filtered inventory from dashboard
        function showFilteredInventory(status) {
            switchTab('inventory'); // Switch to inventory tab

            const tbody = document.getElementById('inventory-table');
            tbody.innerHTML = '';

            const filtered = inventoryData.filter(item => item.status === status);

            filtered.forEach(item => {
                const row = tbody.insertRow();
                let statusClass = '';
                if (item.status === 'OOS') statusClass = 'oos';
                else if (item.status.includes('Low')) statusClass = 'low';
                else statusClass = 'normal';

                row.innerHTML = `
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td><span class="status-badge ${statusClass}">${item.status || ''}</span></td>
                    <td>${item.expiry || 'N/A'}</td>
                    <td>${item.shipment || 'TBD'}</td>
                    <td>${item.remarks || '-'}</td>
                    <td>
                        <button onclick="editProduct('${item.id}')">Edit</button>
                        <button class="btn-danger" onclick="softDeleteProduct('${item.id}')">Delete</button>
                    </td>
                `;
            });
        }

        // Update all tables
        function updateAllTables() {
            updateInventoryTable();
            updateNewProductsTable();
            updateToClearTable();
            updateMasterTable();
            updateRecycleBinTable(); // New: update recycle bin
            updateDashboard();
        }

        // Update inventory table
        function updateInventoryTable() {
            const tbody = document.getElementById('inventory-table');
            tbody.innerHTML = '';

            inventoryData.forEach(item => {
                const row = tbody.insertRow();
                let statusClass = '';
                if (item.status === 'OOS') statusClass = 'oos';
                else if (item.status && item.status.includes('Low')) statusClass = 'low';
                else statusClass = 'normal';

                row.innerHTML = `
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td><span class="status-badge ${statusClass}">${item.status || ''}</span></td>
                    <td>${item.expiry || 'N/A'}</td>
                    <td>${item.shipment || 'TBD'}</td>
                    <td>${item.remarks || '-'}</td>
                    <td>
                        <button onclick="editProduct('${item.id}')">Edit</button>
                        <button class="btn-danger" onclick="softDeleteProduct('${item.id}')">Delete</button>
                    </td>
                `;
            });
        }

        // Update new products table
        function updateNewProductsTable() {
            const tbody = document.getElementById('new-products-table');
            tbody.innerHTML = '';

            newProductsData.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td>${item.addedDate || ''}</td>
                    <td>${item.arrivalDate || 'TBD'}</td>
                    <td>${item.quantity || ''}</td>
                    <td>${item.notes || '-'}</td>
                    <td>
                        <button onclick="editNewProduct('${item.id}')">Edit</button>
                        <button class="btn-danger" onclick="softDeleteNewProduct('${item.id}')">Delete</button>
                    </td>
                `;
            });
        }

        // Update to clear table
        function updateToClearTable() {
            const tbody = document.getElementById('to-clear-table');
            tbody.innerHTML = '';

            toClearData.forEach(item => {
                const row = tbody.insertRow();
                let categoryClass = '';
                if (item.category === 'Short Expiry') categoryClass = 'oos';
                else if (item.category === 'Excess Stock') categoryClass = 'low';
                else categoryClass = 'normal';

                row.innerHTML = `
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td><span class="status-badge ${categoryClass}">${item.category || ''}</span></td>
                    <td>${item.expiryDate || ''}</td>
                    <td>${item.totalQty || ''}</td>
                    <td>${item.weeklyDemand || ''}</td>
                    <td>${item.actionPlan || ''}</td>
                    <td>
                        <button onclick="editToClear('${item.id}')">Edit</button>
                        <button class="btn-danger" onclick="softDeleteToClear('${item.id}')">Delete</button>
                    </td>
                `;
            });
        }

        // Update master table
        function updateMasterTable() {
            const tbody = document.getElementById('master-table');
            tbody.innerHTML = '';

            masterProductsData.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td>${item.category || ''}</td>
                    <td>${item.description || '-'}</td>
                    <td>${item.sku || '-'}</td>
                    <td>$${item.price ? item.price.toFixed(2) : '0.00'}</td>
                    <td>
                        <button onclick="editMasterProduct('${item.id}')">Edit</button>
                        <button class="btn-danger" onclick="softDeleteMasterProduct('${item.id}')">Delete</button>
                    </td>
                `;
            });
        }

        // New: Update Recycle Bin table
        function updateRecycleBinTable() {
            const tbody = document.getElementById('recycle-bin-table');
            tbody.innerHTML = '';

            deletedItemsData.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.originalCollection.replace('_', ' ').replace(/\b\w/g, char => char.toUpperCase())}</td>
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td>
                        <button class="btn-info" onclick="restoreItem('${item.id}', '${item.originalCollection}')">Restore</button>
                        <button class="btn-danger" onclick="hardDeleteItem('${item.id}', '${item.originalCollection}')">Permanently Delete</button>
                    </td>
                `;
            });
        }

        // Update dashboard
        function updateDashboard() {
            const oosCount = inventoryData.filter(item => item.status === 'OOS').length;
            const lowCount = inventoryData.filter(item => item.status && item.status.includes('Low')).length;
            const inStockCount = inventoryData.filter(item => item.status === 'In Stock').length;
            const newCount = newProductsData.length;

            document.getElementById('oos-count').textContent = oosCount;
            document.getElementById('low-count').textContent = lowCount;
            document.getElementById('in-stock-count').textContent = inStockCount;
            document.getElementById('new-count').textContent = newCount;

            // Update alerts
            const alertsDiv = document.getElementById('alerts');
            let alertsHTML = '';

            if (oosCount > 0) {
                alertsHTML += `<div style="padding: 10px; margin: 5px 0; background: #ffebee; border-left: 4px solid #e74c3c; border-radius: 5px;">
                    üö® ${oosCount} products are out of stock!</div>`;
            }
            if (lowCount > 0) {
                alertsHTML += `<div style="padding: 10px; margin: 5px 0; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 5px;">
                    ‚ö†Ô∏è ${lowCount} products are low in stock!</div>`;
            }
            if (alertsHTML === '') {
                alertsHTML = '<p style="color: #2ecc71;">‚úÖ No urgent alerts at this time</p>';
            }
            alertsDiv.innerHTML = alertsHTML;

            // Update last updated time and total products
            const allItems = [
                ...inventoryData,
                ...newProductsData,
                ...toClearData,
                ...masterProductsData,
                ...deletedItemsData
            ];
            const uniqueItems = new Set(allItems.map(item => item.id)); // Count unique IDs

            document.getElementById('last-updated').textContent = new Date().toLocaleString();
            document.getElementById('total-products').textContent = (inventoryData.length + newProductsData.length + toClearData.length + masterProductsData.length).toString();
            document.getElementById('total-products-all').textContent = uniqueItems.size;
        }

        // Modal functions
        function showAddProductModal() {
            document.getElementById('editProductId').value = '';
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('productModal').style.display = 'block';
            document.getElementById('productModal').querySelector('form').reset();
        }

        function showAddNewProductModal() {
            document.getElementById('editNewProductId').value = '';
            document.getElementById('newProductModalTitle').textContent = 'Add New Product';
            document.getElementById('newProductModal').style.display = 'block';
            document.getElementById('newProductModal').querySelector('form').reset();
        }

        function showAddMasterProductModal() {
            document.getElementById('editMasterProductId').value = '';
            document.getElementById('masterProductModalTitle').textContent = 'Add Master Product';
            document.getElementById('masterProductModal').style.display = 'block';
            document.getElementById('masterProductModal').querySelector('form').reset();
        }

        function showAddToClearModal() {
            document.getElementById('editToClearId').value = '';
            document.getElementById('toClearModalTitle').textContent = 'Add Product to Clear';
            document.getElementById('toClearModal').style.display = 'block';
            document.getElementById('toClearModal').querySelector('form').reset();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Save functions (now interacting with Firestore)
        async function saveProduct(event) {
            event.preventDefault();

            const editId = document.getElementById('editProductId').value;
            const productData = {
                brand: document.getElementById('brand').value,
                product: document.getElementById('productName').value,
                status: document.getElementById('status').value,
                expiry: document.getElementById('expiry').value,
                shipment: document.getElementById('shipment').value,
                remarks: document.getElementById('remarks').value,
                isDeleted: false // Ensure new/edited items are not marked deleted
            };

            try {
                await saveDataToFirestore('inventory', editId, productData);
                showNotification(editId ? 'Product updated successfully!' : 'Product added successfully!');
                closeModal('productModal');
                event.target.reset();
                await updateLocalData(); // Refresh data from Firestore
            } catch (error) {
                // Error handled by saveDataToFirestore notification
            }
        }

        async function saveNewProduct(event) {
            event.preventDefault();

            const editId = document.getElementById('editNewProductId').value;
            const productData = {
                brand: document.getElementById('newBrand').value,
                product: document.getElementById('newProductName').value,
                quantity: document.getElementById('quantity').value,
                arrivalDate: document.getElementById('arrivalDate').value,
                notes: document.getElementById('notes').value,
                addedDate: editId ? (newProductsData.find(item => item.id === editId)?.addedDate || new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0],
                isDeleted: false
            };

            try {
                await saveDataToFirestore('new_products', editId, productData);
                showNotification(editId ? 'Product updated successfully!' : 'New product added successfully!');
                closeModal('newProductModal');
                event.target.reset();
                await updateLocalData();
            } catch (error) {
                // Error handled
            }
        }

        async function saveMasterProduct(event) {
            event.preventDefault();

            const editId = document.getElementById('editMasterProductId').value;
            const productData = {
                brand: document.getElementById('masterBrand').value,
                product: document.getElementById('masterProductName').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                sku: document.getElementById('sku').value,
                price: parseFloat(document.getElementById('price').value) || 0,
                isDeleted: false
            };

            try {
                await saveDataToFirestore('master_products', editId, productData);
                showNotification(editId ? 'Product updated successfully!' : 'Master product added successfully!');
                closeModal('masterProductModal');
                event.target.reset();
                await updateLocalData();
            } catch (error) {
                // Error handled
            }
        }

        async function saveToClear(event) {
            event.preventDefault();

            const editId = document.getElementById('editToClearId').value;
            const productData = {
                brand: document.getElementById('toClearBrand').value,
                product: document.getElementById('toClearProductName').value,
                category: document.getElementById('toClearCategory').value,
                expiryDate: document.getElementById('toClearExpiryDate').value,
                totalQty: parseInt(document.getElementById('toClearTotalQty').value),
                weeklyDemand: parseFloat(document.getElementById('toClearWeeklyDemand').value),
                actionPlan: document.getElementById('toClearActionPlan').value,
                isDeleted: false
            };

            try {
                await saveDataToFirestore('to_clear', editId, productData);
                showNotification(editId ? 'Product updated successfully!' : 'Product added to clear list!');
                closeModal('toClearModal');
                event.target.reset();
                await updateLocalData();
            } catch (error) {
                // Error handled
            }
        }

        // Soft Delete functions (mark as isDeleted: true)
        async function softDeleteProduct(id) {
            if (confirm('Are you sure you want to move this product to the Recycle Bin?')) {
                try {
                    await saveDataToFirestore('inventory', id, { isDeleted: true });
                    showNotification('Product moved to Recycle Bin!');
                    await updateLocalData(); // Refresh data
                } catch (error) {
                    showNotification('Error moving product to Recycle Bin.', 'error');
                }
            }
        }

        async function softDeleteNewProduct(id) {
            if (confirm('Are you sure you want to move this new product to the Recycle Bin?')) {
                try {
                    await saveDataToFirestore('new_products', id, { isDeleted: true });
                    showNotification('New product moved to Recycle Bin!');
                    await updateLocalData();
                } catch (error) {
                    showNotification('Error moving product to Recycle Bin.', 'error');
                }
            }
        }

        async function softDeleteMasterProduct(id) {
            if (confirm('Are you sure you want to move this master product to the Recycle Bin?')) {
                try {
                    await saveDataToFirestore('master_products', id, { isDeleted: true });
                    showNotification('Master product moved to Recycle Bin!');
                    await updateLocalData();
                } catch (error) {
                    showNotification('Error moving product to Recycle Bin.', 'error');
                }
            }
        }

        async function softDeleteToClear(id) {
            if (confirm('Are you sure you want to move this "To Clear" product to the Recycle Bin?')) {
                try {
                    await saveDataToFirestore('to_clear', id, { isDeleted: true });
                    showNotification('"To Clear" product moved to Recycle Bin!');
                    await updateLocalData();
                } catch (error) {
                    showNotification('Error moving product to Recycle Bin.', 'error');
                }
            }
        }
        
        // Restore from Recycle Bin (set isDeleted: false)
        async function restoreItem(id, originalCollection) {
            if (confirm('Are you sure you want to restore this item? It will return to its original tab.')) {
                try {
                    await saveDataToFirestore(originalCollection, id, { isDeleted: false });
                    showNotification('Item restored successfully!');
                    await updateLocalData(); // Refresh data
                } catch (error) {
                    showNotification('Error restoring item.', 'error');
                }
            }
        }

        // Hard Delete from Recycle Bin (permanently delete from Firestore)
        async function hardDeleteItem(id, originalCollection) {
            if (confirm('WARNING: Are you sure you want to PERMANENTLY delete this item? This action cannot be undone.')) {
                try {
                    await db.collection(originalCollection).doc(id).delete();
                    showNotification('Item permanently deleted!');
                    await updateLocalData(); // Refresh data
                } catch (error) {
                    console.error("Error permanently deleting document:", error);
                    showNotification('Error permanently deleting item.', 'error');
                }
            }
        }

        // Empty Recycle Bin (permanently delete all deleted items)
        async function emptyRecycleBin() {
            if (confirm('WARNING: Are you sure you want to PERMANENTLY delete ALL items in the Recycle Bin? This action cannot be undone.')) {
                try {
                    const batch = db.batch();
                    deletedItemsData.forEach(item => {
                        const docRef = db.collection(item.originalCollection).doc(item.id);
                        batch.delete(docRef);
                    });
                    await batch.commit();
                    showNotification('Recycle Bin emptied successfully!');
                    await updateLocalData(); // Refresh data
                } catch (error) {
                    console.error("Error emptying Recycle Bin:", error);
                    showNotification('Error emptying Recycle Bin.', 'error');
                }
            }
        }


        // Edit functions
        function editProduct(id) {
            const product = inventoryData.find(item => item.id === id);
            if (product) {
                document.getElementById('editProductId').value = product.id;
                document.getElementById('productModalTitle').textContent = 'Edit Product';
                document.getElementById('brand').value = product.brand || '';
                document.getElementById('productName').value = product.product || '';
                document.getElementById('status').value = product.status || '';
                document.getElementById('expiry').value = product.expiry || '';
                document.getElementById('shipment').value = product.shipment || '';
                document.getElementById('remarks').value = product.remarks || '';
                document.getElementById('productModal').style.display = 'block';
            }
        }

        function editNewProduct(id) {
            const product = newProductsData.find(item => item.id === id);
            if (product) {
                document.getElementById('editNewProductId').value = product.id;
                document.getElementById('newProductModalTitle').textContent = 'Edit New Product';
                document.getElementById('newBrand').value = product.brand || '';
                document.getElementById('newProductName').value = product.product || '';
                document.getElementById('quantity').value = product.quantity || '';
                document.getElementById('arrivalDate').value = product.arrivalDate || '';
                document.getElementById('notes').value = product.notes || '';
                document.getElementById('newProductModal').style.display = 'block';
            }
        }

        function editMasterProduct(id) {
            const product = masterProductsData.find(item => item.id === id);
            if (product) {
                document.getElementById('editMasterProductId').value = product.id;
                document.getElementById('masterProductModalTitle').textContent = 'Edit Master Product';
                document.getElementById('masterBrand').value = product.brand || '';
                document.getElementById('masterProductName').value = product.product || '';
                document.getElementById('category').value = product.category || '';
                document.getElementById('description').value = product.description || '';
                document.getElementById('sku').value = product.sku || '';
                document.getElementById('price').value = product.price || '';
                document.getElementById('masterProductModal').style.display = 'block';
            }
        }

        function editToClear(id) {
            const product = toClearData.find(item => item.id === id);
            if (product) {
                document.getElementById('editToClearId').value = product.id;
                document.getElementById('toClearModalTitle').textContent = 'Edit Product to Clear';
                document.getElementById('toClearBrand').value = product.brand || '';
                document.getElementById('toClearProductName').value = product.product || '';
                document.getElementById('toClearCategory').value = product.category || '';
                document.getElementById('toClearExpiryDate').value = product.expiryDate || '';
                document.getElementById('toClearTotalQty').value = product.totalQty || '';
                document.getElementById('toClearWeeklyDemand').value = product.weeklyDemand || '';
                document.getElementById('toClearActionPlan').value = product.actionPlan || '';
                document.getElementById('toClearModal').style.display = 'block';
            }
        }

        // Search function
        function searchInventory(searchTerm) {
            const tbody = document.getElementById('inventory-table');
            tbody.innerHTML = '';

            const filtered = inventoryData.filter(item =>
                (item.product && item.product.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (item.brand && item.brand.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            filtered.forEach(item => {
                const row = tbody.insertRow();
                let statusClass = '';
                if (item.status === 'OOS') statusClass = 'oos';
                else if (item.status && item.status.includes('Low')) statusClass = 'low';
                else statusClass = 'normal';

                row.innerHTML = `
                    <td>${item.brand || ''}</td>
                    <td>${item.product || ''}</td>
                    <td><span class="status-badge ${statusClass}">${item.status || ''}</span></td>
                    <td>${item.expiry || 'N/A'}</td>
                    <td>${item.shipment || 'TBD'}</td>
                    <td>${item.remarks || '-'}</td>
                    <td>
                        <button onclick="editProduct('${item.id}')">Edit</button>
                        <button class="btn-danger" onclick="softDeleteProduct('${item.id}')">Delete</button>
                    </td>
                `;
            });
        }

        // Export and Import functions (now exporting/importing from/to local data arrays which are synced with Firestore)
        function exportAllData() {
            let csvContent = "data:text/csv;charset=utf-8,";

            // Add inventory data
            csvContent += "INVENTORY DATA (Active)\n";
            csvContent += "Brand,Product,Status,Expiry,Shipment,Remarks\n";
            inventoryData.forEach(item => {
                csvContent += `${item.brand || ''},${item.product || ''},${item.status || ''},${item.expiry || ''},${item.shipment || ''},${item.remarks || ''}\n`;
            });

            // Add new products data
            csvContent += "\n\nNEW PRODUCTS DATA (Active)\n";
            csvContent += "Brand,Product,Added Date,Arrival Date,Quantity,Notes\n";
            newProductsData.forEach(item => {
                csvContent += `${item.brand || ''},${item.product || ''},${item.addedDate || ''},${item.arrivalDate || ''},${item.quantity || ''},${item.notes || ''}\n`;
            });

            // Add to clear data
            csvContent += "\n\nTO CLEAR DATA (Active)\n";
            csvContent += "Brand,Product,Category,Expiry Date,Total Qty,Weekly Demand,Action Plan\n";
            toClearData.forEach(item => {
                csvContent += `${item.brand || ''},${item.product || ''},${item.category || ''},${item.expiryDate || ''},${item.totalQty || ''},${item.weeklyDemand || ''},${item.actionPlan || ''}\n`;
            });

            // Add master products data
            csvContent += "\n\nMASTER PRODUCTS DATA (Active)\n";
            csvContent += "Brand,Product Name,Category,Description,SKU,Price\n";
            masterProductsData.forEach(item => {
                csvContent += `${item.brand || ''},${item.product || ''},${item.category || ''},${item.description || ''},${item.sku || ''},${item.price || 0}\n`;
            });

            // Add deleted items data (Recycle Bin)
            csvContent += "\n\nRECYCLE BIN DATA (Deleted Items)\n";
            csvContent += "Original Collection,Brand,Product\n";
            deletedItemsData.forEach(item => {
                csvContent += `${item.originalCollection || ''},${item.brand || ''},${item.product || ''}\n`;
            });


            // Download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "inventory_export_" + new Date().toISOString().split('T')[0] + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('All data exported successfully!');
        }

        function exportMasterList() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Brand,Product,Category,Description,SKU,Price\n";

            masterProductsData.forEach(item => {
                csvContent += `${item.brand || ''},${item.product || ''},${item.category || ''},${item.description || ''},${item.sku || ''},${item.price || 0}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "master_products_" + new Date().toISOString().split('T')[0] + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('Master list exported successfully!');
        }

        // Import CSV function (for master list, imports to Firestore)
        async function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                await parseCSVAndUpload(text); // Async upload
            };
            reader.readAsText(file);

            event.target.value = ''; // Reset the input
        }

        async function parseCSVAndUpload(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== ''); // Filter empty lines
            if (lines.length === 0) {
                showNotification('CSV file is empty!', 'error');
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim());

            const expectedHeaders = ['Brand', 'Product', 'Category', 'Description', 'SKU', 'Price'];
            const hasValidHeaders = expectedHeaders.every(header =>
                headers.some(h => h.toLowerCase() === header.toLowerCase())
            );

            if (!hasValidHeaders) {
                showNotification('Invalid CSV format! Headers should be: Brand, Product, Category, Description, SKU, Price', 'error');
                return;
            }

            let importedCount = 0;
            const batch = db.batch(); // Use a batch for multiple writes

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = parseCSVLine(line);
                if (values.length >= headers.length) {
                    const newProduct = {
                        brand: values[headers.indexOf('Brand')] || '',
                        product: values[headers.indexOf('Product')] || '',
                        category: values[headers.indexOf('Category')] || '',
                        description: values[headers.indexOf('Description')] || '',
                        sku: values[headers.indexOf('SKU')] || '',
                        price: parseFloat(values[headers.indexOf('Price')]) || 0,
                        isDeleted: false // Ensure imported items are not marked deleted
                    };

                    // Only add if brand and product name exist and it's not a duplicate
                    if (newProduct.brand && newProduct.product) {
                        // Check for existing product to avoid duplicates
                        const existingProduct = masterProductsData.find(item =>
                            item.brand === newProduct.brand &&
                            item.product === newProduct.product &&
                            !item.isDeleted // Only check active products
                        );

                        if (!existingProduct) {
                            const docRef = db.collection('master_products').doc(); // Auto-generate ID
                            batch.set(docRef, newProduct);
                            importedCount++;
                        } else {
                            console.warn(`Skipping duplicate: ${newProduct.brand} - ${newProduct.product}`);
                        }
                    }
                }
            }

            try {
                if (importedCount > 0) {
                    await batch.commit();
                    showNotification(`Successfully imported ${importedCount} products to Master List!`);
                    await updateLocalData(); // Refresh data after import
                } else {
                    showNotification('No new valid products found in the CSV file or all were duplicates!', 'error');
                }
            } catch (error) {
                console.error("Error importing CSV to Firestore:", error);
                showNotification('Error importing CSV. Check console for details.', 'error');
            }
        }

        // Helper function to parse CSV line (handles commas in quotes)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            result.push(current.trim());
            return result;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Initialize on load: Fetch data from Firestore
        window.onload = async function() {
            // Wait for data to load from Firestore before updating tables
            await updateLocalData();
            switchTab('dashboard'); // Default to dashboard after load
        };
    </script>
</body>
</html>